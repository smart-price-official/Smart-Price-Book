<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Smart Price åŸå› èª¿æŸ»ã‚¢ãƒ—ãƒª</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'BIZ UDã‚´ã‚·ãƒƒã‚¯', 'Meiryo', sans-serif;
      background: #121212;
      color: #e0e0e0;
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      color: #ff9800;
      font-size: 1.5rem;
      margin-bottom: 20px;
      border-bottom: 3px solid #ff9800;
      padding-bottom: 10px;
    }
    .section {
      background: #1e1e1e;
      border: 2px solid #444;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .section-title {
      color: #ff9800;
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 10px;
      border-bottom: 1px solid #666;
      padding-bottom: 5px;
    }
    .info-item {
      margin: 8px 0;
      padding: 8px;
      background: #2a2a2a;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.85rem;
      word-break: break-all;
    }
    .info-label {
      color: #aaa;
      font-weight: bold;
    }
    .info-value {
      color: #fff;
      margin-left: 8px;
    }
    .status-ok { color: #4caf50; }
    .status-warn { color: #ff9800; }
    .status-error { color: #ff5252; }
    button {
      background: #ff9800;
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
      transition: background 0.3s;
    }
    button:hover { background: #f57c00; }
    button:active { background: #e65100; }
    button.danger {
      background: #ff5252;
    }
    button.danger:hover {
      background: #d32f2f;
    }
    .log-area {
      background: #000;
      color: #0f0;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.8rem;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .video-preview {
      width: 100%;
      max-width: 400px;
      height: 300px;
      background: #000;
      border: 2px solid #666;
      border-radius: 4px;
      margin-top: 10px;
    }
    .loading { opacity: 0.5; pointer-events: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” Smart Price åŸå› èª¿æŸ»ã‚¢ãƒ—ãƒª</h1>
    
    <!-- A) å®Ÿéš›ã«èª­ã¿è¾¼ã‚“ã  index.html ã®æƒ…å ± -->
    <div class="section">
      <div class="section-title">ğŸ“Œ A) èª­ã¿è¾¼ã‚“ã HTMLã®æƒ…å ±</div>
      <div class="info-item">
        <span class="info-label">FULL_VERSION:</span>
        <span class="info-value" id="full-version">ç¢ºèªä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">BUILD_ID:</span>
        <span class="info-value" id="build-id">ç¢ºèªä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">BUILD_PARAM (?b=):</span>
        <span class="info-value" id="build-param">ç¢ºèªä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">èª­ã¿è¾¼ã‚“ã URL:</span>
        <span class="info-value" id="current-url">ç¢ºèªä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">Date.now():</span>
        <span class="info-value" id="current-time">ç¢ºèªä¸­...</span>
      </div>
      <button onclick="updatePageInfo()">ğŸ”„ ãƒšãƒ¼ã‚¸æƒ…å ±ã‚’æ›´æ–°</button>
    </div>

    <!-- B) Service Worker / ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®çŠ¶æ…‹ -->
    <div class="section">
      <div class="section-title">ğŸ”§ B) Service Worker / ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®çŠ¶æ…‹</div>
      <div class="info-item">
        <span class="info-label">SW Controller:</span>
        <span class="info-value" id="sw-controller">ç¢ºèªä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">SWç™»éŒ²æ•°:</span>
        <span class="info-value" id="sw-registrations">ç¢ºèªä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ•°:</span>
        <span class="info-value" id="cache-count">ç¢ºèªä¸­...</span>
      </div>
      <button onclick="clearServiceWorkerAndCache()">ğŸ—‘ï¸ SWè§£é™¤ï¼‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ï¼‹ãƒªãƒ­ãƒ¼ãƒ‰</button>
    </div>

    <!-- C) ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç³»ã®çŠ¶æ…‹ -->
    <div class="section">
      <div class="section-title">ğŸ’¿ C) ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç³»ã®çŠ¶æ…‹</div>
      <div class="info-item">
        <span class="info-label">localStorageä½¿ç”¨é‡:</span>
        <span class="info-value" id="localstorage-size">ç¢ºèªä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">localStorageã‚­ãƒ¼:</span>
        <span class="info-value" id="localstorage-keys">ç¢ºèªä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">IndexedDBä¸€è¦§:</span>
        <span class="info-value" id="indexeddb-list">ç¢ºèªä¸­...</span>
      </div>
      <button class="danger" onclick="clearAllStorage()">âš ï¸ ã“ã®ã‚µã‚¤ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–</button>
    </div>

    <!-- D) ã‚«ãƒ¡ãƒ©èµ·å‹•ã®åˆ‡ã‚Šåˆ†ã‘ -->
    <div class="section">
      <div class="section-title">ğŸ“· D) ã‚«ãƒ¡ãƒ©èµ·å‹•ã®åˆ‡ã‚Šåˆ†ã‘</div>
      <div class="info-item">
        <span class="info-label">ã‚«ãƒ¡ãƒ©è¨±å¯çŠ¶æ³:</span>
        <span class="info-value" id="camera-permission">ç¢ºèªä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">ã‚«ãƒ¡ãƒ©èµ·å‹•ãƒ†ã‚¹ãƒˆ:</span>
        <span class="info-value" id="camera-status">æœªå®Ÿè¡Œ</span>
      </div>
      <video id="camera-preview" class="video-preview" autoplay playsinline></video>
      <button onclick="testCamera()">ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•ãƒ†ã‚¹ãƒˆ</button>
      <button onclick="stopCamera()">â¹ï¸ ã‚«ãƒ¡ãƒ©åœæ­¢</button>
      <div class="log-area" id="camera-log"></div>
    </div>

    <!-- E) ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼é…ä¿¡ã®åˆ‡ã‚Šåˆ†ã‘ -->
    <div class="section">
      <div class="section-title">ğŸŒ E) ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼é…ä¿¡ã®åˆ‡ã‚Šåˆ†ã‘</div>
      <div class="info-item">
        <span class="info-label">fetchçµæœ (cache: no-store):</span>
        <span class="info-value" id="fetch-no-store">æœªå®Ÿè¡Œ</span>
      </div>
      <div class="info-item">
        <span class="info-label">fetchçµæœ (reload):</span>
        <span class="info-value" id="fetch-reload">æœªå®Ÿè¡Œ</span>
      </div>
      <div class="info-item">
        <span class="info-label">æŠ½å‡ºã—ãŸVERSION:</span>
        <span class="info-value" id="fetched-version">-</span>
      </div>
      <div class="info-item">
        <span class="info-label">æŠ½å‡ºã—ãŸBUILD_ID:</span>
        <span class="info-value" id="fetched-build-id">-</span>
      </div>
      <div class="info-item">
        <span class="info-label">å–å¾—å…ˆURL:</span>
        <span class="info-value" id="fetched-url">-</span>
      </div>
      <div class="info-item">
        <span class="info-label">HTTP status:</span>
        <span class="info-value" id="fetched-status">-</span>
      </div>
      <button onclick="testNetworkFetch()">ğŸŒ åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã®index.htmlã‚’fetch</button>
      <button onclick="clearCacheAndRefetch()" style="margin-left:10px;">ğŸ—‘ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ï¼‹å†å–å¾—</button>
      <div class="log-area" id="network-log"></div>
    </div>

    <!-- ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div class="section">
      <div class="section-title">ğŸ“‹ è¨ºæ–­ãƒ­ã‚°</div>
      <div class="log-area" id="diagnostic-log"></div>
      <button onclick="clearLog()">ğŸ—‘ï¸ ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>
    </div>
  </div>

  <script>
    let cameraStream = null;
    const logArea = document.getElementById('diagnostic-log');

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('ja-JP');
      const prefix = type === 'error' ? 'âŒ' : type === 'warn' ? 'âš ï¸' : 'â„¹ï¸';
      const logText = `[${timestamp}] ${prefix} ${message}\n`;
      logArea.textContent += logText;
      logArea.scrollTop = logArea.scrollHeight;
      console.log(message);
    }

    function clearLog() {
      logArea.textContent = '';
    }

    // âœ… P0-3: A) å®Ÿéš›ã«èª­ã¿è¾¼ã‚“ã  index.html ã®æƒ…å ±ã‚’ç¢ºå®Ÿã«è¡¨ç¤ºï¼ˆåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã®index.htmlã‚’fetchï¼‰
    // ãƒ¦ã‚¤ã®æŒ‡æ‘˜ï¼šã€ŒåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã® index.html ã‚’ fetchï¼ˆcache: no-storeï¼‰ã—ã¦ã€HTMLå†…ã® VERSION / BUILD_ID ã‚’æŠ½å‡ºã—ã¦è¡¨ç¤ºã™ã‚‹æ–¹å¼ã«å¤‰æ›´ã€
    async function updatePageInfo() {
      try {
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ BUILD_PARAM ã‚’å–å¾—
        const urlParams = new URLSearchParams(location.search);
        const bParam = urlParams.get('b') || 'ãªã—';
        document.getElementById('build-param').textContent = bParam;
        document.getElementById('current-url').textContent = location.href;
        document.getElementById('current-time').textContent = new Date().toISOString();
        
        // âœ… P0-3: åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã® index.html ã‚’ fetch ã—ã¦ FULL_VERSION / BUILD_ID ã‚’æŠ½å‡º
        try {
          const indexHtmlUrl = './index.html';
          const res = await fetch(indexHtmlUrl, { cache: 'no-store' });
          const text = await res.text();
          
          // FULL_VERSION ã‚’æŠ½å‡ºï¼ˆã‚³ãƒ¡ãƒ³ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ or const FULL_VERSIONï¼‰
          const versionMatch = text.match(/FULL_VERSION:\s*(v[\d.]+)/) || text.match(/const\s+FULL_VERSION\s*=\s*["'](v[\d.]+)["']/);
          const buildIdMatch = text.match(/BUILD_ID:\s*([^\n]+)/) || text.match(/const\s+BUILD_ID\s*=\s*["']([^"']+)["']/);
          
          const fullVersion = versionMatch ? versionMatch[1] : 'æŠ½å‡ºå¤±æ•—';
          const buildId = buildIdMatch ? buildIdMatch[1].trim() : 'æŠ½å‡ºå¤±æ•—';
          
          // âœ… P0: ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè¨˜å·ã®æ¤œæŸ»ï¼ˆ<<<<<<< / ======= / >>>>>>>ï¼‰
          const conflictMarkers = text.match(/<<<<<<<|=======|>>>>>>>/g);
          if (conflictMarkers) {
            const conflictCount = conflictMarkers.length;
            log(`âš ï¸ ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè¨˜å·ã‚’æ¤œå‡º: ${conflictCount}ç®‡æ‰€`, 'warn');
            document.getElementById('full-version').textContent = `${fullVersion} âš ï¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè¨˜å·ã‚ã‚Š`;
            document.getElementById('build-id').textContent = `${buildId} âš ï¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè¨˜å·ã‚ã‚Š`;
          } else {
            document.getElementById('full-version').textContent = fullVersion;
            document.getElementById('build-id').textContent = buildId;
          }
          
          log(`index.htmlã‹ã‚‰å–å¾—: FULL_VERSION=${fullVersion}, BUILD_ID=${buildId}`, 'info');
        } catch(e) {
          document.getElementById('full-version').textContent = `fetchå¤±æ•—: ${e.message}`;
          document.getElementById('build-id').textContent = `fetchå¤±æ•—: ${e.message}`;
          log(`index.html fetchã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
        }
        
        log('ãƒšãƒ¼ã‚¸æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'info');
      } catch(e) {
        log(`ãƒšãƒ¼ã‚¸æƒ…å ±æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
      }
    }

    // B) Service Worker / ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®çŠ¶æ…‹ã‚’è¡¨ç¤ºï¼‹è§£é™¤ãƒœã‚¿ãƒ³
    async function updateServiceWorkerStatus() {
      try {
        if ('serviceWorker' in navigator) {
          const controller = navigator.serviceWorker.controller;
          document.getElementById('sw-controller').textContent = controller ? `ã‚ã‚Š (${controller.scriptURL})` : 'ãªã—';
          
          const registrations = await navigator.serviceWorker.getRegistrations();
          document.getElementById('sw-registrations').textContent = `${registrations.length}ä»¶`;
          if (registrations.length > 0) {
            const swList = registrations.map(r => r.scope).join('\n  ');
            document.getElementById('sw-registrations').textContent += `\n  ${swList}`;
          }
        } else {
          document.getElementById('sw-controller').textContent = 'æœªå¯¾å¿œ';
          document.getElementById('sw-registrations').textContent = 'æœªå¯¾å¿œ';
        }

        if ('caches' in window) {
          const cacheNames = await caches.keys();
          document.getElementById('cache-count').textContent = `${cacheNames.length}ä»¶`;
          if (cacheNames.length > 0) {
            const cacheList = cacheNames.join('\n  ');
            document.getElementById('cache-count').textContent += `\n  ${cacheList}`;
          }
        } else {
          document.getElementById('cache-count').textContent = 'æœªå¯¾å¿œ';
        }
        
        log('Service Worker/ã‚­ãƒ£ãƒƒã‚·ãƒ¥çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'info');
      } catch(e) {
        log(`Service WorkerçŠ¶æ…‹æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
      }
    }

    async function clearServiceWorkerAndCache() {
      if (!confirm('Service Workerã‚’è§£é™¤ã—ã€ã™ã¹ã¦ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      try {
        log('Service Workerè§£é™¤ï¼‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ã‚’é–‹å§‹...', 'info');
        
        if ('serviceWorker' in navigator) {
          const registrations = await navigator.serviceWorker.getRegistrations();
          for (let registration of registrations) {
            const success = await registration.unregister();
            if (success) {
              log(`Service Workerè§£é™¤: ${registration.scope}`, 'info');
            }
          }
        }

        if ('caches' in window) {
          const cacheNames = await caches.keys();
          for (let cacheName of cacheNames) {
            await caches.delete(cacheName);
            log(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤: ${cacheName}`, 'info');
          }
        }

        log('å®Œäº†ã€‚3ç§’å¾Œã«ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™...', 'info');
        setTimeout(() => {
          location.reload(true);
        }, 3000);
      } catch(e) {
        log(`SWè§£é™¤ï¼‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
      }
    }

    // C) ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç³»ã®çŠ¶æ…‹è¡¨ç¤º
    async function updateStorageStatus() {
      try {
        // localStorageä½¿ç”¨é‡ï¼ˆæ¦‚ç®—ï¼‰
        let totalSize = 0;
        const keys = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          const value = localStorage.getItem(key);
          keys.push(key);
          totalSize += (key ? key.length : 0) + (value ? value.length : 0);
        }
        document.getElementById('localstorage-size').textContent = `${keys.length}ã‚­ãƒ¼ / ç´„${(totalSize / 1024).toFixed(2)}KB`;
        document.getElementById('localstorage-keys').textContent = keys.length > 0 ? keys.join(', ') : 'ãªã—';

        // IndexedDBä¸€è¦§
        if ('indexedDB' in window && 'databases' in indexedDB) {
          try {
            const databases = await indexedDB.databases();
            const dbNames = databases.map(db => db.name).join(', ');
            document.getElementById('indexeddb-list').textContent = databases.length > 0 ? `${databases.length}ä»¶: ${dbNames}` : 'ãªã—';
          } catch(e) {
            document.getElementById('indexeddb-list').textContent = `ç¢ºèªã‚¨ãƒ©ãƒ¼: ${e.message}`;
          }
        } else {
          document.getElementById('indexeddb-list').textContent = 'databases()æœªå¯¾å¿œï¼ˆæ‰‹å‹•ç¢ºèªãŒå¿…è¦ï¼‰';
        }

        log('ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'info');
      } catch(e) {
        log(`ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸çŠ¶æ…‹æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
      }
    }

    function clearAllStorage() {
      if (!confirm('âš ï¸ è­¦å‘Š: ã“ã®ã‚µã‚¤ãƒˆã®ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆlocalStorageã€IndexedDBï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚è³¼å…¥å±¥æ­´ãªã©ã‚‚æ¶ˆãˆã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
        return;
      }

      try {
        log('ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å‰Šé™¤ã‚’é–‹å§‹...', 'warn');
        
        // localStorageå‰Šé™¤
        localStorage.clear();
        log('localStorageã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'info');
        
        // IndexedDBå‰Šé™¤
        if ('indexedDB' in window && 'databases' in indexedDB) {
          indexedDB.databases().then(databases => {
            databases.forEach(db => {
              indexedDB.deleteDatabase(db.name);
              log(`IndexedDBå‰Šé™¤: ${db.name}`, 'info');
            });
          });
        }

        log('å®Œäº†ã€‚3ç§’å¾Œã«ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™...', 'info');
        setTimeout(() => {
          location.reload(true);
        }, 3000);
      } catch(e) {
        log(`ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
      }
    }

    // D) ã‚«ãƒ¡ãƒ©èµ·å‹•ã®åˆ‡ã‚Šåˆ†ã‘
    async function updateCameraPermission() {
      try {
        if ('permissions' in navigator) {
          try {
            const permission = await navigator.permissions.query({ name: 'camera' });
            const status = permission.state;
            document.getElementById('camera-permission').textContent = status;
            log(`ã‚«ãƒ¡ãƒ©è¨±å¯çŠ¶æ³: ${status}`, 'info');
          } catch(e) {
            document.getElementById('camera-permission').textContent = `ç¢ºèªã‚¨ãƒ©ãƒ¼: ${e.message}`;
          }
        } else {
          document.getElementById('camera-permission').textContent = 'Permissions APIæœªå¯¾å¿œ';
        }
      } catch(e) {
        log(`ã‚«ãƒ¡ãƒ©è¨±å¯çŠ¶æ³ç¢ºèªã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
      }
    }

    async function testCamera() {
      const logArea = document.getElementById('camera-log');
      const video = document.getElementById('camera-preview');
      const statusEl = document.getElementById('camera-status');
      
      logArea.textContent = '';
      statusEl.textContent = 'èµ·å‹•ä¸­...';
      
      try {
        // æ—¢å­˜ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
        if (cameraStream) {
          cameraStream.getTracks().forEach(track => track.stop());
        }

        logArea.textContent += 'ã‚«ãƒ¡ãƒ©èµ·å‹•ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...\n';
        
        // æ®µéšçš„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        const configs = [
          { facingMode: { exact: "environment" } },
          { facingMode: { ideal: "environment" } },
          { facingMode: "environment" },
          true
        ];

        let success = false;
        for (let i = 0; i < configs.length; i++) {
          try {
            logArea.textContent += `è©¦è¡Œ${i + 1}: ${JSON.stringify(configs[i])}\n`;
            const stream = await navigator.mediaDevices.getUserMedia({ video: configs[i] });
            
            cameraStream = stream;
            video.srcObject = stream;
            statusEl.textContent = 'âœ… æˆåŠŸ';
            statusEl.className = 'status-ok';
            logArea.textContent += `âœ… æˆåŠŸ: è©¦è¡Œ${i + 1}\n`;
            log(`ã‚«ãƒ¡ãƒ©èµ·å‹•æˆåŠŸ: è©¦è¡Œ${i + 1}`, 'info');
            success = true;
            break;
          } catch(err) {
            logArea.textContent += `âŒ å¤±æ•—: ${err.name}: ${err.message}\n`;
            log(`ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—(è©¦è¡Œ${i + 1}): ${err.name}: ${err.message}`, 'error');
          }
        }

        if (!success) {
          statusEl.textContent = 'âŒ å¤±æ•—';
          statusEl.className = 'status-error';
          logArea.textContent += '\nâŒ ã™ã¹ã¦ã®è©¦è¡ŒãŒå¤±æ•—ã—ã¾ã—ãŸ\n';
        }
      } catch(e) {
        statusEl.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`;
        statusEl.className = 'status-error';
        logArea.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${e.name}: ${e.message}\n`;
        log(`ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
      }
    }

    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
        document.getElementById('camera-preview').srcObject = null;
        document.getElementById('camera-status').textContent = 'åœæ­¢';
        document.getElementById('camera-status').className = '';
        log('ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢ã—ã¾ã—ãŸ', 'info');
      }
    }

    // E) ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼é…ä¿¡ã®åˆ‡ã‚Šåˆ†ã‘
    async function testNetworkFetch() {
      const logArea = document.getElementById('network-log');
      logArea.textContent = '';

      // âœ… P0: å¤‰æ•°ã‚¹ã‚³ãƒ¼ãƒ—ã‚’é–¢æ•°ã‚¹ã‚³ãƒ¼ãƒ—ã§å®£è¨€ï¼ˆversion1 is not defined ã‚¨ãƒ©ãƒ¼ã‚’é˜²æ­¢ï¼‰
      let version1 = 'æœªå–å¾—';
      let buildId1 = 'æœªå–å¾—';
      let version2 = 'æœªå–å¾—';
      let buildId2 = 'æœªå–å¾—';

      try {
        // âœ… P0-3: åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã®index.htmlã®URLã‚’ç”Ÿæˆï¼ˆlocation.pathnameã‹ã‚‰è‡ªå‹•åˆ¤å®šï¼‰
        let indexHtmlUrl = './index.html';
        const absoluteUrl = new URL(indexHtmlUrl, location.href).href;
        document.getElementById('fetched-url').textContent = absoluteUrl;
        
        // cache: no-store ã§å–å¾—
        logArea.textContent += `ã€ãƒ†ã‚¹ãƒˆ1ã€‘cache: no-store ã§å–å¾—: ${absoluteUrl}\n`;
        const start1 = Date.now();
        try {
          const res1 = await fetch(indexHtmlUrl, { cache: 'no-store' });
          const elapsed1 = Date.now() - start1;
          const text1 = await res1.text();
          
          const versionMatch1 = text1.match(/FULL_VERSION:\s*(v[\d.]+)/) || text1.match(/const\s+FULL_VERSION\s*=\s*["'](v[\d.]+)["']/);
          const buildIdMatch1 = text1.match(/BUILD_ID:\s*([^\n]+)/) || text1.match(/const\s+BUILD_ID\s*=\s*["']([^"']+)["']/);
          
          version1 = versionMatch1 ? versionMatch1[1] : 'æŠ½å‡ºå¤±æ•—';
          buildId1 = buildIdMatch1 ? buildIdMatch1[1].trim() : 'æŠ½å‡ºå¤±æ•—';
          
          // âœ… P0: ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè¨˜å·ã®æ¤œæŸ»ï¼ˆ<<<<<<< / ======= / >>>>>>>ï¼‰
          const conflictMarkers1 = text1.match(/<<<<<<<|=======|>>>>>>>/g);
          let conflictNote1 = '';
          if (conflictMarkers1) {
            conflictNote1 = ` âš ï¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè¨˜å·${conflictMarkers1.length}ç®‡æ‰€`;
            logArea.textContent += `âš ï¸ ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè¨˜å·ã‚’æ¤œå‡º: ${conflictMarkers1.length}ç®‡æ‰€\n`;
          }
          
          // âœ… P0-3: HTTP status / å–å¾—å…ˆURL / VERSION/BUILD_ID ã‚’ä¸€è¦§è¡¨ç¤º
          document.getElementById('fetch-no-store').textContent = `âœ… ${res1.status} (${elapsed1}ms) / VERSION: ${version1}${conflictNote1}`;
          document.getElementById('fetched-status').textContent = `${res1.status} (${elapsed1}ms)`;
          document.getElementById('fetched-version').textContent = version1 + conflictNote1;
          document.getElementById('fetched-build-id').textContent = buildId1 + conflictNote1;
          
          logArea.textContent += `âœ… HTTP ${res1.status} (${elapsed1}ms)\n`;
          logArea.textContent += `  FULL_VERSION: ${version1}\n`;
          logArea.textContent += `  BUILD_ID: ${buildId1}\n`;
        } catch(e) {
          document.getElementById('fetch-no-store').textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`;
          logArea.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}\n`;
        }

        // âœ… P0-3: reload ã§å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å†æ¤œè¨¼ï¼‰
        logArea.textContent += '\nã€ãƒ†ã‚¹ãƒˆ2ã€‘reload ã§å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å†æ¤œè¨¼ï¼‰...\n';
        const start2 = Date.now();
        try {
          const res2 = await fetch(indexHtmlUrl, { cache: 'reload' });
          const elapsed2 = Date.now() - start2;
          const text2 = await res2.text();
          
          const versionMatch2 = text2.match(/FULL_VERSION:\s*(v[\d.]+)/) || text2.match(/const\s+FULL_VERSION\s*=\s*["'](v[\d.]+)["']/);
          const buildIdMatch2 = text2.match(/BUILD_ID:\s*([^\n]+)/) || text2.match(/const\s+BUILD_ID\s*=\s*["']([^"']+)["']/);
          
          version2 = versionMatch2 ? versionMatch2[1] : 'æŠ½å‡ºå¤±æ•—';
          buildId2 = buildIdMatch2 ? buildIdMatch2[1].trim() : 'æŠ½å‡ºå¤±æ•—';
          
          // âœ… P0: ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè¨˜å·ã®æ¤œæŸ»ï¼ˆ<<<<<<< / ======= / >>>>>>>ï¼‰
          const conflictMarkers2 = text2.match(/<<<<<<<|=======|>>>>>>>/g);
          let conflictNote2 = '';
          if (conflictMarkers2) {
            conflictNote2 = ` âš ï¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè¨˜å·${conflictMarkers2.length}ç®‡æ‰€`;
            logArea.textContent += `âš ï¸ ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè¨˜å·ã‚’æ¤œå‡º: ${conflictMarkers2.length}ç®‡æ‰€\n`;
          }
          
          document.getElementById('fetch-reload').textContent = `âœ… ${res2.status} (${elapsed2}ms) / VERSION: ${version2}${conflictNote2}`;
          
          logArea.textContent += `âœ… HTTP ${res2.status} (${elapsed2}ms)\n`;
          logArea.textContent += `  FULL_VERSION: ${version2}\n`;
          logArea.textContent += `  BUILD_ID: ${buildId2}\n`;
          
          // æ¯”è¼ƒ
          if (version1 !== version2 || buildId1 !== buildId2) {
            logArea.textContent += `\nâš ï¸ è­¦å‘Š: å–å¾—æ–¹æ³•ã«ã‚ˆã£ã¦VERSION/BUILD_IDãŒç•°ãªã‚Šã¾ã™\n`;
          }
        } catch(e) {
          document.getElementById('fetch-reload').textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`;
          logArea.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}\n`;
        }

        log('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å–å¾—ãƒ†ã‚¹ãƒˆå®Œäº†', 'info');
      } catch(e) {
        log(`ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å–å¾—ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
        document.getElementById('fetched-status').textContent = `ã‚¨ãƒ©ãƒ¼: ${e.message}`;
      }
    }

    // âœ… P0-3: ã‚­ãƒ£ãƒƒã‚·ãƒ¥/SWå‰Šé™¤ï¼‹å†å–å¾—ã‚’1ãƒœã‚¿ãƒ³ã§å¯èƒ½ã«
    // ãƒ¦ã‚¤ã®æŒ‡æ‘˜ï¼šã€ŒHTTP status / å–å¾—å…ˆURL / ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»SWçŠ¶æ…‹ ã‚’ä¸€è¦§åŒ–ã—ã€å‰Šé™¤ã¨å†å–å¾—ã‚’1ãƒœã‚¿ãƒ³ã§å¯èƒ½ã«ã€
    async function clearCacheAndRefetch() {
      if (!confirm('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨Service Workerã‚’å‰Šé™¤ã—ã¦ã€index.htmlã‚’å†å–å¾—ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }
      
      try {
        log('ã‚­ãƒ£ãƒƒã‚·ãƒ¥/SWå‰Šé™¤ï¼‹å†å–å¾—ã‚’é–‹å§‹...', 'warn');
        
        // 1. Service Workerè§£é™¤
        if ('serviceWorker' in navigator) {
          const registrations = await navigator.serviceWorker.getRegistrations();
          for (const registration of registrations) {
            await registration.unregister();
            log(`Service Workerè§£é™¤: ${registration.scope}`, 'info');
          }
        }
        
        // 2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤
        if ('caches' in window) {
          const cacheNames = await caches.keys();
          for (const cacheName of cacheNames) {
            await caches.delete(cacheName);
            log(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤: ${cacheName}`, 'info');
          }
        }
        
        // 3. Service WorkerçŠ¶æ…‹ã‚’æ›´æ–°
        await updateServiceWorkerStatus();
        
        // 4. å†å–å¾—
        log('ã‚­ãƒ£ãƒƒã‚·ãƒ¥/SWå‰Šé™¤å®Œäº†ã€‚index.htmlã‚’å†å–å¾—ã—ã¾ã™...', 'info');
        await testNetworkFetch();
        
        log('ã‚­ãƒ£ãƒƒã‚·ãƒ¥/SWå‰Šé™¤ï¼‹å†å–å¾—å®Œäº†', 'info');
      } catch(e) {
        log(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥/SWå‰Šé™¤ï¼‹å†å–å¾—ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
      }
    }

    // åˆæœŸåŒ–
    window.addEventListener('load', async () => {
      log('è¨ºæ–­ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¾ã—ãŸ', 'info');
      updatePageInfo();
      await updateServiceWorkerStatus();
      await updateStorageStatus();
      await updateCameraPermission();
      
      // debug=1 ã®å ´åˆã¯è‡ªå‹•ã§SWè§£é™¤ï¼‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ï¼‹ãƒªãƒ­ãƒ¼ãƒ‰
      const urlParams = new URLSearchParams(location.search);
      if (urlParams.get('debug') === '1') {
        log('debug=1ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚SWè§£é™¤ï¼‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ã‚’å®Ÿè¡Œã—ã¾ã™...', 'warn');
        setTimeout(() => {
          clearServiceWorkerAndCache();
        }, 2000);
      }
    });
  </script>
</body>
</html>
