# Smart Price 修正コード一覧

**バージョン**: v19.9c-hf12-pwa1  
**日付**: 2026-01-03

---

## 1. index.html の修正箇所

### 1-1. バージョン情報の更新

**場所**: ヘッダーコメント（1-18行目）

```html
<!--
APP: Smart Price
FILE: index.html
VERSION: v19.9c-hf12-pwa1
DATE(JST): 2026-01-03 00:00 JST
TITLE: サブカテゴリ修正＋PWA対応（manifest+sw）
CHANGES:
- サブカテゴリ：categoryTreeが空の場合、DEFAULT_CATEGORY_TREEから補完
- normalizeDb：categoryTreeの初期化と補完を強化
- PWA：manifest.jsonにstart_url/scope追加、sw.js新規作成、SW登録コード追加
- バージョン：v19.9c-hf11 → v19.9c-hf12-pwa1
AUTHOR: Yui / Rex
BUILD_PARAM: ?b=2026-01-03_0000_hf12-pwa1
DEBUG_PARAM: &debug=1
POLICY: 見た目は極力維持（機能復活は最小UIで）
-->
```

**場所**: タイトル（29行目）

```html
<title>Smart Price v19.9c-hf12-pwa1</title>
```

**場所**: ヘッダーバッジ（90行目）

```html
<h5 class="m-0 fw-bold text-white"><i class="bi bi-cart4"></i> Smart Price <span class="v-badge">v19.9c-hf12-pwa1</span></h5>
```

**場所**: APP_VERSION定数（235行目）

```javascript
const APP_VERSION = "v19.9c-hf12-pwa1";
const BUILD_ID = "2026-01-03_0000_hf12-pwa1";
```

---

### 1-2. normalizeDb関数の修正

**場所**: 467-512行目

```javascript
function normalizeDb(input) {
  let o = (input && typeof input === "object") ? input : {};
  if (!o.products || typeof o.products !== "object") o.products = {};
  if (!o.config || typeof o.config !== "object") o.config = {};

  // categoryTree を正として整形（DEFAULT_CATEGORY_TREEから補完）
  if (!o.config.categoryTree || typeof o.config.categoryTree !== "object") {
    // 旧 categories しかない場合
    if (Array.isArray(o.config.categories) && o.config.categories.length) {
      const tree = {};
      o.config.categories.forEach(c => { tree[c] = ["その他"]; });
      o.config.categoryTree = tree;
    } else {
      o.config.categoryTree = JSON.parse(JSON.stringify(DEFAULT_CATEGORY_TREE));
    }
  } else {
    // ✅ 既存のcategoryTreeがある場合、DEFAULT_CATEGORY_TREEのデータで補完
    const merged = JSON.parse(JSON.stringify(DEFAULT_CATEGORY_TREE));
    Object.keys(merged).forEach(key => {
      if (!o.config.categoryTree[key] || !Array.isArray(o.config.categoryTree[key]) || o.config.categoryTree[key].length === 0) {
        o.config.categoryTree[key] = merged[key];
      }
    });
  }
  // categories は表示用のキー配列（互換）
  o.config.categories = Object.keys(o.config.categoryTree);

  // ... 以下既存のコード ...
}
```

---

### 1-3. initSubCategorySelect関数の修正

**場所**: 731-762行目

```javascript
function initSubCategorySelect(cat) {
  const sub = document.getElementById('inputSubCategory');
  if (!sub) return;
  if (!cat || cat === "__NONE__") { sub.style.display = 'none'; return; }

  db = normalizeDb(db); // ✅ 正規化を確実に実行
  
  // ✅ categoryTreeが存在しない、または空の場合、DEFAULT_CATEGORY_TREEから取得
  let list = [];
  if (db.config.categoryTree && db.config.categoryTree[cat] && Array.isArray(db.config.categoryTree[cat]) && db.config.categoryTree[cat].length > 0) {
    list = db.config.categoryTree[cat];
  } else if (DEFAULT_CATEGORY_TREE[cat] && Array.isArray(DEFAULT_CATEGORY_TREE[cat])) {
    // ✅ DEFAULT_CATEGORY_TREEから取得して、db.config.categoryTreeに保存
    list = DEFAULT_CATEGORY_TREE[cat];
    if (!db.config.categoryTree) db.config.categoryTree = {};
    db.config.categoryTree[cat] = [...list];
    saveLocalOnly(); // 保存して次回から使えるように
  } else {
    list = ["その他"];
  }
  
  if (!list.includes("その他")) list = [...list, "その他"];

  sub.style.display = 'block';
  sub.innerHTML = `<option value="__NONE__">サブカテゴリを選ぶ</option>` +
    list.map(s => `<option value="${s}">${s}</option>`).join('') +
    `<option value="ADD_SUB">+ 追記</option>`;

  sub.onchange = async () => {
    if (sub.value === "ADD_SUB") {
      const n = await customPrompt("新しいサブカテゴリ名");
      if (n && n.trim()) {
        const name = n.trim();
        if (!db.config.categoryTree) db.config.categoryTree = {};
        if (!db.config.categoryTree[cat]) db.config.categoryTree[cat] = [];
        if (!db.config.categoryTree[cat].includes(name)) db.config.categoryTree[cat].push(name);
        if (!db.config.categoryTree[cat].includes("その他")) db.config.categoryTree[cat].push("その他");
        initSubCategorySelect(cat);
        sub.value = name;
        saveLocalOnly(); syncFirebasePut();
      } else {
        sub.selectedIndex = 0;
      }
    }
  };
}
```

---

### 1-4. spBindItemImage関数の追加

**場所**: 392-416行目（applyImageKeyToImg関数の直後）

```javascript
// ========= Home Image Fix (base64 + IndexedDB対応) =========
async function spBindItemImage(imgEl, item) {
  if (!imgEl || !item) return;
  
  // 1. base64データ（imageData）があれば優先
  if (item.imageData && typeof item.imageData === 'string' && item.imageData.startsWith('data:')) {
    imgEl.src = item.imageData;
    return;
  }
  
  // 2. IndexedDB（imageKey）があれば取得
  if (item.imageKey && typeof item.imageKey === 'string') {
    await applyImageKeyToImg(imgEl, item.imageKey);
    return;
  }
  
  // 3. HTTP/HTTPS URL（imageUrl）があれば使用
  if (item.imageUrl && typeof item.imageUrl === 'string' && 
      (item.imageUrl.startsWith('http://') || item.imageUrl.startsWith('https://'))) {
    imgEl.src = item.imageUrl;
    return;
  }
  
  // 4. どれもなければplaceholder
  imgEl.src = placeholderImg();
}
```

---

### 1-5. renderHistory関数の修正

**場所**: 893-912行目

```javascript
function renderHistory() {
  const list = document.getElementById('historyList');
  if(!list) return;
  list.innerHTML = "";

  const items = Object.keys(db.products).map(k => ({ code: k, ...db.products[k] }));
  items.sort((a,b) => (histTs(b.history?.[b.history.length-1]) || 0) - (histTs(a.history?.[a.history.length-1]) || 0));

  items.forEach(it => {
    if (!it.history || !it.history.length) return;
    const last = it.history[it.history.length-1];
    const div = document.createElement('div');
    div.className = 'card price-card';
    div.onclick = () => openForm(it.code);

    const imgId = `img_${it.code.replace(/[^a-zA-Z0-9_-]/g,'_')}`;

    div.innerHTML = `
      <div class="d-flex align-items-center">
        <img id="${imgId}" src="" class="prod-thumb">
        <div class="flex-grow-1 overflow-hidden">
          <div class="fw-bold text-white small text-truncate">${it.name || ''}</div>
          <div class="text-secondary" style="font-size:0.6rem;">${last.store || '未設定'}</div>
        </div>
        <div class="text-end ms-2">
          <div class="price-main">${last.price}<span style="font-size:0.6rem;">円</span></div>
        </div>
      </div>`;
    list.appendChild(div);

    // ✅ 画像をバインド（base64 / IndexedDB / URL すべて対応）
    const imgEl = document.getElementById(imgId);
    if (imgEl) {
      spBindItemImage(imgEl, it);
    }
  });
}
```

---

### 1-6. サービスワーカー登録コードの追加

**場所**: 1395-1401行目（</body>直前）

```javascript
<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js", { scope: "./" }).catch(()=>{});
  });
}
</script>
```

---

## 2. manifest.json の修正

**場所**: `Smart-Price-Book/manifest.json`

```json
{
  "name": "Smart Price",
  "short_name": "Smart Price",
  "start_url": "./",
  "scope": "./",
  "display": "standalone",
  "background_color": "#D50000",
  "theme_color": "#D50000",
  "description": "Smart Price App v8.1",
  "icons": [
    {
      "src": "./icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "./icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
```

---

## 3. sw.js の新規作成

**場所**: `Smart-Price-Book/sw.js`

```javascript
/* 
 * APP: Smart Price
 * FILE: sw.js
 * VERSION: v19.9c-hf12-pwa1
 * DATE(JST): 2026-01-03
 * TITLE: PWAオフライン最小セット（安全寄り）
 */

const CACHE_NAME = "smart-price-book-cache-v19.9c-hf12-pwa1";
const RUNTIME_CACHE = "smart-price-book-runtime-v19.9c-hf12-pwa1";

const PRECACHE_URLS = [
  "./",
  "./index.html",
  "./manifest.json"
];

self.addEventListener("install", (event) => {
  event.waitUntil((async () => {
    const cache = await caches.open(CACHE_NAME);
    // addAll失敗で止まらない構成（個別にadd）
    for (const url of PRECACHE_URLS) {
      try {
        await cache.add(url);
      } catch (e) {
        console.warn(`[SW] Failed to cache ${url}:`, e);
      }
    }
    await self.skipWaiting();
  })());
});

self.addEventListener("activate", (event) => {
  event.waitUntil((async () => {
    const keys = await caches.keys();
    await Promise.all(keys.filter(k => k !== CACHE_NAME && k !== RUNTIME_CACHE).map(k => caches.delete(k)));
    await self.clients.claim();
  })());
});

self.addEventListener("fetch", (event) => {
  const req = event.request;
  if (req.method !== "GET") return;

  const url = new URL(req.url);

  // Firebase等はキャッシュしない（事故防止）
  if (/firebase|googleapis|gstatic|firestore|identitytoolkit/i.test(url.hostname + url.pathname)) {
    return;
  }

  // HTML遷移はネット優先→失敗時キャッシュ
  if (req.mode === "navigate") {
    event.respondWith((async () => {
      try {
        const fresh = await fetch(req);
        const cache = await caches.open(CACHE_NAME);
        cache.put("./index.html", fresh.clone());
        return fresh;
      } catch (e) {
        const cache = await caches.open(CACHE_NAME);
        return (await cache.match("./index.html")) || (await cache.match("./")) || Response.error();
      }
    })());
    return;
  }

  // それ以外はキャッシュ優先→裏で更新
  event.respondWith((async () => {
    const cache = await caches.open(RUNTIME_CACHE);
    const cached = await cache.match(req);
    if (cached) {
      event.waitUntil(fetch(req).then(res => {
        if (res && (res.ok || res.type === "opaque")) cache.put(req, res.clone());
      }).catch(() => {}));
      return cached;
    }
    try {
      const res = await fetch(req);
      if (res && (res.ok || res.type === "opaque")) cache.put(req, res.clone());
      return res;
    } catch (e) {
      return cached || Response.error();
    }
  })());
});
```

---

## 修正ファイル一覧

1. ✅ `Smart-Price-Book/index.html` - 全修正箇所を含む
2. ✅ `Smart-Price-Book/manifest.json` - PWA設定更新
3. ✅ `Smart-Price-Book/sw.js` - 新規作成
4. ✅ `Smart-Price-Book/generate-icons.html` - アイコン生成ツール（新規作成）

---

以上



