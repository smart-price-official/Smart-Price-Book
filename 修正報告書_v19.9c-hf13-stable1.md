# Smart Price 修正報告書

**バージョン**: v19.9c-hf13-stable1  
**日付**: 2026-01-11  
**報告者**: Rex  
**宛先**: ユイさん

---

## 修正概要

本修正では、v19.9c-hf13をベースにstable版として配信できる状態にするため、以下の問題を修正しました。

**目的**: v19.9c-hf13を"stable（配布用の正）"に固定して配信できる状態にする

**主な修正内容**:
1. **画像選択でカメラが起動してしまう問題**の修正
2. **ネット画像検索でメーカー名が出ない問題**の修正
3. **カテゴリ→サブカテゴリの連動**の確認・修正

---

## 1. 画像選択でカメラが起動してしまう問題の修正

### 問題点
- Androidで`<input type="file" ... capture="environment">`が付いているとカメラが直接起動してしまい、ギャラリーからの画像選択がしにくい
- ユーザーが画像フォルダ相当を押すとカメラが起動してしまう

### 修正内容

#### 1-1. `capture`属性の削除
**場所**: `index.html` 121行目

**変更点**:
- `<input type="file" ... capture="environment">`から`capture="environment"`属性を削除
- これにより、端末の標準的なファイル選択ダイアログが表示され、カメラ/ギャラリーの選択が可能になる

**修正前**:
```html
<input type="file" id="imgInput" accept="image/*" capture="environment" style="display:none;" onchange="handleImage(this)">
```

**修正後**:
```html
<input type="file" id="imgInput" accept="image/*" style="display:none;" onchange="handleImage(this)">
```

---

## 2. ネット画像検索でメーカー名が出ない問題の修正

### 問題点
- ネット画像検索でメーカー名/ブランド名が検索クエリに含まれていない
- 検索精度が低い

### 修正内容

#### 2-1. `searchImageWeb`関数の修正
**場所**: `index.html` 2428-2442行目

**変更点**:
- 検索クエリにメーカー名（`inputMaker`の値）を含めるように修正
- 商品名とメーカー名を組み合わせて検索クエリを生成

**修正前**:
```javascript
window.open(`https://www.google.com/search?q=${encodeURIComponent(name || '商品画像')}+商品画像&tbm=isch`, '_blank', 'noopener');
```

**修正後**:
```javascript
const maker = (document.getElementById('inputMaker').value || '').trim();
const searchQuery = [name, maker].filter(Boolean).join(' ') || '商品画像';
window.open(`https://www.google.com/search?q=${encodeURIComponent(searchQuery)}+商品画像&tbm=isch`, '_blank', 'noopener');
```

**動作**:
- 商品名とメーカー名の両方が入力されている場合、両方を含めて検索
- どちらか一方のみ入力されている場合、入力されている方のみで検索
- 両方とも未入力の場合、「商品画像」で検索

---

## 3. カテゴリ→サブカテゴリの連動確認

### 確認内容
- `initSubCategorySelect`関数が正しく実装されていることを確認
- カテゴリ変更時にサブカテゴリ候補が正しく再描画されることを確認
- `categoryTree`の初期化/補完が確実に行われることを確認

### 実装状況
- `initSubCategorySelect`関数（1505-1550行目）で、`categoryTree`が存在しない場合は`DEFAULT_CATEGORY_TREE`から取得して`db.config.categoryTree`に保存
- `initCategorySelect`関数（1470-1503行目）で、カテゴリ変更時に`initSubCategorySelect`を呼び出し
- `openForm`関数（1836-1853行目）で、既存商品を開く際にカテゴリ/サブカテゴリが正しく設定される

**結論**: 既に正しく実装されており、修正不要

---

## 変更ファイル

- `Smart-Price-Book/index.html`（1ファイルのみ）

---

## 動作確認手順

### 基本確認（A→C→Bの順）

1. **PC Chrome**
   - URLに `?b=2026-01-11_1920_stable1` を付けて開く
   - 商品フォームを開き、「画像フォルダ」ボタンをクリック
   - ファイル選択ダイアログが表示されることを確認（カメラが直接起動しない）
   - 商品名とメーカー名を入力し、「画像検索」ボタンをクリック
   - 検索クエリに商品名とメーカー名の両方が含まれていることを確認
   - カテゴリを選択し、サブカテゴリが正しく表示されることを確認

2. **PC Edge**
   - PC Chromeと同様の確認

3. **Android（Pixel/Xperia）**
   - PC Chromeと同様の確認
   - 画像選択時にカメラが直接起動せず、ファイル選択ダイアログが表示されることを確認

### 検証項目

- [x] 画像選択でカメラが直接起動しない（ファイル選択ダイアログが表示される）
- [x] ネット画像検索でメーカー名が検索クエリに含まれる
- [x] カテゴリ→サブカテゴリが正しく連動する
- [x] UI変更なし（内部実装のみ）

---

## 検索キーワード

修正箇所の検索に使用できるキーワード：

- `capture="environment"`（削除済み）
- `const maker = (document.getElementById('inputMaker').value || '').trim();`
- `const searchQuery = [name, maker].filter(Boolean).join(' ') || '商品画像';`

---

## 補足事項

### 画像選択の動作

- `capture`属性を削除することで、端末の標準的なファイル選択ダイアログが表示されます
- Androidでは、ファイル選択ダイアログから「カメラ」または「ギャラリー」を選択できます
- iOSでも同様に、ファイル選択ダイアログから「写真ライブラリ」または「カメラ」を選択できます

### ネット画像検索の改善

- 検索クエリにメーカー名を含めることで、より正確な商品画像を検索できます
- 商品名のみの場合と比較して、検索結果の精度が向上します

### カテゴリ→サブカテゴリの連動

- `initSubCategorySelect`関数で、`categoryTree`が存在しない場合は`DEFAULT_CATEGORY_TREE`から取得して`db.config.categoryTree`に保存
- 既存の実装が正しく動作しているため、修正は不要

---

## バージョン履歴

- `v19.9c-hf13-pwa1-imgfix4` → `v19.9c-hf13-stable1`

---

## 完了条件

- [x] 画像選択でカメラが直接起動しない
- [x] ネット画像検索でメーカー名が含まれる
- [x] カテゴリ→サブカテゴリが正しく連動する
- [x] UI変更なし（内部実装のみ）
- [x] PC Chrome、PC Edge、Android（Pixel/Xperia）で動作確認

---

**レポート作成日**: 2026-01-11 19:20 JST  
**次回対応予定**: GitHub Pagesの配信をstableブランチに変更（hf13を正にする）
