<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Smart Price åŸå› èª¿æŸ»ã‚¢ãƒ—ãƒª</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'BIZ UDã‚´ã‚·ãƒƒã‚¯', 'Meiryo', sans-serif;
      background: #121212;
      color: #e0e0e0;
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      color: #ff9800;
      font-size: 1.5rem;
      margin-bottom: 20px;
      border-bottom: 3px solid #ff9800;
      padding-bottom: 10px;
    }
    .section {
      background: #1e1e1e;
      border: 2px solid #444;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .section-title {
      color: #ff9800;
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 10px;
      border-bottom: 1px solid #666;
      padding-bottom: 5px;
    }
    .info-item {
      margin: 8px 0;
      padding: 8px;
      background: #2a2a2a;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.85rem;
      word-break: break-all;
    }
    .info-label {
      color: #aaa;
      font-weight: bold;
    }
    .info-value {
      color: #fff;
      margin-left: 8px;
    }
    .status-ok { color: #4caf50; }
    .status-warn { color: #ff9800; }
    .status-error { color: #ff5252; }
    button {
      background: #ff9800;
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
      transition: background 0.3s;
    }
    button:hover { background: #f57c00; }
    button:active { background: #e65100; }
    button.danger {
      background: #ff5252;
    }
    button.danger:hover {
      background: #d32f2f;
    }
    .log-area {
      background: #000;
      color: #0f0;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.8rem;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .video-preview {
      width: 100%;
      max-width: 400px;
      height: 300px;
      background: #000;
      border: 2px solid #666;
      border-radius: 4px;
      margin-top: 10px;
    }
    .loading { opacity: 0.5; pointer-events: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” Smart Price åŸå› èª¿æŸ»ã‚¢ãƒ—ãƒª</h1>
    
    <!-- A) å®Ÿéš›ã«èª­ã¿è¾¼ã‚“ã  index.html ã®æƒ…å ± -->
    <div class="section">
      <div class="section-title">ğŸ“Œ A) èª­ã¿è¾¼ã‚“ã HTMLã®æƒ…å ±</div>
      <div class="info-item">
        <span class="info-label">FULL_VERSION:</span>
        <span class="info-value" id="full-version">ç¢ºèªä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">BUILD_ID:</span>
        <span class="info-value" id="build-id">ç¢ºèªä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">BUILD_PARAM (?b=):</span>
        <span class="info-value" id="build-param">ç¢ºèªä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">Firebase:</span>
        <span class="info-value" id="firebase-status">ç¢ºèªä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">èª­ã¿è¾¼ã‚“ã URL:</span>
        <span class="info-value" id="current-url">ç¢ºèªä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">Date.now():</span>
        <span class="info-value" id="current-time">ç¢ºèªä¸­...</span>
      </div>
      <button onclick="updatePageInfo()">ğŸ”„ ãƒšãƒ¼ã‚¸æƒ…å ±ã‚’æ›´æ–°</button>
    </div>

    <!-- B) Service Worker / ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®çŠ¶æ…‹ -->
    <div class="section">
      <div class="section-title">ğŸ”§ B) Service Worker / ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®çŠ¶æ…‹</div>
      <div class="info-item">
        <span class="info-label">SW Controller:</span>
        <span class="info-value" id="sw-controller">ç¢ºèªä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">SWç™»éŒ²æ•°:</span>
        <span class="info-value" id="sw-registrations">ç¢ºèªä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ•°:</span>
        <span class="info-value" id="cache-count">ç¢ºèªä¸­...</span>
      </div>
      <button onclick="clearServiceWorkerAndCache()">ğŸ—‘ï¸ SWè§£é™¤ï¼‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ï¼‹ãƒªãƒ­ãƒ¼ãƒ‰</button>
    </div>

    <!-- C) ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç³»ã®çŠ¶æ…‹ -->
    <div class="section">
      <div class="section-title">ğŸ’¿ C) ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç³»ã®çŠ¶æ…‹</div>
      <div class="info-item">
        <span class="info-label">localStorageä½¿ç”¨é‡:</span>
        <span class="info-value" id="localstorage-size">ç¢ºèªä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">localStorageã‚­ãƒ¼:</span>
        <span class="info-value" id="localstorage-keys">ç¢ºèªä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">IndexedDBä¸€è¦§:</span>
        <span class="info-value" id="indexeddb-list">ç¢ºèªä¸­...</span>
      </div>
      <button class="danger" onclick="clearAllStorage()">âš ï¸ ã“ã®ã‚µã‚¤ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–</button>
    </div>

    <!-- D) ã‚«ãƒ¡ãƒ©èµ·å‹•ã®åˆ‡ã‚Šåˆ†ã‘ -->
    <div class="section">
      <div class="section-title">ğŸ“· D) ã‚«ãƒ¡ãƒ©èµ·å‹•ã®åˆ‡ã‚Šåˆ†ã‘</div>
      <div class="info-item">
        <span class="info-label">ã‚«ãƒ¡ãƒ©è¨±å¯çŠ¶æ³:</span>
        <span class="info-value" id="camera-permission">ç¢ºèªä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">ã‚«ãƒ¡ãƒ©èµ·å‹•ãƒ†ã‚¹ãƒˆ:</span>
        <span class="info-value" id="camera-status">æœªå®Ÿè¡Œ</span>
      </div>
      <video id="camera-preview" class="video-preview" autoplay playsinline></video>
      <button onclick="testCamera()">ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•ãƒ†ã‚¹ãƒˆ</button>
      <button onclick="stopCamera()">â¹ï¸ ã‚«ãƒ¡ãƒ©åœæ­¢</button>
      <div class="log-area" id="camera-log"></div>
    </div>

    <!-- E) ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼é…ä¿¡ã®åˆ‡ã‚Šåˆ†ã‘ -->
    <div class="section">
      <div class="section-title">ğŸŒ E) ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼é…ä¿¡ã®åˆ‡ã‚Šåˆ†ã‘</div>
      <div class="info-item">
        <span class="info-label">fetchçµæœ (cache: no-store):</span>
        <span class="info-value" id="fetch-no-store">æœªå®Ÿè¡Œ</span>
      </div>
      <div class="info-item">
        <span class="info-label">fetchçµæœ (reload):</span>
        <span class="info-value" id="fetch-reload">æœªå®Ÿè¡Œ</span>
      </div>
      <div class="info-item">
        <span class="info-label">æŠ½å‡ºã—ãŸVERSION:</span>
        <span class="info-value" id="fetched-version">-</span>
      </div>
      <div class="info-item">
        <span class="info-label">æŠ½å‡ºã—ãŸBUILD_ID:</span>
        <span class="info-value" id="fetched-build-id">-</span>
      </div>
      <button onclick="testNetworkFetch()">ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å–å¾—ãƒ†ã‚¹ãƒˆ</button>
      <div class="log-area" id="network-log"></div>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div class="section">
      <div class="section-title">âŒ ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ï¼ˆç›´è¿‘50ä»¶ï¼‰</div>
      <div class="info-item">
        <span class="info-label">ã‚¨ãƒ©ãƒ¼ä»¶æ•°:</span>
        <span class="info-value" id="error-count">0ä»¶</span>
      </div>
      <div class="log-area" id="error-log" style="max-height: 400px;"></div>
      <button onclick="copyErrorLog()">ğŸ“‹ ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼</button>
      <button onclick="clearErrorLog()" class="danger">ğŸ—‘ï¸ ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>
    </div>

    <!-- ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div class="section">
      <div class="section-title">ğŸ“‹ è¨ºæ–­ãƒ­ã‚°</div>
      <div class="log-area" id="diagnostic-log"></div>
      <button onclick="clearLog()">ğŸ—‘ï¸ ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>
    </div>
  </div>

  <script>
    let cameraStream = null;
    const logArea = document.getElementById('diagnostic-log');

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('ja-JP');
      const prefix = type === 'error' ? 'âŒ' : type === 'warn' ? 'âš ï¸' : 'â„¹ï¸';
      const logText = `[${timestamp}] ${prefix} ${message}\n`;
      logArea.textContent += logText;
      logArea.scrollTop = logArea.scrollHeight;
      console.log(message);
    }

    function clearLog() {
      logArea.textContent = '';
    }

    // A) å®Ÿéš›ã«èª­ã¿è¾¼ã‚“ã  index.html ã®æƒ…å ±ã‚’ç¢ºå®Ÿã«è¡¨ç¤º
    function updatePageInfo() {
      try {
        // FULL_VERSION / BUILD_ID ã¯ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‹ã‚‰ã¯å–å¾—ã§ããªã„ãŸã‚ã€
        // è¦ªãƒšãƒ¼ã‚¸ï¼ˆindex.htmlï¼‰ã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹ï¼ˆwindow.openerã¾ãŸã¯iframeçµŒç”±ï¼‰
        // ã¾ãŸã¯ã€URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
        const urlParams = new URLSearchParams(location.search);
        const bParam = urlParams.get('b') || 'ãªã—';
        
        document.getElementById('full-version').textContent = window.FULL_VERSION || 'è¦ªãƒšãƒ¼ã‚¸ã‹ã‚‰å–å¾—ä¸å¯';
        document.getElementById('build-id').textContent = window.BUILD_ID || 'è¦ªãƒšãƒ¼ã‚¸ã‹ã‚‰å–å¾—ä¸å¯';
        document.getElementById('build-param').textContent = bParam;
        document.getElementById('current-url').textContent = location.href;
        document.getElementById('current-time').textContent = new Date().toISOString();
        
        // âœ… P0ä¿®æ­£: FirebaseçŠ¶æ…‹ã‚’ç¢ºèª
        try {
          const isFirebaseReady = window.isFirebaseReady || false;
          document.getElementById('firebase-status').textContent = isFirebaseReady ? 'ON' : 'OFF';
        } catch(e) {
          document.getElementById('firebase-status').textContent = 'ç¢ºèªä¸å¯';
        }
        
        log('ãƒšãƒ¼ã‚¸æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'info');
      } catch(e) {
        log(`ãƒšãƒ¼ã‚¸æƒ…å ±æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
      }
    }

    // B) Service Worker / ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®çŠ¶æ…‹ã‚’è¡¨ç¤ºï¼‹è§£é™¤ãƒœã‚¿ãƒ³
    async function updateServiceWorkerStatus() {
      try {
        if ('serviceWorker' in navigator) {
          const controller = navigator.serviceWorker.controller;
          document.getElementById('sw-controller').textContent = controller ? `ã‚ã‚Š (${controller.scriptURL})` : 'ãªã—';
          
          const registrations = await navigator.serviceWorker.getRegistrations();
          document.getElementById('sw-registrations').textContent = `${registrations.length}ä»¶`;
          if (registrations.length > 0) {
            const swList = registrations.map(r => r.scope).join('\n  ');
            document.getElementById('sw-registrations').textContent += `\n  ${swList}`;
          }
        } else {
          document.getElementById('sw-controller').textContent = 'æœªå¯¾å¿œ';
          document.getElementById('sw-registrations').textContent = 'æœªå¯¾å¿œ';
        }

        if ('caches' in window) {
          const cacheNames = await caches.keys();
          document.getElementById('cache-count').textContent = `${cacheNames.length}ä»¶`;
          if (cacheNames.length > 0) {
            const cacheList = cacheNames.join('\n  ');
            document.getElementById('cache-count').textContent += `\n  ${cacheList}`;
          }
        } else {
          document.getElementById('cache-count').textContent = 'æœªå¯¾å¿œ';
        }
        
        log('Service Worker/ã‚­ãƒ£ãƒƒã‚·ãƒ¥çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'info');
      } catch(e) {
        log(`Service WorkerçŠ¶æ…‹æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
      }
    }

    async function clearServiceWorkerAndCache() {
      if (!confirm('Service Workerã‚’è§£é™¤ã—ã€ã™ã¹ã¦ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      try {
        log('Service Workerè§£é™¤ï¼‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ã‚’é–‹å§‹...', 'info');
        
        if ('serviceWorker' in navigator) {
          const registrations = await navigator.serviceWorker.getRegistrations();
          for (let registration of registrations) {
            const success = await registration.unregister();
            if (success) {
              log(`Service Workerè§£é™¤: ${registration.scope}`, 'info');
            }
          }
        }

        if ('caches' in window) {
          const cacheNames = await caches.keys();
          for (let cacheName of cacheNames) {
            await caches.delete(cacheName);
            log(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤: ${cacheName}`, 'info');
          }
        }

        log('å®Œäº†ã€‚3ç§’å¾Œã«ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™...', 'info');
        setTimeout(() => {
          location.reload(true);
        }, 3000);
      } catch(e) {
        log(`SWè§£é™¤ï¼‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
      }
    }

    // C) ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç³»ã®çŠ¶æ…‹è¡¨ç¤º
    async function updateStorageStatus() {
      try {
        // localStorageä½¿ç”¨é‡ï¼ˆæ¦‚ç®—ï¼‰
        let totalSize = 0;
        const keys = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          const value = localStorage.getItem(key);
          keys.push(key);
          totalSize += (key ? key.length : 0) + (value ? value.length : 0);
        }
        document.getElementById('localstorage-size').textContent = `${keys.length}ã‚­ãƒ¼ / ç´„${(totalSize / 1024).toFixed(2)}KB`;
        document.getElementById('localstorage-keys').textContent = keys.length > 0 ? keys.join(', ') : 'ãªã—';

        // IndexedDBä¸€è¦§
        if ('indexedDB' in window && 'databases' in indexedDB) {
          try {
            const databases = await indexedDB.databases();
            const dbNames = databases.map(db => db.name).join(', ');
            document.getElementById('indexeddb-list').textContent = databases.length > 0 ? `${databases.length}ä»¶: ${dbNames}` : 'ãªã—';
          } catch(e) {
            document.getElementById('indexeddb-list').textContent = `ç¢ºèªã‚¨ãƒ©ãƒ¼: ${e.message}`;
          }
        } else {
          document.getElementById('indexeddb-list').textContent = 'databases()æœªå¯¾å¿œï¼ˆæ‰‹å‹•ç¢ºèªãŒå¿…è¦ï¼‰';
        }

        log('ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'info');
      } catch(e) {
        log(`ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸çŠ¶æ…‹æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
      }
    }

    function clearAllStorage() {
      if (!confirm('âš ï¸ è­¦å‘Š: ã“ã®ã‚µã‚¤ãƒˆã®ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆlocalStorageã€IndexedDBï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚è³¼å…¥å±¥æ­´ãªã©ã‚‚æ¶ˆãˆã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
        return;
      }

      try {
        log('ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å‰Šé™¤ã‚’é–‹å§‹...', 'warn');
        
        // localStorageå‰Šé™¤
        localStorage.clear();
        log('localStorageã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'info');
        
        // IndexedDBå‰Šé™¤
        if ('indexedDB' in window && 'databases' in indexedDB) {
          indexedDB.databases().then(databases => {
            databases.forEach(db => {
              indexedDB.deleteDatabase(db.name);
              log(`IndexedDBå‰Šé™¤: ${db.name}`, 'info');
            });
          });
        }

        log('å®Œäº†ã€‚3ç§’å¾Œã«ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™...', 'info');
        setTimeout(() => {
          location.reload(true);
        }, 3000);
      } catch(e) {
        log(`ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
      }
    }

    // D) ã‚«ãƒ¡ãƒ©èµ·å‹•ã®åˆ‡ã‚Šåˆ†ã‘
    async function updateCameraPermission() {
      try {
        if ('permissions' in navigator) {
          try {
            const permission = await navigator.permissions.query({ name: 'camera' });
            const status = permission.state;
            document.getElementById('camera-permission').textContent = status;
            log(`ã‚«ãƒ¡ãƒ©è¨±å¯çŠ¶æ³: ${status}`, 'info');
          } catch(e) {
            document.getElementById('camera-permission').textContent = `ç¢ºèªã‚¨ãƒ©ãƒ¼: ${e.message}`;
          }
        } else {
          document.getElementById('camera-permission').textContent = 'Permissions APIæœªå¯¾å¿œ';
        }
      } catch(e) {
        log(`ã‚«ãƒ¡ãƒ©è¨±å¯çŠ¶æ³ç¢ºèªã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
      }
    }

    async function testCamera() {
      const logArea = document.getElementById('camera-log');
      const video = document.getElementById('camera-preview');
      const statusEl = document.getElementById('camera-status');
      
      logArea.textContent = '';
      statusEl.textContent = 'èµ·å‹•ä¸­...';
      
      try {
        // æ—¢å­˜ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
        if (cameraStream) {
          cameraStream.getTracks().forEach(track => track.stop());
        }

        logArea.textContent += 'ã‚«ãƒ¡ãƒ©èµ·å‹•ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...\n';
        
        // æ®µéšçš„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        const configs = [
          { facingMode: { exact: "environment" } },
          { facingMode: { ideal: "environment" } },
          { facingMode: "environment" },
          true
        ];

        let success = false;
        for (let i = 0; i < configs.length; i++) {
          try {
            logArea.textContent += `è©¦è¡Œ${i + 1}: ${JSON.stringify(configs[i])}\n`;
            const stream = await navigator.mediaDevices.getUserMedia({ video: configs[i] });
            
            cameraStream = stream;
            video.srcObject = stream;
            statusEl.textContent = 'âœ… æˆåŠŸ';
            statusEl.className = 'status-ok';
            logArea.textContent += `âœ… æˆåŠŸ: è©¦è¡Œ${i + 1}\n`;
            log(`ã‚«ãƒ¡ãƒ©èµ·å‹•æˆåŠŸ: è©¦è¡Œ${i + 1}`, 'info');
            success = true;
            break;
          } catch(err) {
            logArea.textContent += `âŒ å¤±æ•—: ${err.name}: ${err.message}\n`;
            log(`ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—(è©¦è¡Œ${i + 1}): ${err.name}: ${err.message}`, 'error');
          }
        }

        if (!success) {
          statusEl.textContent = 'âŒ å¤±æ•—';
          statusEl.className = 'status-error';
          logArea.textContent += '\nâŒ ã™ã¹ã¦ã®è©¦è¡ŒãŒå¤±æ•—ã—ã¾ã—ãŸ\n';
        }
      } catch(e) {
        statusEl.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`;
        statusEl.className = 'status-error';
        logArea.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${e.name}: ${e.message}\n`;
        log(`ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
      }
    }

    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
        document.getElementById('camera-preview').srcObject = null;
        document.getElementById('camera-status').textContent = 'åœæ­¢';
        document.getElementById('camera-status').className = '';
        log('ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢ã—ã¾ã—ãŸ', 'info');
      }
    }

    // E) ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼é…ä¿¡ã®åˆ‡ã‚Šåˆ†ã‘
    async function testNetworkFetch() {
      const logArea = document.getElementById('network-log');
      logArea.textContent = '';

      try {
        const devIndexUrl = './index.html';
        
        // cache: no-store ã§å–å¾—
        logArea.textContent += 'ã€ãƒ†ã‚¹ãƒˆ1ã€‘cache: no-store ã§å–å¾—...\n';
        const start1 = Date.now();
        try {
          const res1 = await fetch(devIndexUrl, { cache: 'no-store' });
          const elapsed1 = Date.now() - start1;
          const text1 = await res1.text();
          
          const versionMatch1 = text1.match(/FULL_VERSION:\s*(v[\d.]+)/) || text1.match(/const\s+FULL_VERSION\s*=\s*["'](v[\d.]+)["']/);
          const buildIdMatch1 = text1.match(/BUILD_ID:\s*([^\n]+)/) || text1.match(/const\s+BUILD_ID\s*=\s*["']([^"']+)["']/);
          
          const version1 = versionMatch1 ? versionMatch1[1] : 'æŠ½å‡ºå¤±æ•—';
          const buildId1 = buildIdMatch1 ? buildIdMatch1[1].trim() : 'æŠ½å‡ºå¤±æ•—';
          
          document.getElementById('fetch-no-store').textContent = `âœ… ${res1.status} (${elapsed1}ms) / VERSION: ${version1}`;
          document.getElementById('fetched-version').textContent = version1;
          document.getElementById('fetched-build-id').textContent = buildId1;
          
          logArea.textContent += `âœ… HTTP ${res1.status} (${elapsed1}ms)\n`;
          logArea.textContent += `  FULL_VERSION: ${version1}\n`;
          logArea.textContent += `  BUILD_ID: ${buildId1}\n`;
        } catch(e) {
          document.getElementById('fetch-no-store').textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`;
          logArea.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}\n`;
        }

        // reload ã§å–å¾—
        logArea.textContent += '\nã€ãƒ†ã‚¹ãƒˆ2ã€‘reload ã§å–å¾—...\n';
        const start2 = Date.now();
        try {
          const res2 = await fetch(devIndexUrl, { cache: 'reload' });
          const elapsed2 = Date.now() - start2;
          const text2 = await res2.text();
          
          const versionMatch2 = text2.match(/FULL_VERSION:\s*(v[\d.]+)/) || text2.match(/const\s+FULL_VERSION\s*=\s*["'](v[\d.]+)["']/);
          const buildIdMatch2 = text2.match(/BUILD_ID:\s*([^\n]+)/) || text2.match(/const\s+BUILD_ID\s*=\s*["']([^"']+)["']/);
          
          const version2 = versionMatch2 ? versionMatch2[1] : 'æŠ½å‡ºå¤±æ•—';
          const buildId2 = buildIdMatch2 ? buildIdMatch2[1].trim() : 'æŠ½å‡ºå¤±æ•—';
          
          document.getElementById('fetch-reload').textContent = `âœ… ${res2.status} (${elapsed2}ms) / VERSION: ${version2}`;
          
          logArea.textContent += `âœ… HTTP ${res2.status} (${elapsed2}ms)\n`;
          logArea.textContent += `  FULL_VERSION: ${version2}\n`;
          logArea.textContent += `  BUILD_ID: ${buildId2}\n`;
          
          // æ¯”è¼ƒ
          if (version1 !== version2 || buildId1 !== buildId2) {
            logArea.textContent += `\nâš ï¸ è­¦å‘Š: å–å¾—æ–¹æ³•ã«ã‚ˆã£ã¦VERSION/BUILD_IDãŒç•°ãªã‚Šã¾ã™\n`;
          }
        } catch(e) {
          document.getElementById('fetch-reload').textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`;
          logArea.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}\n`;
        }

        log('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å–å¾—ãƒ†ã‚¹ãƒˆå®Œäº†', 'info');
      } catch(e) {
        log(`ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å–å¾—ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
      }
    }

    // âœ… P0ä¿®æ­£: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function updateErrorLog() {
      try {
        const errorLogsJson = localStorage.getItem('smartPrice_errorLogs');
        const errorLogs = errorLogsJson ? JSON.parse(errorLogsJson) : [];
        const errorLogArea = document.getElementById('error-log');
        const errorCountEl = document.getElementById('error-count');
        
        errorCountEl.textContent = `${errorLogs.length}ä»¶`;
        
        if (errorLogs.length === 0) {
          errorLogArea.textContent = 'ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“';
          return;
        }
        
        // æœ€æ–°ã®ã‚¨ãƒ©ãƒ¼ã‹ã‚‰è¡¨ç¤ºï¼ˆé€†é †ï¼‰
        const reversedLogs = [...errorLogs].reverse();
        let logText = '';
        
        reversedLogs.forEach((log, index) => {
          const timestamp = log.timestamp ? new Date(log.timestamp).toLocaleString('ja-JP') : 'æ™‚åˆ»ä¸æ˜';
          logText += `\nã€${index + 1}ã€‘${timestamp}\n`;
          logText += `ã‚¿ã‚¤ãƒ—: ${log.type || 'ä¸æ˜'}\n`;
          
          if (log.message) {
            logText += `ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${log.message}\n`;
          }
          if (log.detail) {
            logText += `è©³ç´°: ${log.detail}\n`;
          }
          if (log.rawError) {
            logText += `ç”Ÿã®ä¾‹å¤–: ${log.rawError}\n`;
          }
          if (log.stack) {
            logText += `ã‚¹ã‚¿ãƒƒã‚¯:\n${log.stack}\n`;
          }
          if (log.filename) {
            logText += `ãƒ•ã‚¡ã‚¤ãƒ«: ${log.filename} (è¡Œ: ${log.lineno}, åˆ—: ${log.colno})\n`;
          }
          
          logText += 'â”€'.repeat(50) + '\n';
        });
        
        errorLogArea.textContent = logText.trim();
      } catch(e) {
        log(`ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
      }
    }
    
    // âœ… P0ä¿®æ­£: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹é–¢æ•°
    function copyErrorLog() {
      try {
        const errorLogArea = document.getElementById('error-log');
        const text = errorLogArea.textContent;
        
        if (!text || text === 'ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“') {
          alert('ã‚³ãƒ”ãƒ¼ã™ã‚‹ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“');
          return;
        }
        
        navigator.clipboard.writeText(text).then(() => {
          alert('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
          log('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'info');
        }).catch(e => {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ä½¿ç”¨
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          try {
            document.execCommand('copy');
            alert('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            log('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰', 'info');
          } catch(e2) {
            alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e2.message);
            log(`ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼: ${e2.message}`, 'error');
          }
          document.body.removeChild(textarea);
        });
      } catch(e) {
        log(`ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
      }
    }
    
    // âœ… P0ä¿®æ­£: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°
    function clearErrorLog() {
      if (!confirm('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }
      try {
        localStorage.removeItem('smartPrice_errorLogs');
        updateErrorLog();
        log('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
      } catch(e) {
        log(`ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
      }
    }
    
    // åˆæœŸåŒ–
    window.addEventListener('load', async () => {
      log('è¨ºæ–­ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¾ã—ãŸ', 'info');
      updatePageInfo();
      await updateServiceWorkerStatus();
      await updateStorageStatus();
      await updateCameraPermission();
      updateErrorLog(); // âœ… P0ä¿®æ­£: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’è¡¨ç¤º
      
      // debug=1 ã®å ´åˆã¯è‡ªå‹•ã§SWè§£é™¤ï¼‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ï¼‹ãƒªãƒ­ãƒ¼ãƒ‰
      const urlParams = new URLSearchParams(location.search);
      if (urlParams.get('debug') === '1') {
        log('debug=1ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚SWè§£é™¤ï¼‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ã‚’å®Ÿè¡Œã—ã¾ã™...', 'warn');
        setTimeout(() => {
          clearServiceWorkerAndCache();
        }, 2000);
      }
    });
  </script>
</body>
</html>
