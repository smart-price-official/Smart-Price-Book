# Smart Price 修正報告書

**TO:** ユイ（監督）  
**FROM:** Rex  
**DATE:** 2026-01-15 00:45 JST  
**VERSION:** v19.9c-hf18-stores1  
**BUILD_ID:** 2026-01-15_0045_stores1

---

## 📋 修正概要

**TITLE:** 近隣店舗自動取得機能追加（GPS/生活圏→YahooProxy経由でOSM検索）

**目的:**
Smart Price（アプリ側）から、YahooProxy（GAS）へ Stores取得 を投げるときに、area をURLクエリに入れて呼べるようにする（UIを増やさず、内部実装だけ）。

---

## 🔧 実装内容

### 1. **fetchNearbyStores() 関数追加**
**場所:** Smart-Price-Book/index.html (2425-2490行目)

**機能:**
- YahooProxy の `action=stores` API を呼び出し
- GPS優先（lat,lng / 5km）→ 生活圏フォールバック（area / 15km）
- エラー時は空配列を返す（既存の店舗リストに影響しない）

**実装方針:**
```javascript
// 優先1：GPSが取れるなら lat,lng（成功率が高い）
if (isGpsOn && curPos) {
  // ?action=stores&lat=...&lng=...&radius_km=5&limit=40
}

// 優先2：GPSが無い/拒否なら area
if (area) {
  // ?action=stores&area=土浦市&radius_km=15&limit=40
}
```

### 2. **renderStoreList() 強化**
**場所:** Smart-Price-Book/index.html (1602-1658行目)

**変更内容:**
- `window.nearbyStoreNames` を既存の店舗リストに統合
- 優先順位: 手動 > カスタム > 近隣 > プリセット > 履歴頻度順

**修正前:**
```javascript
const finalSet = ["未設定", ...new Set([...manualPriority, ...customStores, ...cityStores, ...sortedFreq])];
```

**修正後:**
```javascript
const nearbyStores = (Array.isArray(window.nearbyStoreNames) && window.nearbyStoreNames.length > 0) ? window.nearbyStoreNames : [];
const finalSet = ["未設定", ...new Set([...manualPriority, ...customStores, ...nearbyStores, ...cityStores, ...sortedFreq])];
```

### 3. **GPS連携強化**
**場所:** Smart-Price-Book/index.html (2360-2383行目)

**変更内容:**
- GPS取得成功時に自動で近隣店舗を取得
- GPS OFF時は近隣店舗候補もクリア

**実装:**
```javascript
// GPS ON 成功時
const nearbyStores = await fetchNearbyStores();
if (nearbyStores && nearbyStores.length > 0) {
  window.nearbyStoreNames = nearbyStores;
}

// GPS OFF 時
window.nearbyStoreNames = []; // クリア
```

### 4. **起動時自動取得**
**場所:** Smart-Price-Book/index.html (923-935行目)

**変更内容:**
- アプリ起動時（`window.onload`）に近隣店舗を自動取得
- GPS OFF でも生活圏が設定されていれば取得可能

**実装:**
```javascript
// 起動時に近隣店舗を取得（GPS OFF でも生活圏があれば取得）
try {
  const nearbyStores = await fetchNearbyStores();
  if (nearbyStores && nearbyStores.length > 0) {
    window.nearbyStoreNames = nearbyStores;
    renderStoreList(); // 近隣店舗を反映して再描画
  }
} catch(e) {
  if (isDebug()) console.warn('[onload] fetchNearbyStores failed:', e);
}
```

---

## 📦 修正ファイル

### ✅ 修正対象
- **Smart-Price-Book/index.html** （全体修正）

### ❌ 修正対象外
- **YahooProxy（GAS）の Code.gs** （すでにユーザー検証済み）

---

## 🌐 配布URL（キャッシュ回避版）

### 通常版
```
https://smart-price-official.github.io/Smart-Price-Book/?b=2026-01-15_0045_stores1
```

### デバッグ版（ログ確認用）
```
https://smart-price-official.github.io/Smart-Price-Book/?b=2026-01-15_0045_stores1&debug=1
```

---

## 🧪 テスト手順（なべちょうさん向け）

### A) 単体（プロキシ直叩き）
GAS WebアプリURL に以下のクエリを付けてブラウザで開く：

**GPS座標版:**
```
.../exec?action=stores&lat=36.08&lng=140.20&radius_km=5&limit=40
```

**生活圏版:**
```
.../exec?action=stores&area=土浦市&radius_km=15&limit=40
```

**期待される結果:**
```json
{
  "ok": true,
  "stores": [
    {"name": "カスミ土浦駅前店", "brand": "カスミ", "kind": "supermarket", "lat": 36.08, "lng": 140.20, "dist_km": 0.5},
    ...
  ]
}
```

### C) アプリ結合（Smart Price 画面から）

#### パターン1: GPS ON
1. Smart Price を開く（デバッグ版推奨）
2. 上部の「GPS」ボタンをタップ
3. 位置情報を許可
4. → 近隣店舗が自動で店名チップに表示される

#### パターン2: GPS OFF + 生活圏設定
1. Smart Price を開く
2. 設定画面で「生活圏（市）」に「土浦市」を入力
3. 「設定保存と同期」をタップ
4. → 起動時に自動で近隣店舗が表示される

### B) 回帰（壊してないか）
- ✅ JAN検索（?jan=...）が以前どおり動く
- ✅ 既存の購入履歴/同期/画像まわりに副作用が無い
- ✅ GPS OFF でも従来通り動作する

---

## ⚠️ 注意事項

### UI変更
- **なし**（内部実装のみ）
- ユーザーは従来通り操作可能

### エラー耐性
- 近隣店舗取得失敗でもアプリは動作
- エラー時は既存の店舗リスト（プリセット・履歴頻度順）で動作

### プライバシー
- GPS座標はYahooProxyへのリクエスト時のみ送信
- GAS側でもログには残るが、永続保存はされない

### キャッシュ
- YahooProxy側で6時間キャッシュ（GAS CacheService）
- 同じ条件での再検索は高速化される

---

## 🔍 デバッグログ（debug=1 時のみ）

### コンソールログ
```
[FetchStores] GPS mode: .../exec?action=stores&lat=36.08&lng=140.20&radius_km=5&limit=40
[FetchStores] GPS result: 15 stores
[GPS] Nearby stores loaded: 15
[onload] Nearby stores loaded: 15
```

### トースト表示
- 「GPS取得中…」
- 「GPS取得成功」
- （デバッグモード）「GPS取得成功（36.0800, 140.2000）」

---

## 📊 技術仕様

### API仕様
**Endpoint:** YahooProxy（GAS WebアプリURL）

**リクエスト例（GPS）:**
```
GET .../exec?action=stores&lat=36.08&lng=140.20&radius_km=5&limit=40
```

**リクエスト例（生活圏）:**
```
GET .../exec?action=stores&area=土浦市&radius_km=15&limit=40
```

**レスポンス:**
```json
{
  "ok": true,
  "ts": "2026-01-15T00:45:00.000Z",
  "area": "土浦市",
  "center": {"lat": 36.08, "lng": 140.20, "src": "geocode"},
  "radius_km": 15,
  "limit": 40,
  "stores": [
    {
      "name": "カスミ土浦駅前店",
      "brand": "カスミ",
      "kind": "supermarket",
      "lat": 36.0750,
      "lng": 140.2050,
      "dist_km": 0.5
    }
  ]
}
```

### データフロー
```
Smart Price (Browser)
  ↓ GPS取得 or 生活圏設定
  ↓ fetchNearbyStores() 呼び出し
  ↓ fetch(.../exec?action=stores&...)
  ↓
YahooProxy (GAS)
  ↓ Nominatim（生活圏→座標変換）
  ↓ Overpass API（OSM検索）
  ↓ 店舗候補を返す
  ↓
Smart Price (Browser)
  ↓ window.nearbyStoreNames に保存
  ↓ renderStoreList() で既存リストに統合
  ↓ 画面に表示
```

---

## ✅ 完了条件

- [x] fetchNearbyStores() 関数を実装
- [x] renderStoreList() を強化
- [x] GPS連携を強化
- [x] 起動時自動取得を実装
- [x] UI変更なし（内部実装のみ）
- [x] エラー時の安全性を確保
- [x] デバッグログを追加（debug=1時のみ）

---

## 📝 次のステップ（今後の課題）

### フェーズ2（必要に応じて）
- 店舗の営業時間・定休日を表示
- ユーザーが店舗を選択した履歴を保存
- 近隣店舗の距離を表示（「500m」など）

### フェーズ3（将来）
- 店舗の価格比較機能
- ルート案内機能（Google Maps連携）

---

**作成者:** Rex  
**作成日時:** 2026-01-15 00:45 JST  
**バージョン:** v19.9c-hf18-stores1
