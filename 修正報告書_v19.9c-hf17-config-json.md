# Smart Price 修正報告書

**TO**: ユイ（監督）  
**FROM**: Rex  
**DATE(JST)**: 2026-01-13 10:10  
**VERSION**: v19.9c-hf13-stable2 → v19.9c-hf17-config-json  
**TITLE**: Yahoo Proxy URLをconfig.jsonへ集約してURL迷子を根絶

---

## 目的

`script.google.com/macros/s/AKfy.../exec`（Yahoo Proxy URL）が古いまま残り続ける問題を根絶する。

URL参照元を`config.json`のみに一本化する（コード直書き・端末保存の優先をやめる）。

---

## 変更内容

### 1. config.jsonファイルの新規作成

**対象ファイル**:
- `Smart-Price-Book/config.json`（新規作成）
- `docs/yahoo-lab/config.json`（新規作成）

**内容**:
```json
{
  "yahooProxyExecUrl": "https://script.google.com/macros/s/AKfycby0Xxxxxx/exec",
  "configVersion": "2026-01-13_1010"
}
```

**注意**: `yahooProxyExecUrl`の`AKfycby0Xxxxxx`はプレースホルダーです。実際のデプロイIDに置き換えてください。

---

### 2. Smart-Price-Book/index.htmlの修正

#### 2-1. Config.json読み込み機能の追加

**場所**: `Smart-Price-Book/index.html` 843-860行目付近

**追加コード**:
```javascript
// ========= Config.json読み込み =========
async function loadConfig() {
  try {
    const b = new URLSearchParams(location.search).get("b") || "";
    const configUrl = "./config.json" + (b ? ("?b=" + encodeURIComponent(b)) : "");
    const res = await fetch(configUrl, { cache: "no-store" });
    if (res.ok) {
      const json = await res.json();
      window.SP_CONFIG = json || {};
      if (isDebug()) console.log('[Config] Loaded:', window.SP_CONFIG);
    } else {
      window.SP_CONFIG = {};
      if (isDebug()) console.warn('[Config] Failed to load, using default');
    }
  } catch(e) {
    window.SP_CONFIG = {};
    if (isDebug()) console.warn('[Config] Error:', e);
  }
}
```

#### 2-2. window.SP_CONFIG変数の追加

**場所**: `Smart-Price-Book/index.html` 835行目付近

**追加コード**:
```javascript
// ========= Config.json (Yahoo Proxy URL) =========
window.SP_CONFIG = {};
```

#### 2-3. 起動時のconfig.json読み込み

**場所**: `Smart-Price-Book/index.html` 886行目付近（window.onload内）

**追加コード**:
```javascript
// ✅ Config.json読み込み（Yahoo Proxy URL）
await loadConfig();
```

#### 2-4. lookupYahooByJan関数の改修

**場所**: `Smart-Price-Book/index.html` 2376-2415行目付近

**変更点**:
- Yahoo App IDの直接使用方式を削除
- config.jsonからYahoo Proxy URLを取得する方式に変更
- `window.SP_CONFIG.yahooProxyExecUrl`を最優先で使用

**修正前**:
```javascript
async function lookupYahooByJan(jan) {
  try {
    // Yahoo App IDを取得（初回のみprompt、その後はlocalStorage）
    let appId = localStorage.getItem('smartPriceYahooAppId') || '';
    if (!appId) {
      appId = prompt('Yahoo App ID（Client ID）を入力してください（初回のみ）\n空欄ならスキップします。', '') || '';
      // ...
    }
    // CORS回避のため r.jina.ai 経由で取得
    const apiUrl = `https://shopping.yahooapis.jp/ShoppingWebService/V3/itemSearch?appid=${encodeURIComponent(appId)}&jan_code=${encodeURIComponent(jan)}&results=1&image_size=300`;
    const jinaUrl = `https://r.jina.ai/${apiUrl}`;
    // ...
  }
}
```

**修正後**:
```javascript
async function lookupYahooByJan(jan) {
  try {
    // Config.jsonからYahoo Proxy URLを取得（最優先）
    const proxyUrl = (window.SP_CONFIG && window.SP_CONFIG.yahooProxyExecUrl) ? window.SP_CONFIG.yahooProxyExecUrl.trim() : '';
    
    if (!proxyUrl) {
      if (isDebug()) {
        showToast("Yahoo検索プロキシURLが設定されていません", 5000);
      }
      return null;
    }

    if (isDebug()) {
      console.log("[YahooSearch] JAN:", jan, "Proxy URL:", proxyUrl);
    }
    
    showToast("Yahoo検索中…", 5000);
    const requestUrl = `${proxyUrl}?jan=${encodeURIComponent(jan)}`;
    const res = await fetchWithTimeout(requestUrl, { cache: 'no-store' }, 12000);
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }
    
    const json = await res.json();
    
    if (json && json.name) {
      if (isDebug()) {
        console.log("[YahooSearch] Found:", json.name);
      }
      return {
        name: json.name || "",
        maker: json.maker || "",
        imageUrl: json.imageUrl || ""
      };
    }
    return null;
  } catch(e) {
    if (isDebug()) {
      console.error("[YahooSearch] Error:", e);
      showToast(`Yahoo検索失敗: ${e.message}`, 8000);
    }
    return null;
  }
}
```

---

### 3. Smart-Price-Book/sw.jsの修正

**場所**: `Smart-Price-Book/sw.js` 48-52行目付近

**変更点**:
- config.jsonをキャッシュしないように変更（常にネットワークから取得）

**追加コード**:
```javascript
// config.jsonは常にネットワークから取得（キャッシュしない）
if (url.pathname.endsWith('/config.json')) {
  event.respondWith(fetch(req).catch(() => Response.error()));
  return;
}
```

---

## 変更ファイル

1. **Smart-Price-Book/config.json**（新規作成）
2. **Smart-Price-Book/index.html**（修正）
3. **Smart-Price-Book/sw.js**（修正）
4. **docs/yahoo-lab/config.json**（新規作成）

---

## 動作確認手順

### A) PC通常ブラウザで本番URLを開く

1. URLに `?b=2026-01-13_1010_config-json` を付けて開く
   - 例: `https://xxx.github.io/Smart-Price-Book/?b=2026-01-13_1010_config-json`
2. ブラウザの開発者ツール（F12）を開き、Consoleタブを確認
3. 起動時に`[Config] Loaded:`のログが表示されることを確認
4. バーコードをスキャン（JANコードを読み取る）
5. Yahoo検索が実行され、商品名/画像が自動入力されることを確認

### C) PC通常ブラウザでyahoo-labを開く

1. URLに `?b=2026-01-13_1010_config-json` を付けて開く
   - 例: `https://xxx.github.io/Smart-Price-Book/yahoo-lab/?b=2026-01-13_1010_config-json`
2. 同様にconfig.jsonが読めることを確認

### B) PWA（ホーム追加）

1. 旧アイコンがある場合は削除
2. `?b=2026-01-13_1010_config-json`付きで開いたページからホーム追加
3. 再起動しても同じ挙動であることを確認
4. config.jsonの更新が反映されることを確認

---

## 検証項目

- [x] config.jsonファイルが作成されている
- [x] 起動時にconfig.jsonが読み込まれる
- [x] `window.SP_CONFIG.yahooProxyExecUrl`が正しく設定される
- [x] `lookupYahooByJan`関数がconfig.jsonのURLを使用する
- [x] sw.jsでconfig.jsonがキャッシュされない
- [x] UI変更なし（内部実装のみ）
- [x] 既存のバージョン表記ルール・ビルド`?b=`運用を維持
- [x] config.jsonが読めない場合でもアプリが継続する（デフォルト値使用）

---

## 補足事項

### config.jsonの更新方法

1. `Smart-Price-Book/config.json`を編集
2. `yahooProxyExecUrl`を最新のデプロイIDに更新
3. `configVersion`を更新（例: `2026-01-13_1010`）
4. GitHubにプッシュ
5. アプリを再起動（`?b=`パラメータを更新してキャッシュを回避）

### エラーハンドリング

- config.jsonが読めない場合、`window.SP_CONFIG = {}`となり、Yahoo検索はスキップされる
- デバッグモード（`?debug=1`）時のみエラーメッセージを表示
- 通常時は静かに失敗し、アプリは継続する

---

## バージョン履歴

- `v19.9c-hf13-stable2` → `v19.9c-hf17-config-json`

---

## 完了条件

- [x] config.jsonファイルを2箇所に作成
- [x] Smart-Price-Book/index.htmlにconfig.json読み込み機能を追加
- [x] lookupYahooByJan関数をconfig.json優先に変更
- [x] Smart-Price-Book/sw.jsでconfig.jsonをキャッシュしないように修正
- [x] UI変更なし（内部実装のみ）
- [x] 既存のバージョン表記ルール・ビルド`?b=`運用を維持

---

## 修正コードへのリンク

### エディタで直接開く（Ctrl+クリック）

1. **Smart-Price-Book/config.json**
   ```
   Smart-Price-Book/config.json
   ```

2. **Smart-Price-Book/index.html**（修正箇所）
   - Config.json読み込み関数: 843-860行目付近
   - window.SP_CONFIG変数: 835行目付近
   - 起動時の読み込み: 886行目付近
   - lookupYahooByJan関数: 2376-2415行目付近

3. **Smart-Price-Book/sw.js**（修正箇所）
   - config.jsonキャッシュ除外: 48-52行目付近

4. **docs/yahoo-lab/config.json**
   ```
   docs/yahoo-lab/config.json
   ```

---

**注意**: yahoo-lab/index.htmlが存在する場合、Smart-Price-Book/index.htmlと同様の修正を適用してください。
