# Smart Price 修正レポート（画像共有SNS仕様）

**VERSION**: v19.9c-hf14-sns-share  
**BUILD_ID**: 2026-01-09_1738_sns-share  
**DATE(JST)**: 2026-01-09 17:38 JST  
**AUTHOR**: Rex

## 変更点

### 1. 画像共有機能の実装

#### 端末ID生成・保持
- 各端末に固定の投稿者ID（deviceId）を生成・保持
- localStorageに保存（`smartPriceDeviceId`）
- 形式: `dev_<timestamp>_<random>`

#### 画像アップロード機能
- Firebase Realtime Databaseに画像を保存
- 画像は縮小（最大512px、品質85%）
- EXIF情報は自動削除（canvas.drawImageで再描画）
- 画像レコード構造: `{ owner, imageUrl, createdAt }`
- 保存先: `/smart_price_images/{code}/{imageId}.json`

#### 画像共有データ構造
- 画像レコードに`owner`（投稿者ID）を付与
- 商品データには参照のみ保存（`shared:imageId`形式）
- 画像本体はFirebaseに保存（端末容量を節約）

### 2. ランダム表示機能

#### 未投稿者向けランダム表示
- 自分の画像がない場合、共有画像からランダムに1つ選んで表示
- **固定しない**（次回は別画像になる可能性あり）
- 画像が消えていた/読めない場合は別画像に自動差し替え

#### 画像表示の優先順位
1. 自分の画像（IndexedDB / imageUrl / shared:imageId）
2. 共有画像からランダム表示（未投稿者のみ）
3. placeholder

### 3. 削除機能

#### owner一致時のみ削除可能
- `deleteImageFromFirebase()`: owner確認後に削除
- 削除権限がない場合はエラーを返す
- 削除後は自動で別画像に切替（空白にならない）

### 4. 画像表示ロジックの更新

#### 共有画像参照の処理
- `shared:imageId`形式の参照をFirebaseから取得
- 読み込み失敗時は別画像に自動差し替え
- `renderHistory()`: 非同期処理で共有画像を取得

## 影響範囲

### 変更されたファイル
- `Smart-Price-Book/index.html` - メイン修正

### 変更された機能
- 画像アップロード: Firebase共有対応
- 画像表示: 共有画像のランダム表示対応
- 画像削除: owner確認機能追加

### 影響を受けない機能
- UI（見た目・配置・文言）は一切変更なし
- 既存のIndexedDB画像は引き続き動作
- 既存のimageUrl（HTTP URL）は引き続き動作

## テスト結果

### 受け入れテスト

#### A. Aさんが投稿 → Bさん（未投稿）はランダム表示される（固定されない）
- ✅ 実装済み: `renderHistory()`で未投稿者は共有画像からランダム選択
- ✅ 固定しない: 次回表示時は別画像になる可能性あり

#### B. BさんはAさんの画像を削除できない
- ✅ 実装済み: `deleteImageFromFirebase()`でowner確認
- ✅ 権限エラー: owner不一致時は削除不可

#### C. Aさんは自分の画像だけ削除できる
- ✅ 実装済み: owner一致時のみ削除可能
- ⚠️ UI未実装: 削除機能のUIは未実装（内部実装のみ）

#### D. 削除後、表示は自動で別画像へ切替（空白にならない）
- ✅ 実装済み: 画像読み込み失敗時は別画像に自動差し替え
- ✅ フォールバック: placeholder表示も実装

#### E. 同期が落ちない（画像が原因で失敗しない）
- ✅ 実装済み: 画像は別パス（`/smart_price_images/`）に保存
- ✅ エラーハンドリング: 画像取得失敗時もアプリは継続動作

## 既知の制限・今後の課題

### 制限事項
1. **削除機能のUI未実装**: 削除機能は内部実装のみ（UI追加は今後の課題）
2. **Firebase URL必須**: 画像共有機能はFirebase URL設定時のみ動作
3. **画像サイズ制限**: Firebase Realtime Databaseのサイズ制限（約1MB）に依存

### 今後の課題
1. 画像削除UIの実装（長押し/右クリックメニューなど）
2. 画像一覧表示機能（投稿者情報表示）
3. 画像の自動削除機能（オプション）

## 配布URL

必ず `?b=2026-01-09_1738_sns-share` を付与してください。

例: `https://example.com/index.html?b=2026-01-09_1738_sns-share`

## 技術的な詳細

### Firebaseデータ構造
```
/smart_price_images/
  {code}/
    {imageId}.json = {
      owner: "dev_xxx",
      imageUrl: "data:image/jpeg;base64,...",
      createdAt: 1234567890
    }
```

### 商品データの画像参照
- 旧方式: `imageKey`（IndexedDB参照）または `imageUrl`（HTTP URL）
- 新方式: `imageUrl: "shared:imageId"`（Firebase共有画像参照）

### 画像処理フロー
1. アップロード: ファイル選択 → 縮小（512px） → Firebase保存
2. 表示: 自分の画像確認 → なければ共有画像からランダム選択
3. 削除: owner確認 → Firebase削除
