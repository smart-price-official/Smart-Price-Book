# Smart Price 修正報告書

**TO:** ユイ（監督）  
**FROM:** Rex  
**SOURCE:** ChatGPT（ユイ）指示  
**DATE:** 2026-01-15 01:12 JST  
**VERSION:** v19.9c-hf18-stores1fix1  
**BUILD_ID:** 2026-01-15_0112_stores1fix1

---

## 📋 修正概要

**TITLE:** 近隣店舗機能の安全性強化（config.json エラー時の画面内ログ追加）

**目的:**
「近隣店舗（stores）」機能を安全に入れるため、ユイが指定した必須2点＋推奨1点を修正。

---

## ✅ 修正完了内容（3点）

### 【必須①】area のURLエンコード漏れをゼロにする

**結果:** ✅ **既に対応済み**

**確認箇所:**
- `Smart-Price-Book/index.html` 2490行目
- `const requestUrl = \`${proxyUrl}?action=stores&area=${encodeURIComponent(area)}&radius_km=${radiusKm}&limit=${limit}\`;`

**判定:** 日本語（例：土浦市）も確実にエンコードされている。修正不要。

---

### 【必須②】config.json が無い/読めない時に"静かに安全に"抜ける

**結果:** ✅ **修正完了**

**修正箇所:**
1. **loadConfig()** (Smart-Price-Book/index.html 849-868行目)
   - エラー時に `window.SP_CONFIG = {}` で初期化（例外を投げない）
   - `debug=1` の時のみ `showToast()` で画面内ログを表示
   - 修正行数：860-862行目、865-868行目

2. **fetchNearbyStores()** (Smart-Price-Book/index.html 2457-2510行目)
   - `yahooProxyExecUrl` が無い場合は即 `return []`（空配列）
   - `debug=1` の時のみ `showToast()` で画面内ログを表示
   - 修正行数：2461-2467行目、2501-2506行目

**画面内ログの内容（debug=1時のみ）:**
- `Config読み込み失敗（デフォルト使用）`
- `Config読み込みエラー: [エラー内容]`
- `Yahoo Proxy URLが設定されていません`
- `店舗検索失敗: [エラー内容]`

**安全性:**
- config.json が無くても既存機能（JAN検索、購入履歴、同期、画像）は正常動作
- 近隣店舗機能だけが静かに無効化される（空配列を返す）

---

### 【推奨③】manifestのコメントアウトは"storesパッチと分離"

**結果:** ✅ **既にコメントアウト済み**

**確認箇所:**
- `Smart-Price-Book/index.html` 26行目
- `<!-- <link rel="manifest" href="manifest.json"> -->`

**判定:** 既に前ビルドでコメントアウト済み。今回は触れていない（manifest変更は別パッチで対応）。

---

## 📂 修正ファイル

| ファイル | 修正内容 | 行数 |
|---------|---------|------|
| **Smart-Price-Book/index.html** | config.json エラー時の画面内ログ追加（debug=1時のみ） | 860-868, 2461-2467, 2501-2506 |
| **Smart-Price-Book/config.json** | 確認のみ（修正不要・既存のまま） | - |

---

## 🌐 配布URL（キャッシュ回避版）

### 通常版
```
https://smart-price-official.github.io/Smart-Price-Book/?b=2026-01-15_0112_stores1fix1
```

### デバッグ版（ログ確認用）
```
https://smart-price-official.github.io/Smart-Price-Book/?b=2026-01-15_0112_stores1fix1&debug=1
```

---

## 🧪 テスト手順（A→C→B順）

### A：PCブラウザ（Chrome / Edge）

#### テスト1：起動直後に落ちない
1. デバッグ版URLを開く（`&debug=1`）
2. コンソールを開く（F12）
3. エラーが無いことを確認

**期待結果:** 
- 起動成功
- （config.json が無い場合）画面下部に `Config読み込み失敗（デフォルト使用）` と表示される

#### テスト2：店名候補に近隣由来が混ざる
1. 設定画面（⚙️）を開く
2. 「生活圏（市）」に「土浦市」を入力
3. 「設定保存と同期」をタップ
4. ホーム画面に戻る
5. 上部の店名チップを確認

**期待結果:** 
- （Yahoo Proxy URLが正しく設定されている場合）近隣店舗が表示される
- （Yahoo Proxy URLが設定されていない場合）画面下部に `Yahoo Proxy URLが設定されていません` と表示される

#### テスト3：debug=1 で失敗理由が画面内ログに出る
1. config.json の `yahooProxyExecUrl` をダミー値に変更（例：`"https://example.com/"`）
2. デバッグ版URLを開く
3. 画面下部のトースト表示を確認

**期待結果:** 
- `Yahoo Proxy URLが設定されていません` または `店舗検索失敗: [エラー内容]` が表示される

---

### C：スマホブラウザ（PWAじゃない通常タブ）

#### テスト1：GPS OFFでも生活圏で候補が出る
1. 通常版URLをスマホブラウザで開く
2. GPS は OFF のまま
3. 設定画面で「生活圏（市）」に「土浦市」を入力
4. 「設定保存と同期」をタップ
5. ホーム画面で店名チップを確認

**期待結果:** 
- （Yahoo Proxy URLが正しく設定されている場合）近隣店舗が表示される
- 表示されなくても落ちない

#### テスト2：GPS ONで候補が増える
1. 上部の「GPS」ボタンをタップ
2. 位置情報を許可
3. 店名チップを確認

**期待結果:** 
- GPS座標に基づく近隣店舗が表示される（増える）
- 増えなくても落ちない

---

### B：回帰（最低限）

#### テスト1：JAN検索
1. ホーム画面の「スキャン」をタップ
2. バーコードを読み取る（または手入力）
3. 商品情報が表示されることを確認

**期待結果:** 
- stores修正で壊れていない

#### テスト2：購入履歴
1. ホーム画面で過去の購入履歴が表示されることを確認
2. カードをタップして詳細画面が開くことを確認

**期待結果:** 
- stores修正で壊れていない

#### テスト3：同期
1. 設定画面で「設定保存と同期」をタップ
2. 同期完了のトーストが表示されることを確認

**期待結果:** 
- stores修正で壊れていない

#### テスト4：画像
1. 商品詳細画面で画像が表示されることを確認
2. 画像を変更できることを確認

**期待結果:** 
- stores修正で壊れていない

---

## 📊 変更点（3行で）

1. **エンコード:** area は既に `encodeURIComponent(area)` 対応済み（修正不要）
2. **config安全化:** config.json が読めなくても例外を投げず、`debug=1` 時のみ画面内ログを表示
3. **manifest分離:** manifest.json は既にコメントアウト済み（今回は触れていない）

---

## ⚠️ 注意事項

### UI変更
- **なし**（UI_FREEZE厳守・内部修正のみ）
- ユーザーは従来通り操作可能

### config.json の設定
- **重要:** `config.json` の `yahooProxyExecUrl` に実際のGAS WebアプリURLを設定してください
- 現在はプレースホルダー（`AKfycby0Xxxxxx`）のため、近隣店舗機能は動作しません

### エラー耐性
- config.json が無い/読めない → 他機能は正常動作（近隣店舗のみ無効）
- Yahoo Proxy URLが無い → 近隣店舗のみ無効（他機能は正常動作）
- 店舗検索失敗 → 既存の店舗リスト（プリセット・履歴頻度順）で動作

---

## 🔍 デバッグログ（debug=1 時のみ）

### コンソールログ
```
[Config] Failed to load, using default
[FetchStores] Proxy URL not configured
```

### 画面内ログ（トースト表示）
```
Config読み込み失敗（デフォルト使用）
Yahoo Proxy URLが設定されていません
```

---

## 📝 次のステップ（今後の課題）

### 即座に対応が必要
- **config.json の yahooProxyExecUrl を実際のGAS WebアプリURLに差し替え**

### フェーズ2（必要に応じて）
- manifest.json の復活（PWA設定・別パッチで）
- Service Worker の有効化（オフライン対応・別パッチで）

---

## 📞 受け入れ条件（合格ライン）

- [x] 日本語の生活圏（例：土浦市）で近隣取得が失敗しない → **既に対応済み**
- [x] config.json が無い/読めない環境でも他機能が巻き込まれない → **修正完了**
- [x] manifest変更を混ぜない → **既にコメントアウト済み（今回は触れていない）**
- [x] UIは完全に据え置き → **UI_FREEZE厳守**

---

**作成者:** Rex  
**作成日時:** 2026-01-15 01:12 JST  
**バージョン:** v19.9c-hf18-stores1fix1  
**ビルドID:** 2026-01-15_0112_stores1fix1
