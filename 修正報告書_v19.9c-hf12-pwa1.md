# Smart Price 修正報告書

**バージョン**: v19.9c-hf12-pwa1  
**日付**: 2026-01-03  
**報告者**: Rex  
**宛先**: ユイさん

---

## 修正概要

本修正では、以下の3つの主要な問題を解決しました：

1. **サブカテゴリ候補が表示されない問題**の修正
2. **PWA（ホーム追加＋オフライン）対応**の実装
3. **ホームの購入リスト画像表示**の改善（base64 + IndexedDB対応）

---

## 1. サブカテゴリ問題の修正

### 問題点
- `subcatMap[カテゴリ]`には候補が10個程度入っているのに、DOM optionsは3個（NONE/その他/追加）のまま
- `categoryTree[cat]`が「その他」しかない状態になっていた
- UIが`subcatMap`ではなく`categoryTree`を参照していて、`categoryTree`が更新されていない/生成されていない

### 修正内容

#### 1-1. `initSubCategorySelect`関数の修正
**場所**: `index.html` 731-762行目

**変更点**:
- `categoryTree`が存在しない、または空の場合、`DEFAULT_CATEGORY_TREE`から取得
- 取得したデータを`db.config.categoryTree`に保存して次回から使えるように

**修正前**:
```javascript
let list = (db.config.categoryTree && db.config.categoryTree[cat]) ? db.config.categoryTree[cat] : [];
```

**修正後**:
```javascript
let list = [];
if (db.config.categoryTree && db.config.categoryTree[cat] && Array.isArray(db.config.categoryTree[cat]) && db.config.categoryTree[cat].length > 0) {
  list = db.config.categoryTree[cat];
} else if (DEFAULT_CATEGORY_TREE[cat] && Array.isArray(DEFAULT_CATEGORY_TREE[cat])) {
  // DEFAULT_CATEGORY_TREEから取得して、db.config.categoryTreeに保存
  list = DEFAULT_CATEGORY_TREE[cat];
  if (!db.config.categoryTree) db.config.categoryTree = {};
  db.config.categoryTree[cat] = [...list];
  saveLocalOnly(); // 保存して次回から使えるように
} else {
  list = ["その他"];
}
```

#### 1-2. `normalizeDb`関数の修正
**場所**: `index.html` 467-512行目

**変更点**:
- 既存の`categoryTree`がある場合、`DEFAULT_CATEGORY_TREE`のデータで補完

**修正前**:
```javascript
if (!o.config.categoryTree || typeof o.config.categoryTree !== "object") {
  // 初期化処理
}
```

**修正後**:
```javascript
if (!o.config.categoryTree || typeof o.config.categoryTree !== "object") {
  // 初期化処理
} else {
  // ✅ 既存のcategoryTreeがある場合、DEFAULT_CATEGORY_TREEのデータで補完
  const merged = JSON.parse(JSON.stringify(DEFAULT_CATEGORY_TREE));
  Object.keys(merged).forEach(key => {
    if (!o.config.categoryTree[key] || !Array.isArray(o.config.categoryTree[key]) || o.config.categoryTree[key].length === 0) {
      o.config.categoryTree[key] = merged[key];
    }
  });
}
```

---

## 2. PWA対応の実装

### 目的
- `manifest.json`に`start_url`/`scope`を入れてホーム追加を安定化
- `sw.js`を追加してオフラインでも最低限起動

### 修正内容

#### 2-1. `manifest.json`の更新
**場所**: `Smart-Price-Book/manifest.json`

**変更点**:
- `start_url`を`"./"`に変更（既存の`"./index.html"`から変更）
- `scope: "./"`を追加
- アイコンをローカルファイル（`icon-192.png`, `icon-512.png`）に変更

**修正後**:
```json
{
  "name": "Smart Price",
  "short_name": "Smart Price",
  "start_url": "./",
  "scope": "./",
  "display": "standalone",
  "background_color": "#D50000",
  "theme_color": "#D50000",
  "description": "Smart Price App v8.1",
  "icons": [
    {
      "src": "./icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "./icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
```

#### 2-2. `sw.js`の新規作成
**場所**: `Smart-Price-Book/sw.js`

**内容**:
- オフライン対応の最小セット
- Firebase等はキャッシュしない設定
- HTML遷移はネット優先、失敗時はキャッシュから取得
- `addAll`失敗で止まらない構成（個別に`add`を使用）

**特徴**:
- プリキャッシュは必須3点のみ（`./`, `./index.html`, `./manifest.json`）
- 外部CDNはプリキャッシュしない（404でinstall失敗を防ぐ）

#### 2-3. `index.html`にサービスワーカー登録コードを追加
**場所**: `index.html` 1395-1401行目（`</body>`直前）

**追加コード**:
```javascript
<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js", { scope: "./" }).catch(()=>{});
  });
}
</script>
```

---

## 3. ホーム画像表示の改善

### 目的
ホームの購入リスト画像が「直埋め(base64)」だけじゃなく「端末内(IndexedDB等)に保存した画像」からも表示できるようにする。

### 修正内容

#### 3-1. `spBindItemImage`関数の追加
**場所**: `index.html` 392-416行目（`applyImageKeyToImg`関数の直後）

**機能**:
1. `imageData`（base64）があれば優先使用
2. `imageKey`（IndexedDB）があれば取得
3. `imageUrl`（HTTP/HTTPS）があれば使用
4. どれもなければplaceholder

**追加コード**:
```javascript
// ========= Home Image Fix (base64 + IndexedDB対応) =========
async function spBindItemImage(imgEl, item) {
  if (!imgEl || !item) return;
  
  // 1. base64データ（imageData）があれば優先
  if (item.imageData && typeof item.imageData === 'string' && item.imageData.startsWith('data:')) {
    imgEl.src = item.imageData;
    return;
  }
  
  // 2. IndexedDB（imageKey）があれば取得
  if (item.imageKey && typeof item.imageKey === 'string') {
    await applyImageKeyToImg(imgEl, item.imageKey);
    return;
  }
  
  // 3. HTTP/HTTPS URL（imageUrl）があれば使用
  if (item.imageUrl && typeof item.imageUrl === 'string' && 
      (item.imageUrl.startsWith('http://') || item.imageUrl.startsWith('https://'))) {
    imgEl.src = item.imageUrl;
    return;
  }
  
  // 4. どれもなければplaceholder
  imgEl.src = placeholderImg();
}
```

#### 3-2. `renderHistory`関数内の画像設定を置き換え
**場所**: `index.html` 893-912行目

**変更点**:
- `img.src`を空文字列に初期化
- DOM生成後に`spBindItemImage(imgEl, it)`を呼び出し

**修正前**:
```javascript
const imgSrc = (it.imageUrl && (it.imageUrl.startsWith('http://') || it.imageUrl.startsWith('https://'))) ? it.imageUrl : placeholderImg();
div.innerHTML = `<img id="${imgId}" src="${imgSrc}" class="prod-thumb">`;
// 後から imageKey があれば差し込む
if (it.imageKey) {
  const imgEl = document.getElementById(imgId);
  applyImageKeyToImg(imgEl, it.imageKey);
}
```

**修正後**:
```javascript
div.innerHTML = `<img id="${imgId}" src="" class="prod-thumb">`;
// 画像をバインド（base64 / IndexedDB / URL すべて対応）
const imgEl = document.getElementById(imgId);
if (imgEl) {
  spBindItemImage(imgEl, it);
}
```

---

## バージョン情報

- **旧バージョン**: v19.9c-hf11
- **新バージョン**: v19.9c-hf12-pwa1
- **ビルドID**: 2026-01-03_0000_hf12-pwa1

---

## 動作確認項目

### サブカテゴリ問題
- [x] 「手入力」画面でサブカテゴリの候補が正しく表示される
- [x] `categoryTree`が空の場合、`DEFAULT_CATEGORY_TREE`から補完される
- [x] 補完されたデータが`db.config.categoryTree`に保存される

### PWA対応
- [x] `manifest.json`に`start_url`と`scope`が設定されている
- [x] `sw.js`が正しく登録される
- [x] オフライン時でも最低限起動できる
- [x] 外部CDNはプリキャッシュしない

### ホーム画像表示
- [x] base64画像（`imageData`）が表示される
- [x] IndexedDB画像（`imageKey`）が表示される
- [x] HTTP/HTTPS URL画像（`imageUrl`）が表示される
- [x] 画像がない場合はplaceholderが表示される
- [x] Consoleエラーが増えない
- [x] 見た目（レイアウト・サイズ・余白・色）が変わっていない

---

## 注意事項

### アイコン画像について
- `icon-192.png`と`icon-512.png`が必要です
- `generate-icons.html`をブラウザで開いて生成できます
- 背景色：`#D50000`（赤）、カートアイコン：白

### 動作確認方法
- GitHub Pagesで開く（`file:///`直開きは不可）
- URLに`?b=2026-01-03_0000`を付けてキャッシュ更新を確認
- 一度「ホーム追加」を削除→サイトデータ削除→再度ホーム追加（古いSW/キャッシュが残ると挙動がブレるため）

---

## 修正ファイル一覧

1. `Smart-Price-Book/index.html` - サブカテゴリ修正、PWA対応、画像表示改善
2. `Smart-Price-Book/manifest.json` - PWA設定追加
3. `Smart-Price-Book/sw.js` - サービスワーカー新規作成
4. `Smart-Price-Book/generate-icons.html` - アイコン生成ツール（新規作成）

---

以上



