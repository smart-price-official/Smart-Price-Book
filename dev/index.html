<!--
APP: Smart Price
FILE: Smart-Price-Book/index.html
  VERSION: v20.4.13B [VERLOCK SSOT]
  VERSION_INFO.FULL: v20.4.13B [VERLOCK SSOT]: openFormæ–°è¦å•†å“ã®Yahooè‡ªå‹•è£œå®Œã‚’åœæ­¢ï¼ˆDB_ONLYæ™‚ï¼‰
BUILD_PARAM: '?b=2026-01-27_0030_verlock-v20.4.13B'
  DEBUG_PARAM: &debug=1 (debug only)
POLICY: UIå¤‰æ›´ãªã—ãƒ»ã‚¹ã‚­ãƒ£ãƒ³å‘¨ã‚Šä¸€åˆ‡è§¦ã‚‰ãªã„

âš ï¸ PWAã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œã®å¯¾å‡¦æ³•ï¼ˆå®Ÿæ©Ÿã§VERSIONãŒæ›´æ–°ã•ã‚Œãªã„å ´åˆãƒ»å®šå‹æ‰‹é †ï¼‰:
1. ã¾ãšç¢ºèªã™ã‚‹ã®ã¯"UIã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤º"ï¼ˆç”»é¢ã®VERSION/BUILDãŒå¤ã„ã¾ã¾ï¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹URLé•ã„ï¼‰
2. é€šå¸¸ã‚¿ãƒ–ã§é–‹ã: ãƒ–ãƒ©ã‚¦ã‚¶ã®é€šå¸¸ã‚¿ãƒ–ã§ /?b=2026-01-21_210000_p0-p1-product-invite ã‚’é–‹ã
3. ã ã‚ãªã‚‰ã‚µã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿å‰Šé™¤: å¯¾è±¡ã‚µã‚¤ãƒˆã®ã‚µã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
4. ãã‚Œã§ã‚‚ã ã‚ãªã‚‰PWAå‰Šé™¤â†’å†è¿½åŠ :
   - ã‚¹ãƒãƒ›ã®ãƒ›ãƒ¼ãƒ ç”»é¢ã‹ã‚‰PWAã‚’å‰Šé™¤
   - ãƒ–ãƒ©ã‚¦ã‚¶ã§é€šå¸¸ã‚¿ãƒ–ã§é–‹ã
   - ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’é¸æŠã—ã¦å†è¿½åŠ 
-->

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#D50000">
  <title>Smart Price 20.4.13B</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    body { font-family: sans-serif; background-color: #121212; color: #e0e0e0; padding-bottom: 90px; touch-action: manipulation; }
    .header { background: linear-gradient(135deg, #D50000, #9b0000); padding: 12px 15px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
    .v-badge { background: #ff5252; color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; margin-left: 10px; font-weight: bold; }
    .store-area { background: #1e1e1e; padding: 10px; border-bottom: 1px solid #333; min-height: 55px; }
    .store-list { display: flex; align-items: center; overflow-x: auto; gap: 8px; padding: 5px 0; -webkit-overflow-scrolling: touch; }
    .store-tag { padding: 6px 14px; border: 1px solid #444; border-radius: 20px; white-space: nowrap; font-size: 0.85rem; background: #2c2c2c; color: #ccc; }
    .store-hint { white-space: nowrap; font-size: 12px; line-height: 1.2; padding: 0; margin-left: 2px; opacity: 0.65; }
    .store-tag.active { background: #D50000; color: white; border-color: #D50000; }
    .store-tag.gps-btn { border: 1px solid #ff5252; color: #ff5252; }
    .store-tag.gps-btn.on { background: #ff5252; color: white; }
    .store-tag.add-store { border: 1px dashed #777; color: #ddd; background: #262626; }
    .store-tag.add-store:active { background: #333; }
    .gps-status { font-size: 0.6rem; margin-left: 4px; opacity: 0.9; }

    .card { background-color: #1e1e1e; border: 1px solid #333; margin-bottom: 10px; border-radius: 12px; overflow: hidden; }
    .price-card { padding: 12px; border-left: 4px solid #444; cursor: pointer; }
    .price-card.cheap { border-left-color: #ff5252; background: linear-gradient(90deg, #2a1a1a 0%, #1e1e1e 100%); }
    .prod-thumb { width: 68px; height: 68px; object-fit: contain; background: #fff; border-radius: 8px; margin-right: 12px; }

    .price-main { font-size: 1.25rem; font-weight: bold; color: #fff; line-height: 1; }
    .stats-strip { display: flex; flex-direction: column; background: #262626; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.75rem; border: 1px solid #333; }
    .stats-row { display: flex; justify-content: space-around; width: 100%; }
    .stat-item { text-align: center; flex: 1; color: #aaa; }
    .stat-val { display: block; font-weight: bold; color: #fff; font-size: 0.9rem; }

    .history-row { font-size: 0.8rem; padding: 10px 0; border-top: 1px solid #333; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    
    /* âœ… P0: è³¼å…¥å±¥æ­´é¸æŠæ™‚ã®èµ¤æ ã‚’#priceSectionã¨åŒã˜ä»•æ§˜ã¸çµ±ä¸€ */
    .selected {
      border: 1px solid #ff5252 !important;
      border-radius: 12px !important; /* è§’ä¸¸çµ±ä¸€ï¼ˆä»–ã‚«ãƒ¼ãƒ‰ã¨åŒã˜åŠå¾„ï¼‰ */
      background: rgba(213,0,0,0.12);
      box-sizing: border-box !important; /* æ ã‚ºãƒ¬äºˆé˜² */
      max-width: 100% !important; /* æ ã‚ºãƒ¬äºˆé˜² */
      overflow: hidden !important; /* æ ã‚ºãƒ¬äºˆé˜² */
      padding: 12px !important; /* å·¦å³ä½™ç™½ï¼ˆæ ç·šã«å¯¾ã—ã¦æƒ…å ±ãŒè¿‘ã™ãã‚‹ã®ã‚’è§£æ¶ˆï¼‰ */
      margin: 0 !important; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ */
    }

    #camera-area { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; background: black; z-index: 2000; }
    #interactive { width: 100%; height: 100%; position: relative; }
    #interactive video { width: 100%; height: 100%; object-fit: cover; }
    /* âœ… ã‚¹ã‚­ãƒ£ãƒŠç”»é¢ï¼šåˆã‚ã›çª“ï¼ˆè§’ä¸¸ã‚¬ã‚¤ãƒ‰æ ï¼‰- æ—¢å­˜UIã¨çµ±ä¸€ */
    .scan-frame { 
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      width: 280px; 
      height: 180px; 
      z-index: 2001; /* videoã‚ˆã‚Šå‰é¢ã«å›ºå®š */
      box-shadow: 0 0 0 4000px rgba(0,0,0,0.65); /* å‘¨å›²ã‚’æš—ãã™ã‚‹ */
      border: 2px solid #ff5252; /* ç·šå¹…ã‚’çµ±ä¸€ï¼ˆ2pxï¼‰ */
      border-radius: 12px; /* è§’ä¸¸ã‚’çµ±ä¸€ï¼ˆcardã¨åŒã˜ï¼‰ */
      display: block; /* å¿…ãšè¡¨ç¤º */
      pointer-events: none; /* ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆç„¡è¦– */
    }
    
    /* âœ… ã‚¹ã‚­ãƒ£ãƒ³ãƒãƒ¼ï¼ˆèµ°æŸ»ãƒ©ã‚¤ãƒ³ï¼‰- DOMè¦ç´ ã§ç¢ºå®Ÿè¡¨ç¤º */
    .scan-laser { 
      position: absolute; 
      top: 15%; /* åˆæœŸä½ç½® */
      left: 5%; 
      width: 90%; 
      height: 3px; /* å°‘ã—å¤ªã‚ã«ï¼ˆè¦–èªæ€§å‘ä¸Šï¼‰ */
      background: linear-gradient(180deg, rgba(255,0,0,0.3), rgba(255,0,0,1), rgba(255,0,0,0.3)); /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§ç«‹ä½“æ„Ÿ */
      box-shadow: 
        0 0 8px 1px rgba(255,0,0,0.8), 
        0 0 15px 3px rgba(255,0,0,0.5); /* ã‚°ãƒ­ãƒ¼åŠ¹æœ */
      animation: scan-move 2s infinite ease-in-out; 
      z-index: 2002; /* scan-frameã‚ˆã‚Šå‰é¢ */
      border-radius: 2px; 
      will-change: transform; /* ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– */
      pointer-events: none; /* ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆç„¡è¦– */
      transform: translateZ(0); /* ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚¢ã‚¯ã‚»ãƒ©ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœ‰åŠ¹åŒ– */
      backface-visibility: hidden; /* ã¡ã‚‰ã¤ãé˜²æ­¢ */
    }
    
    /* âœ… ã‚¹ã‚­ãƒ£ãƒ³ãƒãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ - ã‚·ãƒ³ãƒ—ãƒ«ãƒ»ç¢ºå®Ÿ */
    @keyframes scan-move { 
      0% { 
        top: 15%; 
        opacity: 0.6; 
      } 
      50% { 
        top: 82%; /* ä¸‹ç«¯ä»˜è¿‘ã¾ã§ */
        opacity: 1; 
      } 
      100% { 
        top: 15%; 
        opacity: 0.6; 
      } 
    }

    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; justify-content: center; align-items: center; }
    .modal-content { background: #1e1e1e; padding: 25px; border-radius: 20px; width: 95%; max-width: 450px; border: 1px solid #D50000; }

    .toast-msg{
    position: fixed;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%);
    z-index: 99999;

    max-width: 92vw;
    max-height: 40vh;
    overflow: auto;

    padding: 10px 14px;
    border-radius: 14px;
    background: rgba(0,0,0,0.75);
    color: #fff;
    font-size: 13px;
    line-height: 1.35;
    white-space: pre-wrap;     /* åã¾ã‚‰ãªã„æƒ…å ±ã¯æ”¹è¡Œã—ã¦è¦‹ã›ã‚‹ */
    word-break: break-word;    /* é•·ã„URL/ã‚¨ãƒ©ãƒ¼æ–‡ã‚’æŠ˜ã‚Šè¿”ã™ */

    opacity: 0;
    pointer-events: none;
    transition: opacity .2s ease, transform .2s ease;
  }
  .toast-msg.show{
    opacity: 1;
    pointer-events: auto;      /* ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹ */
    transform: translateX(-50%) translateY(0);
  }
  .toast-msg.is-error{
    background: rgba(213,0,0,0.92);
  }

    .city-chips { display: flex; overflow-x: auto; gap: 5px; padding: 5px 0; margin-bottom: 10px; -webkit-overflow-scrolling: touch; }
    .city-chip { font-size: 0.75rem; padding: 4px 12px; border-radius: 15px; background: #333; color: #ccc; border: 1px solid #555; white-space: nowrap; cursor: pointer; }
    .city-chip:active { background: #D50000; color: white; }

    .url-box { font-size: 0.9rem; padding: 12px; border-radius: 12px; }
    .hint { font-size: 0.75rem; color: #aaa; line-height: 1.4; }
  
/* PATCH v19.9.39: modal overlay fix */
.modal-view{
  position: fixed !important;
  left: 0 !important; top: 0 !important; right: 0 !important; bottom: 0 !important;
  width: 100vw !important; height: 100vh !important;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 16px;
  background: rgba(0,0,0,0.72);
  z-index: 99999 !important;
}
.modal-view .card{
  max-height: 90vh;
  overflow: auto;
}
#settingsModal{ z-index: 1000; }


/* PATCH v19.9.41: invite readability + modal overlay */
.modal-view{
  position: fixed !important;
  left: 0 !important; top: 0 !important; right: 0 !important; bottom: 0 !important;
  width: 100vw !important; height: 100vh !important;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 16px;
  background: rgba(0,0,0,0.78);
  z-index: 99999 !important;
}
.modal-view .card{ max-height: 90vh; overflow:auto; }
#inviteModal, #adminGateModal{ z-index: 99999 !important; }
#inviteModal .text-secondary, #inviteModal .small.text-secondary{ color:#EAEAEA !important; opacity: 1 !important; }
#inviteModal #inviteCopyText{ color:#FFFFFF !important; }


/* PATCH v19.9.42: invite readability stronger */
#inviteModal .text-secondary, #inviteModal .small.text-secondary{ color:#F0F0F0 !important; opacity: 1 !important; }
#inviteModal #inviteCopyText{ color:#FFFFFF !important; font-size: 14px; line-height: 1.5; }


/* --- v20.4.13B HOTFIX: store-bar tap unblocked + early paint --- */
.store-area{ position:relative; z-index:50; pointer-events:auto; }
#store-list{ pointer-events:auto; }
#store-list .store-tag{ pointer-events:auto; }

</style>

<style id="sp-2044-fix-storetap">
/* v20.4.13B: ensure store bar is tappable */
.store-area{ position:relative; z-index:60; pointer-events:auto; }
#store-list{ pointer-events:auto; }
.store-tag{ pointer-events:auto; }
</style>

</head>

<body>
<header class="header d-flex justify-content-between align-items-center">
   <h5 class="m-0 fw-bold text-white"><i class="bi bi-cart4"></i> Smart Price <span class="v-badge" id="version-badge">20.4.13B</span></h5>
  <button class="btn btn-sm btn-outline-light" onclick="openSettings()"><i class="bi bi-gear-fill"></i></button>
</header>

<div class="store-area"><div id="store-list" class="store-list"></div></div>

<div class="container p-3">
  <div id="mainView">
    <div class="row g-2 mb-4">
      <div class="col-7"><button id="scanBtnTop" class="btn btn-danger w-100 py-3 rounded-4 shadow" onclick="startScanner()"><i class="bi bi-upc-scan fs-1"></i><br>ã‚¹ã‚­ãƒ£ãƒ³</button></div>
      <div class="col-5"><button class="btn btn-dark w-100 py-3 rounded-4 border-secondary shadow" onclick="showVeggieMenu()"><i class="bi bi-keyboard fs-1"></i><br>æ‰‹å…¥åŠ›</button></div>
    </div>
    <div id="historyList"></div>
  </div>

  <div id="formView" style="display:none;">
    <div class="card p-3 shadow-lg">
      <div id="curStoreIndicator" class="text-danger small fw-bold mb-2 text-center" style="opacity:0.8;"></div>

      <div class="text-center mb-2">
        <button id="storeJumpBtn" class="btn btn-sm btn-outline-secondary w-100" style="display:none;" onclick="jumpToStoreChips()">åº—åã‚’å¤‰æ›´ï¼ˆä¸Šã«ç§»å‹•ï¼‰</button>
      </div>

      <div id="formMainUI">
        <div class="d-flex mb-3">
          <div style="position:relative; width:90px; height:90px; margin-right:12px;">
            <img id="previewImg" style="width:100%; height:100%; object-fit:contain; background:white; border-radius:10px;">
            <div class="position-absolute bottom-0 start-0 w-100 d-flex justify-content-between px-1 pb-1">
              <button class="btn btn-dark btn-sm p-1 opacity-75" onclick="document.getElementById('imgInput').click()"><i class="bi bi-folder2-open"></i></button>
              <button class="btn btn-dark btn-sm p-1 opacity-75" onclick="searchImageWeb()"><i class="bi bi-search"></i></button>
            </div>
            <input type="file" id="imgInput" accept="image/*" style="display:none;" onchange="handleImage(this)">
          </div>
          <div class="flex-grow-1">
            <input type="text" id="inputName" class="form-control bg-dark text-white border-secondary mb-2" placeholder="å•†å“åï¼ˆå†…å®¹é‡ï¼‰">
            <select id="inputCategory" class="form-control bg-dark text-white border-secondary mb-2" style="font-size:0.85rem; padding:4px;"></select>
            <!-- âœ… ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªå¾©æ´»ï¼ˆæœ€å°UIï¼‰ -->
            <select id="inputSubCategory" class="form-control bg-dark text-white border-secondary mb-2" style="font-size:0.85rem; padding:4px; display:none;"></select>
            <input type="text" id="inputMaker" class="form-control bg-dark text-white border-secondary py-1" style="font-size:0.85rem;" placeholder="ãƒ¡ãƒ¼ã‚«ãƒ¼å">
          </div>
        </div>

        <div id="priceSection" class="mb-3 p-3 border rounded border-danger" style="background:#1a1a1a; border-width: 1px !important; box-sizing: border-box; max-width: 100%; overflow: hidden; padding: 12px !important;">
          <div id="calcOptionArea" class="d-flex align-items-center mb-2">
            <div class="btn-group btn-group-sm w-100 me-2">
              <input type="radio" class="btn-check" name="taxMode" id="taxEx" value="ex" checked>
              <label class="btn btn-outline-danger" for="taxEx">ç¨åˆ¥</label>
              <input type="radio" class="btn-check" name="taxMode" id="taxIn" value="in">
              <label class="btn btn-outline-danger" for="taxIn">ç¨è¾¼</label>
            </div>
            <div class="input-group input-group-sm w-50">
              <input type="number" id="inputDisc" class="form-control bg-dark text-white border-secondary" placeholder="0">
              <span class="input-group-text bg-dark text-secondary border-secondary">%å¼•</span>
            </div>
          </div>
          <input type="number" id="inputPrice" class="form-control text-end fw-bold text-danger border-0 bg-transparent fs-1" placeholder="0">
        </div>

        <div id="statsBox" class="stats-strip"></div>
        <div id="detailHistory" class="mb-3" style="display:none;"></div>

        <div class="text-center mb-3">
          <button id="toggleHistBtn" class="btn btn-sm btn-outline-secondary w-100" onclick="toggleHistoryList()">è³¼å…¥å±¥æ­´ã‚’è¡¨ç¤ºï¼ˆã‚¿ãƒƒãƒ—ã§ç·¨é›†ï¼‰</button>
        </div>

        <div class="d-flex gap-2 mb-3">
          <button id="delHistBtn" class="btn btn-outline-secondary py-3 fw-bold flex-grow-0 px-3 shadow" style="display:none;" onclick="confirmDeleteHist()">å‰Šé™¤</button>
          <button id="saveBtn" class="btn btn-danger py-3 fw-bold fs-5 shadow flex-grow-1" onclick="saveData()">ä¿å­˜</button>
        </div>
      </div>

      <button class="btn btn-link text-secondary w-100" onclick="showHome()">æˆ»ã‚‹</button>
    </div>
  </div>
</div>

<div id="camera-area">
  <div id="interactive">
    <!-- scan-frame ã¨ scan-laser ã¯å‹•çš„ç”Ÿæˆï¼ˆensureScanbarDom()ã§ç”Ÿæˆï¼‰ -->
  </div>
  <button onclick="stopScanner()" class="btn btn-danger position-absolute top-0 end-0 m-4 fs-3 shadow-lg">Ã—</button>
</div>

<div id="dialogModal" class="modal">
  <div class="modal-content text-center">
    <h6 id="dialogTitle" class="text-secondary mb-3">Smart Price</h6>
    <p id="dialogMsg" class="text-white mb-4"></p>
    <div id="dialogInputArea" style="display:none;"><input type="text" id="dialogInput" class="form-control bg-dark text-white mb-3"></div>
    <div class="d-flex gap-2">
      <button id="dialogCancel" class="btn btn-dark flex-grow-1" style="display:none;">ã‚„ã‚ã‚‹</button>
      <button id="dialogOk" class="btn btn-danger flex-grow-1">OK</button>
    </div>
  </div>
</div>

<div id="settingsModal" class="modal">
  <div class="modal-content">
    <h5 class="text-white mb-4 text-center">è¨­å®š</h5>

    <div class="mb-3">
      <label class="small text-secondary">ç”Ÿæ´»åœï¼ˆå¸‚ï¼‰</label>
      <input type="text" id="home-city-input" class="form-control bg-dark text-white border-secondary mb-1" placeholder="ä¾‹ï¼šåœŸæµ¦å¸‚">
      <div id="city-history-chips" class="city-chips"></div>
    </div>

    <input type="hidden" id="fb-url-input">

    <button id="syncBtn" class="btn btn-warning w-100 py-3 fw-bold mb-2 shadow" onclick="startMigration()">è¨­å®šä¿å­˜ã¨åŒæœŸ</button>
    <button class="btn btn-outline-secondary w-100 py-2 fw-bold mb-2" onclick="openWebModal()">ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã</button>
    <button class="btn btn-outline-light w-100 py-2 fw-bold mb-2" onclick="openInviteModal('friend')">å‹äººç´¹ä»‹</button>
    <button class="btn btn-outline-light w-100 py-2 fw-bold mb-2" onclick="openInviteModal('family')">å®¶æ—å…±æœ‰</button>
    <button class="btn btn-outline-danger w-100 py-2 fw-bold mb-2" onclick="openAdminGate()">ç®¡ç†</button>
    <div id="debugBackupButtons" style="display:none;">
      <button class="btn btn-success w-100 py-2 fw-bold mb-2" onclick="exportBackup()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‡ºåŠ›</button>
      <button class="btn btn-info w-100 py-2 fw-bold mb-2" onclick="importBackup()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—èª­ã¿è¾¼ã¿</button>
    </div>
<button class="btn btn-link text-secondary w-100" onclick="closeSettings()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<div id="webModal" class="modal">
  <div class="modal-content">
    <h5 class="text-white mb-3 text-center">ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã</h5>

    <textarea id="webUrlNormal" class="form-control bg-dark text-white border-secondary url-box mb-3" rows="2" readonly style="display:none;"></textarea>

    <div class="d-flex gap-2 mb-3">
      <button class="btn btn-danger w-100 py-3 fw-bold" onclick="openWebDirect()">é–‹ã</button>
    </div>

    <button class="btn btn-link text-secondary w-100" onclick="closeWebModal()">æˆ»ã‚‹</button>
  </div>
</div>


<div id="adminGateModal" class="modal">
  <div class="modal-content">
    <h5 class="text-white mb-3 text-center">ç®¡ç†</h5>
    <div class="hint mb-3">
      ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
    </div>
    <input type="password" id="adminPassInput" class="form-control bg-dark text-white border-secondary mb-3" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <div class="d-flex gap-2 mb-3">
      <button class="btn btn-warning w-100 py-2 fw-bold" onclick="enterAdmin()">å…¥ã‚‹</button>
    </div>
    <button class="btn btn-link text-secondary w-100" onclick="closeAdminGate()">æˆ»ã‚‹</button>
  </div>
</div>

<div id="adminModal" class="modal">
  <div class="modal-content">
    <h5 class="text-white mb-3 text-center">ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h5>

    <div class="mb-3">
      <label class="small text-secondary">åŒæœŸå…ˆï¼ˆå¤‰æ›´ã§ãã¾ã›ã‚“ï¼‰</label>
      <textarea id="adminFbUrl" class="form-control bg-dark text-white border-secondary url-box" rows="2" readonly></textarea>
    </div>

    
    <div class="mb-3">
      <label class="small text-secondary">Yahoo Proxy URLï¼ˆGASï¼‰â€»GPSã§è¿‘éš£ã‚¹ãƒˆã‚¢åã‚’å‡ºã™ãŸã‚ï¼ˆç®¡ç†ã®ã¿ï¼‰</label>
      <textarea id="adminProxyUrl" class="form-control bg-dark text-white border-secondary url-box mb-2" rows="2" placeholder="https://script.google.com/macros/s//exec"></textarea>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-light w-50" onclick="saveProxyUrl()">ä¿å­˜</button>
        <button class="btn btn-outline-secondary w-50" onclick="clearProxyUrl()">æ¶ˆã™</button>
      </div>
      <div class="hint mt-2">â€»æœªè¨­å®šã§ã‚‚å‹•ä½œã—ã¾ã™ï¼ˆGPSã®åº—åã ã‘å‡ºã¾ã›ã‚“ï¼‰ã€‚</div>
    </div>
<label class="small text-secondary">URL</label>
    <textarea id="adminUrlNormal" class="form-control bg-dark text-white border-secondary url-box mb-2" rows="2" readonly></textarea>
    <div class="d-flex gap-2 mb-3">
      <button class="btn btn-outline-light w-50" onclick="copyText('adminUrlNormal')">ã‚³ãƒ”ãƒ¼</button>
      <button class="btn btn-danger w-50" onclick="openUrlFromBox('adminUrlNormal')">é–‹ã</button>
    </div>

    <label class="small text-secondary">ãƒ‡ãƒãƒƒã‚°URL</label>
    <textarea id="adminUrlDebug" class="form-control bg-dark text-white border-secondary url-box mb-2" rows="2" readonly></textarea>
    <div class="d-flex gap-2 mb-3">
      <button class="btn btn-outline-light w-50" onclick="copyText('adminUrlDebug')">ã‚³ãƒ”ãƒ¼</button>
      <button class="btn btn-danger w-50" onclick="openUrlFromBox('adminUrlDebug')">é–‹ã</button>
    </div>

    <div class="d-flex gap-2 mb-3">
      <button class="btn btn-outline-info w-50" onclick="openDiagnostics()">æ¤œè¨¼ãƒ„ãƒ¼ãƒ«</button>
      <button id="pwaInstallBtnAdmin" class="btn btn-outline-success w-50" style="display:none;" onclick="installPWA()">ğŸ“± ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½œã‚‹</button>
    </div>

    <button class="btn btn-link text-secondary w-100" onclick="closeAdmin()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<div id="toast" class="toast-msg"></div>
<!-- âœ… P0: debug=1ã®ã¨ãã ã‘æœ€çµ‚ã‚¨ãƒ©ãƒ¼ã‚’å›ºå®šè¡¨ç¤º -->
<div id="debug-error-display" style="display:none; position:fixed; top:calc(env(safe-area-inset-top, 0px) + 74px); left:12px; right:80px; transform:none; max-height:28vh; overflow:auto; z-index:10001; background:rgba(213,0,0,0.92); color:#fff; padding:10px 12px; border-radius:12px; font-size:14px; line-height:1.25; box-shadow:0 10px 30px rgba(0,0,0,.45); word-break:break-word; white-space:pre-wrap;"></div>

<!-- SDK (v9 compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
    // ===== VERSION SSOT (SINGLE SOURCE OF TRUTH) =====
const VERSION_INFO = {
  NUM: "20.4.6",
  REV: "B",
  BUILD: "2026-01-27_1705_verlock-v20.4.13B",
  get FULL(){ return `${this.NUM}${this.REV}`; },
  get TITLE(){ return `Smart Price ${this.FULL}`; }
};
const BUILD_ID = VERSION_INFO.BUILD; // ä»¥å¾Œã€æ‰‹æ›¸ãç¦æ­¢ï¼ˆã“ã“ãŒæ­£æœ¬ï¼‰

function applyVersionUI(){
  try{
    const isDbg = (typeof isDebug === "function" && isDebug());
    document.title = isDbg ? `${VERSION_INFO.TITLE} / ${VERSION_INFO.BUILD}` : VERSION_INFO.TITLE;

    // ãƒ˜ãƒƒãƒ€å†…ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒãƒƒã‚¸ï¼ˆè¡¨ç¤ºï¼‰
    const badge = document.getElementById("version-badge");
    if(badge) badge.textContent = VERSION_INFO.FULL;

    // ã‚‚ã—å¤ã„è¡¨è¨˜ãŒæ®‹ã£ã¦ã„ã¦ã‚‚ã€å¼·åˆ¶çš„ã«ä¸Šæ›¸ãã—ã¦ã‚ºãƒ¬ã‚’æ½°ã™
    const els = document.querySelectorAll("[data-version], .version-text, #appVersionText");
    els.forEach(el => { try{ el.textContent = VERSION_INFO.FULL; }catch(e){} });
  }catch(e){}
}
document.addEventListener("DOMContentLoaded", applyVersionUI);
// ===== /VERSION SSOT =====
// ===== /VERSION SSOT =====
 // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆè©³ç´°ï¼‰

    // ===== Proxy URL (Admin only) =====
    const PROXY_URL_LS_KEY = "sp_proxy_exec_url";
    function getProxyExecUrl(){
      try{
        const v = (localStorage.getItem(PROXY_URL_LS_KEY)||"").trim();
        if(v) return v;
      }catch(e){}
      try{
        const v2 = (window.SP_CONFIG && window.SP_CONFIG.yahooProxyExecUrl) ? String(window.SP_CONFIG.yahooProxyExecUrl).trim() : "";
        return v2 || "";
      }catch(e){}
      return "";
    }
    function saveProxyUrl(){
      try{
        const ta = document.getElementById("adminProxyUrl");
        const v = ta ? String(ta.value||"").trim() : "";
        if(v){
          localStorage.setItem(PROXY_URL_LS_KEY, v);
          showToast("Proxy URL ã‚’ä¿å­˜ã—ã¾ã—ãŸ", 2500);
        }else{
          localStorage.removeItem(PROXY_URL_LS_KEY);
          showToast("Proxy URL ã‚’æ¶ˆã—ã¾ã—ãŸ", 2500);
        }
      }catch(e){}
    }
    function clearProxyUrl(){
      try{
        localStorage.removeItem(PROXY_URL_LS_KEY);
        const ta = document.getElementById("adminProxyUrl");
        if(ta) ta.value = "";
        showToast("Proxy URL ã‚’æ¶ˆã—ã¾ã—ãŸ", 2500);
      }catch(e){}
    }

  // ========= Firebase Configuration =========
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyCYjQ79KgsohOPlEViHBX5BygVUvX-70l4",
    authDomain: "smartpricedb.firebaseapp.com",
    databaseURL: "https://smartpricedb-default-rtdb.firebaseio.com",
    projectId: "smartpricedb",
    storageBucket: "smartpricedb.firebasestorage.app",
    messagingSenderId: "892635601514",
    appId: "1:892635601514:web:3a496e522a9972e8de0813",
    measurementId: "G-317L3VFKQV"
  };

  // ========= Firebase Initialization =========
  let firebaseApp = null;
  let firebaseAuth = null;
  let firebaseDb = null;
  let currentAuthUid = null;
  let isFirebaseReady = false;

  async function initializeFirebase() {
    try {
      if (!FIREBASE_CONFIG || !FIREBASE_CONFIG.apiKey) {
        if (isDebug()) console.warn('[Firebase] Config not set, fallback to legacy mode');
        return false;
      }

      // FirebaseåˆæœŸåŒ–
      firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
      firebaseAuth = firebase.auth();
      firebaseDb = firebase.database();

      // åŒ¿åãƒ­ã‚°ã‚¤ãƒ³
      await firebaseAuth.signInAnonymously();
      currentAuthUid = firebaseAuth.currentUser?.uid;

      if (!currentAuthUid) {
        throw new Error('Anonymous sign-in failed: no uid');
      }

      isFirebaseReady = true;
      if (isDebug()) {
        console.log('[Firebase] Initialized successfully');
        console.log('[Firebase] Auth UID:', currentAuthUid);
      }
      return true;

    } catch(e) {
      if (isDebug()) console.warn('[Firebase] Initialization failed:', e);
      isFirebaseReady = false;
      return false;
    }
  }

  // AuthçŠ¶æ…‹å¤‰åŒ–ã®ç›£è¦–
  function setupAuthListener() {
    if (!firebaseAuth) return;
    firebaseAuth.onAuthStateChanged((user) => {
      if (user) {
        currentAuthUid = user.uid;
        if (isDebug()) console.log('[Firebase] Auth state changed, UID:', currentAuthUid);
      } else {
        currentAuthUid = null;
        isFirebaseReady = false;
        if (isDebug()) console.warn('[Firebase] User signed out');
      }
    });
  }

  // ========= Debug =========
  function isDebug() {
    try { return new URL(location.href).searchParams.get('debug') === '1'; } catch(e){ return false; }
  }

// ======== UID SCOPE (DEV) ========
// å•†å“ãƒã‚¹ã‚¿ãƒ¼ã¯å…±é€šã€‚è³¼å…¥å±¥æ­´ï¼ˆhistoryï¼‰ã ã‘ userId ã§åˆ†é›¢ã™ã‚‹ã€‚
const USER_ID_KEY = 'sp_user_id_dev';
function getOrCreateUserId() {
  let uid = localStorage.getItem(USER_ID_KEY);
  if (!uid) {
    try {
      uid = (window.crypto && typeof window.crypto.randomUUID === 'function') ? window.crypto.randomUUID() : null;
    } catch(e) {
      uid = null;
    }
    if (!uid) uid = 'u-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
    localStorage.setItem(USER_ID_KEY, uid);
  }
  return uid;
}
const currentUserId = getOrCreateUserId();

function shouldShowHistoryItem(h) {
  // debug=1 ã§ã‚‚å…¨ä»¶è¡¨ç¤ºã«ã—ãªã„ï¼ˆã‚¹ã‚¿ãƒƒãƒ•æ¤œè¨¼ã®äº‹æ•…é˜²æ­¢ï¼‰
  return !!(h && typeof h.userId === 'string' && h.userId === currentUserId);
}

function filterHistoryForMe(history) {
  const arr = Array.isArray(history) ? history : [];
  return arr.filter(shouldShowHistoryItem);
}

function lastHistoryForMe(history) {
  const arr = Array.isArray(history) ? history : [];
  for (let i = arr.length - 1; i >= 0; i--) {
    const h = arr[i];
    if (h && typeof h.userId === 'string' && h.userId === currentUserId) return h;
  }
  return null;
}

  // âœ… P0: debug=1ã®ã¨ãã ã‘ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¼·åŒ–
  if (isDebug()) {
    const errorDisplay = document.getElementById('debug-error-display');
    if (errorDisplay) errorDisplay.style.display = 'block';

    // æœ€çµ‚ã‚¨ãƒ©ãƒ¼ã‚’ç”»é¢ã«å›ºå®šè¡¨ç¤ºã™ã‚‹é–¢æ•°
    // âœ… P0ä¿®æ­£: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ä¿å­˜ã™ã‚‹é…åˆ—ï¼ˆè¨ºæ–­ãƒ„ãƒ¼ãƒ«ç”¨ï¼‰
    const errorLogs = [];
    const MAX_ERROR_LOGS = 50; // æœ€å¤§50ä»¶ã¾ã§ä¿å­˜
    
    // âœ… P0ä¿®æ­£: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
    function addErrorLog(errorInfo) {
      errorLogs.push({
        errorInfo,
        timestamp: errorInfo.timestamp || new Date().toISOString()
      });
      // æœ€å¤§ä»¶æ•°ã‚’è¶…ãˆãŸã‚‰å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
      if (errorLogs.length > MAX_ERROR_LOGS) {
        errorLogs.shift();
      }
      // localStorageã«ã‚‚ä¿å­˜ï¼ˆè¨ºæ–­ãƒ„ãƒ¼ãƒ«ã§èª­ã¿è¾¼ã‚€ãŸã‚ï¼‰
      try {
        localStorage.setItem('smartPrice_errorLogs', JSON.stringify(errorLogs));
      } catch(e) {
        console.warn('[ErrorLog] Failed to save to localStorage:', e);
      }
    }
    
    function setLastError(msg) {
      const errorDisplay = document.getElementById('debug-error-display');
      if (errorDisplay) {
        errorDisplay.textContent = msg;
        errorDisplay.style.display = 'block';
      }
    }

    window.addEventListener('error', (e) => {
      // âœ… P0: ã€ŒScript error.ã€ã®è©³ç´°æƒ…å ±ã‚’å–å¾—ï¼ˆCORSã‚¨ãƒ©ãƒ¼ã®å ´åˆã§ã‚‚å¯èƒ½ãªé™ã‚Šè©³ç´°ã‚’è¡¨ç¤ºï¼‰
      let errorName = 'Error';
      let errorMsg = e.message || 'Unknown error';
      let errorStack = '';
      let errorFileName = e.filename || '';
      let errorLine = e.lineno || 0;
      let errorCol = e.colno || 0;
      
      if (e.error) {
        errorName = e.error.name || 'Error';
        errorMsg = e.error.message || e.message || 'Unknown error';
        errorStack = e.error.stack || '';
      } else if (e.message && e.message !== 'Script error.') {
        errorName = 'Error';
        errorMsg = e.message;
      }
      
      // Script error.ã®å ´åˆã€è©³ç´°æƒ…å ±ã‚’è¿½åŠ 
      if (errorMsg === 'Script error.' || errorMsg === 'Script error') {
        errorMsg = `Script error. (ãƒ•ã‚¡ã‚¤ãƒ«: ${errorFileName || 'ä¸æ˜'}, è¡Œ: ${errorLine}, åˆ—: ${errorCol})`;
        if (errorFileName) {
          errorMsg += ` - å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆCORSåˆ¶é™ï¼‰`;
        }
      }
      
      const errorDetail = `${errorName}: ${errorMsg}`;
      const fullMsg = `JSã‚¨ãƒ©ãƒ¼: ${errorDetail}`;
      showToast(fullMsg, 10000);
      setLastError(fullMsg);
      
      // âœ… P0ä¿®æ­£: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ä¿å­˜ï¼ˆè¨ºæ–­ãƒ„ãƒ¼ãƒ«ç”¨ï¼‰
      addErrorLog({
        type: 'js_error',
        name: errorName,
        message: errorMsg,
        filename: errorFileName,
        lineno: errorLine,
        colno: errorCol,
        stack: errorStack,
        timestamp: new Date().toISOString()
      });
      
      // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚è©³ç´°ã‚’å‡ºåŠ›ï¼ˆå†…éƒ¨æ¤œè¨¼ç”¨ï¼‰
      console.error('[JS Error]', {
        name: errorName,
        message: errorMsg,
        filename: errorFileName,
        lineno: errorLine,
        colno: errorCol,
        stack: errorStack,
        event: e
      });
    });
    window.addEventListener('unhandledrejection', (e) => {
      const reason = e.reason || e;
      const errorName = reason && reason.name ? reason.name : 'PromiseRejection';
      const errorMsg = (reason && reason.message) ? reason.message : String(reason);
      const errorDetail = `${errorName}: ${errorMsg}`;
      const fullMsg = `Promiseã‚¨ãƒ©ãƒ¼: ${errorDetail}`;
      showToast(fullMsg, 10000);
      setLastError(fullMsg);
      
      // âœ… P0ä¿®æ­£: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ä¿å­˜ï¼ˆè¨ºæ–­ãƒ„ãƒ¼ãƒ«ç”¨ï¼‰
      addErrorLog({
        type: 'unhandled_rejection',
        name: errorName,
        message: errorMsg,
        stack: reason && reason.stack ? reason.stack : '',
        reason: String(reason),
        timestamp: new Date().toISOString()
      });
    });
  }

  // ========= Category Treeï¼ˆAmazon/Rakutenã‚’å®Ÿç”¨ãƒ¬ãƒ™ãƒ«ã«æ•´ç†ï¼‹è¿½è¨˜å¯ï¼‰ =========
  const DEFAULT_CATEGORY_TREE = {
    "ãƒ‰ãƒªãƒ³ã‚¯": ["æ°´ãƒ»ãƒŸãƒãƒ©ãƒ«ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼","ç‚­é…¸é£²æ–™","ä¹³é£²æ–™","ã‚³ãƒ¼ãƒ’ãƒ¼","ç´…èŒ¶","ãŠèŒ¶","ã‚¹ãƒãƒ¼ãƒ„ãƒ‰ãƒªãƒ³ã‚¯","ã‚¸ãƒ¥ãƒ¼ã‚¹","ç²‰æœ«ãƒ‰ãƒªãƒ³ã‚¯","ãã®ä»–"],
    "ãŠé…’": ["ãƒ“ãƒ¼ãƒ«","ç™ºæ³¡é…’","ãƒãƒ¥ãƒ¼ãƒã‚¤","æ—¥æœ¬é…’","ç„¼é…","ãƒ¯ã‚¤ãƒ³","ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼","æ¢…é…’","ãã®ä»–"],
    "è“å­ãƒ»ã‚¹ãƒŠãƒƒã‚¯": ["ã‚¹ãƒŠãƒƒã‚¯","ãƒãƒ§ã‚³","ãƒ“ã‚¹ã‚±ãƒƒãƒˆ","ã‚­ãƒ£ãƒ³ãƒ‡ã‚£ãƒ»ã‚¬ãƒ ","å’Œè“å­","ãƒŠãƒƒãƒ„","ãã®ä»–"],
    "ç±³ãƒ»é›‘ç©€": ["ç™½ç±³","ç„ç±³","é›‘ç©€ç±³","ã‚‚ã¡ç±³","ã”é£¯ãƒ‘ãƒƒã‚¯","é¤…","ãã®ä»–"],
    "éººé¡ãƒ»ãƒ‘ã‚¹ã‚¿": ["ãƒ©ãƒ¼ãƒ¡ãƒ³","ã†ã©ã‚“","ãã°","ãã†ã‚ã‚“","ç„¼ããã°","ãƒ‘ã‚¹ã‚¿","ãã®ä»–"],
    "ãƒ‘ãƒ³ãƒ»ã‚¸ãƒ£ãƒ ãƒ»ã‚·ãƒªã‚¢ãƒ«": ["ãƒ‘ãƒ³","ã‚¸ãƒ£ãƒ ãƒ»ã¯ã¡ã¿ã¤","ã‚·ãƒªã‚¢ãƒ«","ãã®ä»–"],
    "ç²¾è‚‰ãƒ»è‚‰åŠ å·¥å“": ["ç‰›è‚‰","è±šè‚‰","é¶è‚‰","æŒ½è‚‰","åŠ å·¥å“","ã‚»ãƒƒãƒˆ","ãã®ä»–"],
    "é­šä»‹é¡ãƒ»æ°´ç”£åŠ å·¥å“": ["ãƒã‚°ãƒ­","ã‚µã‚±","ã‚µãƒ","ã‚¨ãƒ“","ã‚«ãƒ‹","è²é¡","æµ·è—»é¡","é­šåµ","åŠ å·¥å“","ãã®ä»–"],
    "é‡èœãƒ»ãã®ã“": ["è‘‰ç‰©","æ ¹èœ","æœèœ","ãã®ã“","è±†é¡","ã‚«ãƒƒãƒˆé‡èœ","ãã®ä»–"],
    "ãƒ•ãƒ«ãƒ¼ãƒ„ãƒ»æœç‰©": ["æŸ‘æ©˜","ã‚Šã‚“ã”ç³»","ãƒ™ãƒªãƒ¼","ãƒãƒŠãƒŠ","ã¶ã©ã†","ãã®ä»–"],
    "ä¹³è£½å“ãƒ»åµ": ["ç‰›ä¹³","ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ","ãƒãƒ¼ã‚º","ãƒã‚¿ãƒ¼ãƒ»ãƒãƒ¼ã‚¬ãƒªãƒ³","åµ","ä»£æ›¿å“","ãã®ä»–"],
    "è±†è…ãƒ»ç´è±†ãƒ»ã“ã‚“ã«ã‚ƒããƒ»ç·´ã‚Šç‰©": ["è±†è…","ç´è±†","ã“ã‚“ã«ã‚ƒã","ç·´ã‚Šç‰©","ãã®ä»–"],
    "æ¼¬ç‰©ãƒ»ä½ƒç…®": ["æ¼¬ç‰©","æ¢…å¹²ã—","ã‚­ãƒ ãƒ","ä½ƒç…®","ãã®ä»–"],
    "å†·å‡é£Ÿå“": ["å†·å‡æƒ£èœ","å†·å‡éºº","å†·å‡é‡èœ","ã‚¢ã‚¤ã‚¹","ãã®ä»–"],
    "æƒ£èœãƒ»ãƒãƒ«ãƒ‰": ["å’Œé¢¨æƒ£èœ","æ´‹é¢¨æƒ£èœ","ä¸­è¯æƒ£èœ","éŸ“å›½æƒ£èœ","ãã®ä»–"],
    "ãƒ¬ãƒˆãƒ«ãƒˆãƒ»æ–™ç†ã®ç´ ": ["ã‚«ãƒ¬ãƒ¼","ã‚¹ãƒ¼ãƒ—","ä¸¼","ãƒ‘ã‚¹ã‚¿ã‚½ãƒ¼ã‚¹","æ–™ç†ã®ç´ ","ãã®ä»–"],
    "ç¼¶è©°ãƒ»ç“¶è©°": ["æ°´ç”£","è‚‰","é‡èœ","ãƒ•ãƒ«ãƒ¼ãƒ„","æƒ£èœ","ãã®ä»–"],
    "ä¹¾ç‰©": ["æµ·è‹”","é°¹ç¯€","æ˜†å¸ƒ","ã‚ã‹ã‚","æ˜¥é›¨","ãã®ä»–"],
    "ç²‰é¡": ["å°éº¦ç²‰","ç‰‡æ —ç²‰","ãƒ‘ãƒ³ç²‰","ç±³ç²‰","ãã®ä»–"],
    "èª¿å‘³æ–™ãƒ»é£Ÿç”¨æ²¹ãƒ»ãƒ‰ãƒ¬ãƒƒã‚·ãƒ³ã‚°": ["ç ‚ç³–","å¡©","é…¢","ã—ã‚‡ã†ã‚†","ã¿ã","ã ã—","ã‚ã‚“ã¤ã‚†","ã‚½ãƒ¼ã‚¹ãƒ»ãŸã‚Œ","ã‚±ãƒãƒ£ãƒƒãƒ—","ãƒãƒ¨ãƒãƒ¼ã‚º","ã‚¹ãƒ‘ã‚¤ã‚¹","æ²¹","ãƒ‰ãƒ¬ãƒƒã‚·ãƒ³ã‚°","ãã®ä»–"],
    "ãƒ™ãƒ“ãƒ¼ãƒ•ãƒ¼ãƒ‰": ["é›¢ä¹³é£Ÿ","ãŠã‚„ã¤","ãã®ä»–"],
    "å¥åº·é£Ÿå“": ["ã‚µãƒ—ãƒª","ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³","ãã®ä»–"],
    "ä»‹è­·ç”¨é£Ÿå“": ["ã‚„ã‚ã‚‰ã‹é£Ÿ","ã¨ã‚ã¿","ãã®ä»–"],
    "ãƒŸãƒ¼ãƒ«ã‚­ãƒƒãƒˆ": ["ãƒŸãƒ¼ãƒ«ã‚­ãƒƒãƒˆ","ãã®ä»–"],
    "æ—¥ç”¨å“": ["æ´—å‰¤","ã‚­ãƒƒãƒãƒ³ç”¨å“","ç´™è£½å“","è¡›ç”Ÿç”¨å“","ãã®ä»–"],
    "è–¬": ["é¢¨é‚ª","èƒƒè…¸","ç—›ã¿","å¤–ç”¨","ãã®ä»–"],
    "ãã®ä»–": ["ãã®ä»–"]
  };

  const DEFAULT_CONFIG = {
    // äº’æ›ã®ãŸã‚æ®‹ã™ï¼ˆå®Ÿä½“ã¯ categoryTreeï¼‰
    categories: [],
    categoryTree: JSON.parse(JSON.stringify(DEFAULT_CATEGORY_TREE)),
    lastTax: "ex",
    homeCity: "",
    homeCities: [],
    customStores: [],
    storeTaxModes: {} // ã‚¹ãƒˆã‚¢ã”ã¨ã®ç¨åˆ¥/ç¨è¾¼æ—¢å®šå€¤ { "ã‚¹ãƒˆã‚¢å": "ex" or "in" }
  };

  const STORE_MASTER_MODE = "EMBEDDED"; // "EMBEDDED" (B) -> "FIREBASE" (A) later

  // Bé‹ç”¨: åŸ‹ã‚è¾¼ã¿ã‚¹ãƒˆã‚¢ãƒã‚¹ã‚¿ãƒ¼ï¼ˆè¡¨ç¤ºåã¯ã“ã“ãŒå”¯ä¸€ã®æ­£è§£ï¼‰
  const STORE_MASTER_EMBEDDED = {}; // v(legacy): ç”Ÿæ´»åœã®å›ºå®šãƒªã‚¹ãƒˆã¯å»ƒæ­¢ï¼ˆGPS/å®Ÿç¸¾ã‹ã‚‰è‡ªå‹•ä½œæˆï¼‰
// æ—§ãƒ—ãƒªã‚»ãƒƒãƒˆã¯ä½¿ç”¨ã—ãªã„ï¼ˆäº’æ›ã®ãŸã‚ç©ºã«å›ºå®šï¼‰
  const CITY_STORE_PRESET = {};

  function _normStoreName(s){
    if(!s) return "";
    return String(s).replace(/\s+/g, " ").trim();
  }
  function _hashStoreId(prefix, name){
    try{
      const h = (prefix + "|" + name);
      let out = 0;
      for(let i=0;i<h.length;i++){ out = ((out<<5)-out) + h.charCodeAt(i); out |= 0; }
      return prefix + "_" + Math.abs(out);
    }catch(e){
      return prefix + "_" + Math.random().toString(36).slice(2);
    }
  }
  
function getStoreMasterByCity(city){
  // âœ… Fallback: GPS/å±¥æ­´ãŒ0ä»¶ã§ã‚‚ã€Œåº—åå€™è£œã€ã‚’æœ€ä½é™å‡ºã™ï¼ˆUIã¯åŒã˜ãƒãƒƒãƒ—è¡¨ç¤ºã®ã¾ã¾ï¼‰
  // ç›®çš„ï¼šåˆå›ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚‚ã€Œæœªè¨­å®šã€ã ã‘ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
  const base = [
    'ã‚«ã‚¹ãƒŸ','ãƒ¨ãƒ¼ã‚¯ãƒ™ãƒ‹ãƒãƒ«','ã‚¤ã‚ªãƒ³','ãƒãƒ«ãƒˆ','ã‚»ã‚¤ãƒ–','ãƒ™ã‚¤ã‚·ã‚¢',
    'æ¥­å‹™ã‚¹ãƒ¼ãƒ‘ãƒ¼','ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³','ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒãƒ¼ãƒˆ','ãƒ­ãƒ¼ã‚½ãƒ³',
    'ãƒ„ãƒ«ãƒãƒ‰ãƒ©ãƒƒã‚°','ã‚¦ã‚¨ãƒ«ã‚·ã‚¢','ã‚«ãƒ¯ãƒè–¬å“'
  ];
  // city ã¯å°†æ¥æ‹¡å¼µï¼ˆå¸‚ç”ºæ‘ã§çµã‚Šè¾¼ã¿ç­‰ï¼‰ã§ãã‚‹ã‚ˆã†æ®‹ã™
  return base;
}

function buildStoreOptions(city){
  // v(legacy): ã‚¹ãƒˆã‚¢å€™è£œã¯ã€ŒGPSã§æ‹¾ã£ãŸåº—åã€ï¼‹ã€Œè‡ªåˆ†ã®è³¼å…¥å®Ÿç¸¾ã‹ã‚‰ã®åº—åã€ã ã‘
  const opts = [];
  const seen = new Set();

  const norm = _normStoreName;
  const add = (id, name, source) => {
    const key = norm(name);
    if(!key || seen.has(key)) return;
    seen.add(key);
    opts.push({ storeId: id || _hashStoreId(source||'auto', key), storeName: key, source: source||'auto' });
  };

  // 1) è‡ªåˆ†ã®è³¼å…¥å®Ÿç¸¾ï¼ˆå±¥æ­´ï¼‰ã‹ã‚‰åº—åã‚’æŠ½å‡ºï¼ˆé »åº¦â†’æœ€æ–°é †ï¼‰
  try{
    const freq = new Map();
    const last = new Map();

    const products = (db && db.products) ? db.products : {};
    Object.keys(products).forEach(jan=>{
      const p = products[jan];
      if(!p || !Array.isArray(p.history)) return;
      const safe = filterHistoryForMe(p.history);
      safe.forEach(h=>{
        const s = norm(h && (h.store || h.storeName || ''));
        if(!s || s === 'æœªè¨­å®š') return;
        freq.set(s, (freq.get(s)||0) + 1);
        const t = Number(h.ts||0);
        if(!last.has(s) || t > last.get(s)) last.set(s, t);
      });
    });

    const ranked = Array.from(freq.keys()).sort((a,b)=>{
      const fa=freq.get(a)||0, fb=freq.get(b)||0;
      if(fb!==fa) return fb-fa;
      const ta=last.get(a)||0, tb=last.get(b)||0;
      return tb-ta;
    });

    ranked.slice(0, 24).forEach(name => add(_hashStoreId('hist', name), name, 'hist'));
  }catch(e){ /* ignore */ }

  // 2) GPSè¿‘éš£å€™è£œï¼ˆåå‰ã ã‘ï¼‰
  const nearby = (Array.isArray(window.nearbyStoreNames) ? window.nearbyStoreNames : []).map(norm).filter(Boolean);
  nearby.forEach(name => add(_hashStoreId("gps", name), name, "gps"));

  // 3) æœ€ä½é™ã®å€™è£œï¼ˆGPS/å±¥æ­´ãŒç„¡ã„åˆå›å‘ã‘ï¼‰
  if(opts.length < 6){
    try{
      const master = getStoreMasterByCity(city) || [];
      master.forEach(name => add(_hashStoreId('master', name), name, 'master'));
    }catch(e){}
  }

  return opts;
}
;

  // ========= Image Store (IndexedDB) =========
  const IMG_DB_NAME = "smart_price_img_db_v1";
  const IMG_STORE = "images";
  let imgDbPromise = null;

  function openImgDb() {
    if (!('indexedDB' in window)) return Promise.resolve(null);
    if (imgDbPromise) return imgDbPromise;
    imgDbPromise = new Promise((resolve) => {
      const req = indexedDB.open(IMG_DB_NAME, 1);
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        // âœ… ä¿å­˜ç®±ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å¿…ãšä½œæˆï¼ˆæ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚‚å®‰å…¨ï¼‰
        if (!db.objectStoreNames.contains(IMG_STORE)) {
          try {
            db.createObjectStore(IMG_STORE);
          } catch (err) {
            console.warn('[IDB] createObjectStore failed:', err);
          }
        }
      };
      req.onsuccess = () => {
        const db = req.result;
        // âœ… ä¿å­˜ç®±ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆå¿µã®ãŸã‚ï¼‰
        if (db && !db.objectStoreNames.contains(IMG_STORE)) {
          // ä¿å­˜ç®±ãŒç„¡ã„å ´åˆã¯å†ä½œæˆã‚’è©¦ã¿ã‚‹
          try {
            db.close();
            indexedDB.deleteDatabase(IMG_DB_NAME);
            imgDbPromise = null; // ãƒªã‚»ãƒƒãƒˆ
            resolve(openImgDb()); // å†å¸°å‘¼ã³å‡ºã—
            return;
          } catch (err) {
            console.warn('[IDB] recreate failed:', err);
            resolve(null);
            return;
          }
        }
        resolve(db);
      };
      req.onerror = (e) => {
        console.warn('[IDB] open failed:', e);
        resolve(null);
      };
    });
    return imgDbPromise;
  }

  async function idbPut(key, blob) {
    const dbi = await openImgDb();
    if (!dbi) return false;
    // âœ… ä¿å­˜ç®±ã®å­˜åœ¨ç¢ºèª
    if (!dbi.objectStoreNames.contains(IMG_STORE)) {
      console.warn('[IDB] objectStore not found:', IMG_STORE);
      return false;
    }
    return new Promise((res) => {
      try {
        const tx = dbi.transaction(IMG_STORE, "readwrite");
        const store = tx.objectStore(IMG_STORE);
        store.put(blob, key);
        tx.oncomplete = () => res(true);
        tx.onerror = (e) => {
          console.warn('[IDB] put failed:', e);
          res(false);
        };
      } catch (err) {
        console.warn('[IDB] transaction failed:', err);
        res(false);
      }
    });
  }

  async function idbGet(key) {
    const dbi = await openImgDb();
    if (!dbi) return null;
    // âœ… ä¿å­˜ç®±ã®å­˜åœ¨ç¢ºèª
    if (!dbi.objectStoreNames.contains(IMG_STORE)) {
      console.warn('[IDB] objectStore not found:', IMG_STORE);
      return null;
    }
    return new Promise((res) => {
      try {
        const tx = dbi.transaction(IMG_STORE, "readonly");
        const store = tx.objectStore(IMG_STORE);
        const req = store.get(key);
        req.onsuccess = () => res(req.result || null);
        req.onerror = (e) => {
          console.warn('[IDB] get failed:', e);
          res(null);
        };
      } catch (err) {
        console.warn('[IDB] transaction failed:', err);
        res(null);
      }
    });
  }

  function dataUrlToBlob(dataUrl) {
    try {
      const arr = dataUrl.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8 = new Uint8Array(n);
      while (n--) u8[n] = bstr.charCodeAt(n);
      return new Blob([u8], { type: mime });
    } catch(e){ return null; }
  }

  // âœ… dataURLtoBlobï¼ˆä¿å­˜ç”¨ã€ã‚ˆã‚Šå®‰å…¨ãªå®Ÿè£…ï¼‰
  function dataURLtoBlob(dataurl){
    try{
      const parts = String(dataurl).split(',');
      const head = parts[0] || '';
      const b64 = parts[1] || '';
      const m = head.match(/data:(.*?);base64/);
      const mime = (m && m[1]) ? m[1] : 'image/png';
      const bin = atob(b64);
      const u8 = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i);
      return new Blob([u8], { type: mime });
    }catch(e){
      return null;
    }
  }

  async function fileToThumbBlob(file, maxSide=256, quality=0.78) {
    return new Promise((resolve) => {
      const fr = new FileReader();
      fr.onload = () => {
        const img = new Image();
        img.onload = () => {
          const w = img.width, h = img.height;
          const scale = Math.min(1, maxSide / Math.max(w, h));
          const cw = Math.max(1, Math.round(w * scale));
          const ch = Math.max(1, Math.round(h * scale));
          const canvas = document.createElement('canvas');
          canvas.width = cw; canvas.height = ch;
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = "#fff";
          ctx.fillRect(0,0,cw,ch);
          // âœ… EXIFæƒ…å ±ã¯è‡ªå‹•ã§å‰Šé™¤ã•ã‚Œã‚‹ï¼ˆcanvas.drawImageã§å†æç”»ã™ã‚‹ãŸã‚ï¼‰
          ctx.drawImage(img, 0,0,cw,ch);
          canvas.toBlob((blob) => {
            resolve(blob || null);
          }, 'image/jpeg', quality);
        };
        img.onerror = () => resolve(null);
        img.src = fr.result;
      };
      fr.onerror = () => resolve(null);
      fr.readAsDataURL(file);
    });
  }

  // ========= ç”»åƒã‚’Firebaseã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆSDKç‰ˆï¼šAuth + DB Ruleså¯¾å¿œï¼‰ =========
  async function uploadImageToFirebase(code, blob) {
    // Firebase SDK ãŒæœ‰åŠ¹ãªå ´åˆã¯SDKç‰ˆã‚’ä½¿ç”¨
    if (isFirebaseReady && firebaseDb && currentAuthUid) {
      try {
        // Blobã‚’base64ã«å¤‰æ›
        const dataUrl = await new Promise((resolve, reject) => {
          const fr = new FileReader();
          fr.onload = () => resolve(fr.result);
          fr.onerror = () => reject(new Error('ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—'));
          fr.readAsDataURL(blob);
        });

        const imageId = 'img_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9);
        const imageRecord = {
          owner: currentAuthUid,  // âœ… auth.uid ã‚’ä½¿ç”¨
          imageUrl: dataUrl,
          createdAt: Date.now()
        };

        // Firebase SDKï¼ˆdatabaseï¼‰ã§ä¿å­˜
        const ref = firebaseDb.ref(`smart_price_images/${code}/${imageId}`);
        await ref.set(imageRecord);

        if (isDebug()) console.log('[Firebase SDK] Image uploaded:', imageId);
        return { imageId, owner: currentAuthUid };

      } catch(e) {
        if (isDebug()) console.warn('[Firebase SDK] Upload failed, fallback to REST:', e);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: RESTç‰ˆã‚’å®Ÿè¡Œ
      }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: RESTç‰ˆï¼ˆå¾“æ¥æ–¹å¼ï¼‰
    if (!fbUrl) {
      throw new Error('Firebase URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    }

    const dataUrl = await new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => resolve(fr.result);
      fr.onerror = () => reject(new Error('ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—'));
      fr.readAsDataURL(blob);
    });

    const deviceId = getDeviceId();
    const imageId = 'img_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9);
    const imageRecord = {
      owner: deviceId,  // ãƒ¬ã‚¬ã‚·ãƒ¼: deviceId
      imageUrl: dataUrl,
      createdAt: Date.now()
    };

    const imageUrl = getImageUrl(fbUrl, code, imageId);
    await fetchWithTimeout(imageUrl, {
      method: 'PUT',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(imageRecord)
    }, 15000);

    return { imageId, owner: deviceId };
  }

  // ========= å…±æœ‰ç”»åƒã‚’å–å¾—ï¼ˆSDKç‰ˆï¼šãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤ºç”¨ï¼‰ =========
  async function getSharedImages(code) {
    // Firebase SDK ãŒæœ‰åŠ¹ãªå ´åˆã¯SDKç‰ˆã‚’ä½¿ç”¨
    if (isFirebaseReady && firebaseDb) {
      try {
        const ref = firebaseDb.ref(`smart_price_images/${code}`);
        const snapshot = await ref.once('value');
        const data = snapshot.val();
        
        if (!data || typeof data !== 'object') return [];
        
        const images = [];
        for (const [imageId, record] of Object.entries(data)) {
          if (record && typeof record === 'object' && record.imageUrl) {
            images.push({ imageId, record });
          }
        }
        
        if (isDebug()) console.log('[Firebase SDK] Loaded images:', images.length);
        return images;

      } catch(e) {
        if (isDebug()) console.warn('[Firebase SDK] Get images failed, fallback to REST:', e);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: RESTç‰ˆã‚’å®Ÿè¡Œ
      }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: RESTç‰ˆï¼ˆå¾“æ¥æ–¹å¼ï¼‰
    if (!fbUrl) return [];
    try {
      const listUrl = getImageListUrl(fbUrl, code);
      const res = await fetchWithTimeout(listUrl, {}, 10000);
      const data = await res.json();
      if (!data || typeof data !== 'object') return [];
      
      const images = [];
      for (const [imageId, record] of Object.entries(data)) {
        if (record && typeof record === 'object' && record.imageUrl) {
          images.push({ imageId, record });
        }
      }
      return images;
    } catch(e) {
      if (isDebug()) console.warn('[getSharedImages]', e);
      return [];
    }
  }

  // ========= è‡ªåˆ†ã®ç”»åƒã‚’å–å¾—ï¼ˆSDKç‰ˆï¼šownerç¢ºèªï¼‰ =========
  async function getMyImages(code) {
    const allImages = await getSharedImages(code);
    
    // Firebase SDK ãŒæœ‰åŠ¹ãªå ´åˆã¯ auth.uid ã§åˆ¤å®š
    if (isFirebaseReady && currentAuthUid) {
      return allImages.filter(img => img.owner === currentAuthUid);
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: deviceId ã§åˆ¤å®š
    const deviceId = getDeviceId();
    return allImages.filter(img => img.owner === deviceId);
  }

  // ========= ç”»åƒã‚’å‰Šé™¤ï¼ˆSDKç‰ˆï¼šDB Rulesã§å¼·åˆ¶ï¼‰ =========
  async function deleteImageFromFirebase(code, imageId) {
    // Firebase SDK ãŒæœ‰åŠ¹ãªå ´åˆã¯SDKç‰ˆã‚’ä½¿ç”¨ï¼ˆDB Rules ã§æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼‰
    if (isFirebaseReady && firebaseDb && currentAuthUid) {
      try {
        const ref = firebaseDb.ref(`smart_price_images/${code}/${imageId}`);
        
        // ownerç¢ºèª
        const snapshot = await ref.once('value');
        const record = snapshot.val();
        
        if (!record) {
          throw new Error('ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
        
        if (record.owner !== currentAuthUid) {
          throw new Error('å‰Šé™¤æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆæŠ•ç¨¿è€…ã®ã¿å‰Šé™¤å¯èƒ½ï¼‰');
        }
        
        // å‰Šé™¤ï¼ˆDB Rulesã§ã‚‚æ¨©é™ãƒã‚§ãƒƒã‚¯ã•ã‚Œã‚‹ï¼‰
        await ref.remove();
        
        if (isDebug()) console.log('[Firebase SDK] Image deleted:', imageId);
        return;

      } catch(e) {
        if (isDebug()) console.warn('[Firebase SDK] Delete failed:', e);
        throw e;  // ã‚¨ãƒ©ãƒ¼ã‚’å†ã‚¹ãƒ­ãƒ¼
      }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: RESTç‰ˆï¼ˆå¾“æ¥æ–¹å¼ï¼‰
    if (!fbUrl) {
      throw new Error('Firebase URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    }

    // ownerç¢ºèª
    const imageUrl = getImageUrl(fbUrl, code, imageId);
    const res = await fetchWithTimeout(imageUrl, {}, 8000);
    const record = await res.json();
    
    if (!record || record.owner !== getDeviceId()) {
      throw new Error('å‰Šé™¤æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆæŠ•ç¨¿è€…ã®ã¿å‰Šé™¤å¯èƒ½ï¼‰');
    }

    // å‰Šé™¤
    await fetchWithTimeout(imageUrl, {
      method: 'DELETE'
    }, 8000);
  }

  // âœ… ç”»åƒã‚­ãƒ¼ã®å¾©å…ƒãƒ­ã‚¸ãƒƒã‚¯å¼·åŒ–ï¼ˆå¤ã„ç´ã¥ã‘ã‚‚æ¢ç´¢ï¼‰
  async function applyImageKeyToImg(imgEl, key) {
    if (!imgEl || !key) {
      return Promise.reject(new Error('Invalid parameters'));
    }
    try {
      // 1. ã¾ãšæŒ‡å®šã•ã‚ŒãŸã‚­ãƒ¼ã§å–å¾—
      let blob = await idbGet(key);
      if (blob) {
        const url = URL.createObjectURL(blob);
        imgEl.src = url;
        imgEl.referrerPolicy = "no-referrer";
        // ãƒ¡ãƒ¢ãƒªè§£æ”¾ï¼ˆç½®æ›æ™‚ï¼‰
        if (imgEl.dataset && imgEl.dataset.objurl) {
          try { URL.revokeObjectURL(imgEl.dataset.objurl); } catch(e) {}
        }
        imgEl.dataset.objurl = url;
        return Promise.resolve();
      }
      
      // 2. æŒ‡å®šã•ã‚ŒãŸã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€å¤ã„ã‚­ãƒ¼ã‚’æ¢ç´¢
      const dbi = await openImgDb();
      if (!dbi || !dbi.objectStoreNames.contains(IMG_STORE)) {
        return Promise.reject(new Error('Image not found in IndexedDB'));
      }
      
      // IndexedDBã‹ã‚‰å…¨ã‚­ãƒ¼ã‚’å–å¾—
      const allKeys = await new Promise((resolve) => {
        try {
          const tx = dbi.transaction(IMG_STORE, "readonly");
          const store = tx.objectStore(IMG_STORE);
          const req = store.getAllKeys();
          req.onsuccess = () => resolve(req.result || []);
          req.onerror = () => resolve([]);
        } catch(e) {
          resolve([]);
        }
      });
      
      // 3. å¤ã„ã‚­ãƒ¼ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è©¦ã™ï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰
      // ã‚­ãƒ¼ã‹ã‚‰ãƒãƒ¼ã‚³ãƒ¼ãƒ‰éƒ¨åˆ†ã‚’æŠ½å‡ºï¼ˆä¾‹ï¼šimg_1234567890123 â†’ 1234567890123ï¼‰
      const codeMatch = key.match(/img_([0-9]+)/);
      if (codeMatch && codeMatch[1]) {
        const code = codeMatch[1];
        // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®ã‚­ãƒ¼ã‚’æ¢ã™ï¼ˆimg_${code} ã¾ãŸã¯ img_${code}_*ï¼‰
        const candidateKeys = allKeys.filter(k => {
          const kStr = String(k);
          return kStr.includes(code) && (kStr.startsWith('img_') || kStr.includes('_img_'));
        });
        
        // å€™è£œã‚­ãƒ¼ã‚’è©¦ã™ï¼ˆæœ€ã‚‚é•·ã„ã‚­ãƒ¼ã‹ã‚‰è©¦ã™ï¼‰
        candidateKeys.sort((a, b) => String(b).length - String(a).length);
        for (const candidateKey of candidateKeys) {
          blob = await idbGet(candidateKey);
          if (blob) {
            const url = URL.createObjectURL(blob);
            imgEl.src = url;
            imgEl.referrerPolicy = "no-referrer";
            if (imgEl.dataset && imgEl.dataset.objurl) {
              try { URL.revokeObjectURL(imgEl.dataset.objurl); } catch(e) {}
            }
            imgEl.dataset.objurl = url;
            if (isDebug()) console.log('[applyImageKeyToImg] Found old key:', candidateKey, 'for', key);
            return Promise.resolve();
          }
        }
      }
      
      // 4. ãã‚Œã§ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
      return Promise.reject(new Error('Image not found in IndexedDB (tried fallback)'));
    } catch(e) {
      if (isDebug()) console.warn('[applyImageKeyToImg]', e);
      return Promise.reject(e);
    }
  }

  // ========= Home Image Fix (base64 + IndexedDBå¯¾å¿œ) =========
  async function spBindItemImage(imgEl, item, last) {
    if (!imgEl || !item) return;
    
    // å„ªå…ˆé †ä½ï¼šlast.imageData â†’ item.imageData â†’ last.imageKey â†’ item.imageKey â†’ last.imageUrl â†’ item.imageUrl â†’ placeholder
    
    // 1. base64ãƒ‡ãƒ¼ã‚¿ï¼ˆimageDataï¼‰ãŒã‚ã‚Œã°å„ªå…ˆ
    if (last && last.imageData && typeof last.imageData === 'string' && last.imageData.startsWith('data:')) {
      imgEl.src = last.imageData;
      return;
    }
    if (item.imageData && typeof item.imageData === 'string' && item.imageData.startsWith('data:')) {
      imgEl.src = item.imageData;
      return;
    }
    
    // 2. IndexedDBï¼ˆimageKeyï¼‰ãŒã‚ã‚Œã°å–å¾—
    if (last && last.imageKey && typeof last.imageKey === 'string') {
      await applyImageKeyToImg(imgEl, last.imageKey);
      return;
    }
    if (item.imageKey && typeof item.imageKey === 'string') {
      await applyImageKeyToImg(imgEl, item.imageKey);
      return;
    }
    
    // 3. HTTP/HTTPS URLï¼ˆimageUrlï¼‰ãŒã‚ã‚Œã°ä½¿ç”¨
    if (last && last.imageUrl && typeof last.imageUrl === 'string' && 
        (last.imageUrl.startsWith('http://') || last.imageUrl.startsWith('https://'))) {
      imgEl.src = last.imageUrl;
      return;
    }
    if (item.imageUrl && typeof item.imageUrl === 'string' && 
        (item.imageUrl.startsWith('http://') || item.imageUrl.startsWith('https://'))) {
      imgEl.src = item.imageUrl;
      return;
    }
    
    // 4. ã©ã‚Œã‚‚ãªã‘ã‚Œã°placeholder
    imgEl.src = placeholderImg();
  }

  // ========= P0/P1: LocalStorage Cache & User Profile =========
  
  /**
   * P1: ãƒ©ãƒ³ãƒ€ãƒ ãªUIDã‚’ç”Ÿæˆï¼ˆu_ã‹ã‚‰å§‹ã¾ã‚‹12æ–‡å­—ï¼‰
   */
  function generateUid() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let uid = 'u_';
    for (let i = 0; i < 10; i++) {
      uid += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return uid;
  }

  /**
   * P1: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ï¼ˆLocalStorageï¼‰
   * @returns {object} { uid, areaId, invitedBy, createdAt }
   */
  function getUserProfile() {
    try {
      const json = localStorage.getItem('smartPrice_userProfile');
      if (json) {
        const profile = JSON.parse(json);
        // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œè¨¼
        if (profile.uid) {
          return profile;
        }
      }
    } catch(e) {
      if (isDebug()) console.warn('[UserProfile] Failed to load:', e);
    }
    return null;
  }

  /**
   * P1: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ï¼ˆLocalStorageï¼‰
   * @param {object} profile { uid, areaId, invitedBy, createdAt }
   */
  function setUserProfile(profile) {
    try {
      localStorage.setItem('smartPrice_userProfile', JSON.stringify(profile));
      if (isDebug()) console.log('[UserProfile] Saved:', profile);
    } catch(e) {
      if (isDebug()) console.error('[UserProfile] Failed to save:', e);
    }
  }

  /**
   * P1: URLã‹ã‚‰æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Š
   * @returns {string|null} invite code (ä¾‹: "XXXX") ã¾ãŸã¯ null
   */
  function parseInviteCode() {
    try {
      const params = new URL(location.href).searchParams;
      const invite = params.get('invite');
      if (invite && invite.trim().length > 0) {
        return invite.trim();
      }
    } catch(e) {
      if (isDebug()) console.warn('[InviteCode] Failed to parse:', e);
    }
    return null;
  }

  /**
   * P0: JANã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å–å¾—ï¼ˆLocalStorageï¼‰
   * @param {string} jan 
   * @returns {object|null} { name, maker, imageUrl, imageRefType, areaId, cachedAt }
   */
  function getJanCache(jan) {
    try {
      const key = `smartPrice_jan_${jan}`;
      const json = localStorage.getItem(key);
      if (json) {
        const data = JSON.parse(json);
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ï¼ˆ7æ—¥é–“ï¼‰
        if (data.cachedAt) {
          const now = Date.now();
          const age = now - data.cachedAt;
          if (age > 7 * 24 * 60 * 60 * 1000) {
            // æœŸé™åˆ‡ã‚Œ
            localStorage.removeItem(key);
            return null;
          }
        }
        return data;
      }
    } catch(e) {
      if (isDebug()) console.warn('[JanCache] Failed to load:', jan, e);
    }
    return null;
  }

  /**
   * P0: JANã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜ï¼ˆLocalStorageï¼‰
   * @param {string} jan 
   * @param {object} data { name, maker, imageUrl, imageRefType, areaId, source }
   */
  function setJanCache(jan, data) {
    try {
      const userProfile = getUserProfile();
      const cacheData = {
        data,
        cachedAt: Date.now(),
        areaId: data.areaId || (userProfile ? userProfile.areaId : null)
      };
      const key = `smartPrice_jan_${jan}`;
      localStorage.setItem(key, JSON.stringify(cacheData));
      if (isDebug()) console.log('[JanCache] Saved:', jan, cacheData);
    } catch(e) {
      if (isDebug()) console.error('[JanCache] Failed to save:', jan, e);
    }
  }

  // ========= App State =========
  let db = { products: {}, config: JSON.parse(JSON.stringify(DEFAULT_CONFIG)) };
  let curBarcode = null, curStore = "", curStoreId = "";
  try{ curStore = localStorage.getItem('sp.curStore') || curStore; }catch(e){}
  try{ curStoreId = localStorage.getItem('sp.curStoreId') || curStoreId; }catch(e){}

  // --- Store selection (tap) ---
  function setCurStore(storeName, storeId="") {
    try{
      curStore = String(storeName || "");
      curStoreId = String(storeId || "");
      // local persistence (è»½ã„ä¿é™º)
      try{ localStorage.setItem('sp.curStore', curStore); }catch(e){}
      try{ localStorage.setItem('sp.curStoreId', curStoreId); }catch(e){}

      // UI reflect
      try{ renderStoreList(); }catch(e){}

      // save (æ—¢å­˜ã®ä¿å­˜é–¢æ•°ã«å¯„ã›ã‚‹)
      try{ if (typeof saveDb === 'function') saveDb(); }catch(e){}
    }catch(e){
      showToast("JSã‚¨ãƒ©ãƒ¼: "+(e && e.message ? e.message : String(e)), 12000);
    }
  }
  let processBarcodeInFlight = new Set(); // âœ… P0: åŒä¸€JANã®äºŒé‡ç™ºç«é˜²æ­¢
  let janCoolDown = new Map(); // âœ… P0: åŒã˜JANã‚’0.8ã€œ1.2ç§’ä»¥å†…ã«å†æ¤œå‡ºã—ãŸã‚‰ç„¡è¦–ï¼ˆã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰
  let tempImgData = null; // {type:'key', key} or {type:'url', url}
  let scanner = null, editingHistIdx = null, isScanning = false;
  let deferredPrompt = null; // âœ… PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

  // âœ… ã“ã“ã¯å¿…ãš letï¼ˆconst ã«ã™ã‚‹ã¨ "Assignment to constant variable" ã®åŸå› ã«ãªã‚‹ï¼‰
  let fbUrl = localStorage.getItem('smartPriceFirebaseUrl') || '';

  // ========= Config.json (Yahoo Proxy URL) =========
  window.SP_CONFIG = {};

  
  // âœ… P0: å¤–éƒ¨æ¤œç´¢å®Œå…¨é®æ–­ï¼ˆDB/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã¿ï¼‰
  window.SP_P0_DB_ONLY = false;
let isGpsOn = false, curPos = null, lastGpsTime = "";
  let activeSyncController = null;
  // âœ… åŒæœŸãƒ­ãƒƒã‚¯ï¼ˆäºŒé‡èµ·å‹•é˜²æ­¢ï¼‰
  let syncInFlight = false;
  let syncQueued = false;
  
  // âœ… è¿‘éš£åº—èˆ—å€™è£œï¼ˆGPS/ç”Ÿæ´»åœã‹ã‚‰å–å¾—ï¼‰
  window.nearbyStoreNames = [];

  // ========= Config.jsonèª­ã¿è¾¼ã¿ =========
  async function loadConfig() {
    try {
      const b = new URLSearchParams(location.search).get("b") || "";
      const configUrl = "./config.json" + (b ? ("?b=" + encodeURIComponent(b)) : "");
      
      // âœ… ãƒ‡ãƒãƒƒã‚°: configèª­è¾¼é–‹å§‹
      if (isDebug()) {
        const fullUrl = new URL(configUrl, location.href).href;
        showToast(`[Config] Loading from: ${fullUrl}`, 5000);
        console.log('[Config] Loading from:', fullUrl);
      }
      
      const res = await fetch(configUrl, { cache: "no-store" });
      
      // âœ… ãƒ‡ãƒãƒƒã‚°: HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
      if (isDebug()) {
        showToast(`[Config] HTTP Status: ${res.status} ${res.statusText}`, 5000);
        console.log('[Config] HTTP Status:', res.status, res.statusText);
      }
      
      if (res.ok) {
        const json = await res.json();
        try{ window.__lastStoresFetch.raw = json; }catch(_e){}
        window.SP_CONFIG = json || {};
        if (isDebug()) {
          showToast(`[Config] Loaded OK: ${JSON.stringify(json).substring(0, 100)}`, 5000);
          console.log('[Config] Loaded:', window.SP_CONFIG);
        }
      } else {
        window.SP_CONFIG = {};
        if (isDebug()) {
          console.warn('[Config] Failed to load, using default');
          showToast('Configèª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½¿ç”¨ï¼‰', 10000);
        }
      }
    } catch(e) {
      window.SP_CONFIG = {};
      if (isDebug()) {
        console.warn('[Config] Error:', e);
        showToast('Configèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + (e.message || 'ä¸æ˜'), 10000);
      }
    }
  }

  // ========= ç«¯æœ«IDï¼ˆæŠ•ç¨¿è€…IDï¼‰ç”Ÿæˆãƒ»ä¿æŒ =========
  function getDeviceId() {
    let deviceId = localStorage.getItem('smartPriceDeviceId');
    if (!deviceId) {
      // ç«¯æœ«IDã‚’ç”Ÿæˆï¼ˆãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ—ï¼‰
      deviceId = 'dev_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 11);
      localStorage.setItem('smartPriceDeviceId', deviceId);
    }
    return deviceId;
  }

  window.onload = async () => {
    // âœ… P0: ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤ºã¯SSOTã§çµ±ä¸€
    try{ applyVersionUI(); }catch(e){}

    // âœ… èµ·å‹•æ™‚ã®é»’ç”»é¢å¯¾ç­–ï¼šå³åº§ã«è¡¨ç¤ºã‚’ç¢ºå®Ÿã«ã™ã‚‹
    try {
      document.body.style.display = 'block';
      const mainView = document.getElementById('mainView');
      if (mainView) mainView.style.display = 'block';
    } catch(e) {
      if (isDebug()) console.warn('[onload] display error:', e);
    }

    try {
      // âœ… Config.jsonèª­ã¿è¾¼ã¿ï¼ˆYahoo Proxy URLï¼‰
      await loadConfig();

      // âœ… ä¿ç®¡ç®±ã®ä¿è­·ï¼ˆè‡ªå‹•æ•´ç†ã•ã‚Œã«ããã™ã‚‹ï¼‰
      if ('storage' in navigator && 'persist' in navigator.storage) {
        try {
          const persisted = await navigator.storage.persist();
          if (isDebug()) console.log('[Storage] Persist granted:', persisted);
        } catch(e) {
          if (isDebug()) console.warn('[Storage] Persist failed:', e);
        }
      }

      // âœ… FirebaseåˆæœŸåŒ–ï¼ˆåŒ¿åãƒ­ã‚°ã‚¤ãƒ³ï¼‰
      await initializeFirebase();
      setupAuthListener();

      loadLocal();
      db = normalizeDb(db);

      // æ—§data:imageãŒæ®‹ã£ã¦ã„ã‚‹ç«¯æœ«ã¯ã€IndexedDBã¸ç§»è¡Œã—ã¦ç”»åƒå¾©æ´»
      await migrateLegacyImagesToIdb();

      // âœ… M_å•†å“ã¨JANã®è‡ªå‹•çµ±åˆï¼ˆèµ·å‹•æ™‚ãƒ»YahooæˆåŠŸã«ä¾å­˜ã—ãªã„ï¼‰
      migrateMergeManualToJan();

      initCategorySelect();
      renderStoreList();
      renderHistory();

      if (fbUrl) {
        await syncFirebase(); // âœ… ãƒãƒ¼ã‚¸æ–¹å¼ã§ç”»åƒãŒæ¶ˆãˆãªã„
        renderHistory();
        renderStoreList();
      }

      setupFocusGuides();

      // âœ… èµ·å‹•æ™‚ã«è¿‘éš£åº—èˆ—ã‚’å–å¾—ï¼ˆGPS OFF ã§ã‚‚ç”Ÿæ´»åœãŒã‚ã‚Œã°å–å¾—ï¼‰
      try {
        const nearbyStores = await fetchNearbyStores();
        if (nearbyStores && nearbyStores.length > 0) {
          window.nearbyStoreNames = nearbyStores;
          renderStoreList(); // è¿‘éš£åº—èˆ—ã‚’åæ˜ ã—ã¦å†æç”»
          if (isDebug()) console.log('[onload] Nearby stores loaded:', nearbyStores.length);
        }
      } catch(e) {
        if (isDebug()) console.warn('[onload] fetchNearbyStores failed:', e);
      }

      if (isDebug()) {
        // âœ… P0: debug=1ã®ã¨ãã ã‘ã‚¹ã‚­ãƒ£ãƒ³ã‚¬ã‚¤ãƒ‰æ ã‚’è¡¨ç¤º
        document.body.setAttribute('data-debug', '1');
        setTimeout(() => {
          showToast(`DEBUG:${VERSION_INFO.FULL} / ${BUILD_ID} / Firebase:${isFirebaseReady?'ON':'OFF'}`, 4000);
        }, 300);
      } else {
        document.body.removeAttribute('data-debug');
      }
    } catch(e) {
      showToast(`èµ·å‹•ã‚¨ãƒ©ãƒ¼: ${e.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`, 10000);
      if (isDebug()) console.error('[onload]', e);
    }
  };

  // âœ… pageshowã‚¤ãƒ™ãƒ³ãƒˆã§ã‚‚åˆæœŸåŒ–ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯å¯¾ç­–ï¼‰
  window.addEventListener("pageshow", async (e) => {
    if (e.persisted) {
      // ãƒãƒƒã‚¯ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å¾©å¸°ã—ãŸå ´åˆ
      renderHistory();
      renderStoreList();
    }
  });

  // âœ… PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆAndroid/PC Chrome/Edgeï¼‰
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    if (isDebug()) console.log('[PWA] Install prompt captured');
    
    // âœ… webModalãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯å³åº§ã«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    const webModal = document.getElementById('webModal');
    const installBtn = document.getElementById('pwaInstallBtn');
    if (webModal && webModal.style.display === 'flex' && installBtn) {
      installBtn.style.display = 'block';
      if (isDebug()) console.log('[PWA] Install button shown (modal is open)');
    }
  });

  window.addEventListener("pageshow", resetSyncBtn);
  window.addEventListener("beforeunload", resetSyncBtn);
  document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
      resetSyncBtn();
      if (activeSyncController) activeSyncController.abort();
    }
  });

  function resetSyncBtn() {
    const btn = document.getElementById('syncBtn');
    if (btn) {
      btn.disabled = false;
      btn.innerText = "è¨­å®šä¿å­˜ã¨åŒæœŸ";
    }
  }

  // âœ… P0ä¿®æ­£: ã‚¹ã‚­ãƒ£ãƒ³èµ·å‹•ã‚¨ãƒ©ãƒ¼ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºæ™‚é–“ã‚’å»¶é•·ï¼ˆæœ€ä½12ç§’ã€æ¨å¥¨15ç§’ï¼‰
  let lastToastTimeout = null;
  let lastToastElement = null;
  
  function showToast(msg, ms=2500) {
    const el = document.getElementById('toast');
    if (!el) return;

    // --- style ---
    const isErr = (typeof msg === 'string') && (msg.startsWith('JSã‚¨ãƒ©ãƒ¼') || msg.startsWith('ã‚¨ãƒ©ãƒ¼') || msg.includes('ReferenceError') || msg.includes('SyntaxError'));
    el.classList.toggle('is-error', !!isErr);

    // --- duration ---
    const isDebug = !!getQueryParam('debug');
    let dur = Number(ms) || 2500;
    if (isDebug) {
      // debugä¸­ã¯ã‚¹ã‚¯ã‚·ãƒ§ã—ã‚„ã™ã„é•·ã•ã«
      dur = Math.max(dur, isErr ? 30000 : 12000);
    }

    // --- show ---
    clearTimeout(window.__toastTimer);
    el.textContent = String(msg ?? '');
    el.classList.add('show');

    // ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹ï¼ˆã‚¹ã‚¯ã‚·ãƒ§/ã‚³ãƒ”ãƒ¼ã®é‚ªé­”ã‚’ã—ãªã„ï¼‰
    if (!el.__boundClick) {
      el.__boundClick = true;
      el.addEventListener('click', () => {
        el.classList.remove('show');
      }, { passive: true });
    }

    window.__toastTimer = setTimeout(() => {
      el.classList.remove('show');
    }, dur);
  }

// Alias: some code paths expect saveDb()
function saveDb(){
  try { saveLocalOnly(); } catch(e) { /* ignore */ }
}

// æ—¢å­˜ã®Service Workerã‚’è§£é™¤ï¼ˆPCçœŸã£é»’å¯¾ç­–ï¼‰
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.getRegistrations().then(function(registrations) {
    for(let registration of registrations) {
      registration.unregister();
    }
  });
}


// ====== P1: ç°¡æ˜“ã€Œãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã€(ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶å‘ã‘)
function openWebDirect(){
  try {
    const url = buildUrl(false);
    window.open(url, '_blank');
  } catch(e){}
  closeWebModal();
}

// ====== ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆåˆè¨€è‘‰ï¼‰
function openAdminGate(){
  try{ window.openAdminGate = openAdminGate; }catch(e){}
  const m = document.getElementById('adminGateModal');
  if(!m) return;
  const inp = document.getElementById('adminPassInput');
  if(inp) inp.value = '';
  m.style.display = "flex";
}
function closeAdminGate(){
  const m = document.getElementById('adminGateModal');
  if(m) m.style.display = "none";
}
function enterAdmin(){
  const inp = document.getElementById('adminPassInput');
  const pass = (inp && inp.value) ? String(inp.value) : '';
  if(pass !== '55533557'){
    // ã‚„ã•ã—ãä½•ã‚‚ã—ãªã„ï¼ˆèª¤å…¥åŠ›æ™‚ã«æƒ…å ±ã‚’å‡ºã•ãªã„ï¼‰
    return;
  }
  closeAdminGate();
  openAdmin();
}
function openAdmin(){
  const m = document.getElementById('adminModal');
  if(!m) return;
  // Proxy URL è¡¨ç¤ºï¼ˆç®¡ç†ã®ã¿ï¼‰
  try{
    const p = document.getElementById('adminProxyUrl');
    if(p) p.value = getProxyExecUrl();
  }catch(e){}

  // URLç”Ÿæˆ
  try{
    const n = document.getElementById('adminUrlNormal');
    const d = document.getElementById('adminUrlDebug');
    if(n) n.value = buildUrl(false);
    if(d) d.value = buildUrl(true);
  }catch(e){}
  // åŒæœŸå…ˆè¡¨ç¤ºï¼ˆå¤‰æ›´ä¸å¯ï¼‰
  try{
    const fb = document.getElementById('adminFbUrl');
    if(fb){
      const fbInput = document.getElementById('fb-url-input');
      fb.value = (fbInput && fbInput.value) ? fbInput.value : '';
    }
  }catch(e){}
  // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ï¼ˆç®¡ç†ã®ã¿ï¼‰
  try{
    const btn = document.getElementById('pwaInstallBtnAdmin');
    if(btn){
      btn.style.display = (typeof deferredPrompt !== 'undefined' && deferredPrompt) ? 'block' : 'none';
    }
  }catch(e){}
  m.style.display = "flex";
}
function closeAdmin(){
  const m = document.getElementById('adminModal');
  if(m) m.style.display = "none";
}
function copyText(id){
  try{
    const el = document.getElementById(id);
    if(!el) return;
    el.select();
    document.execCommand('copy');
  }catch(e){}
}
function openUrlFromBox(id){
  try{
    const el = document.getElementById(id);
    if(!el) return;
    const url = String(el.value||'');
    if(url) window.open(url, '_blank');
  }catch(e){}
}
function openDiagnostics(){
  try{
    const base = location.origin + location.pathname.replace(/\/dev\/?$/, '/dev/');
    const url = base + 'diagnostics.html?b=' + encodeURIComponent(BUILD_ID);
    window.open(url, '_blank');
  }catch(e){}
}
















// ===== PATCH (legacy) (force-blank hard fix: openSettings fill / mergeDb / city chips / store list / openWeb alias) =====
(function(){
  // force-blank flag
  window.getForceBlank = function(){
    try{ return localStorage.getItem('sp_city_force_blank') === '1'; }catch(e){ return false; }
  };
  window.setForceBlank = function(on){
    try{ if(on) localStorage.setItem('sp_city_force_blank','1'); else localStorage.removeItem('sp_city_force_blank'); }catch(e){}
  };

  function applyForceBlankToDb(){
    try{
      db = normalizeDb(db);
      if(!db.config) db.config={};
      db.config.homeCity = '';
      db.config.homeCities = [];
      db.config.customStores = [];
      db.config.storeTaxModes = {};
    }catch(e){}
    try{ curStore = "æœªè¨­å®š"; }catch(e){}
  }

  function repaintForceBlankUI(){
    try{
      const cityInput=document.getElementById('home-city-input');
      if(cityInput) cityInput.value='';
      const chipArea=document.getElementById('city-history-chips');
      if(chipArea) chipArea.innerHTML='';
    }catch(e){}
    try{
      // store indicator
      const ind=document.getElementById('curStoreIndicator');
      if(ind) ind.innerText = "ã€ æœªè¨­å®š ã€‘ã§ä¿å­˜ã—ã¾ã™";
    }catch(e){}
    try{
      // store list: forceBlankã§ã‚‚å€™è£œè¡¨ç¤ºã¯ç¶­æŒï¼ˆGPS/å®Ÿç¸¾ï¼‰
      if(typeof renderStoreList==='function') renderStoreList();
    }catch(e){} }



  function forceBlankNow(){
    window.setForceBlank(true);
    applyForceBlankToDb();
    try{ if(typeof saveLocalOnly==='function') saveLocalOnly(); }catch(e){}
    repaintForceBlankUI();
  }

  // 1) openSettings: fillæŠ‘æ­¢ï¼ˆã“ã“ãŒä¸€ç•ªå¼·ã„ï¼‰
  const _orig_openSettings = (typeof openSettings === 'function') ? openSettings : null;
  if(_orig_openSettings){
    openSettings = function(){
      const r=_orig_openSettings();
      try{
        if(window.getForceBlank && window.getForceBlank()){ forceBlankNow(); }
      }catch(e){}
      // watcher attach
      setTimeout(attachCityWatcher, 0);
      return r;
    };
  }

  // 2) city input watcher: input/change/blur å…¨éƒ¨ã§æ‹¾ã†
  function attachCityWatcher(){
    const el=document.getElementById('home-city-input');
    if(!el || el.__sp_watch2) return;
    el.__sp_watch2=true;
    const handler=()=>{
      const v=((el.value||'')+'').trim();
      if(v==='') forceBlankNow();
      else window.setForceBlank(false);
    };
    el.addEventListener('input', handler);
    el.addEventListener('change', handler);
    el.addEventListener('blur', handler);
  }
  document.addEventListener('DOMContentLoaded', ()=>setTimeout(attachCityWatcher, 0));

  // 3) normalizeDb: force_blankãªã‚‰æœ€å¾Œã«å¿…ãšä¸Šæ›¸ãï¼ˆhomeCitieså†ç”Ÿæˆã‚‚æ½°ã™ï¼‰
  const _orig_normalizeDb = (typeof normalizeDb === 'function') ? normalizeDb : null;
  if(_orig_normalizeDb){
    normalizeDb = function(raw){
      const out=_orig_normalizeDb(raw);
      try{
        if(window.getForceBlank && window.getForceBlank()){
          if(!out.config) out.config={};
          out.config.homeCity='';
          out.config.homeCities=[];
          out.config.customStores=[];
          out.config.storeTaxModes={};
        }
      }catch(e){}
      return out;
    };
  }

  // 4) mergeDb: syncã®ãƒãƒ¼ã‚¸ã§ã€Œç©ºãŒè² ã‘ã‚‹ã€ã‚’æ½°ã™ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰/ãƒ­ãƒ¼ã‚«ãƒ«ã©ã£ã¡ã§ã‚‚ï¼‰
  const _orig_mergeDb = (typeof mergeDb === 'function') ? mergeDb : null;
  if(_orig_mergeDb){
    mergeDb = function(localDb, cloudDb){
      const out=_orig_mergeDb(localDb, cloudDb);
      try{
        if(window.getForceBlank && window.getForceBlank()){
          if(!out.config) out.config={};
          out.config.homeCity='';
          out.config.homeCities=[];
          out.config.customStores=[];
          out.config.storeTaxModes={};
        }
      }catch(e){}
      return out;
    };
  }

  // 5) renderCityChips: force_blankæ™‚ã¯å¿…ãšç©ºè¡¨ç¤º
  const _orig_renderCityChips = (typeof renderCityChips === 'function') ? renderCityChips : null;
  if(_orig_renderCityChips){
    renderCityChips = function(){
      if(window.getForceBlank && window.getForceBlank()){
        const chipArea=document.getElementById('city-history-chips');
        if(chipArea) chipArea.innerHTML='';
        return;
      }
      return _orig_renderCityChips();
    };
  }

  // 6) renderStoreList: force_blankã§ã‚‚ã€Œå€™è£œè¡¨ç¤ºã€ã¯ç¶­æŒï¼ˆæœªè¨­å®šã ã‘ã«ã—ãªã„ï¼‰
  const _orig_renderStoreList = (typeof renderStoreList === 'function') ? renderStoreList : null;
  if(_orig_renderStoreList){
    renderStoreList = function(manualPriority=[]){
      // force_blank ã¯ã€Œå¸‚ç”ºæ‘ãƒãƒƒãƒ—éè¡¨ç¤ºã€ç”¨é€”ã ãŒã€ã‚¹ãƒˆã‚¢å€™è£œã¯è¡¨ç¤ºã—ã¦OKï¼ˆåˆå›ãŒè©°ã¾ã‚‹ãŸã‚ï¼‰
      try{
        if(window.getForceBlank && window.getForceBlank()){
          applyForceBlankToDb();
          repaintForceBlankUI();
        }
      }catch(e){}
      return _orig_renderStoreList(manualPriority);
    };
  }

  // 7) startMigration: åŒæœŸå¾Œã«å¿…ãšå†é©ç”¨
  const _orig_startMigration = (typeof startMigration === 'function') ? startMigration : null;
  if(_orig_startMigration){
    startMigration = async function(){
      const el=document.getElementById('home-city-input');
      const v=(((el?el.value:'')||'')+'').trim();
      if(v==='') window.setForceBlank(true); else window.setForceBlank(false);
      const ret = await _orig_startMigration();
      if(window.getForceBlank && window.getForceBlank()){ forceBlankNow(); }
      return ret;
    };
  }

  // 8) openWebSimple alias: HTML onclick è§£æ±ºã®æºã‚Œã‚’æ½°ã™ï¼ˆå¿…ãšã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ï¼‰
  if(typeof window.openWebSimple === 'function') {
    try{ window.openWebSimple = window.openWebSimple; }catch(e){}
    try{ openWebSimple = window.openWebSimple; }catch(e){}
  }

  // èµ·å‹•æ™‚ã«ã‚‚åæ˜ 
  try{ if(window.getForceBlank && window.getForceBlank()) setTimeout(forceBlankNow, 120); }catch(e){}

})();
// ===== /PATCH =====


// ===== PATCH (legacy) [GLOBAL FN FIX + OPENWEB FALLBACK] =====
(function(){
  try {
    // ç®¡ç†åˆè¨€è‘‰ãŒé€šã£ãŸã‚‰ trueï¼ˆæ—¢å­˜ enterAdmin ã‚’å®‰å…¨ã«æ‹¡å¼µï¼‰
    if (typeof window.__sp_admin_ok !== 'boolean') window.__sp_admin_ok = false;
    if (typeof enterAdmin === 'function' && !enterAdmin.__patched) {
      const _origEnterAdmin = enterAdmin;
      enterAdmin = function(){
        try{
          const inp = document.getElementById('adminPassInput');
          const pass = (inp && inp.value) ? String(inp.value) : '';
          if (pass === '55533557') { window.__sp_admin_ok = true; try{ localStorage.setItem('sp_admin_ok_dev','1'); }catch(e){} }
        }catch(e){}
        return _origEnterAdmin.apply(this, arguments);
      };
      enterAdmin.__patched = true;
    }
    // èµ·å‹•æ™‚ã«ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ãƒ©ã‚°å¾©å…ƒ
    try{ if(localStorage.getItem('sp_admin_ok_dev')==='1') window.__sp_admin_ok = true; }catch(e){}

    // ---- å‹äººç´¹ä»‹ / å®¶æ—å…±æœ‰ï¼šonclick ã‹ã‚‰å¿…ãšå‘¼ã¹ã‚‹ã‚ˆã†ã« window ã«å…¬é–‹ ----
    window.openInviteModal = window.openInviteModal || function(kind){
      try{
        const modal = document.getElementById('inviteModal');
        if(!modal) return;
        const titleEl = document.getElementById('inviteTitle');
        const bodyEl  = document.getElementById('inviteBody');
        const txtEl   = document.getElementById('inviteCopyText');
        const isFamily = (kind === 'family');
        if(titleEl) titleEl.textContent = isFamily ? 'å®¶æ—å…±æœ‰' : 'å‹äººç´¹ä»‹';
        if(bodyEl) bodyEl.style.color = '#fff';

        const base = window.location.href.split('#')[0].split('?')[0];
        const link = base + '?ref=' + encodeURIComponent(String(currentUserId||''));
        const msg = isFamily
          ? 'å®¶æ—ã§ä½¿ãˆã‚‹è²·ã„ç‰©ãƒ¡ãƒ¢ã€ŒSmart Priceã€ã§ã™ã€‚\nè³¼å…¥å±¥æ­´ã¯ç¬¬ä¸‰è€…ã«å…±æœ‰ã•ã‚Œã¾ã›ã‚“ã€‚\n' + link
          : 'è²·ã„ç‰©ã®ç›®å®‰ãŒåˆ†ã‹ã‚‹ã€ŒSmart Priceã€ã§ã™ã€‚\nè³¼å…¥å±¥æ­´ã¯ç¬¬ä¸‰è€…ã«å…±æœ‰ã•ã‚Œã¾ã›ã‚“ã€‚\n' + link;
        if(txtEl) txtEl.textContent = msg;
        modal.style.display = 'flex';
      }catch(e){ try{ console.error(e); }catch(_e){} }
    };

    window.closeInviteModal = window.closeInviteModal || function(){
      const modal = document.getElementById('inviteModal');
      if(modal) modal.style.display = 'none';
    };

    window.shareInvite = window.shareInvite || async function(mode){
      try{
        const txt = (document.getElementById('inviteCopyText')||{}).textContent || '';
        if(!txt) return;
        if (navigator.share && mode === 'share') {
          await navigator.share({ text: txt });
          return;
        }
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(txt);
          showToast && showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
          return;
        }
        // clipboardä¸å¯ã®ç«¯æœ«ã¯ã€é¸æŠã—ã‚„ã™ã„ã‚ˆã†ã« prompt
        window.prompt('ã“ã®æ–‡ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„', txt);
      }catch(e){
        try{ window.prompt('ã“ã®æ–‡ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„', (document.getElementById('inviteCopyText')||{}).textContent||''); }catch(_e){}
      }
    };

    // ---- ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãï¼šPWAã§ _blank ãŒåŠ¹ã‹ãªã„æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ ----
    window.openWebSimple = window.openWebSimple || function(){
      const url = window.location.href.split('#')[0].split('?')[0] + (window.DEFAULT_BUILD ? ('?b=' + encodeURIComponent(String(window.DEFAULT_BUILD))) : '');
      try{
        const w = window.open(url, '_blank', 'noopener,noreferrer');
        if(!w){
          // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯ç­‰
          window.prompt('ã“ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ãã ã•ã„', url);
        }
      }catch(e){
        window.prompt('ã“ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ãã ã•ã„', url);
      }
    };

  } catch(e) {}
})();
// ===== /PATCH (legacy) =====




// ===== PATCH (legacy) (ghostkill: forceBlank wins + startMigration explicit + mergeConfig override + city watcher hardened) =====
(function(){
  // --- helpers ---
  function q(id){ return document.getElementById(id); }
  function safeTrim(s){ return (s==null)?'':String(s).trim(); }

  // ensure get/set exist
  if(typeof window.getForceBlank!=='function') {
    window.getForceBlank = function(){ try{ return localStorage.getItem('sp_city_force_blank')==='1'; }catch(e){return false;} };
  }
  if(typeof window.setForceBlank!=='function') {
    window.setForceBlank = function(on){ try{ if(on) localStorage.setItem('sp_city_force_blank','1'); else localStorage.removeItem('sp_city_force_blank'); }catch(e){} };
  }

  // --- 1) mergeConfig: forceBlank/local blank must win over cloud defaults ---
  if(typeof window.mergeConfig==='function' && !window.__mergeConfigForceBlankWrapped) {
    const __origMergeConfig = window.mergeConfig;
    window.mergeConfig = function(cc, lc){
      const out = __origMergeConfig(cc, lc);
      try{
        const fb = (lc && lc.forceBlank===true) || (cc && cc.forceBlank===true) || window.getForceBlank();
        if(fb){
          out.forceBlank = true;
          out.homeCity = "";
          out.homeCities = [];
        }
      }catch(e){}
      return out;
    };
    window.__mergeConfigForceBlankWrapped = true;
  }

  // --- 2) startMigration: explicitly attach to window + forceBlank set/clear before sync ---
  if(typeof window.startMigration==='function' && !window.__startMigrationForceBlankWrapped) {
    const __origStartMigration = window.startMigration;
    window.startMigration = async function(){
      try{
        const cityInputEl = q('home-city-input');
        const city = safeTrim(cityInputEl ? cityInputEl.value : '');
        const blank = (city === '');
        window.setForceBlank(blank);

        // reflect to db.config immediately (cloud mergeå¯¾ç­–)
        try{
          if(typeof window.db==='object' && window.db){
            if(!db.config) db.config={};
            db.config.forceBlank = blank;
            db.config.homeCity = blank ? "" : city;
            if(blank) db.config.homeCities = [];
          }
        }catch(e){}
      }catch(e){}

      const r = await __origStartMigration();

      // after sync, force-blank must win again (cloudãŒæˆ»ã—ã¦ã‚‚æœ€å¾Œã«æ¶ˆã™)
      try{
        if(window.getForceBlank && window.getForceBlank()){
          try{ if(!db.config) db.config={}; db.config.forceBlank=true; db.config.homeCity=""; db.config.homeCities=[]; }catch(e){}
          try{ if(typeof window.applyForceBlankToDb==='function') window.applyForceBlankToDb(); }catch(e){}
          try{
            const cityInputEl = q('home-city-input');
            if(cityInputEl) cityInputEl.value = "";
            const chips = q('city-history-chips');
            if(chips) chips.innerHTML = "";
          }catch(e){}
          try{ if(typeof window.repaint==='function') window.repaint(); }catch(e){}
        }
      }catch(e){}

      return r;
    };
    window.__startMigrationForceBlankWrapped = true;
  }

  // --- 3) openSettings: if forceBlank => always show empty city + no chips ---
  if(typeof window.openSettings==='function' && !window.__openSettingsForceBlankWrapped) {
    const __origOpenSettings = window.openSettings;
    window.openSettings = function(){
      const r = __origOpenSettings();
      try{
        if(window.getForceBlank && window.getForceBlank()){
          const cityInputEl = q('home-city-input');
          if(cityInputEl) cityInputEl.value = "";
          const chips = q('city-history-chips');
          if(chips) chips.innerHTML = "";
        }
      }catch(e){}
      return r;
    };
    window.__openSettingsForceBlankWrapped = true;
  }

  // --- 4) city input watcher: mobileã‚¤ãƒ™ãƒ³ãƒˆå–ã‚Šã“ã¼ã—å¯¾ç­–ï¼ˆinput/change/blur/keyupï¼‰ ---
  if(!window.__cityWatcherHardened){
    window.__cityWatcherHardened = true;
    function attach(){
      const el=q('home-city-input');
      if(!el) return;
      if(el.__sp_watch) return;
      el.__sp_watch=true;
      const handler=function(){
        const v=safeTrim(el.value);
        const blank=(v==='');
        window.setForceBlank(blank);
        try{ if(blank){ const chips=q('city-history-chips'); if(chips) chips.innerHTML=''; } }catch(e){}
      };
      ['input','change','blur','keyup'].forEach(ev=>el.addEventListener(ev, handler, {passive:true}));
    }
    attach();
    setTimeout(attach, 300);
    setTimeout(attach, 900);
  }

})();
// ===== /PATCH (legacy) =====

// ===== PATCH (legacy): Diagnostics Modal (GPSâ†’Store candidates) =====
function __diagEscapeHtml(s){
  return String(s||'').replace(/[&<>"]/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]||c));
}
function openDiagModal(){
  const m = document.getElementById('diagModal');
  if(!m) return;
  m.style.display = 'flex';
  updateDiagModal();
}
function closeDiagModal(){
  const m = document.getElementById('diagModal');
  if(m) m.style.display = 'none';
}
function clearDiagModal(){
  const st = document.getElementById('diagStatus');
  const list = document.getElementById('diagList');
  const raw = document.getElementById('diagRaw');
  if(st) st.textContent = '';
  if(list) list.innerHTML = '';
  if(raw) raw.value = '';
}
function updateDiagModal(){
  const st = document.getElementById('diagStatus');
  const list = document.getElementById('diagList');
  const raw = document.getElementById('diagRaw');

  const last = window.__lastStoresFetch || null;
  const names = (window.nearbyStoreNames && Array.isArray(window.nearbyStoreNames)) ? window.nearbyStoreNames : [];
  let cfg = window.__cfgCache || null;
  try{ if(!cfg && typeof getConfig==='function') cfg = getConfig(); }catch(_e){}
  const proxyUrl = (cfg && (cfg.yahooProxyExecUrl || cfg.proxyExecUrl)) ? (cfg.yahooProxyExecUrl || cfg.proxyExecUrl) : '';

  if(st){
    const lines = [];
    lines.push(`ProxyURL: ${proxyUrl ? proxyUrl : '(æœªè¨­å®š)'}`);
    lines.push(`GPS: ${window.currentPosition ? (window.currentPosition.lat.toFixed(5)+','+window.currentPosition.lng.toFixed(5)) : '(æœªå–å¾—)'}`);
    if(last){
      lines.push(`LastFetch: ${new Date(last.at||Date.now()).toLocaleString()} / status=${last.status} / ok=${last.ok} / count=${last.count}`);
      if(last.err) lines.push(`Error: ${last.err}`);
      if(last.url) lines.push(`URL: ${last.url}`);
    }else{
      lines.push('LastFetch: (ãªã—)');
    }
    lines.push(`nearbyStoreNames: ${names.length}ä»¶`);
    st.textContent = lines.join('\n');
  }

  if(list){
    if(names.length===0){
      list.innerHTML = '<div style="opacity:.8;">ï¼ˆ0ä»¶ï¼‰GPSâ†’å€™è£œå–å¾— ã‚’æŠ¼ã—ã¦ã­</div>';
    }else{
      list.innerHTML = names.map((n,i)=>`<div style="padding:6px 4px;border-bottom:1px solid rgba(255,255,255,.08);">${i+1}. ${__diagEscapeHtml(n)}</div>`).join('');
    }
  }

  if(raw){
    try{
      raw.value = last && last.raw ? JSON.stringify(last.raw, null, 2) : '';
    }catch(e){
      raw.value = '';
    }
  }
}

async function runDiagGps(){
  try{
    // 1) GPS
    const pos = await getCurrentPosition();
    window.currentPosition = pos;
    showToast(`GPSå–å¾—æˆåŠŸï¼ˆ${pos.lat.toFixed(4)}, ${pos.lng.toFixed(4)}ï¼‰`, 2500);

    // 2) ã‚¹ãƒˆã‚¢å€™è£œå–å¾—
    await fetchNearbyStores();
    updateDiagModal();

    // 3) ç”»é¢å´ã®ãƒãƒƒãƒ—ã‚‚æ›´æ–°ï¼ˆãƒ›ãƒ¼ãƒ ç”Ÿæ´»åœãŒç©ºã§ã‚‚è¿‘å‚å€™è£œã¯å‡ºã™ï¼‰
    try{ renderStoreList(''); }catch(_e){}
  }catch(e){
    console.error(e);
    showToast('GPSæ¤œè¨¼ã§å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™/é€šä¿¡ã‚’ç¢ºèªï¼‰', 4500);
    updateDiagModal();
  }
}

(function bindDiagModalOnce(){
  // æ—¢å­˜ã®åˆæœŸåŒ–ã¨å¹²æ¸‰ã—ãªã„ã‚ˆã†ã«ã€DOMãŒã§ããŸå¾Œã«ç´ã¥ã‘
  document.addEventListener('DOMContentLoaded', ()=>{
    const btnRun = document.getElementById('diagBtnRunGps');
    const btnClear = document.getElementById('diagBtnClear');
    const btnClose = document.getElementById('diagBtnClose');
    const modal = document.getElementById('diagModal');

    if(btnRun) btnRun.addEventListener('click', runDiagGps);
    if(btnClear) btnClear.addEventListener('click', ()=>{ clearDiagModal(); updateDiagModal(); });
    if(btnClose) btnClose.addEventListener('click', closeDiagModal);

    if(modal){
      // å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ï¼ˆèª¤æ“ä½œã‚’é¿ã‘ã‚‹ãŸã‚ï¼šä¸­èº«ä»¥å¤–ã ã‘ï¼‰
      modal.addEventListener('click', (ev)=>{
        if(ev.target === modal) closeDiagModal();
      });
    }
  }, { once:true });
})();
// ===== /PATCH (legacy) =====


/* ===== PATCH (legacy)hotfix (2026-01-24 22:34 JST) =====
   - è¨­å®šâ†’ã€Œãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã€: openWebModalã¸çµ±ä¸€
   - webModalå†…ãƒœã‚¿ãƒ³ï¼ˆé–‹ã/æˆ»ã‚‹ï¼‰ãŒåŠ¹ã‹ãªã„ç«¯æœ«å¯¾ç­–ï¼šonclickç”¨é–¢æ•°ã‚’å¿…ãšwindowã¸éœ²å‡º
   - UIã¯å¤‰æ›´ã—ãªã„ï¼ˆæŒ™å‹•ã®ã¿å¾©æ—§ï¼‰
===== */
(function(){
  function buildShareUrl(){
    try {
      const base = window.location.origin + window.location.pathname;
      const p = new URLSearchParams(window.location.search || '');
      const b = p.get('b') || window.DEFAULT_BUILD || '';
      if(!b) return base;
      return base + '?b=' + encodeURIComponent(String(b));
    } catch(e) {
      try {
        const base = window.location.href.split('#')[0].split('?')[0];
        const b = window.DEFAULT_BUILD || '';
        return b ? (base + '?b=' + encodeURIComponent(String(b))) : base;
      } catch(_e) {
        return window.location.href;
      }
    }
  }

  // web modal open/close
  window.openWebModal = window.openWebModal || function(){
    try {
      const m = document.getElementById('webModal');
      if(!m) return;
      const n = document.getElementById('webUrlNormal');
      if(n) n.value = buildShareUrl();
      m.style.display = 'flex';
    } catch(e) {}
  };
  window.closeWebModal = window.closeWebModal || function(){
    try {
      const m = document.getElementById('webModal');
      if(m) m.style.display = 'none';
    } catch(e) {}
  };
  window.openWebDirect = window.openWebDirect || function(){
    try {
      const url = buildShareUrl();
      const w = window.open(url, '_blank', 'noopener,noreferrer');
      if(!w) {
        window.prompt('ã“ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ãã ã•ã„', url);
      }
    } catch(e) {
      try {
        const url = buildShareUrl();
        window.prompt('ã“ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ãã ã•ã„', url);
      } catch(_e) {}
    }
    try { window.closeWebModal(); } catch(e) {}
  };

})();
/* ===== /PATCH (legacy)hotfix ===== */

/* ===== PATCH (legacy)hotfix (2026-01-25 00:01 JST) =====
- è¨­å®šå†…ã®ä¸‹æ®µãƒœã‚¿ãƒ³ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã/å‹äººç´¹ä»‹/å®¶æ—å…±æœ‰/ç®¡ç†ï¼‰ãŒåå¿œã—ãªã„ç«¯æœ«ã‚’æœ€çµ‚å¯¾ç­–
- åŸå› ã®ã€Œwindowæœªéœ²å‡ºã€ã‚„ã€ŒDOMå†ç”Ÿæˆã§onclickãŒæ­»ã¬ã€ã‚’ä¸¡æ–¹å¸åï¼ˆUIå¤‰æ›´ãªã—ï¼‰
- æ—¢å­˜å®Ÿè£…ãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆã—ã€ç„¡ã‘ã‚Œã°å®‰å…¨ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’æä¾›
===== */
(function(){
  try{
    // ---- 1) æ—¢å­˜é–¢æ•°ã‚’ window ã«ç¢ºå®Ÿã«éœ²å‡ºï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰----
    if(typeof openWebModal === 'function') window.openWebModal = openWebModal;
    if(typeof closeWebModal === 'function') window.closeWebModal = closeWebModal;
    if(typeof openWebDirect === 'function') window.openWebDirect = openWebDirect;

    if(typeof openAdminGate === 'function') window.openAdminGate = openAdminGate;
    if(typeof closeAdminGate === 'function') window.closeAdminGate = closeAdminGate;
    if(typeof enterAdmin === 'function') window.enterAdmin = enterAdmin;
    // äº’æ›ï¼šæ—§ãƒœã‚¿ãƒ³å unlockAdmin() â†’ ç¾è¡Œ enterAdmin()
    if(typeof window.unlockAdmin !== 'function'){
      window.unlockAdmin = function(){ try{ if(typeof window.enterAdmin === 'function') return window.enterAdmin(); }catch(e){} };
    }

    // ---- 2) å‹äººç´¹ä»‹/å®¶æ—å…±æœ‰ï¼šç„¡ã„å ´åˆã ã‘ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’æä¾›ï¼ˆç©ºé–¢æ•°ã«ã¯ã—ãªã„ï¼‰----
    if(typeof window.openInviteModal !== 'function'){
      window.openInviteModal = function(kind){
        try{
          const modal = document.getElementById('inviteModal');
          if(!modal) return;
          const titleEl = document.getElementById('inviteTitle');
          const txtEl   = document.getElementById('inviteCopyText');
          const isFamily = (kind === 'family');
          if(titleEl) titleEl.textContent = isFamily ? 'å®¶æ—å…±æœ‰' : 'å‹äººç´¹ä»‹';

          // currentUserId ã¯æœ¬ä½“ã§ const å®šç¾©æ¸ˆã¿ï¼ˆæœªå®šç¾©ãªã‚‰ç©ºï¼‰
          let uid = '';
          try{ uid = (typeof currentUserId !== 'undefined' && currentUserId) ? String(currentUserId) : ''; }catch(e){ uid = ''; }

          const base = window.location.href.split('#')[0].split('?')[0];
          const link = base + '?ref=' + encodeURIComponent(uid);
          const msg = (isFamily
            ? 'å®¶æ—ã§ä½¿ãˆã‚‹è²·ã„ç‰©ãƒ¡ãƒ¢ã€ŒSmart Priceã€ã§ã™ã€‚\nè³¼å…¥å±¥æ­´ã¯ç¬¬ä¸‰è€…ã«å…±æœ‰ã•ã‚Œã¾ã›ã‚“ã€‚\n'
            : 'è²·ã„ç‰©ã®ç›®å®‰ãŒåˆ†ã‹ã‚‹ã€ŒSmart Priceã€ã§ã™ã€‚\nè³¼å…¥å±¥æ­´ã¯ç¬¬ä¸‰è€…ã«å…±æœ‰ã•ã‚Œã¾ã›ã‚“ã€‚\n'
          ) + link;

          if(txtEl) txtEl.textContent = msg;
          modal.style.display = 'flex';
        }catch(e){}
      };
    }
    if(typeof window.closeInviteModal !== 'function'){
      window.closeInviteModal = function(){ const m=document.getElementById('inviteModal'); if(m) m.style.display='none'; };
    }
    if(typeof window.shareInvite !== 'function'){
      window.shareInvite = async function(){
        try{
          const txt = (document.getElementById('inviteCopyText')||{}).textContent || '';
          if(navigator.share) return navigator.share({ text: txt });
          if(navigator.clipboard && navigator.clipboard.writeText) await navigator.clipboard.writeText(txt);
        }catch(e){}
      };
    }

    // ---- 3) DOMå†ç”Ÿæˆã§ã‚‚æ­»ãªãªã„ã‚ˆã†ã€Œè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒœã‚¿ãƒ³ã€ã‚’éƒ½åº¦é…ç·šã—ç›´ã™ ----
    function wireSettingsButtons(){
      const modal = document.getElementById('settingsModal');
      if(!modal) return;
      const btns = Array.from(modal.querySelectorAll('button'));
      const pick = (label) => btns.find(b => (b.textContent||'').trim() === label);

      const bWeb = pick('ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã');
      if(bWeb) bWeb.onclick = function(){ try{ (window.openWebModal||openWebModal)(); }catch(e){} };

      const bFriend = pick('å‹äººç´¹ä»‹');
      if(bFriend) bFriend.onclick = function(){ try{ (window.openInviteModal)('friend'); }catch(e){} };

      const bFamily = pick('å®¶æ—å…±æœ‰');
      if(bFamily) bFamily.onclick = function(){ try{ (window.openInviteModal)('family'); }catch(e){} };

      const bAdmin = pick('ç®¡ç†');
      if(bAdmin) bAdmin.onclick = function(){ try{ (window.openAdminGate||openAdminGate)(); }catch(e){} };
    }

    // åˆå›ï¼‹ã€Œè¨­å®šã‚’é–‹ã„ãŸç›´å¾Œã€ã«ã‚‚é…ç·š
    wireSettingsButtons();

    if(typeof openSettings === 'function'){
      const _orig = openSettings;
      window.openSettings = function(){
        try{ _orig(); }catch(e){}
        try{ wireSettingsButtons(); }catch(e){}
      };
    }

    // ä¸‡ä¸€ã€ã‚¢ãƒ—ãƒªå´ãŒ innerHTML å†æç”»ã™ã‚‹ç’°å¢ƒå‘ã‘ã«é…å»¶ã§ã‚‚ã†ä¸€å›ã ã‘
    setTimeout(function(){ try{ wireSettingsButtons(); }catch(e){} }, 50);
  }catch(e){}
})();
/* ===== /PATCH (legacy)hotfix ===== */



</script>

</div>


<!-- Invite Modal (General / no-bootstrap) -->
<div id="inviteModal" class="modal-view" style="display:none;">
  <div class="card p-3 shadow-lg" style="max-width:520px; margin:0 auto;">
    <div class="text-center fw-bold mb-2" id="inviteTitle">å‹äººç´¹ä»‹</div>
    <div class="small text-white mb-2" id="inviteLead" style="color:#fff;">é€ã‚‹å…ˆã‚’é¸ã‚“ã§ãã ã•ã„</div>

    <div class="p-3 mb-3" style="background:#111; border-radius:12px; border:1px solid #333;">
      <div class="fw-bold mb-2">é€ã‚‹æ–‡</div>
      <div class="small" id="inviteCopyText" style="white-space:pre-wrap;"></div>
    </div>

    <div class="d-grid gap-2">
      <button class="btn btn-success py-2 fw-bold" onclick="shareInvite('line')">LINEã§é€ã‚‹</button>
      <button class="btn btn-primary py-2 fw-bold" onclick="shareInvite('mail')">ãƒ¡ãƒ¼ãƒ«ã§é€ã‚‹</button>
      <button class="btn btn-outline-light py-2 fw-bold" onclick="shareInvite('copy')">ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>

    <div class="small text-white mt-3">
      â€»ã“ã®ã‚¢ãƒ—ãƒªã¯<strong>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸è¦</strong>ã§ã™ã€‚å¿…ãš<strong>ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦</strong>ä½¿ã£ã¦ãã ã•ã„ã€‚<br>
      â€»è³¼å…¥å±¥æ­´ã¯<strong>ä»–äººã«ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“</strong>ï¼ˆæœ¬äººã®ç«¯æœ«ã ã‘ï¼‰ã€‚ã‚µãƒ¼ãƒå´ã«ã¯ç§˜åŒ¿ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™ã€‚
    </div>

    <div class="text-center mt-3">
      <button class="btn btn-link text-secondary" onclick="closeInviteModal()">æˆ»ã‚‹</button>
    </div>
  </div>
</div>

<!-- Admin Gate Modal (no-bootstrap) -->
<div id="adminGateModal" class="modal-view" style="display:none;">
  <div class="card p-3 shadow-lg" style="max-width:420px; margin:0 auto;">
    <div class="text-center fw-bold mb-2">ç®¡ç†</div>
    <div class="small text-white mb-2">åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
    <input id="adminPassInput" type="password" class="form-control bg-dark text-white border-secondary mb-3" placeholder="åˆè¨€è‘‰">

    <div class="d-grid gap-2">
      <button class="btn btn-danger py-2 fw-bold" onclick="unlockAdmin()">é–‹ã</button>
    </div>

    <div class="text-center mt-3">
      <button class="btn btn-link text-secondary" onclick="closeAdminGate()">æˆ»ã‚‹</button>
    </div>
  </div>
</div>


<!-- ===== Diagnostics Modal (GPS Store Tool) ===== -->
<div id="diagModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:720px;">
    <h3 style="margin:0 0 10px 0;">æ¤œè¨¼ãƒ„ãƒ¼ãƒ«ï¼ˆGPSâ†’ã‚¹ãƒˆã‚¢å€™è£œï¼‰</h3>
    <div style="font-size:13px;opacity:.9;line-height:1.5;margin-bottom:10px;">
      ã“ã“ã¯ã€ŒGPSå–å¾—â†’è¿‘ãã®åº—å€™è£œã‚’å–ã‚‹ã€ã ã‘ã‚’ç¢ºèªã™ã‚‹ç”»é¢ã§ã™ã€‚<br>
      â€»ã‚³ãƒ³ãƒ“ãƒ‹ã¯è‡ªå‹•ã§é™¤å¤–ã—ã¾ã™ã€‚
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin:10px 0;">
      <button class="btn btn-primary" id="diagBtnRunGps">GPSâ†’å€™è£œå–å¾—</button>
      <button class="btn" id="diagBtnClear">çµæœã‚¯ãƒªã‚¢</button>
      <button class="btn btn-secondary" id="diagBtnClose">é–‰ã˜ã‚‹</button>
    </div>
    <div id="diagStatus" style="margin:8px 0;font-size:13px;white-space:pre-wrap;color:#000;background:#fff;border:1px solid #ccc;padding:8px;border-radius:8px;min-height:72px;">ï¼ˆã“ã“ã« ProxyURL / status / count ãŒå‡ºã¾ã™ï¼‰</div>
    <div style="margin-top:10px;">
      <div style="font-weight:600;margin-bottom:6px;">å€™è£œãƒªã‚¹ãƒˆ</div>
      <div id="diagList" style="max-height:220px;overflow:auto;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:10px;"></div>
    </div>
    <div style="margin-top:10px;">
      <div style="font-weight:600;margin-bottom:6px;">ç”Ÿãƒ­ã‚°ï¼ˆæœ€æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰</div>
      <textarea id="diagRaw" style="width:100%;height:160px;background:rgba(0,0,0,.35);color:#fff;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:10px;font-size:12px;"></textarea>
    </div>
  </div>
</div>
<!-- ===== /Diagnostics Modal ===== -->



<!-- ===== PATCH (legacy)initfix (2026-01-25 00:25 JST) =====
- Fix: èµ·å‹•æ™‚ã®æ—¢å®šã‚¹ãƒˆã‚¢ã‚’ã€Œæœªè¨­å®šã€ã«ã—ãªã„ï¼ˆæœªè¨­å®šOFFã§é–‹å§‹ï¼‰
- Fix: GPS åˆå›ONã§ã‚¹ãƒˆã‚¢å€™è£œãŒå‡ºãªã„ã“ã¨ãŒã‚ã‚‹ â†’ 1å›ã ã‘æ¡ä»¶å¤‰æ›´ã—ã¦è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤
- Fix: è¨­å®šã®ä¸‹æ®µãƒœã‚¿ãƒ³ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶/å‹äººç´¹ä»‹/å®¶æ—å…±æœ‰/ç®¡ç†ï¼‰ãŒç’°å¢ƒã«ã‚ˆã£ã¦ç„¡åå¿œ â†’ windowã¸å®Ÿä½“ã‚’å¼·åˆ¶ãƒã‚¤ãƒ³ãƒ‰ï¼ˆno-opä¸Šæ›¸ãç¦æ­¢ï¼‰
- UIå¤‰æ›´ãªã—
===== -->
<script>
(function(){
  try{
    // 1) èµ·å‹•æ™‚ï¼šæœªè¨­å®šã‚’å‹æ‰‹ã«ONã«ã—ãªã„
    try{ if (typeof curStore !== 'undefined' && curStore === 'æœªè¨­å®š') curStore = ''; }catch(e){}
    try{
      // ä»¥å‰ã®ä¿å­˜ãŒã€Œæœªè¨­å®šã€ã§ã‚‚ã€èµ·å‹•æ™‚ã¯OFFï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŠ¼ã—ãŸæ™‚ã ã‘ONï¼‰
      const s = localStorage.getItem('lastStoreName');
      if(s === 'æœªè¨­å®š') localStorage.setItem('lastStoreName', '');
    }catch(e){}

    // 2) inline onclick ã®â€œé…ç·šâ€ã‚’å¿…ãšç”Ÿã‹ã™ï¼ˆç©ºé–¢æ•°ã§ä¸Šæ›¸ãã—ãªã„ï¼‰
    var forceBind = function(name, fn){
      try{
        if(typeof fn === 'function') window[name] = fn;
      }catch(e){}
    };

    // settings
    forceBind('openSettings', (typeof openSettings==='function')?openSettings:null);
    forceBind('closeSettings', (typeof closeSettings==='function')?closeSettings:null);
    forceBind('startMigration', (typeof startMigration==='function')?startMigration:null);

    // web modal
    forceBind('openWebModal', (typeof openWebModal==='function')?openWebModal:null);
    forceBind('closeWebModal', (typeof closeWebModal==='function')?closeWebModal:null);
    forceBind('openWebDirect', (typeof openWebDirect==='function')?openWebDirect:null);

    // invite
    if(typeof openInviteModal === 'function'){
      window.openInviteModal = openInviteModal;
    } else {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šæœ€ä½é™ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
      window.openInviteModal = function(kind){
        try{
          const m = document.getElementById('inviteModal');
          if(!m) return;
          const t = document.getElementById('inviteTitle');
          if(t) t.innerText = (kind==='family'?'å®¶æ—å…±æœ‰':'å‹äººç´¹ä»‹');
          m.style.display='flex';
        }catch(e){}
      };
    }
    forceBind('closeInviteModal', (typeof closeInviteModal==='function')?closeInviteModal:null);
    forceBind('shareInvite', (typeof shareInvite==='function')?shareInvite:null);

    // admin
    forceBind('openAdminGate', (typeof openAdminGate==='function')?openAdminGate:null);
    forceBind('closeAdminGate', (typeof closeAdminGate==='function')?closeAdminGate:null);
    forceBind('enterAdmin', (typeof enterAdmin==='function')?enterAdmin:null);
    // Gateå†…ãƒœã‚¿ãƒ³ã¯ unlockAdmin() ã‚’å‘¼ã¶ã®ã§ã€ç¢ºå®Ÿã« enterAdmin ã«æ¥ç¶š
    window.unlockAdmin = function(){
      try{
        if(typeof window.enterAdmin === 'function') return window.enterAdmin();
        if(typeof enterAdmin === 'function') return enterAdmin();
      }catch(e){}
    };

    // æœ€å¾Œã«ï¼šè¨­å®šãŒé–‹ã„ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚‚é…ç·šã‚’ã‹ã‘ç›´ã™ï¼ˆå†æç”»å¯¾ç­–ï¼‰
    try{
      const _os = window.openSettings;
      if(typeof _os === 'function'){
        window.openSettings = function(){
          const r = _os.apply(this, arguments);
          setTimeout(function(){
            try{
              forceBind('openWebModal', (typeof openWebModal==='function')?openWebModal:null);
              if(typeof openInviteModal==='function') window.openInviteModal=openInviteModal;
              forceBind('openAdminGate', (typeof openAdminGate==='function')?openAdminGate:null);
            }catch(e){}
          }, 0);
          return r;
        };
      }
    }catch(e){}
  }catch(e){}
})();
</script>
<!-- ===== /PATCH (legacy)initfix ===== -->

<script>
/* ===== PATCH (legacy)gpsfirst-back-admin (2026-01-25 00:15 JST) =====
- èµ·å‹•ç›´å¾Œ: GPS 1å›ç›®ONã§ã‚¹ãƒˆã‚¢åãŒå‡ºãªã„å•é¡Œã‚’ã€Œç©ºçµæœãªã‚‰1å›ã ã‘å†å–å¾—ã€ã—ã¦å®‰å®šåŒ–
- è¨­å®š: æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆcloseWebModal/closeInviteModalï¼‰ã®å®Ÿä½“ã‚’å¿…ãšæœ‰åŠ¹åŒ–
- ç®¡ç†: unlockAdmin() ã‚’ openAdminGate() ã«ç¢ºå®Ÿã«æ¥ç¶š
- UIå¤‰æ›´ãªã—ï¼ˆé…ç·šã¨å†å–å¾—ã®ã¿ï¼‰
===== */
(function(){
  try {
    if (typeof applyVersionUI === 'function') applyVersionUI();
  } catch(e) {}

  function _spShow(id, on){
    try {
      var el = document.getElementById(id);
      if(!el) return false;
      el.style.display = on ? 'flex' : 'none';
      return true;
    } catch(e) { return false; }
  }

  // Back (web modal)
  try {
    if (typeof window.closeWebModal !== 'function') {
      window.closeWebModal = function(){ _spShow('webModal', false); };
    }
    if (typeof window.openWebModal !== 'function' && typeof openWebModal === 'function') {
      window.openWebModal = openWebModal;
    }
    if (typeof window.openWebDirect !== 'function' && typeof openWebDirect === 'function') {
      window.openWebDirect = openWebDirect;
    }
  } catch(e) {}

  // Back (invite modal)
  try {
    if (typeof window.closeInviteModal !== 'function') {
      window.closeInviteModal = function(){ _spShow('inviteModal', false); };
    }
    if (typeof window.openInviteModal !== 'function' && typeof openInviteModal === 'function') {
      window.openInviteModal = openInviteModal;
    }
    if (typeof window.shareInvite !== 'function' && typeof shareInvite === 'function') {
      window.shareInvite = shareInvite;
    }
  } catch(e) {}

  // Admin (onclick="unlockAdmin()")
  try {
    if (typeof window.unlockAdmin !== 'function') {
      window.unlockAdmin = function(){
        try {
          if (typeof openAdminGate === 'function') return openAdminGate();
          if (typeof window.openAdminGate === 'function') return window.openAdminGate();
          _spShow('adminGateModal', true);
        } catch(e) {}
      };
    }
    if (typeof window.openAdminGate !== 'function' && typeof openAdminGate === 'function') window.openAdminGate = openAdminGate;
    if (typeof window.closeAdminGate !== 'function' && typeof closeAdminGate === 'function') window.closeAdminGate = closeAdminGate;
    if (typeof window.enterAdmin !== 'function' && typeof enterAdmin === 'function') window.enterAdmin = enterAdmin;
  } catch(e) {}

  // GPS first ON: if no stores, retry fetch once
  try {
    if (typeof window.toggleGps === 'function' && typeof window.__toggleGpsPatched2030 === 'undefined') {
      window.__toggleGpsPatched2030 = true;
      var _origToggleGps = window.toggleGps;
      window.toggleGps = function(){
        var wasOn = false;
        try { wasOn = (typeof isGpsOn !== 'undefined') ? !!isGpsOn : false; } catch(e){}
        var r = _origToggleGps.apply(this, arguments);

        try {
          if (!wasOn && (typeof isGpsOn !== 'undefined') && isGpsOn) {
            setTimeout(function(){
              (async function(){
                try {
                  var near = Array.isArray(window.nearbyStoreNames) ? window.nearbyStoreNames : [];
                  var cnt = 0;
                  for (var i=0;i<near.length;i++) if (near[i]) cnt++;
                  if (cnt === 0 && typeof fetchNearbyStores === 'function') {
                    var got = await fetchNearbyStores();
                    if (got && got.length) window.nearbyStoreNames = got;
                    if (typeof renderStoreList === 'function') renderStoreList();
                  }
                } catch(e) {}
              })();
            }, 900);
          }
        } catch(e) {}

        return r;
      };
    }
  } catch(e) {}

})();


/* ===== PATCH (legacy)gps1st-back-adminfix (2026-01-25 00:28 JST) =====
- GPS åˆå›ONã§ã‚¹ãƒˆã‚¢å€™è£œãŒå‡ºãªã„å ´åˆï¼š1å›ã ã‘è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤
- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã€Œæˆ»ã‚‹ã€ç³»ãƒœã‚¿ãƒ³ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶/å‹äººç´¹ä»‹/å®¶æ—å…±æœ‰ï¼‰ã® close ç³»ã‚’ window ã«ç¢ºå®Ÿå›ºå®š
- ç®¡ç†ãƒœã‚¿ãƒ³ï¼ˆunlockAdminï¼‰ã‚’ openAdminGate/enterAdmin ã«ç¢ºå®Ÿæ¥ç¶š
- UIå¤‰æ›´ãªã—ï¼ˆé…ç·šã®ã¿ï¼‰
===== */
(function(){
  try{
    // --- close ç³»ï¼ˆæˆ»ã‚‹ï¼‰ã‚’ç¢ºå®Ÿã«å®Ÿä½“åŒ– ---
    window.closeWebModal = function(){
      try{ const m=document.getElementById('webModal'); if(m) m.style.display='none'; }catch(e){}
    };
    window.closeInviteModal = function(){
      try{ const m=document.getElementById('inviteModal'); if(m) m.style.display='none'; }catch(e){}
    };
    window.closeAdminGate = function(){
      try{ const m=document.getElementById('adminGateModal'); if(m) m.style.display='none'; }catch(e){}
    };

    // --- ç®¡ç†ãƒœã‚¿ãƒ³åã®äº’æ›ï¼šunlockAdmin() â†’ openAdminGate()ï¼ˆãªã‘ã‚Œã°enterAdminï¼‰ ---
    window.unlockAdmin = function(){
      try{ if(typeof window.openAdminGate==='function') return window.openAdminGate(); }catch(e){}
      try{ if(typeof window.enterAdmin==='function') return window.enterAdmin(); }catch(e){}
    };

    // --- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«å†…ãƒœã‚¿ãƒ³ã‚’â€œæ–‡å­—â€ã§é…ç·šï¼ˆç’°å¢ƒå·®ã§onclickãŒæ­»ã¬ã®ã‚’å›é¿ï¼‰ ---
    const wireSettingsButtons = function(){
      try{
        const modal = document.getElementById('settingsModal');
        if(!modal) return;
        const btns = Array.from(modal.querySelectorAll('button, .btn, .setting-btn'));
        const findByText = (t)=> btns.find(b=> (b.textContent||'').trim()===t);
        const bWeb = findByText('ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã');
        const bInv = findByText('å‹äººç´¹ä»‹');
        const bFam = findByText('å®¶æ—å…±æœ‰');
        const bAdm = findByText('ç®¡ç†');

        if(bWeb) bWeb.onclick = function(){ try{ if(typeof window.openWebModal==='function') window.openWebModal(); }catch(e){} };
        if(bInv) bInv.onclick = function(){ try{ if(typeof window.openInviteModal==='function') window.openInviteModal('friend'); }catch(e){} };
        if(bFam) bFam.onclick = function(){ try{ if(typeof window.openInviteModal==='function') window.openInviteModal('family'); }catch(e){} };
        if(bAdm) bAdm.onclick = function(){ try{ window.unlockAdmin(); }catch(e){} };
      }catch(e){}
    };

    // openSettings ã®ãŸã³ã«é…ç·šã—ç›´ã™ï¼ˆinnerHTMLå†æç”»ã§ã‚‚å¾©æ´»ï¼‰
    if(typeof window.openSettings==='function' && !window.openSettings.__wired){
      const orig = window.openSettings;
      const wrapped = function(){
        const r = orig.apply(this, arguments);
        setTimeout(wireSettingsButtons, 0);
        return r;
      };
      wrapped.__wired = true;
      window.openSettings = wrapped;
    }

    // èµ·å‹•æ™‚ã«ã‚‚1å›ã ã‘ï¼ˆå¿µã®ãŸã‚ï¼‰
    setTimeout(wireSettingsButtons, 0);
  }catch(e){}
})();
/* ===== /PATCH (legacy)gps1st-back-adminfix ===== */

</script>

<script>
/* ===== PATCH (legacy)settings-directshare-admin-gpsfast (2026-01-25 00:35 JST) =====
- GPS: åˆå›ONå¾Œã®ã€ŒåŒæœŸå®Œäº†â†’ã‚¹ãƒˆã‚¢è¡¨ç¤ºã€ãŒé…ã„ä»¶ã‚’çŸ­ç¸®ï¼ˆç©ºã®ã¨ãã ã‘æœ€å°å¾…ã¡ã§å†å–å¾—ï¼‰
- è¨­å®š: ã€Œãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã€ã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‡ºã•ãšâ€œç›´æ¥é–‹ãâ€
- å‹äººç´¹ä»‹/å®¶æ—å…±æœ‰: LINE/ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒœã‚¿ãƒ³ã‚’å®Ÿè£…ï¼ˆshareInvite(mode)ï¼‰
- æˆ»ã‚‹: closeInviteModal / closeAdminGate / closeWebModal ã‚’ç¢ºå®Ÿã«å‹•ä½œã•ã›ã‚‹
- ç®¡ç†: è¨­å®šâ†’ç®¡ç† ã§ adminGateModal ã‚’å¿…ãšé–‹ãï¼ˆunlockAdmin ã‚‚åŒã˜æŒ™å‹•ï¼‰
- UIå¤‰æ›´ãªã—ï¼ˆå†…éƒ¨é…ç·šã®ã¿ï¼‰
===== */
(function(){
  'use strict';

  function $(id){ return document.getElementById(id); }
  function safe(fn){ try{ return fn(); }catch(e){} }
  function showToastSafe(msg, ms){
    if(typeof window.showToast === 'function') return safe(()=>window.showToast(msg, ms||2000));
  }

  // 1) GPS first ON: faster + only-when-empty retry
  (function(){
    if(typeof window.toggleGps !== 'function') return;

    if(!window.__gpsToggleWrapped){
      window.__gpsToggleWrapped = true;
      const orig = window.toggleGps;

      window.toggleGps = async function(){
        const ret = safe(()=>orig());

        const gpsBtn = document.querySelector('.store-tag.gps-btn');
        const isOn = gpsBtn ? gpsBtn.classList.contains('on') : (window.isGpsOn===true);

        if(isOn){
          if(typeof window.renderStoreList === 'function') safe(()=>window.renderStoreList());

          // ç©ºã®ã¨ãã ã‘å†å–å¾—ï¼ˆçŸ­ã„å¾…ã¡ã§æœ€å¤§2å›ï¼‰
          if(!window.__gpsFirstRetryDone){
            window.__gpsFirstRetryDone = true;

            const tryRetry = async () => {
              const names = window.nearbyStoreNames;
              const empty = !names || !Array.isArray(names) || names.length===0;
              if(!empty) return;

              if(typeof window.fetchNearbyStores === 'function'){ try{ await window.fetchNearbyStores(); }catch(e){} }
              if(typeof window.renderStoreList === 'function') safe(()=>window.renderStoreList());
            };

            setTimeout(()=>safe(()=>tryRetry()), 250);
            setTimeout(()=>safe(()=>tryRetry()), 600);
          }
        }
        return ret;
      };
    }
  })();

  // 2) Modal close functions: always work
  window.closeInviteModal = function(){ safe(()=>{ const m=$('inviteModal'); if(m) m.style.display='none'; }); };
  window.closeAdminGate  = function(){ safe(()=>{ const m=$('adminGateModal'); if(m) m.style.display='none'; }); };
  if(typeof window.closeWebModal !== 'function'){
    window.closeWebModal = function(){ safe(()=>{ const m=$('webModal'); if(m) m.style.display='none'; }); };
  }

  // 3) ShareInvite: LINE / Mail / Copy
  window.shareInvite = async function(mode){
    try{
      const txt = ( $('inviteCopyText') ? $('inviteCopyText').textContent : '' ) || '';
      if(!txt){ showToastSafe('å…±æœ‰ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“', 1800); return; }

      if(mode === 'line'){
        const lineUrl = 'https://social-plugins.line.me/lineit/share?url=' + encodeURIComponent(txt);
        window.open(lineUrl, '_blank', 'noopener,noreferrer');
        return;
      }
      if(mode === 'mail'){
        const mailUrl = 'mailto:?body=' + encodeURIComponent(txt);
        window.location.href = mailUrl;
        return;
      }

      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(txt);
        showToastSafe('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 1800);
      }else{
        showToastSafe('ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ãŒä½¿ãˆã¾ã›ã‚“', 1800);
      }
    }catch(e){}
  };

  // 4) Settings buttons wiring (direct open / admin)
  function buildUrlSafe(){
    if(typeof window.buildUrl === 'function'){ try{ return window.buildUrl(false); }catch(e){} }
    return location.href;
  }

  function wireSettingsButtons(){
    const modal = $('settingsModal');
    if(!modal) return;

    const btns = Array.from(modal.querySelectorAll('button'));
    const findBtn = (label)=>btns.find(b => ((b.textContent||'').trim() === label));

    const bWeb = findBtn('ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã');
    if(bWeb && !bWeb.dataset.wired){
      bWeb.dataset.wired = '1';
      bWeb.onclick = function(){
        safe(()=>{ const url = buildUrlSafe(); window.open(url, '_blank', 'noopener,noreferrer'); });
      };
    }

    const bAdmin = findBtn('ç®¡ç†');
    if(bAdmin && !bAdmin.dataset.wired){
      bAdmin.dataset.wired = '1';
      bAdmin.onclick = function(){
        safe(()=>{
          const gate = $('adminGateModal');
          if(gate){
            gate.style.display = 'flex';
            const pass = $('adminPassInput'); if(pass) pass.value = '';
          }else if(typeof window.openAdminGate === 'function'){
            window.openAdminGate();
          }else if(typeof window.enterAdmin === 'function'){
            window.enterAdmin();
          }
        });
      };
    }
  }

  const origOpenSettings = window.openSettings;
  if(typeof origOpenSettings === 'function' && !window.__openSettingsWrapped){
    window.__openSettingsWrapped = true;
    window.openSettings = function(){
      const r = safe(()=>origOpenSettings());
      setTimeout(()=>safe(()=>wireSettingsButtons()), 50);
      setTimeout(()=>safe(()=>wireSettingsButtons()), 200);
      return r;
    };
  }else{
    setTimeout(()=>safe(()=>wireSettingsButtons()), 300);
  }

  window.unlockAdmin = function(){
    safe(()=>{
      const gate = $('adminGateModal');
      if(gate){
        gate.style.display='flex';
        const pass = $('adminPassInput'); if(pass) pass.value='';
      }else if(typeof window.openAdminGate === 'function'){
        window.openAdminGate();
      }else if(typeof window.enterAdmin === 'function'){
        window.enterAdmin();
      }
    });
  };

  setTimeout(()=>safe(()=>{
    const backBtn = document.querySelector('#inviteModal button[onclick*="closeInviteModal"]');
    if(backBtn && !backBtn.dataset.wired){
      backBtn.dataset.wired='1';
      backBtn.onclick = window.closeInviteModal;
    }
  }), 120);

})();
 /* ===== /PATCH (legacy)settings-directshare-admin-gpsfast ===== */

/* ===== PATCH (legacy)gpsfast3-settings-directshare-adminfix (2026-01-25 00:37 JST) =====
- GPSåˆå›ONã®ä½“æ„Ÿé€Ÿåº¦æ”¹å–„: ç›´è¿‘ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¹ãƒˆã‚¢å€™è£œã‚’å³è¡¨ç¤ºâ†’è£ã§å†å–å¾—ã€çµæœãŒæ¥ãŸã‚‰å³åæ˜ 
- è¨­å®šâ†’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã: ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‡ºã•ãšç›´æ¥åˆ¥ã‚¿ãƒ–ã§é–‹ãï¼ˆopenWebModalã‚‚ç›´é–‹ãã«é€€é¿ï¼‰
- å‹äººç´¹ä»‹/å®¶æ—å…±æœ‰: shareInvite('line'/'mail'/'copy') ã‚’å®Ÿè£…ã—ã€LINE/ãƒ¡ãƒ¼ãƒ«ãŒç¢ºå®Ÿã«å‹•ã
- ç®¡ç†: enterAdminã®ç„¡åå¿œã‚’æ½°ã™ï¼ˆèª¤ãƒ‘ã‚¹ã¯ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºï¼‰ï¼‹è¨­å®šã€Œç®¡ç†ã€ãƒœã‚¿ãƒ³ã¯å¿…ãšã‚²ãƒ¼ãƒˆã‚’é–‹ã
- UIã®è¦‹ãŸç›®ã¯ç¶­æŒï¼ˆæ–‡è¨€ã€Œåˆè¨€è‘‰ã€â†’ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ã¯ç®¡ç†ã‚²ãƒ¼ãƒˆã®ã¿ï¼‰
===== */
(function(){
  try{
    // ---- 0) è¿‘éš£ã‚¹ãƒˆã‚¢å€™è£œã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆä½“æ„Ÿé€Ÿåº¦æ”¹å–„ï¼‰ ----
    const NEARBY_CACHE_KEY = 'SP_NEARBY_CACHE_V1';
    function loadNearbyCache(){
      try{
        const raw = localStorage.getItem(NEARBY_CACHE_KEY);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(!obj || !Array.isArray(obj.names) || !obj.ts) return null;
        // 6æ™‚é–“ä»¥å†…ãªã‚‰å³è¡¨ç¤ºã«ä½¿ã†
        if(Date.now() - obj.ts > 6*60*60*1000) return null;
        return obj.names.filter(Boolean);
      }catch(e){ return null; }
    }
    function saveNearbyCache(names){
      try{
        if(!Array.isArray(names) || names.length===0) return;
        localStorage.setItem(NEARBY_CACHE_KEY, JSON.stringify({ ts: Date.now(), names: names.slice(0,80) }));
      }catch(e){}
    }

    // fetchNearbyStores ã‚’ã€ŒçµæœãŒæ¥ãŸã‚‰å³åæ˜  + ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ã€ã™ã‚‹è–„ã„ãƒ©ãƒƒãƒ‘ãƒ¼
    async function fetchNearbyStoresAndApply(){
      try{
        const arr = await (window.fetchNearbyStores ? window.fetchNearbyStores() : (typeof fetchNearbyStores==='function' ? fetchNearbyStores() : []));
        if(Array.isArray(arr) && arr.length>0){
          window.nearbyStoreNames = arr;
          saveNearbyCache(arr);
          if(typeof renderStoreList==='function') renderStoreList();
        }
        return arr;
      }catch(e){ return []; }
    }

    // ---- 1) GPSåˆå›ONã‚’é€Ÿãæ„Ÿã˜ã•ã›ã‚‹ ----
    // toggleGps å†…éƒ¨ã®å®Ÿè£…ã‚’å£Šã•ãšã€GPS ONæ™‚ã«ã€Œã‚­ãƒ£ãƒƒã‚·ãƒ¥å³è¡¨ç¤ºâ†’è£ã§å†å–å¾—ã€ã‚’è¿½åŠ 
    if(typeof window.toggleGps === 'function' && !window.__gpsfast3_patched){
      window.__gpsfast3_patched = true;
      const _tg = window.toggleGps;
      window.toggleGps = function(){
        const wasOn = (typeof window.isGpsOn !== 'undefined') ? window.isGpsOn : false;
        // å®Ÿè¡Œå‰ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å³åæ˜ ï¼ˆã“ã‚Œã ã‘ã§ä½“æ„ŸãŒã‹ãªã‚Šè‰¯ããªã‚‹ï¼‰
        if(!wasOn){
          const cached = loadNearbyCache();
          if(cached && cached.length>0){
            window.nearbyStoreNames = cached;
            try{ if(typeof renderStoreList==='function') renderStoreList(); }catch(e){}
          }
        }
        const ret = _tg.apply(this, arguments);

        // GPSã‚’ONã«ã—ãŸç›´å¾Œã€çŸ­ã„å¾…ã¡ã§2å›ã¾ã§å†å–å¾—ï¼ˆOFFâ†’ONä¸è¦ã«ã™ã‚‹ï¼‰
        try{
          if(!wasOn){
            // æ—¢ã«åˆ¥ãƒ‘ãƒƒãƒãŒèµ°ã£ã¦ã„ã¦ã‚‚ã€ã“ã“ã¯â€œç©ºã®ã¨ãã ã‘â€å‹•ã
            let tries = 0;
            const kick = async () => {
              tries++;
              const names = Array.isArray(window.nearbyStoreNames) ? window.nearbyStoreNames : [];
              if(names.length>0) return;
              await fetchNearbyStoresAndApply();
              const names2 = Array.isArray(window.nearbyStoreNames) ? window.nearbyStoreNames : [];
              if(names2.length===0 && tries<3) {
                setTimeout(kick, tries===1 ? 250 : 600);
              }
            };
            setTimeout(kick, 120);
          }
        }catch(e){}
        return ret;
      };
    }

    // ---- 2) è¨­å®šâ†’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãï¼šãƒ¢ãƒ¼ãƒ€ãƒ«ç„¡ã—ã§ç›´é–‹ã ----
    function openInNewTab(url){
      try{ window.open(url, '_blank', 'noopener,noreferrer'); }catch(e){}
    }
    function buildNormalUrlSafe(){
      try{
        if(typeof buildUrl==='function') return buildUrl(false);
      }catch(e){}
      try{ return location.href; }catch(e){ return ''; }
    }
    // openWebModal è‡ªä½“ã‚‚ã€Œç›´é–‹ãã€ã«é€€é¿ï¼ˆè¨­å®šãƒœã‚¿ãƒ³ãŒä½•ã‚’å‘¼ã‚“ã§ã‚‚OKã«ã™ã‚‹ï¼‰
    window.openWebModal = function(){
      const url = buildNormalUrlSafe();
      if(url) openInNewTab(url);
    };
    // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã€Œé–‹ãã€ãƒœã‚¿ãƒ³ã‚‚ä¿é™ºã§ç›´é–‹ã
    window.openWebDirect = function(){
      const url = buildNormalUrlSafe();
      if(url) openInNewTab(url);
      try{ if(typeof closeWebModal==='function') closeWebModal(); }catch(e){}
    };

    // ---- 3) å‹äººç´¹ä»‹/å®¶æ—å…±æœ‰ï¼šLINE/ãƒ¡ãƒ¼ãƒ«/ã‚³ãƒ”ãƒ¼ã‚’ç¢ºå®Ÿã« ----
    window.shareInvite = async function(mode){
      try{
        const txt = (document.getElementById('inviteCopyText')||{}).textContent || '';
        if(!txt) return;
        const m = String(mode||'').toLowerCase();

        if(m==='line'){
          // ãƒ¢ãƒã‚¤ãƒ«å‘ã‘: line.me ã®ãƒ†ã‚­ã‚¹ãƒˆé€ä¿¡
          const lineUrl = 'https://line.me/R/msg/text/?' + encodeURIComponent(txt);
          openInNewTab(lineUrl);
          return;
        }
        if(m==='mail'){
          const mailUrl = 'mailto:?body=' + encodeURIComponent(txt);
          location.href = mailUrl;
          return;
        }
        // copy (æ—¢å®š)
        if(navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(txt);
          try{ if(typeof showToast==='function') showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 2000); }catch(e){}
          return;
        }
        // clipboardãŒç„¡ã„å ´åˆã¯ share ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        if(navigator.share){
          await navigator.share({ text: txt });
          return;
        }
      }catch(e){}
    };

    // ---- 4) è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒœã‚¿ãƒ³é…ç·šï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç›´é–‹ãï¼‹ç®¡ç†ã‚²ãƒ¼ãƒˆï¼‰ ----
    function wireSettingsButtons_v2033(){
      const modal = document.getElementById('settingsModal');
      if(!modal) return;
      const btns = Array.from(modal.querySelectorAll('button'));
      const pick = (label) => btns.find(b => (b.textContent||'').trim() === label);

      const bWeb = pick('ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã');
      if(bWeb) bWeb.onclick = function(){
        try{ const url = buildNormalUrlSafe(); if(url) openInNewTab(url); }catch(e){}
        try{ if(typeof closeSettings==='function') closeSettings(); }catch(e){}
      };

      const bAdmin = pick('ç®¡ç†');
      if(bAdmin) bAdmin.onclick = function(){
        try{ if(typeof openAdminGate==='function') openAdminGate(); }catch(e){}
      };
    }
    try{ wireSettingsButtons_v2033(); }catch(e){}
    if(typeof window.openSettings === 'function' && !window.__openSettings_wire2033){
      window.__openSettings_wire2033 = true;
      const _os = window.openSettings;
      window.openSettings = function(){
        try{ _os(); }catch(e){}
        try{ wireSettingsButtons_v2033(); }catch(e){}
      };
    }

    // ---- 5) ç®¡ç†: enterAdminãŒç„¡åå¿œã«è¦‹ãˆã‚‹ã®ã‚’æ”¹å–„ï¼ˆèª¤ãƒ‘ã‚¹ã¯ãƒˆãƒ¼ã‚¹ãƒˆï¼‰ ----
    if(typeof window.enterAdmin === 'function' && !window.__enterAdmin_patched2033){
      window.__enterAdmin_patched2033 = true;
      const _ea = window.enterAdmin;
      window.enterAdmin = function(){
        try{
          const inp = document.getElementById('adminPassInput');
          const pass = (inp && inp.value) ? String(inp.value) : '';
          const stored = (()=>{ try{ return String(localStorage.getItem('ADMIN_PASS')||''); }catch(e){ return ''; } })();
          const okPass = stored || '55533557';
          if(pass !== okPass){
            try{ if(typeof showToast==='function') showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™', 2000); }catch(e){}
            return;
          }
        }catch(e){}
        return _ea.apply(this, arguments);
      };
    }
    // äº’æ›ï¼šunlockAdmin ã¯å¿…ãšã‚²ãƒ¼ãƒˆã‚’é–‹ã
    window.unlockAdmin = function(){ try{ if(typeof openAdminGate==='function') openAdminGate(); }catch(e){} };

  }catch(e){}
})();
/* ===== /PATCH (legacy)gpsfast3-settings-directshare-adminfix ===== */


/* ===== PATCH (legacy)hotfix (JST 2026-01-26 23:24) =====
- store-list: ã‚¯ãƒªãƒƒã‚¯å§”ä»»ã§ã€Œæœªè¨­å®š/ã‚¹ãƒˆã‚¢åã€ãŒå¿…ãšé¸ã¹ã‚‹ã‚ˆã†å¾©æ—§ï¼ˆå†æç”»ã§é…ç·šãŒæ¶ˆãˆãªã„ï¼‰
- è¨­å®š: ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã=ç›´æ¥åˆ¥ã‚¿ãƒ–ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ç„¡ã—ï¼‰
- æ‹›å¾…: LINE/ãƒ¡ãƒ¼ãƒ«/ã‚³ãƒ”ãƒ¼ã®é…ç·šã‚’ç¢ºå®ŸåŒ–ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«å†…ãƒœã‚¿ãƒ³ã® onclick ã‚’ä¸Šæ›¸ãï¼‰
- ç®¡ç†: ãƒ‘ã‚¹å…¥åŠ›â†’å…¥ã‚‹ ãŒåå¿œã™ã‚‹ï¼èª¤å…¥åŠ›ã¯ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºï¼æ–‡è¨€ã€Œåˆè¨€è‘‰ã€â†’ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€
- UIå¤‰æ›´ãªã—ï¼ˆé…ç·šã¨æŒ™å‹•ã®ã¿ï¼‰
===== */
(function(){
  try{
    // ---- Store list: event delegation (prevents "ã‚¯ãƒªãƒƒã‚¯ã§ããªã„" / å†æç”»ã§æ­»ã¬å•é¡Œ)
    function _sp2034_handleStoreTap(target){
      if(!target) return;
      const tag = (target.closest) ? target.closest('.store-tag') : null;
      if(!tag) return;
      if(tag.classList.contains('gps-btn')) return;

      const name = (tag.textContent||'').trim();
      if(!name) return;

      if(name === 'æœªè¨­å®š'){
        if(window.curStore === 'æœªè¨­å®š'){
          window.curStore = '';
          window.curStoreId = '';
          try{ if(window.db && db.config){ db.config.lastStoreId=''; db.config.lastStoreName=''; } }catch(e){}
          try{ const ind=document.getElementById('curStoreIndicator'); if(ind) ind.innerText=''; }catch(e){}
        } else {
          window.curStore = 'æœªè¨­å®š';
          window.curStoreId = '';
          try{ if(window.db && db.config){ db.config.lastStoreId=''; db.config.lastStoreName='æœªè¨­å®š'; } }catch(e){}
          try{ const ind=document.getElementById('curStoreIndicator'); if(ind) ind.innerText=`ã€ æœªè¨­å®š ã€‘ã§ä¿å­˜ã—ã¾ã™`; }catch(e){}
        }
      } else {
        window.curStore = name;
        try{ if(window.db && db.config){ db.config.lastStoreName = name; } }catch(e){}
        try{ const ind=document.getElementById('curStoreIndicator'); if(ind) ind.innerText=`ã€ ${name} ã€‘ã§ä¿å­˜ã—ã¾ã™`; }catch(e){}
      }

      try{ if(typeof saveDb==='function') saveDb(); }catch(e){}
      try{ if(typeof renderStoreList==='function') renderStoreList(); }catch(e){}
    }

    function _sp2034_wireStoreDelegation(){
      const list = document.getElementById('store-list');
      if(!list) return;
      if(list.__sp2034_delegated) return;
      list.__sp2034_delegated = true;
      list.addEventListener('click', function(ev){ _sp2034_handleStoreTap(ev.target); }, { passive:true });
    }

    // ---- Invite share
    async function _sp2034_shareInvite(mode){
      try{
        const txt = (document.getElementById('inviteCopyText')||{}).textContent || '';
        if(!txt) return;
        const m = String(mode||'').toLowerCase();

        if(m === 'line'){
          const lineUrl = 'https://line.me/R/msg/text/?' + encodeURIComponent(txt);
          window.open(lineUrl, '_blank', 'noopener,noreferrer');
          return;
        }
        if(m === 'mail'){
          const mailUrl = 'mailto:?body=' + encodeURIComponent(txt);
          window.location.href = mailUrl;
          return;
        }
        if(m === 'copy'){
          if(navigator.clipboard && navigator.clipboard.writeText){
            await navigator.clipboard.writeText(txt);
            try{ if(typeof showToast==='function') showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 1500); }catch(e){}
          }
          return;
        }
      }catch(e){}
    }
    window.shareInvite = _sp2034_shareInvite;

    function _sp2034_wireInviteButtons(){
      const m = document.getElementById('inviteModal');
      if(!m) return;
      const els = Array.from(m.querySelectorAll('button, a'));
      const byText = (t)=>els.find(b=> (b.textContent||'').trim()===t);

      const bLine = byText('LINE');
      if(bLine) bLine.onclick = ()=>_sp2034_shareInvite('line');

      const bMail = byText('ãƒ¡ãƒ¼ãƒ«');
      if(bMail) bMail.onclick = ()=>_sp2034_shareInvite('mail');

      const bCopy = byText('ã‚³ãƒ”ãƒ¼');
      if(bCopy) bCopy.onclick = ()=>_sp2034_shareInvite('copy');

      const bBack = byText('æˆ»ã‚‹');
      if(bBack) bBack.onclick = ()=>{ try{ if(typeof closeInviteModal==='function') closeInviteModal(); }catch(e){ const mm=document.getElementById('inviteModal'); if(mm) mm.style.display='none'; } };
    }

    // openInviteModalã®å¾Œã«é…ç·šã—ç›´ã™
    const _sp2034_openInvite_orig = window.openInviteModal;
    window.openInviteModal = function(kind){
      let r;
      try{ if(typeof _sp2034_openInvite_orig === 'function') r = _sp2034_openInvite_orig(kind); }catch(e){}
      setTimeout(_sp2034_wireInviteButtons, 0);
      return r;
    };

    // ---- Settings: Browser open direct + ensure buttons wired
    function _sp2034_openWebDirect(){
      try{ if(typeof openWebDirect==='function') return openWebDirect(); }catch(e){}
      try{ const url = (typeof buildUrl==='function') ? buildUrl(false) : window.location.href; window.open(url, '_blank', 'noopener,noreferrer'); }catch(e){}
    }
    window.openWebModal = _sp2034_openWebDirect; // ãƒ¢ãƒ¼ãƒ€ãƒ«çµŒç”±ã‚’æ½°ã™

    function _sp2034_wireSettingsButtons(){
      const m = document.getElementById('settingsModal');
      if(!m) return;
      const btns = Array.from(m.querySelectorAll('button'));
      const byText = (t)=>btns.find(b=> (b.textContent||'').trim()===t);

      const bWeb = byText('ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã');
      if(bWeb) bWeb.onclick = ()=>_sp2034_openWebDirect();

      const bInvite = byText('å‹äººç´¹ä»‹');
      if(bInvite) bInvite.onclick = ()=>{ try{ window.openInviteModal('friend'); }catch(e){} };

      const bFamily = byText('å®¶æ—å…±æœ‰');
      if(bFamily) bFamily.onclick = ()=>{ try{ window.openInviteModal('family'); }catch(e){} };

      const bAdmin = byText('ç®¡ç†');
      if(bAdmin) bAdmin.onclick = ()=>{ try{ if(typeof window.openAdminGate==='function') window.openAdminGate(); }catch(e){} };
    }

    const _sp2034_openSettings_orig = window.openSettings;
    window.openSettings = function(){
      let r;
      try{ if(typeof _sp2034_openSettings_orig === 'function') r = _sp2034_openSettings_orig(); }catch(e){}
      setTimeout(_sp2034_wireSettingsButtons, 0);
      return r;
    };

    // ---- Admin gate: password enter works + toast + wording fix
    function _sp2034_enterAdmin(){
      const inp = document.getElementById('adminPassInput');
      const pass = (inp && inp.value) ? String(inp.value) : '';
      if(pass !== '55533557'){
        try{ if(typeof showToast==='function') showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™', 2000); }catch(e){}
        return;
      }
      try{ if(typeof closeAdminGate==='function') closeAdminGate(); }catch(e){ const m=document.getElementById('adminGateModal'); if(m) m.style.display='none'; }
      try{ if(typeof openAdmin==='function') openAdmin(); }catch(e){}
    }
    window.enterAdmin = _sp2034_enterAdmin;
    window.unlockAdmin = _sp2034_enterAdmin;

    function _sp2034_wireAdminGateButtons(){
      const m = document.getElementById('adminGateModal');
      if(!m) return;

      const btns = Array.from(m.querySelectorAll('button'));
      const byText = (t)=>btns.find(b=> (b.textContent||'').trim()===t);

      const bEnter = byText('å…¥ã‚‹');
      if(bEnter) bEnter.onclick = _sp2034_enterAdmin;

      const bBack = byText('æˆ»ã‚‹');
      if(bBack) bBack.onclick = ()=>{ try{ if(typeof closeAdminGate==='function') closeAdminGate(); }catch(e){ m.style.display='none'; } };

      // æ–‡è¨€ã ã‘ç½®æ›ï¼ˆUIè¿½åŠ ãªã—ï¼‰
      try{
        m.querySelectorAll('*').forEach(el=>{
          if(el.childNodes && el.childNodes.length===1 && el.childNodes[0].nodeType===3){
            const t = el.textContent || '';
            if(t.indexOf('åˆè¨€è‘‰')>=0) el.textContent = t.replace(/åˆè¨€è‘‰/g, 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰');
          }
        });
      }catch(e){}
    }

    const _sp2034_openAdminGate_orig = window.openAdminGate;
    window.openAdminGate = function(){
      let r;
      try{ if(typeof _sp2034_openAdminGate_orig === 'function') r = _sp2034_openAdminGate_orig(); }catch(e){}
      setTimeout(_sp2034_wireAdminGateButtons, 0);
      return r;
    };

    document.addEventListener('DOMContentLoaded', ()=>{
      _sp2034_wireStoreDelegation();
      setTimeout(()=>{ _sp2034_wireInviteButtons(); _sp2034_wireAdminGateButtons(); }, 200);
    });
  }catch(e){}
})();
/* ===== /PATCH (legacy)hotfix ===== */

</script>


<!-- ===== /PATCH (legacy)gpsfirst-back-admin ===== -->

<!-- ===== PATCH (legacy)settingsinviteadminfix (2026-01-26 23:35 JST) =====
- è¨­å®šã€Œä¿å­˜/åŒæœŸã€å¾Œã«ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‰ãªã„ï¼ˆãƒˆãƒ¼ã‚¹ãƒˆã®ã¿ï¼‰
- ã‚¹ãƒˆã‚¢ã‚¿ã‚°ï¼šå†æç”»ã«å¼·ã„ã‚¯ãƒªãƒƒã‚¯å§”ä»»ã§ã€Œæœªè¨­å®š/ã‚¹ãƒˆã‚¢åãŒé¸ã¹ãªã„ã€ã‚’é˜²ã
- å‹äººç´¹ä»‹/å®¶æ—å…±æœ‰ï¼šé€ã‚‹æ–‡ã®è¦‹æœ¬ã‚’å¿…ãšè¡¨ç¤ºã—ã€LINE/ãƒ¡ãƒ¼ãƒ«/ã‚³ãƒ”ãƒ¼ãŒå¿…ãšå‹•ã
- ç®¡ç†ï¼šãƒ‘ã‚¹å…¥åŠ›â†’ç®¡ç†ç”»é¢ã‚’é–‹ãã€‚èª¤ãƒ‘ã‚¹ã¯ãƒˆãƒ¼ã‚¹ãƒˆã€‚è¨­å®šç”»é¢ã¸å¼·åˆ¶å¾©å¸°ã—ãªã„
- UIå¤‰æ›´ãªã—ï¼ˆæŒ™å‹•ã®ã¿ï¼‰
===== -->
<script>
(function(){
  try{
    // ---------- 1) ã‚¹ãƒˆã‚¢é¸æŠã®ã‚¯ãƒªãƒƒã‚¯å§”ä»»ï¼ˆå†æç”»ã«å¼·ã„ï¼‰ ----------
    if(!window.__sp2035_store_delegate_bound){
      window.__sp2035_store_delegate_bound = true;
      document.addEventListener('click', function(ev){
        try{
          const t = ev.target;
          if(!t) return;
          // store-tag ä»¥å¤–ã¯ç„¡è¦–
          if(!(t.classList && t.classList.contains('store-tag'))) return;
          // GPSãƒœã‚¿ãƒ³ãƒ»è¿½åŠ ãƒœã‚¿ãƒ³ã¯ç„¡è¦–
          if(t.classList.contains('gps-btn') || t.classList.contains('add-store')) return;

          const name = (t.textContent || '').trim();
          if(!name) return;

          // ã“ã“ãŒã€Œç¢ºå®Ÿã«é¸ã¹ã‚‹ã€æœ¬ä½“
          try{ window.curStore = name; }catch(e){}
          try{
            if(window.db && window.db.config){
              window.db.config.lastStoreName = name;
              // æœªè¨­å®šã®å¼·åˆ¶ONã‚’é˜²ãï¼ˆèµ·å‹•æ™‚ã¯ç©ºãŒæ­£ï¼‰
              if(name === 'æœªè¨­å®š') window.db.config.lastStoreName = '';
            }
          }catch(e){}

          // è¡¨ç¤ºæ›´æ–°ï¼ˆèµ¤æ ã‚’ã¤ã‘ã‚‹ï¼‰
          try{
            document.querySelectorAll('.store-tag').forEach(s=>s.classList.remove('active'));
            t.classList.add('active');
          }catch(e){}

          try{
            const ind = document.getElementById('curStoreIndicator');
            if(ind) ind.innerText = `ã€ ${name} ã€‘ã§ä¿å­˜ã—ã¾ã™`;
          }catch(e){}

          try{ if(typeof window.saveDb === 'function') window.saveDb(); }catch(e){}
        }catch(e){}
      }, true);
    }

    // ---------- 2) æ‹›å¾…ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šæ–‡ç« è¦‹æœ¬ï¼†ãƒœã‚¿ãƒ³é…ç·š ----------
    function _sp2035_buildInviteText(kind){
      const isFamily = (kind === 'family');
      const base = (location.href.split('#')[0].split('?')[0]);
      let uid = '';
      try{ uid = (typeof window.currentUserId !== 'undefined' && window.currentUserId) ? String(window.currentUserId) : ''; }catch(e){}
      const link = base + '?ref=' + encodeURIComponent(uid || 'user');
      const msg = isFamily
        ? `å®¶æ—ã§ä½¿ãˆã‚‹è²·ã„ç‰©ãƒ¡ãƒ¢ã€ŒSmart Priceã€ã§ã™ã€‚
è³¼å…¥å±¥æ­´ã¯ç¬¬ä¸‰è€…ã«å…±æœ‰ã•ã‚Œã¾ã›ã‚“ã€‚

${link}`
        : `è²·ã„ç‰©ã®ç›®å®‰ãŒåˆ†ã‹ã‚‹ã€ŒSmart Priceã€ã§ã™ã€‚
è³¼å…¥å±¥æ­´ã¯ç¬¬ä¸‰è€…ã«å…±æœ‰ã•ã‚Œã¾ã›ã‚“ã€‚

${link}`;
      return msg;
    }

    window.openInviteModal = function(kind){
      try{
        const modal = document.getElementById('inviteModal');
        if(!modal) return;
        const titleEl = document.getElementById('inviteTitle');
        const txtEl   = document.getElementById('inviteCopyText');
        const isFamily = (kind === 'family');
        if(titleEl) titleEl.textContent = isFamily ? 'å®¶æ—å…±æœ‰' : 'å‹äººç´¹ä»‹';
        if(txtEl) txtEl.textContent = _sp2035_buildInviteText(kind);
        modal.style.display = 'flex';

        // é–‹ã„ãŸç›´å¾Œã«é…ç·šï¼ˆå†æç”»ã«å¼·ã„ï¼‰
        setTimeout(_sp2035_wireInviteButtons, 50);
      }catch(e){}
    };

    function _sp2035_wireInviteButtons(){
      try{
        const m = document.getElementById('inviteModal');
        if(!m) return;
        const els = Array.from(m.querySelectorAll('button, a'));
        const bLine = els.find(b => ((b.textContent||'').trim().toUpperCase().includes('LINE')));
        const bMail = els.find(b => ((b.textContent||'').trim().includes('ãƒ¡ãƒ¼ãƒ«')));
        const bCopy = els.find(b => ((b.textContent||'').trim().includes('ã‚³ãƒ”ãƒ¼')));
        if(bLine){ bLine.onclick = ()=>window.shareInvite('line'); }
        if(bMail){ bMail.onclick = ()=>window.shareInvite('mail'); }
        if(bCopy){ bCopy.onclick = ()=>window.shareInvite('copy'); }
      }catch(e){}
    }

    window.shareInvite = async function(mode){
      try{
        const txt = (document.getElementById('inviteCopyText')||{}).textContent || '';
        if(!txt) { try{ if(typeof showToast==='function') showToast('é€ã‚‹æ–‡ãŒç©ºã§ã™', 2000); }catch(e){} return; }
        const m = String(mode||'').toLowerCase();

        if(m === 'line'){
          // âœ… æ­£ã—ã„å½¢å¼ï¼š https://line.me/R/msg/text/?<encoded>
          const lineUrl = 'https://line.me/R/msg/text/?' + encodeURIComponent(txt);
          window.open(lineUrl, '_blank', 'noopener,noreferrer');
          return;
        }
        if(m === 'mail'){
          const mailUrl = 'mailto:?body=' + encodeURIComponent(txt);
          location.href = mailUrl;
          return;
        }
        // copy / default
        if(navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(txt);
          try{ if(typeof showToast==='function') showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 2000); }catch(e){}
          return;
        }
        window.prompt('ã“ã®æ–‡ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦é€ã£ã¦ãã ã•ã„', txt);
      }catch(e){}
    };

    // ---------- 3) ç®¡ç†ï¼šãƒ‘ã‚¹å…¥åŠ›â†’ç®¡ç†ç”»é¢ã¸ï¼ˆè¨­å®šã¸æˆ»ã•ãªã„ï¼‰ ----------
    function _sp2035_adminEnter(){
      try{
        const inp = document.getElementById('adminPassInput');
        const pass = (inp && inp.value) ? String(inp.value) : '';
        const okPass = '55533557';
        if(pass !== okPass){
          try{ if(typeof showToast==='function') showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™', 2000); }catch(e){}
          return;
        }
        try{ if(typeof window.closeAdminGate === 'function') window.closeAdminGate(); }catch(e){}
        try{
          // æ–‡è¨€ã®ã€Œåˆè¨€è‘‰ã€â†’ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ç½®æ›ï¼ˆè¦‹ãŸç›®ã ã‘ï¼‰
          const gate = document.getElementById('adminGateModal');
          if(gate){
            gate.querySelectorAll('*').forEach(el=>{
              if(el && typeof el.textContent==='string' && el.textContent.includes('åˆè¨€è‘‰')){
                el.textContent = el.textContent.replace('åˆè¨€è‘‰','ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰');
              }
            });
          }
        }catch(e){}
        // ç®¡ç†ç”»é¢ã‚’é–‹ãï¼ˆæœ¬ä½“é–¢æ•°å„ªå…ˆï¼‰
        if(typeof window.openAdmin === 'function') { window.openAdmin(); return; }
        if(typeof window.enterAdmin_orig === 'function') { window.enterAdmin_orig(); return; }
        // æœ€å¾Œã®æ‰‹æ®µï¼šdiagModal
        const dm = document.getElementById('diagModal');
        if(dm) dm.style.display = 'flex';
      }catch(e){}
    }

    // æ—¢å­˜enterAdminãŒã‚ã‚Œã°é€€é¿ã—ã¦ä¸Šæ›¸ã
    if(typeof window.enterAdmin === 'function' && !window.__sp2035_enterAdmin_patched){
      window.__sp2035_enterAdmin_patched = true;
      window.enterAdmin_orig = window.enterAdmin;
      window.enterAdmin = _sp2035_adminEnter;
    }
    window.unlockAdmin = _sp2035_adminEnter;

    // ---------- 4) è¨­å®šï¼šãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã¯ç›´é–‹ãï¼ˆå¿µã®ãŸã‚å›ºå®šï¼‰ ----------
    window.openWebModal = function(){
      try{
        const url = (typeof buildUrl === 'function') ? buildUrl(false) : location.href;
        window.open(url, '_blank', 'noopener,noreferrer');
      }catch(e){}
    };

    // ---------- 5) åŒæœŸ/ä¿å­˜å¾Œï¼šãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‰ãªã„ï¼ˆå¿µã®ãŸã‚äºŒé‡ã‚¬ãƒ¼ãƒ‰ï¼‰ ----------
    if(typeof window.startMigration === 'function' && !window.__sp2035_startMigration_wrap){
      window.__sp2035_startMigration_wrap = true;
      const _orig = window.startMigration;
      window.startMigration = async function(){
        // æœ¬ä½“ã«ä»»ã›ã¤ã¤ã€æœ€å¾Œã«ç”»é¢æ¨ç§»ã‚’æŠ‘æ­¢ï¼ˆæˆ»ã‚Šå…ˆã‚’æ¶ˆã™ï¼‰
        const r = await _orig.apply(this, arguments);
        // closeSettings/showHome ã‚’ä»–æ‰€ã§å‘¼ã°ã‚Œã¦ã‚‚ç„¡è¦–ã—ãŸã„ã®ã§ã€ã“ã“ã§ä½•ã‚‚ã—ãªã„
        return r;
      };
    }

    // invite modal opened via button: ensure wiring
    setTimeout(_sp2035_wireInviteButtons, 200);

  }catch(e){}
})();
</script>
<!-- ===== /PATCH (legacy)settingsinviteadminfix ===== -->


<!-- ===== PATCH (legacy)fix-syntax-toast-ver (JST 2026-01-27 00:16) =====
- è¨­å®šã€Œè¨­å®šä¿å­˜ã¨åŒæœŸã€ï¼šãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‰ãªã„ï¼ˆè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ç¶­æŒã€ãƒˆãƒ¼ã‚¹ãƒˆã®ã¿ï¼‰
- ç®¡ç†ï¼šãƒ‘ã‚¹OKã§è¨­å®šã‚’é–‰ã˜ã¦ç®¡ç†ç”»é¢ã‚’å‰é¢è¡¨ç¤ºï¼ˆæˆ»ã£ã¦ã—ã¾ã†å•é¡Œã‚’è§£æ¶ˆï¼‰
- æ‹›å¾…ï¼šLINEé€ä¿¡ãŒé–‹ã‘ãªã„ç«¯æœ«å‘ã‘ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆwindow.openå¤±æ•—æ™‚ã¯ location.hrefï¼‰
- UIå¤‰æ›´ãªã—ï¼ˆé…ç·šã¨é·ç§»ã®ã¿ï¼‰
===== -->
<script>
(function(){
  try{
    // ---- (A) åŒæœŸå¾Œã«ãƒ›ãƒ¼ãƒ ã¸é·ç§»ã—ãªã„ï¼šstartMigration ä¸­ã ã‘ closeSettings / showHome ã‚’ç„¡åŠ¹åŒ–
    if(typeof window.startMigration === 'function' && !window.__sp2036_syncwrap){
      window.__sp2036_syncwrap = true;

      const _origCloseSettings = window.closeSettings;
      const _origShowHome = window.showHome;

      // ã‚¬ãƒ¼ãƒ‰ä»˜ãã«å·®ã—æ›¿ãˆï¼ˆåŒæœŸä¸­ã ã‘ç„¡åŠ¹åŒ–ï¼‰
      window.closeSettings = function(){
        try{ if(window.__sp2036_noNav) return; }catch(e){}
        try{ if(typeof _origCloseSettings === 'function') return _origCloseSettings.apply(this, arguments); }catch(e){}
      };
      window.showHome = function(){
        try{ if(window.__sp2036_noNav) return; }catch(e){}
        try{ if(typeof _origShowHome === 'function') return _origShowHome.apply(this, arguments); }catch(e){}
      };

      const _origStart = window.startMigration;
      window.startMigration = async function(){
        window.__sp2036_noNav = true;
        try{
          const r = await _origStart.apply(this, arguments);
          // åŒæœŸå®Œäº†å¾Œï¼šè¨­å®šç”»é¢ã«ç•™ã‚ã‚‹
          try{
            const sm = document.getElementById('settingsModal');
            if(sm) sm.style.display = 'flex';
          }catch(e){}
          try{ if(typeof showToast==='function') showToast('åŒæœŸã—ã¾ã—ãŸ', 2000); }catch(e){}
          return r;
        } finally {
          // ä½™éŸ»ã§ä»–å‡¦ç†ãŒèµ°ã‚‹ã®ã§å°‘ã—é…ã‚‰ã›ã¦è§£é™¤
          setTimeout(()=>{ try{ window.__sp2036_noNav=false; }catch(e){} }, 300);
        }
      };
    }

    // ---- (B) ç®¡ç†ï¼šãƒ‘ã‚¹OKã§ã€Œè¨­å®šãŒå‰é¢ã«æ®‹ã‚‹ã€å•é¡Œã‚’è§£æ¶ˆï¼ˆè¨­å®šã‚’é–‰ã˜ã¦ç®¡ç†ã‚’æœ€å‰é¢ã¸ï¼‰
    function _sp2036_openAdminFront(){
      try{
        const settings = document.getElementById('settingsModal');
        if(settings) settings.style.display = 'none';
      }catch(e){}
      try{
        const am = document.getElementById('adminModal');
        if(am) am.style.zIndex = 99999;
      }catch(e){}
      try{ if(typeof openAdmin==='function') return openAdmin(); }catch(e){}
      try{
        // fallback: diagModal
        const dm = document.getElementById('diagModal');
        if(dm){ dm.style.zIndex = 99999; dm.style.display='flex'; }
      }catch(e){}
    }

    function _sp2036_adminEnter(){
      try{
        const inp = document.getElementById('adminPassInput');
        const pass = (inp && inp.value) ? String(inp.value) : '';
        const okPass = '55533557';
        if(pass !== okPass){
          try{ if(typeof showToast==='function') showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™', 2000); }catch(e){}
          return;
        }
        try{ if(typeof closeAdminGate==='function') closeAdminGate(); }catch(e){ const gm=document.getElementById('adminGateModal'); if(gm) gm.style.display='none'; }
        _sp2036_openAdminFront();
      }catch(e){}
    }

    // enterAdmin/unlockAdmin ã‚’æœ€çµ‚çš„ã«ã“ã‚Œã¸å›ºå®š
    window.enterAdmin = _sp2036_adminEnter;
    window.unlockAdmin = _sp2036_adminEnter;

    // ---- (C) æ‹›å¾…ï¼šLINEé€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆopenå¤±æ•—æ™‚ã¯ location.hrefï¼‰
    const _origShare = window.shareInvite;
    window.shareInvite = async function(mode){
      const m = String(mode||'').toLowerCase();
      if(m === 'line'){
        try{
          const txt = (document.getElementById('inviteCopyText')||{}).textContent || '';
          if(!txt) return;
          const lineUrl = 'https://line.me/R/msg/text/?' + encodeURIComponent(txt);
          const w = window.open(lineUrl, '_blank', 'noopener,noreferrer');
          if(!w) location.href = lineUrl;
          return;
        }catch(e){}
      }
      // ãã‚Œä»¥å¤–ã¯æ—¢å­˜ã¸
      try{ if(typeof _origShare === 'function') return _origShare.apply(this, arguments); }catch(e){}
    };

  }catch(e){}
})();
</script>
<!-- ===== /PATCH (legacy)fix-syntax-toast-ver ===== -->


<!-- ===== PATCH v20.4.13B-recover-storebar (BUILD 2026-01-27_0140_recover-storebar) =====
- ç”»é¢ä¸Šéƒ¨ã®ã€ŒGPS / æœªè¨­å®š / ã‚¹ãƒˆã‚¢ä¸€è¦§ã€ãŒè¡¨ç¤ºã•ã‚Œãªã„ç«¯æœ«ã®å¾©æ—§ï¼ˆUIè¿½åŠ ãªã—ãƒ»æ¬ è½æ™‚ã®ã¿å†ç”Ÿæˆï¼‰
- renderStoreList ã‚’å®‰å…¨åŒ–ï¼ˆä¾‹å¤–ã§å…¨æ»…ã—ãªã„ï¼‰
- åˆæœŸåŒ–ç›´å¾Œã«ã‚¹ãƒˆã‚¢ãƒãƒ¼ã‚’ç¢ºå®Ÿã«æç”»ï¼ˆ2å›ãƒˆãƒ©ã‚¤ï¼‰
===== -->
<script>
(function() {
  'use strict';

  // ---- SSOT: version/badge/title ã‚’ä¸€æœ¬åŒ–ï¼ˆè¡¨ç¤ºã‚ºãƒ¬é˜²æ­¢ï¼‰----
  try {
    var __SSOT_VER = 'v20.4.13B';
    window.__SMARTPRICE_VERSION_SSOT = __SSOT_VER;
    try { document.title = 'Smart Price ' + __SSOT_VER.replace(/^v/, ''); } catch(e) {}
    // ç”»é¢ãƒãƒƒã‚¸ï¼ˆæ—¢å­˜è¦ç´ ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
    try {
      var vb = document.querySelector('.version-badge, #versionBadge, [data-role="version-badge"]');
      if(vb) vb.textContent = __SSOT_VER.replace(/^v/, '');
    } catch(e) {}
  } catch(e) {}

  // ---- store barï¼ˆGPS/æœªè¨­å®š/ã‚¹ãƒˆã‚¢ä¸€è¦§ï¼‰ã® DOM ãŒæ¬ ã‘ãŸæ™‚ã ã‘å¾©æ—§ ----
  function ensureStoreBarDom() {
    try {
      var area = document.querySelector('.store-area');
      var list = document.getElementById('store-list');

      if(area && list) return true;

      // æ—¢å­˜ã®æŒ¿å…¥ä½ç½®ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ç›´ä¸‹ï¼‰
      var header = document.querySelector('.header') || document.querySelector('header') || document.body.firstElementChild;
      var anchor = null;
      if(header) {
        anchor = header.nextElementSibling;
      }

      if(!area) {
        area = document.createElement('div');
        area.className = 'store-area';
      }

      if(!list) {
        list = document.createElement('div');
        list.id = 'store-list';
        list.className = 'store-list';
      }

      // area ã« list ãŒå…¥ã£ã¦ã„ãªã‘ã‚Œã°å…¥ã‚Œã‚‹
      if(area && list && list.parentElement !== area) {
        try { area.innerHTML = ''; } catch(e) {}
        area.appendChild(list);
      }

      // æ—¢ã« body é…ä¸‹ã«ã‚ã‚‹ãªã‚‰ä½ç½®ã ã‘èª¿æ•´ï¼ˆãªã‘ã‚Œã°è¿½åŠ ï¼‰
      if(!area.parentElement) {
        if(anchor && anchor.parentElement) {
          anchor.parentElement.insertBefore(area, anchor);
        } else {
          document.body.insertBefore(area, document.body.firstChild);
        }
      }

      return true;
    } catch(e) {
      return false;
    }
  }

  // ---- renderStoreList ã‚’ã€Œè½ã¡ãªã„ã€ã‚ˆã†ã«åŒ…ã‚€ï¼ˆå…ƒé–¢æ•°ã¯å°Šé‡ï¼‰----
  function installSafeRender() {
    try {
      if(typeof window.renderStoreList !== 'function') return;

      if(window.__sp_safe_render_installed) return;
      window.__sp_safe_render_installed = true;

      var _orig = window.renderStoreList;
      window.renderStoreList = function() {
        try {
          ensureStoreBarDom();
          return _orig.apply(this, arguments);
        } catch(e) {
          // æœ€ä½é™ï¼šGPS ã¨ ç¾åœ¨ã‚¹ãƒˆã‚¢ï¼ˆæœªè¨­å®šï¼‰ã ã‘ã¯å‡ºã™
          try {
            ensureStoreBarDom();
            var list = document.getElementById('store-list');
            if(!list) return;
            list.innerHTML = '';

            var gpsTxt = (window.isGpsOn ? 'GPS ON' : 'GPS OFF');
            var gps = document.createElement('span');
            gps.className = 'store-tag gps-btn' + (window.isGpsOn ? ' on' : '');
            gps.textContent = gpsTxt;
            gps.onclick = function() { try { if(typeof window.toggleGps==='function') window.toggleGps(); } catch(e) {} };
            list.appendChild(gps);

            var cur = (window.curStore && String(window.curStore).trim()) ? String(window.curStore).trim() : 'æœªè¨­å®š';
            var curSpan = document.createElement('span');
            curSpan.className = 'store-tag' + ((cur !== 'æœªè¨­å®š') ? ' active' : '');
            curSpan.textContent = cur;
            curSpan.onclick = function() { /* ã“ã“ã§ã¯é¸æŠUIã ã‘ */ };
            list.appendChild(curSpan);
          } catch(_e) {}
        }
      };
    } catch(e) {}
  }

  // ---- åˆæœŸåŒ–å¾Œã«ã€Œå¿…ãšã€ã‚¹ãƒˆã‚¢ãƒãƒ¼ã‚’æç”»ï¼ˆè¡¨ç¤ºãŒæ¶ˆãˆã‚‹ç«¯æœ«å¯¾ç­–ï¼‰----
  function kickStoreBarRender() {
    try {
      ensureStoreBarDom();
      installSafeRender();
      if(typeof window.renderStoreList === 'function') {
        try { window.renderStoreList(); } catch(e) {}
        // 200mså¾Œã«ã‚‚ã†ä¸€åº¦ï¼ˆåˆå›DOMç¢ºå®šå¾…ã¡ï¼‰
        setTimeout(function(){ try { window.renderStoreList(); } catch(e) {} }, 200);
      }
    } catch(e) {}
  }

  // DOM æº–å‚™å¾Œã«å®Ÿè¡Œ
  if(document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', kickStoreBarRender, {once:true});
  } else {
    kickStoreBarRender();
  }
})();
</script>
<!-- ===== /PATCH v20.4.13B-recover-storebar ===== -->


<script>
/* =========================================================
   APP: Smart Price
   VERSION: v20.4.13B [VERLOCK SSOT]
   DATE(JST): 2026-01-27 09:43
   TITLE: Recover store bar tap + VERLOCK SSOT + remove stray PATCH text
   CHANGES:
   - Fix: previous PATCH JS was injected as plain text (removed + re-added as script)
   - Fix: force version SSOT to v20.4.13B in VERSION_INFO / title / badge
   - Fix: store bar (GPS/æœªè¨­å®š/å€™è£œ) renders immediately and becomes tappable
   - Fix: disable invisible tap-shield overlays above store bar (safe whitelist)
   BUILD_PARAM(b): ?b=2026-01-27_0943_fix-tap-verlock
   DEBUG_PARAM: &debug=1
   POLICY: UI unchanged (internal-only)
   AUTHOR: Yui
========================================================== */
(function(){
  'use strict';
  var SSOT_VER = '20.4.13B';
  // ---- 1) VERLOCK SSOT (single source of truth at runtime) ----
  try {
    if (typeof window.VERSION_INFO === 'object' && window.VERSION_INFO) {
      window.VERSION_INFO.FULL = SSOT_VER + 'B [VERLOCK SSOT]'.replace('BB','B');
      window.VERSION_INFO.VER  = SSOT_VER + 'B'.replace('BB','B');
    } else {
      window.VERSION_INFO = { FULL: SSOT_VER + 'B [VERLOCK SSOT]'.replace('BB','B'), VER: SSOT_VER + 'B'.replace('BB','B') };
    }
  } catch(e) {}

  try {
    if (typeof document !== 'undefined') {
      // title
      if (document.title && document.title.indexOf('Smart Price') === 0) {
        document.title = 'Smart Price ' + (SSOT_VER + 'B').replace('BB','B');
      }
      // badge text (try common selectors)
      var candidates = [
        document.getElementById('versionBadge'),
        document.querySelector('.version-badge'),
        document.querySelector('[data-role="version-badge"]')
      ];
      candidates.forEach(function(el){
        try { if(el) el.textContent = (SSOT_VER + 'B').replace('BB','B'); } catch(_e){}
      });
    }
  } catch(e) {}

  // ---- 2) Force store bar render ASAP ----
  function _sp_forceStoreBarRender(){
    try {
      if (typeof window.renderStoreList === 'function') {
        window.renderStoreList();
      }
    } catch(e) {}
    try {
      var area = document.querySelector('.store-area');
      if (area) {
        area.style.zIndex = '60';
        area.style.pointerEvents = 'auto';
      }
      var list = document.getElementById('store-list');
      if (list) {
        list.style.pointerEvents = 'auto';
      }
    } catch(e) {}
    _sp_killTapShieldOverStoreBar();
    _sp_rebindStoreChips();
  }

  // ---- 3) If an invisible overlay is sitting above store bar, disable pointer-events ----
  function _sp_killTapShieldOverStoreBar(){
    // ç›®çš„ï¼šã‚¹ãƒˆã‚¢ãƒãƒ¼ï¼ˆGPS/æœªè¨­å®š/ã‚¹ãƒˆã‚¢å€™è£œï¼‰ã®ã‚¿ãƒƒãƒ—ãŒåŠ¹ã‹ãªã„ã¨ãã€
    // é€æ˜ãƒ¬ã‚¤ãƒ¤ãƒ¼ç­‰ãŒè¢«ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€ä¸Šã«è¢«ã£ã¦ã„ã‚‹è¦ç´ ã ã‘ pointer-events:none ã«ã™ã‚‹ã€‚
    // UIã¯å¤‰ãˆãªã„ï¼ˆdebug=1ã§ã‚‚è¡¨ç¤ºã‚’å¢—ã‚„ã•ãªã„ï¼‰
    try {
      var storeList = document.getElementById('store-list');
      if(!storeList) return;

      var storeRect = storeList.getBoundingClientRect();
      // ã‚¹ãƒˆã‚¢ãƒãƒ¼å‘¨è¾ºã®å°‘ã—ä¸Šã‚‚å«ã‚ã‚‹ï¼ˆã‚¿ãƒƒãƒ—ãŒå¸ã‚ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ï¼‰
      var bandTop = Math.max(0, storeRect.top - 10);
      var bandBottom = Math.min(window.innerHeight || 9999, storeRect.bottom + 10);

      var nodes = Array.from(document.body.querySelectorAll('*'));
      for (var i=0;i<nodes.length;i++) {
        var el = nodes[i];
        if (!el || el === document.body) continue;

        // ã‚¹ãƒˆã‚¢ãƒãƒ¼è‡ªèº«/å­å­«ã¯çµ¶å¯¾ã«è§¦ã‚‰ãªã„ï¼ˆã“ã“ã‚’è§¦ã‚‹ã¨ã€Œè¡¨ç¤ºã¯å‡ºã‚‹ãŒæŠ¼ã›ãªã„ã€ã«ãªã‚‹ï¼‰
        try {
          if (el === storeList) continue;
          if (el.closest && el.closest('#store-list')) continue;
          if (el.closest && el.closest('.store-area')) continue;
          if (el.classList && (el.classList.contains('store-tag') || el.classList.contains('store-list'))) continue;
        } catch(_e){}

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é¡ã¯é™¤å¤–ï¼ˆæ“ä½œã«å½±éŸ¿ã™ã‚‹ã®ã§è§¦ã‚‰ãªã„ï¼‰
        if (el.closest && el.closest('#settingsModal,#inviteModal,#adminGateModal,#adminModal,#diagModal')) continue;

        var r;
        try { r = el.getBoundingClientRect(); } catch(_e){ continue; }
        if(!r) continue;

        // ã‚¹ãƒˆã‚¢ãƒãƒ¼å¸¯ã¨é‡ãªã‚‹ã‹
        var overlaps = !(r.bottom < bandTop || r.top > bandBottom || r.right < storeRect.left || r.left > storeRect.right);
        if(!overlaps) continue;

        var st = window.getComputedStyle(el);
        if(!st) continue;

        // æ˜ã‚‰ã‹ã«ä¸Šã«è¢«ã•ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã‚‚ã®ã ã‘å¯¾è±¡ï¼ˆfixed/absolute/stickyï¼‰
        var pos = st.position;
        if(pos !== 'fixed' && pos !== 'absolute' && pos !== 'sticky') continue;

        // æ—¢ã«ç„¡åŠ¹åŒ–æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
        if(st.pointerEvents === 'none') continue;

        // é€æ˜ã§ã‚‚ã‚¿ãƒƒãƒ—ã‚’å¥ªã†ã“ã¨ãŒã‚ã‚‹ã®ã§ã€èƒŒæ™¯è‰²ã‚„é€æ˜åº¦ã¯æ¡ä»¶ã«ã—ãªã„
        // ãŸã ã—ã€z-indexãŒä½ã„ã‚‚ã®ã¯è§¦ã‚‰ãªã„ï¼ˆèª¤çˆ†é˜²æ­¢ï¼‰
        var zi = 0;
        try { zi = parseInt(st.zIndex, 10); if(isNaN(zi)) zi = 0; } catch(_e){ zi = 0; }
        if(zi < 1000) continue; // header(1000)ç›¸å½“ã‚ˆã‚Šä¸‹ã¯åŸºæœ¬è§¦ã‚‰ãªã„

        // ã“ã“ã ã‘ç„¡åŠ¹åŒ–
        el.style.pointerEvents = 'none';

        // debug=1æ™‚ã ã‘ã€å†…éƒ¨ãƒ­ã‚°ã«æ®‹ã™ï¼ˆUIè¡¨ç¤ºã¯å¢—ã‚„ã•ãªã„ï¼‰
        try{
          if(isDebug()){
            console.log('[TapShield] pointer-events none:', {tag: el.tagName, id: el.id, className: el.className, zIndex: zi});
          }
        }catch(_e){}
      }
    } catch(e) {}
  }


  // ---- 4) Rebind store chips click to ensure tap works even if delegation was broken ----
  function _sp_rebindStoreChips(){
    try {
      var list = document.getElementById('store-list');
      if (!list) return;
      var chips = Array.from(list.querySelectorAll('.store-tag'));
      chips.forEach(function(chip){
        try {
          if (chip.classList.contains('gps-btn')) return;
          if (chip.classList.contains('add-store')) return;
          if (chip.__sp_onclick_fixed) return;
          chip.__sp_onclick_fixed = true;
          chip.addEventListener('click', function(ev){
            try { ev.preventDefault(); ev.stopPropagation(); } catch(_e){}
            var name = (chip.textContent || '').trim();
            if (!name) return;
            try { window.curStore = name; } catch(_e){}
            try {
              var ind = document.getElementById('curStoreIndicator');
              if (ind) ind.innerText = 'ã€ ' + name + ' ã€‘ã§ä¿å­˜ã—ã¾ã™';
            } catch(_e){}
            try {
              chips.forEach(function(s){ try{ s.classList.remove('active'); }catch(_e){} });
              chip.classList.add('active');
            } catch(_e){}
            try {
              if (typeof window.db !== 'undefined' && window.db && window.db.config) {
                window.db.config.lastStoreName = name;
              }
            } catch(_e){}
            try { if (typeof window.saveDb === 'function') window.saveDb(); } catch(_e){}
          }, {passive:false});
        } catch(e) {}
      });
    } catch(e) {}
  }

  function boot(){
    _sp_forceStoreBarRender();
    setTimeout(_sp_forceStoreBarRender, 20);
    setTimeout(_sp_forceStoreBarRender, 200);
    setTimeout(_sp_forceStoreBarRender, 800);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function(){
      boot();
      requestAnimationFrame(boot);
    });
  } else {
    boot();
    requestAnimationFrame(boot);
  }
})();</script>


<!-- ===== PATCH v20.4.13B-fix-storetap-gps (2026-01-27) ===== -->
<script>
(function(){
  try{
    if(typeof VERSION_INFO==='object' && VERSION_INFO){
      VERSION_INFO.VER = '20.4.13B';
      VERSION_INFO.FULL = '20.4.13B [VERLOCK SSOT]';
    }
    if(document && document.title && document.title.indexOf('Smart Price')===0){
      document.title = 'Smart Price 20.4.13B';
    }
  }catch(_e){}

  function forceStoreBar(){
    try{
      var area=document.querySelector('.store-area'); if(area){area.style.zIndex='60';area.style.pointerEvents='auto';}
      var list=document.getElementById('store-list'); if(list){list.style.pointerEvents='auto';}
      var gps=document.querySelector('.gps-btn'); if(gps){gps.classList.toggle('on', !!window.isGpsOn);}
    }catch(_e){}
  }

  if(typeof window.renderStoreList==='function' && !window.__sp2044_renderWrap){
    window.__sp2044_renderWrap=true;
    var orig=window.renderStoreList;
    window.renderStoreList=function(){ var r=orig.apply(this,arguments); forceStoreBar(); return r; };
  }

  if(typeof window.toggleGps==='function' && !window.__sp2044_toggleWrap){
    window.__sp2044_toggleWrap=true;
    var tg=window.toggleGps;
    window.toggleGps=function(){ var r=tg.apply(this,arguments); try{ if(typeof window.renderStoreList==='function') window.renderStoreList(); }catch(_e){} setTimeout(function(){try{ if(typeof window.renderStoreList==='function') window.renderStoreList(); }catch(_e){}},300); return r; };
  }

  // initial render early
  try{ if(typeof window.renderStoreList==='function') window.renderStoreList(); }catch(_e){}
  document.addEventListener('DOMContentLoaded', function(){ try{ if(typeof window.renderStoreList==='function') window.renderStoreList(); }catch(_e){} });
})();
</script>


<!-- ===== PATCH v20.4.13B-verlock-storebar-gps (2026-01-27 JST) ===== -->
<script>
(function(){
  'use strict';
  // SSOT
  var SP_VER = '20.4.13B';
  var SP_VER_FULL = '20.4.13B [VERLOCK SSOT]';
  try {
    if (typeof window.VERSION_INFO === 'object' && window.VERSION_INFO) {
      window.VERSION_INFO.VER = SP_VER;
      window.VERSION_INFO.FULL = SP_VER_FULL;
    }
  } catch(e) {}

  // Force title/badge (UI unchanged: just text)
  function _sp_setText(el, txt) {
    try { if (el) el.textContent = txt; } catch(e) {}
  }
  function _sp_refreshVersionBadge() {
    try {
      // badge is usually in header; find elements that look like version pill
      var pills = Array.from(document.querySelectorAll('header span, header div, .header span, .app-header span, .topbar span'))
        .filter(function(n){ return (n.textContent||'').trim().match(/^\d+\.\d+\.\d+[A-Za-z]?$/) || (n.textContent||'').trim().match(/^v?\d+\.\d+\.\d+/); });
      pills.forEach(function(p){ _sp_setText(p, SP_VER); });
      if (document.title && document.title.indexOf('Smart Price')===0) document.title = 'Smart Price ' + SP_VER;
    } catch(e) {}
  }

  // SW/Cache hard-bypass once per build (prevents "version stuck")
  function _sp_cacheBypassOnce() {
    try {
      var p = new URL(location.href);
      var b = p.searchParams.get('b') || '';
      if (!b) return;
      var key = '__sp_last_build__';
      var last = '';
      try { last = localStorage.getItem(key) || ''; } catch(e) {}
      if (last === b) return;
      try { localStorage.setItem(key, b); } catch(e) {}

      // If ServiceWorker controls this page, unregister + clear caches then reload once.
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(regs){
          return Promise.all(regs.map(function(r){ try { return r.unregister(); } catch(e){ return false; } }));
        }).catch(function(){}).finally(function(){
          if ('caches' in window) {
            caches.keys().then(function(keys){
              return Promise.all(keys.map(function(k){ try { return caches.delete(k); } catch(e){ return false; } }));
            }).catch(function(){}).finally(function(){
              setTimeout(function(){ location.replace(p.toString()); }, 50);
            });
          } else {
            setTimeout(function(){ location.replace(p.toString()); }, 50);
          }
        });
      }
    } catch(e) {}
  }

  // Store bar tappable + delegation
  function _sp_fixStoreBarTap() {
    try {
      var area = document.querySelector('.store-area') || document.getElementById('store-area') || document.querySelector('.storebar') || document.querySelector('.store-bar');
      if (area) {
        area.style.position = area.style.position || 'relative';
        area.style.zIndex = '60';
        area.style.pointerEvents = 'auto';
      }
      var list = document.getElementById('store-list');
      if (list) {
        list.style.pointerEvents = 'auto';
        // delegation (works even if innerHTML is used)
        if (!list.__sp_delegated) {
          list.__sp_delegated = true;
          list.addEventListener('click', function(ev){
            var t = ev.target;
            if (!t) return;
            var el = t.closest ? t.closest('.store-tag') : t;
            if (!el || !el.classList || !el.classList.contains('store-tag')) return;
            if (el.classList.contains('gps-btn') || el.classList.contains('add-store')) return;

            var name = (el.getAttribute('data-name') || el.textContent || '').trim();
            if (!name) return;
            // ensure global curStore updates
            try {
              if (typeof window.curStore !== 'undefined') window.curStore = name;
              if (window.db && db.config) db.config.lastStoreName = name;
            } catch(e) {}

            // visual active
            try {
              Array.from(list.querySelectorAll('.store-tag')).forEach(function(s){ s.classList.remove('active'); });
              el.classList.add('active');
            } catch(e) {}

            try { if (typeof window.saveDb === 'function') window.saveDb(); } catch(e) {}
            try {
              var ind = document.getElementById('curStoreIndicator');
              if (ind) ind.innerText = 'ã€ ' + name + ' ã€‘ã§ä¿å­˜ã—ã¾ã™';
            } catch(e) {}
          }, true);
        }
      }
    } catch(e) {}
  }

  // GPS toggle: ensure button state + immediate render + async fetch
  function _sp_patchToggleGps() {
    try {
      var orig = window.toggleGps;
      if (typeof orig !== 'function') return;
      if (orig.__sp_patched_2045) return;
      function setBtn(on) {
        try {
          var btn = document.querySelector('.gps-btn');
          if (!btn) return;
          if (on) btn.classList.add('on'); else btn.classList.remove('on');
          // text might be "GPS ON/OFF"
          if (btn.textContent && btn.textContent.indexOf('GPS')===0) {
            btn.textContent = on ? 'GPS ON' : 'GPS OFF';
          }
        } catch(e) {}
      }
      var wrapped = function(){
        var before = !!window.isGpsOn;
        var ret;
        try { ret = orig.apply(this, arguments); } catch(e) { ret = undefined; }
        // some versions return nothing; treat as toggle
        window.isGpsOn = !before;
        setBtn(window.isGpsOn);
        try { if (typeof window.renderStoreList==='function') window.renderStoreList(); } catch(e) {}
        // async refresh nearby stores when turning on
        if (window.isGpsOn && typeof window.fetchNearbyStores==='function') {
          Promise.resolve().then(function(){ return window.fetchNearbyStores(); }).then(function(){
            try { if (typeof window.renderStoreList==='function') window.renderStoreList(); } catch(e) {}
          }).catch(function(){});
        }
        return ret;
      };
      wrapped.__sp_patched_2045 = true;
      window.toggleGps = wrapped;
      // reflect initial button state
      setBtn(!!window.isGpsOn);
    } catch(e) {}
  }

  function _sp_boot() {
    _sp_refreshVersionBadge();
    _sp_fixStoreBarTap();
    _sp_patchToggleGps();
  }

  // run
  _sp_cacheBypassOnce();
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function(){ _sp_boot(); setTimeout(_sp_boot, 350); });
  } else {
    _sp_boot(); setTimeout(_sp_boot, 350);
  }
  // keep refreshing version pill after any late header render
  setTimeout(_sp_refreshVersionBadge, 800);
})();
</script>

</body>
</html>
