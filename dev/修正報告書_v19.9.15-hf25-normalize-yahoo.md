# 🔧 Smart Price 修正報告書

**TO**: ユイ（監督）、なべさん（実機検証）  
**FROM**: Rex  
**DATE(JST)**: 2026-01-15 00:15 JST  
**VERSION**: v19.9.15-hf25-normalize-yahoo  
**BUILD_ID**: 2026-01-15_0015_normalize-yahoo

---

## 📋 今回の修正スコープ

**ユイ指示Item 2**: Yahoo情報の"12本1箱問題"を賢く回避

**方針**: UIを増やさず、自動整形＋必要なら既存の入力欄で手直し

---

## ✅ 実施内容

### 新機能：`normalizeYahooProductInfo()` 関数

Yahoo Shopping APIから取得した商品情報を自動的に整形します。

#### 1️⃣ まとめ買い語の検出

**検出パターン**:
- `×12本` `×24個` `×6缶` 等
- `12本×` `24個×` 等
- `12本セット` `24個セット` 等
- `ケース` `箱買い` `まとめ買い`
- `[12本]` `[24個]` 等

**処理**: フラグを立て、商品名から一旦削除 → 末尾に「（ケース）」を追加

---

#### 2️⃣ 不要な販促文言の除去

**除去パターン**:
```
「送料無料！」「地域限定」「最短」「公式」「PayPay」「ポイント」
【送料無料】【公式】
(送料無料) (公式)
/ot/ /
```

---

#### 3️⃣ 重複・冗長な情報の除去

**例**:
```
整形前: キリンビバレッジ 小岩井ココア [小岩井 ココア 400g]
整形後: キリンビバレッジ 小岩井ココア
```

商品名に既に含まれている `[ ]` 内の情報を削除

---

#### 4️⃣ メーカー名から販売店名を除去

**除去パターン**:
- `○○店` `○○ストア` `○○ショップ`
- `楽天` `Amazon` `ヤフー` `Yahoo`

---

#### 5️⃣ 空白・記号の整理

- 連続する空白を1つに
- 先頭・末尾の空白・記号を除去

---

#### 6️⃣ まとめ買い注記の追加

まとめ買い商品には、短く「（ケース）」を末尾に追加

---

## 📊 実例：なべさんのスクショから

### Before（整形前）
```
「送料無料！」「地域限定」キリンビバレッジ 小岩井 The ミルクココア ホット 400mlペットボトル×24本 [小岩井 ミルクココア ココア 400g] /ot/
```

### After（整形後）
```
キリンビバレッジ 小岩井 The ミルクココア ホット 400ml ペットボトル（ケース）
```

**削除された要素**:
- ✅ 「送料無料！」
- ✅ 「地域限定」
- ✅ 「×24本」
- ✅ 「[小岩井 ミルクココア ココア 400g]」
- ✅ 「/ot/」

**追加された要素**:
- ✅ 「（ケース）」（まとめ買い注記）

---

## 🔍 デバッグ機能

### debug=1 のとき

**画面内ログ**:
```
[Normalize] Before: 「送料無料！」...×24本...
[Normalize] After: キリン...（ケース）
[Normalize] Pack hint detected
[Yahoo] まとめ買い商品を検出しました
```

---

## 📦 デプロイURL

### 通常URL（実機テスト用）
```
https://smart-price-official.github.io/Smart-Price-Book/dev/?b=2026-01-15_0015_normalize-yahoo
```

### デバッグURL（詳細ログ確認用）
```
https://smart-price-official.github.io/Smart-Price-Book/dev/?b=2026-01-15_0015_normalize-yahoo&debug=1
```

---

## 🧪 検証推奨項目（なべさん向け）

| 項目 | 確認内容 | 期待結果 |
|------|----------|----------|
| 1. まとめ買い検出 | 「×24本」等の商品をスキャン | 「（ケース）」が表示される |
| 2. 販促文言除去 | 「送料無料！」等の商品 | 自動的に削除される |
| 3. 商品名短縮 | 長いタイトルの商品 | 読みやすい短い名前になる |
| 4. 手動修正可能 | 整形後の商品名を編集 | 通常通り編集できる |
| 5. デバッグログ | debug=1 で確認 | 整形前後が画面に表示される |

---

## 📝 変更履歴

```
VERSION: v19.9.15
FULL_VERSION: v19.9.15-hf25-normalize-yahoo
DATE(JST): 2026-01-15 00:15 JST
TITLE: Yahoo商品情報の自動整形（12本1箱問題対応）

CHANGES:
- normalizeYahooProductInfo() 関数を追加（商品情報の自動整形）
- 販促文言の自動除去（送料無料/地域限定/公式/PayPay等）
- まとめ買い検出（×12/×24/ケース/箱/セット等）
- 商品名の短縮化（1個買い想定の短い表示名）
- 重複・冗長な情報の除去
- メーカー名から販売店名を除去
- まとめ買い商品には「（ケース）」注記を追加
- debug=1 で整形前後を画面内ログに表示

AUTHOR: Rex
BUILD_ID: 2026-01-15_0015_normalize-yahoo
POLICY: UI変更禁止（自動整形のみ）
```

---

## ✅ 完了確認

- [x] normalizeYahooProductInfo() 関数追加
- [x] まとめ買い語の検出ロジック実装
- [x] 販促文言の除去ロジック実装
- [x] 重複情報の除去ロジック実装
- [x] メーカー名整形ロジック実装
- [x] まとめ買い注記の追加
- [x] デバッグログの追加
- [x] バージョン情報更新（v19.9.15-hf25-normalize-yahoo）
- [x] リンターエラー確認（0件）
- [x] 修正報告書作成

---

## 🎯 ユイ指示の達成状況

| # | 項目 | 状態 |
|---|------|------|
| **1** | **Failed to fetch完全解決** | 🟡 部分対応（Item 2優先） |
| **2** | **12本1箱問題** | ✅ **完了** |
| **3** | **税込↔税別切替** | ⏳ 次回対応 |
| **4** | **EC価格統一表示** | ⏳ 次回対応 |
| **5** | **赤マーク意味確定** | ⏳ 次回対応 |

---

**次のステップ**: なべさんによる実機検証（A→C→B）
