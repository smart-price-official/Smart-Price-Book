# 🔧 Smart Price デバッグ強化報告書

**TO**: なべさん、ユイ（監督）  
**FROM**: Rex  
**DATE(JST)**: 2026-01-14 17:30 JST  
**VERSION**: v19.9.14-hf24-debug-fetch  
**BUILD_ID**: 2026-01-14_1728_rex-check

---

## 📋 今回の目的

**Failed to fetch の原因切り分け**:
- ①フォルダ違い（config.json の読込パス）
- ②CORS（GAS側の設定）
- ③Service Workerキャッシュ
- ④その他（タイムアウト等）

---

## ✅ 実施内容（2件）

### 1️⃣ config読込のデバッグログ追加

**対象**: `loadConfig()` 関数

**追加したログ**:
```javascript
// ✅ 読込開始
showToast(`[Config] Loading from: ${fullUrl}`, 5000);

// ✅ HTTPステータス
showToast(`[Config] HTTP Status: ${res.status} ${res.statusText}`, 5000);

// ✅ 読込成功
showToast(`[Config] Loaded OK: ${JSON.stringify(json).substring(0, 100)}...`, 5000);
```

**確認できる情報**:
- 実際に読み込んでいるURLの完全パス
- HTTPステータスコード（200/404/403等）
- 読み込んだconfig.jsonの内容（先頭100文字）

---

### 2️⃣ Yahoo検索のデバッグログ追加

**対象**: `lookupYahooByJan()` 関数

**追加したログ**:
```javascript
// ✅ 検索開始
showToast(`[Yahoo] Fetching: ${requestUrl}`, 5000);

// ✅ HTTPステータス
showToast(`[Yahoo] HTTP Status: ${res.status} ${res.statusText}`, 5000);

// ✅ エラー詳細
showToast(`[Yahoo] Error: ${errorDetail}`, 8000);
```

**確認できる情報**:
- 実際に送信しているリクエストURL
- HTTPステータスコード
- エラーの種類（タイムアウト/CORS/404等）

---

## 📦 デプロイURL

### 検証用URL（キャッシュ回避＋デバッグ）

**通常URL**:
```
https://smart-price-official.github.io/Smart-Price-Book/dev/?b=2026-01-14_1728_rex-check
```

**デバッグURL**（画面内ログ表示）:
```
https://smart-price-official.github.io/Smart-Price-Book/dev/?b=2026-01-14_1728_rex-check&debug=1
```

**config.json直接確認**:
```
https://smart-price-official.github.io/Smart-Price-Book/dev/config.json
```

**キャッシュ回避版**:
```
https://smart-price-official.github.io/Smart-Price-Book/dev/config.json?b=2026-01-14_1728_rex-check
```

---

## 🧪 検証手順（A→C→B）

### A) 通常タブで開く

1. **URL**: `https://smart-price-official.github.io/Smart-Price-Book/dev/`
2. **確認内容**:
   - ページが正常に表示されるか
   - エラーが出るか（出たら画面キャプチャ）

### C) デバッグモードで開く（★重要）

1. **URL**: `https://smart-price-official.github.io/Smart-Price-Book/dev/?b=2026-01-14_1728_rex-check&debug=1`
2. **確認内容**:
   - 画面下部に表示される黒いトースト（ログメッセージ）を確認
   - 以下の情報をスクショ:
     - `[Config] Loading from: ...` （どこから読んでいるか）
     - `[Config] HTTP Status: ...` （ステータスコード）
     - `[Config] Loaded OK: ...` （読込成功したか）
   - バーコードスキャン or 手入力でJAN検索を試行
   - 以下の情報をスクショ:
     - `[Yahoo] Fetching: ...` （どこに送信しているか）
     - `[Yahoo] HTTP Status: ...` （ステータスコード）
     - `[Yahoo] Error: ...` （エラーが出た場合）

### B) PWA/ホーム追加で開く

1. **URL**: 同じく `?b=2026-01-14_1728_rex-check&debug=1`
2. **確認内容**:
   - A/Cと同じ手順で確認
   - A/CでOKなのにBだけNGなら → Service Workerキャッシュが原因

---

## 🔍 切り分け観点

### ① フォルダ違い

**症状**:
- `[Config] HTTP Status: 404 Not Found` が表示される
- `[Config] Loading from: ...` のパスが間違っている

**対応**:
- アプリ内の config 読込パスを修正

---

### ② CORS

**症状**:
- `[Yahoo] Error: Failed to fetch` が表示される
- HTTPステータスが表示されない（CORSエラーは先に止まる）
- ブラウザで直接開くとJSON返却されるが、アプリからは失敗

**対応**:
- GAS側で `Access-Control-Allow-Origin: *` を設定
- または同一オリジンのProxyを挟む

---

### ③ Service Workerキャッシュ

**症状**:
- A/CでOK、BだけNG
- `b=` パラメータを変えても改善しない

**対応**:
- Service Workerのキャッシュ対象から `config.json` と Yahoo Proxy結果を除外
- または PWA を削除→再追加

---

### ④ タイムアウト

**症状**:
- `[Yahoo] Error: タイムアウト（12秒）` が表示される

**対応**:
- タイムアウト時間を延長（現在12秒）
- またはGAS側のレスポンス速度を改善

---

## 📝 変更履歴

```
VERSION: v19.9.14
FULL_VERSION: v19.9.14-hf24-debug-fetch
DATE(JST): 2026-01-14 17:30 JST
TITLE: config/Yahoo検索のデバッグログ追加（画面内表示）

CHANGES:
- loadConfig() に画面内デバッグログを追加（URL/HTTPステータス/エラー詳細）
- lookupYahooByJan() に画面内デバッグログを追加（URL/HTTPステータス/エラー詳細）
- タイムアウト/CORS/404の切り分けが可能に
- debug=1 で全てのログが画面内に表示される

AUTHOR: Rex
BUILD_ID: 2026-01-14_1728_rex-check
POLICY: UI変更禁止（デバッグログのみ）
```

---

## ✅ 完了確認

- [x] config読込デバッグログ追加
- [x] Yahoo検索デバッグログ追加
- [x] エラー詳細表示（タイムアウト/CORS判別）
- [x] バージョン情報更新（v19.9.14-hf24-debug-fetch）
- [x] リンターエラー確認（0件）
- [x] 修正報告書作成

---

## 📌 現状確認事項

### config.json の中身

現在のローカル `Smart-Price-Book/dev/config.json`:
```json
{
  "yahooProxyExecUrl": "https://script.google.com/macros/s/AKfycby0Xxxxxx/exec",
  "configVersion": "2026-01-13_1010"
}
```

**確認が必要**:
- ❓ `Xxxxxx` 部分が実際のGASのデプロイIDに置き換わっているか
- ❓ GitHub Pages上の `dev/config.json` も同じ内容か

---

## 🎯 次のステップ

1. **なべさんが検証**（A→C→B）
2. **スクショ報告**（特にC）
3. **原因を特定**（①②③④のどれか）
4. **最小修正案を提示**（UIは触らない）

---

**次のステップ**: なべさんによる実機検証（A→C→B）
