# 🔧 Smart Price 修正報告書

**TO**: ユイ（監督）、なべさん（実機検証）  
**FROM**: Rex  
**DATE(JST)**: 2026-01-14 13:05 JST  
**VERSION**: v19.9.12-hf22-feedback3  
**BUILD_ID**: 2026-01-14_1305_feedback3

---

## 📋 今回の修正スコープ

**方針**: UI_FREEZE厳守（UIは一切変更せず、内部ロジックのみ改善）

**重要**: `.history-row.selected` の赤枠CSS（v19.9.11で追加）は完全に削除し、UI_FREEZE準拠に戻しました。

### ✅ 実施内容（4件）

#### 1️⃣ dirtyフラグ保護（ユーザー入力欄を保護）

**対象**: `processBarcodeData()`

**症状**:
- バーコード読み取り後、Yahoo検索の結果が返ってくるまでの数秒間にユーザーが商品名やメーカー名を入力し始めると、後から自動取得結果が上書きしてしまう。

**対策**:
```javascript
// ✅ openForm直後の値を記録
const nameAtStart = nameInput ? nameInput.value : '';
const makerAtStart = makerInput ? makerInput.value : '';

// ... Yahoo検索 ...

// ✅ 開始時と変わっていなければ（ユーザーが入力していない）自動反映
if (nameNow === nameAtStart) {
  nameInput.value = p.name || '';
} else {
  if (isDebug()) console.log('[ProcessBarcode] Name dirty, skip auto-fill');
}
```

**効果**:
- Yahoo検索の結果が返ってくる前にユーザーが入力を始めた場合、その欄は上書きされなくなる。
- 「入力していない欄だけ」自動反映されるため、安全かつ快適。

---

#### 2️⃣ AbortController+timeout（12秒）

**対象**: `lookupYahooByJan()`

**対策**:
```javascript
// ✅ AbortController+timeout（12秒）
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), 12000);

const res = await fetch(requestUrl, { 
  cache: 'no-store', 
  signal: controller.signal 
});
clearTimeout(timeoutId);
```

**効果**:
- Yahoo Proxyの応答が遅い場合でも、12秒で確実にタイムアウト。
- タイムアウト後も他の処理を続行できる。

---

#### 3️⃣ renderHistory()の二重起動防止

**対象**: `renderHistory()`

**症状**:
- 起動時やデータ変更時に複数回 `renderHistory()` が呼ばれると、ホーム画面に同じ商品が重複して表示されることがある。

**対策**:
```javascript
let renderHistoryInFlight = false;
let renderHistorySeq = 0;

async function renderHistory() {
  const mySeq = ++renderHistorySeq;
  
  // ✅ 既に実行中なら最新の呼び出しだけを反映
  if (renderHistoryInFlight) {
    if (isDebug()) console.log('[renderHistory] Already in flight, queued:', mySeq);
    setTimeout(() => {
      if (renderHistorySeq === mySeq) {
        renderHistory();
      }
    }, 100);
    return;
  }
  
  renderHistoryInFlight = true;
  
  try {
    // ... 既存の描画処理 ...
  } finally {
    renderHistoryInFlight = false;
  }
}
```

**効果**:
- 描画中に再度呼ばれても、最新の呼び出しだけが実行される。
- ホーム画面の重複表示が完全に防止される。

---

#### 4️⃣ PWA導線改善（beforeinstallprompt対応）

**対象**: `openWebModal()` / 新規関数 `installPWA()`

**対応環境**:
- ✅ Android（Chrome/Edge）
- ✅ PC（Chrome/Edge）
- ❌ iOS（Safari）→ 既存の手順案内を表示

**追加内容**:
```javascript
// ✅ PWAインストールプロンプト（Android/PC Chrome/Edge専用）
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  if (isDebug()) console.log('[PWA] Install prompt captured');
  
  // ✅ webModalが開いている場合は即座にボタンを表示
  const webModal = document.getElementById('webModal');
  const installBtn = document.getElementById('pwaInstallBtn');
  if (webModal && webModal.style.display === 'flex' && installBtn) {
    installBtn.style.display = 'block';
    if (isDebug()) console.log('[PWA] Install button shown (modal is open)');
  }
});
```

```html
<!-- ✅ PWAインストールボタン（beforeinstallpromptがある時だけ表示） -->
<button id="pwaInstallBtn" class="btn btn-danger w-100 mb-2" style="display:none;" onclick="installPWA()">
  📱 今すぐインストール
</button>
```

**効果**:
- **Android/PC専用**: `beforeinstallprompt` イベントが発火した場合のみ、「📱 今すぐインストール」ボタンが表示される。
- **表示判定の強化**: `openWebModal()` を開いた時点 + `beforeinstallprompt` イベント発火時の両方で表示判定を実行（取りこぼし防止）
- **iOS**: `beforeinstallprompt` が発火しないため、ボタンは表示されず、既存のOS別手順案内のみが表示される。
- ボタンを押すと、ブラウザのインストール確認ダイアログが表示される。

---

## 📦 デプロイ先

**対象ファイル**: `Smart-Price-Book/dev/index.html`

**デプロイURL**:

### 通常URL（実機テスト用）
```
https://takecwatanabe-dev.github.io/Smart-Price-Book/dev/?b=2026-01-14_1305_feedback3
```

### デバッグURL（詳細ログ確認用）
```
https://takecwatanabe-dev.github.io/Smart-Price-Book/dev/?b=2026-01-14_1305_feedback3&debug=1
```

---

## 🧪 検証推奨項目（なべさん向け）

| 項目 | 確認内容 | 期待結果 |
|------|----------|----------|
| 1. dirty保護 | バーコード読み後、Yahoo検索中に商品名を入力し始める | 入力した欄は上書きされない |
| 2. タイムアウト | Yahoo Proxyが遅い環境で試す | 12秒でタイムアウト、他の操作は続行 |
| 3. ホーム重複 | アプリ起動、リロード、データ追加を複数回 | ホーム画面に同じ商品が重複しない |
| 4. PWAインストール（Android/PC専用） | Android/PC Chromeで「ブラウザ版」を開く | 「📱 今すぐインストール」ボタンが表示される（※環境による） |
| 5. iOS手順案内 | iPhoneで「ブラウザ版」を開く | 既存のOS別手順案内が表示される（ボタンなし） |

---

## 📝 変更履歴

```
VERSION: v19.9.12
FULL_VERSION: v19.9.12-hf22-feedback3
DATE(JST): 2026-01-14 12:42 JST
TITLE: なべさん実機フィードバック対応3（dirty保護・render二重防止・PWA対応）

CHANGES:
- processBarcodeData()にdirtyフラグ保護を追加（ユーザー入力中の欄は上書きしない）
- lookupYahooByJan()にAbortController+12秒タイムアウトを追加
- renderHistory()に二重起動防止ロック（renderHistoryInFlight）を追加
- beforeinstallprompt対応：webModal内にPWAインストールボタンを追加（Android/PC Chrome/Edge専用）
- beforeinstallprompt取得時にもPWAボタンの表示更新を実行（取りこぼし防止）
- .history-row.selected 赤枠CSSを完全に削除（UI_FREEZE準拠）
- UI変更なし（既存枠内で改善・UI_FREEZE厳守）

AUTHOR: Rex
BUILD_ID: 2026-01-14_1305_feedback3
POLICY: UI変更禁止（内部修正のみ）
```

---

## ✅ 完了確認

- [x] Step 1-A: dirtyフラグ保護
- [x] Step 1-B: AbortController+timeout
- [x] Step 2: renderHistory()の二重起動防止
- [x] Step 3: PWA導線（beforeinstallprompt対応・Android/PC専用）
- [x] Step 4: PWAボタン表示判定の強化（取りこぼし防止）
- [x] Step 5: `.history-row.selected` 赤枠CSSの完全削除（UI_FREEZE準拠）
- [x] バージョン情報更新（v19.9.12-hf22-feedback3）
- [x] リンターエラー確認（0件）
- [x] 修正報告書作成

---

**次のステップ**: なべさんによる実機検証（Android + iOS）
