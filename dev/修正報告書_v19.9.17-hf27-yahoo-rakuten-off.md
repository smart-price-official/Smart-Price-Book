# 🔧 Smart Price 修正報告書

**TO**: ユイ（監督）、なべさん（実機検証）  
**FROM**: Rex  
**DATE(JST)**: 2026-01-15 14:00 JST  
**VERSION**: v19.9.17-hf27-yahoo-rakuten-off  
**BUILD_ID**: 2026-01-15_1400_yahoo-rakuten-off

---

## 📋 今回の修正スコープ

**ユイ指示**: 商品DBの優先順位を確定（Yahoo→国内→OFF）＋自動整形の精度アップ

**方針**: UI変更禁止（見た目・文言・配置そのまま）。内部ロジックのみ。

---

## ✅ 実施内容

### 0. 結論（優先順位）

**変更前**: OFF優先 → Yahoo価格取得

**変更後**: 
1. **Yahoo最優先**（現状の仕組みを維持、賢くする）
2. **国内DB（楽天）第2優先**（日本語・画像品質が安定しやすい）
3. **Open Food Facts（海外）第3優先**＝"最後の保険"

**理由**: 英語名・自撮り画像・カテゴリぶれが起きやすいので「最初から使わない」

---

### 1. Yahoo側の強化（ベースは維持、賢くする）

#### 1.1 信頼度スコア付き `normalizeYahooProductInfo()`

**目的**: Yahooが「12本1箱」みたいなタイトルを返しても、ユーザーが買う"1個"目線で表示する。

**実装内容**:
- **packCount検出**: `×12本` `×24個` 等から個数を抽出
- **isCase判定**: `ケース` `箱買い` `まとめ買い` 等を検出
- **信頼度スコア**: 初期値100、pack疑いが強いときは-20、中は-10

**返り値の拡張**:
```javascript
{
  name: "...",
  maker: "...",
  imageUrl: "...",
  packHint: true/false,  // まとめ買いフラグ
  packCount: 12,        // まとめ買い個数
  isCase: true/false,   // ケース商品フラグ
  trustScore: 80        // 信頼度スコア（100が最高）
}
```

**内部メタ情報保持**: `packCount` と `isCase` を保持（将来の比較に使う）

---

#### 1.2 メーカー名/販売店名混入の正規化関数を汎用化

**新規関数**: `normalizeMakerName(maker)`

**機能**:
- 販売店名パターンを除去（店/ストア/ショップ/楽天/Amazon/Yahoo等）
- Yahoo・楽天・OFFすべて共通の「正規化関数」として再利用

**使用箇所**:
- `normalizeYahooProductInfo()` 内で使用
- `lookupRakutenByJan()` 内で使用
- 将来的にOFFでも使用可能

---

### 2. 国内DB（第2優先）の導入：楽天を想定

#### 2.1 新規関数: `lookupRakutenByJan(jan, keyword = null)`

**狙い**: Yahooが変なときに、日本語名・メーカー・画像を国内ソースで補完する。

**実装内容**:
- **Yahoo Proxy経由**: `action=rakuten` で楽天データを取得
- **JAN優先**: JANでヒットするならJAN優先、ダメならキーワード
- **タイムアウト**: 12秒（Yahooと揃える）
- **エラーハンドリング**: 失敗時は静かに `null` を返す

**取得項目**:
- 商品名: `product.name`
- ブランド/メーカー: `product.brand` または `product.maker`
- 画像: `product.imageUrl` または `product.mediumImageUrl`

**正規化**: メーカー名は `normalizeMakerName()` で正規化

---

#### 2.2 フロー例（UI増やさない）

```
Yahooで取得 → 結果が弱い/空なら
  ↓
楽天で取得（JANでヒットするならJAN優先、ダメならキーワード）
  ↓
楽天が取れたら Yahoo結果を上書きせず、「不足している項目だけ補完」
```

**補完ルール**:
- 例：Yahooの画像がケース画像っぽい→楽天の単品画像があれば差し替え
- 例：メーカー名が空→楽天で補完
- 例：商品名が空→楽天で補完

---

### 3. Open Food Facts（第3優先）の"使い方ルール"

#### 3.1 絶対に第1優先にしない。補助だけ。

**OFFを使う条件（どれか満たしたら）**:
- Yahooも楽天も「未取得」または「整形後も不自然」
- かつ JAN（EAN-13）で問い合わせできる

**自動入力していい条件（厳しめ）**:
1. **商品名が日本語フィールドで取れる、または日本語が十分含まれる**
   - `product_name_ja` または `generic_name_ja` が存在
   - または商品名に日本語文字（ひらがな・カタカナ・漢字）が含まれる

2. **画像が明らかに商品正面（自撮り/棚写真っぽいのは自動採用しない）**
   - 画像URLに `front` が含まれる
   - または `image_front_url` が存在

**条件を満たさない場合の挙動**:
- 自動入力はしない（空のまま）
- 代わりに `debug=1` の画面内ログに「OFFは英語/画像品質の理由で採用しない」を出す
- 通常モードではトースト1回だけでOK（UI追加なし）

**カテゴリ補完**: 今回は「商品名・メーカー・画像」だけに限定（カテゴリ補完は次段階）

---

### 4. `processBarcodeData()` の優先順位変更

#### 4.1 実装フロー

```
1. Yahoo最優先（商品身元情報＋価格情報）
   ↓
2. Yahoo結果が弱い/空なら → 楽天で補完（不足項目のみ）
   ↓
3. Yahooも楽天も未取得の場合のみ → OFFを使用（条件チェック済み）
```

#### 4.2 上書き禁止ルール

- **Yahooで埋めた情報は、楽天/OFFで上書きしない**
- **例外**: Yahooの項目が空の場合のみ、その項目だけ楽天/OFFで補完

#### 4.3 デバッグログ

- `[Yahoo] OK (商品身元+価格)`
- `[楽天] 補完OK`
- `[採用] yahoo` / `yahoo+rakuten` / `rakuten` / `off` / `none`

---

### 5. P0（最優先）：カメラのピント問題対応

#### 5.1 なべさん報告

- **Xperia**: Web/PWAどちらもピントが合いにくい（カメラアプリは正常）
- **Pixel**: 読み取り精度が甘い印象
- **読み取り→商品反映までのタイムラグ**も未解決

#### 5.2 Rex対応方針（UI増やさない）

**実装内容**:
- **背面カメラ固定**: `facingMode: "environment"`（既存）
- **連続オートフォーカス優先**: `focusMode: "continuous"`（対応端末のみ）
- **連続露出調整**: `exposureMode: "continuous"`（対応端末のみ）
- **アスペクト比指定**: `aspectRatio: { ideal: 16/9 }`

**コード実装**:
```javascript
const cameraConfig = {
  facingMode: "environment", // 背面カメラ固定
  aspectRatio: { ideal: 16/9 },
  focusMode: "continuous", // 連続オートフォーカス（対応端末のみ）
  advanced: [
    { focusMode: "continuous" }, // 連続オートフォーカス優先
    { exposureMode: "continuous" } // 連続露出調整
  ]
};
```

**読み取り後の処理**: 先にUIへ仮反映→裏で補完（遅延体感を減らす）←既存実装

---

## 📊 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `Smart-Price-Book/dev/index.html` | ✅ 新規関数追加・既存関数修正 |

---

## 🔍 修正箇所の詳細

### 1. 新規関数: `normalizeMakerName(maker)`

**場所**: `normalizeYahooProductInfo()` の前

**機能**: メーカー名から販売店名を除去（汎用化）

---

### 2. 修正関数: `normalizeYahooProductInfo(info)`

**変更点**:
- 信頼度スコア付き（`trustScore`）
- `packCount` と `isCase` を保持
- メーカー名正規化に `normalizeMakerName()` を使用

---

### 3. 新規関数: `lookupRakutenByJan(jan, keyword = null)`

**場所**: `lookupOffByJan()` の後、`lookupYahooByJan()` の前

**機能**: 楽天API（Yahoo Proxy経由）から商品情報を取得

---

### 4. 修正関数: `lookupOffByJan(jan)`

**変更点**:
- 条件チェック追加（日本語フィールド、画像品質）
- 条件を満たさない場合は自動入力しない

---

### 5. 修正関数: `processBarcodeData(code)`

**変更点**:
- 優先順位変更（Yahoo最優先→楽天第2→OFF第3）
- 上書き禁止ルール実装
- デバッグログ追加（どのソースを採用したか）

---

### 6. 修正関数: `startScanner()`

**変更点**:
- カメラ設定を拡張（連続オートフォーカス、連続露出調整）

---

## 🎯 期待される効果

### ✅ 商品情報の品質向上

- **Yahoo最優先**: 現状の仕組みを維持しつつ、信頼度スコアで品質を判定
- **楽天補完**: 日本語名・メーカー・画像の品質が安定
- **OFFは最後の保険**: 英語名・自撮り画像の問題を回避

### ✅ カメラのピント問題改善

- **連続オートフォーカス**: 対応端末でピントが合いやすくなる
- **背面カメラ固定**: 一貫した読み取り環境

---

## 🧪 テスト観点

### A. 通常ブラウザ（PC Chrome/Edge）

1. **JANコードを入力** → Yahoo取得成功 → 商品名・メーカー・画像がYahoo由来で表示される
2. **JANコードを入力** → Yahoo弱い → 楽天で補完 → 不足項目が補完される
3. **JANコードを入力** → Yahoo/楽天失敗 → OFFで取得（条件チェック済み）

### B. PWA/スマホ

1. **スキャン** → Yahoo取得成功 → 商品情報がYahoo由来で表示される
2. **スキャン** → ピントが合いやすくなる（連続オートフォーカス）
3. **手入力** → 優先順位通りに取得される

### C. debug=1

1. **Yahoo取得成功**: `[Yahoo] OK (商品身元+価格)` が表示される
2. **楽天補完**: `[楽天] 補完OK` が表示される
3. **OFF採用/不採用**: `[OFF] OK ...` または `[OFF] 英語/画像品質の理由で採用しない` が表示される
4. **採用ソース**: `[採用] yahoo` / `yahoo+rakuten` / `rakuten` / `off` / `none` が表示される

---

## 📝 注意事項

### ⚠️ 楽天APIの実装

- **Yahoo Proxy経由**: 楽天APIは直接呼び出さず、Yahoo Proxy経由で取得
- **GAS側の実装**: `action=rakuten` の実装が必要（今回はクライアント側のみ）

### ⚠️ OFF APIの制限

- **条件チェック**: 日本語フィールド・画像品質の条件を満たさない場合は自動入力しない
- **デバッグログ**: 条件を満たさない理由を `debug=1` で表示

### ⚠️ カメラ設定

- **対応端末のみ**: 連続オートフォーカス・連続露出調整は対応端末のみ有効
- **フォールバック**: 対応していない端末では既存の動作にフォールバック

---

## 🚀 デプロイ情報

### 検証URL

**通常URL**:
```
https://smart-price-official.github.io/Smart-Price-Book/dev/?b=2026-01-15_1400_yahoo-rakuten-off
```

**デバッグURL**:
```
https://smart-price-official.github.io/Smart-Price-Book/dev/?b=2026-01-15_1400_yahoo-rakuten-off&debug=1
```

---

## 📌 次のステップ（将来の拡張）

1. **楽天API（GAS側）**: `action=rakuten` の実装が必要
2. **価格DBの拡張**: Open Prices（Open Food Facts系の姉妹）の調査
3. **カテゴリ補完**: OFFのカテゴリ情報を活用（次段階）

---

**以上**
