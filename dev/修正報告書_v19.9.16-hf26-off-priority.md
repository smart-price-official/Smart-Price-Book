# 🔧 Smart Price 修正報告書

**TO**: ユイ（監督）、なべさん（実機検証）  
**FROM**: Rex  
**DATE(JST)**: 2026-01-15 13:00 JST  
**VERSION**: v19.9.16-hf26-off-priority  
**BUILD_ID**: 2026-01-15_1300_off-priority

---

## 📋 今回の修正スコープ

**ユイ指示**: 商品情報は Open Food Facts（OFF）優先、価格は Yahoo 優先の二段構えに変更

**方針**: UI変更禁止（見た目・文言・配置そのまま）。内部ロジックのみ。

---

## ✅ 実施内容

### Task 1: OFFクライアント実装（`lookupOffByJan()` 関数）

**新規関数**: `lookupOffByJan(jan)`

#### エンドポイント（優先順位）
1. `https://jp.openfoodfacts.org/api/v2/product/{JAN}.json`（日本優先）
2. `https://world.openfoodfacts.org/api/v2/product/{JAN}.json`（フォールバック）

#### 取得項目（存在する範囲でOK）
- **商品名候補**: `product_name_ja` → `product_name` → `generic_name_ja` → `generic_name`
- **ブランド**: `brands`（カンマ区切りなら先頭だけ）
- **画像**: `image_front_url` → `image_url`

#### タイムアウト・エラーハンドリング
- **タイムアウト**: 12秒（Yahoo側と揃える）
- **AbortController**: タイムアウト制御
- **CORS**: `mode: 'cors'`, `credentials: 'omit'`
- **失敗時**: 静かに `null` を返し、次へ進む（アプリが落ちない）

#### デバッグログ（`debug=1`）
- `[OFF] Fetching...`
- `[OFF] OK name=... brand=... img=...`
- `[OFF] Miss/Fail → fallback Yahoo normalize`

---

### Task 2: 既存フローに"OFF優先"を組み込む（`processBarcodeData()` 修正）

#### 採用順位（最重要ルール）

**A. 商品"身元"情報（商品名/メーカー/画像）**
1. **OFF** →（ダメなら）**Yahoo normalize** →（ダメなら）**手入力**

**B. 価格情報（比較・最安値・購入導線）**
1. **Yahoo** →（将来）Rakuten/Amazon →（将来）他

#### 実装フロー

```
1. JANが読めたら、まずOFFを投げる
   ↓
2. OFFが成功したら「商品身元」をOFFで埋める
   ↓
3. その後 Yahooは価格取得目的で実行
   （商品名/メーカー/画像は原則上書きしない）
   ↓
4. OFFが失敗した場合のみ、Yahooの normalizeYahooProductInfo() を使って商品身元を作る
```

#### 上書き禁止ルール（重要）

- **OFFで埋めた `name/brand/image` は、Yahoo結果で上書きしない**
- **例外**: OFFの `name` が空、`brand` が空、`image` が空の場合のみ、その項目だけYahooで補完してよい

#### コード実装例

```javascript
// ✅ OFF優先（商品身元情報）
offInfo = await lookupOffByJan(jan);
if (offInfo) {
  finalInfo.name = offInfo.name || '';
  finalInfo.maker = offInfo.maker || '';
  finalInfo.imageUrl = offInfo.imageUrl || '';
}

// ✅ Yahooは価格取得目的で実行
yahooInfo = await lookupYahooByJan(jan);

// ✅ 上書き禁止ルール
if (!finalInfo.name && yahooInfo.name) {
  finalInfo.name = yahooInfo.name; // 空の場合のみ補完
}
if (!finalInfo.maker && yahooInfo.maker) {
  finalInfo.maker = yahooInfo.maker; // 空の場合のみ補完
}
if (!finalInfo.imageUrl && yahooInfo.imageUrl) {
  finalInfo.imageUrl = yahooInfo.imageUrl; // 空の場合のみ補完
}
```

---

### Task 3: debug=1 のログ（最小）

**UI追加なし**で、既存トーストに短く出す（必要最低限）

- `[OFF] Fetching...`
- `[OFF] OK name=... brand=... img=...`
- `[OFF] Miss/Fail → fallback Yahoo normalize`
- `[Yahoo] Price OK`（価格取得が成功したことだけ分かればOK）

---

### Task 4: "箱買い画像"の扱い（暫定）

- **OFFで画像が取れたらそれを最優先採用**（箱買い画像回避の主手段）
- **OFF画像が無い場合だけYahoo画像を採用**（現状維持）
- 追加のAI判定は次フェーズ（今回はルールで止血）

---

## 📊 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `Smart-Price-Book/dev/index.html` | ✅ 新規関数追加・既存関数修正 |

---

## 🔍 修正箇所の詳細

### 1. 新規関数: `lookupOffByJan(jan)`

**場所**: `normalizeYahooProductInfo()` の後、`lookupYahooByJan()` の前

**行数**: 約120行

**機能**:
- Open Food Facts API（日本優先・世界版フォールバック）から商品情報を取得
- 商品名・ブランド・画像を抽出
- タイムアウト12秒、エラーハンドリング完備

---

### 2. 修正関数: `processBarcodeData(code)`

**場所**: 既存の `processBarcodeData()` 関数を全面書き換え

**変更点**:
- **OFF優先ロジック**: まず `lookupOffByJan()` を呼び出す
- **Yahoo価格取得**: その後 `lookupYahooByJan()` を価格取得目的で呼び出す
- **上書き禁止**: OFFで埋めた情報はYahooで上書きしない
- **補完ルール**: OFFが空の項目だけYahooで補完

---

## 🎯 期待される効果

### ✅ 商品情報の品質向上

- **箱買い問題の根本的解決**: OFFは1個単位の商品情報を提供するため、「×12本」「ケース」等の表記が混入しない
- **販促文言の混入回避**: OFFは販売サイトではないため、送料無料・地域限定等の文言が混入しない
- **メーカー名の正確性**: OFFはブランド情報を正確に保持している

### ✅ 価格情報の維持

- **Yahoo価格の継続利用**: 価格比較・最安値表示は引き続きYahooを主として使用
- **EC価格との比較**: 将来的にRakuten/Amazon等への拡張も可能

### ✅ ユーザー体験の向上

- **体感速度**: OFFとYahooを並列実行可能（現状は順次実行だが、将来的に並列化可能）
- **情報の正確性**: 商品名・メーカー名が正確になり、検索・比較が容易になる

---

## 🧪 テスト観点

### A. 通常ブラウザ（PC Chrome/Edge）

1. **JANコードを入力** → OFF取得成功 → 商品名・メーカー・画像がOFF由来で表示される
2. **JANコードを入力** → OFF失敗 → Yahoo normalizeで商品情報が表示される
3. **Yahoo価格取得** → 価格情報が正常に表示される

### B. PWA/スマホ

1. **スキャン** → OFF取得成功 → 商品情報がOFF由来で表示される
2. **手入力** → OFF失敗 → Yahoo normalizeで商品情報が表示される
3. **画像表示** → OFF画像が優先表示される（箱買い画像回避）

### C. debug=1

1. **OFF取得中**: `[OFF] Fetching...` が表示される
2. **OFF成功**: `[OFF] OK name=... brand=... img=...` が表示される
3. **OFF失敗**: `[OFF] Miss/Fail → fallback Yahoo normalize` が表示される
4. **Yahoo価格取得**: `[Yahoo] Price OK` が表示される

---

## 📝 注意事項

### ⚠️ OFF APIの制限

- **レート制限**: Open Food Facts APIにはレート制限がある可能性がある（現状は未確認）
- **データの有無**: すべてのJANコードがOFFに登録されているわけではない
- **日本語データ**: `product_name_ja` が存在しない場合、英語名が返される可能性がある

### ⚠️ フォールバック動作

- **OFF失敗時**: 自動的にYahoo normalizeにフォールバックする（ユーザー操作不要）
- **Yahoo失敗時**: 手入力にフォールバック（既存動作）

---

## 🚀 デプロイ情報

### 検証URL

**通常URL**:
```
https://smart-price-official.github.io/Smart-Price-Book/dev/?b=2026-01-15_1300_off-priority
```

**デバッグURL**:
```
https://smart-price-official.github.io/Smart-Price-Book/dev/?b=2026-01-15_1300_off-priority&debug=1
```

---

## 📌 次のステップ（将来の拡張）

1. **並列実行**: OFFとYahooを並列実行して体感速度を向上
2. **Rakuten/Amazon価格**: 価格情報の取得元を拡張
3. **AI判定**: 箱買い画像の自動判定（現状はOFF画像優先のみ）

---

**以上**
