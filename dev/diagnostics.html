<!doctype html>
<html lang="ja">
<head>
  <!--
    APP: Smart Price Diagnosticsï¼ˆåŸå› èª¿æŸ»ã‚¢ãƒ—ãƒªï¼‰
    FILE: diagnostics.html
    VERSION: v1.1.0-diag-history-r1
    DATE(JST): 2026-01-30 09:19:47 JST
    AUTHOR: Yui (ChatGPT)
    TITLE: Smart Price åŸå› èª¿æŸ»ã‚¢ãƒ—ãƒªï¼ˆå±¥æ­´/ç”»åƒ/IDBã®æ•´åˆãƒã‚§ãƒƒã‚¯è¿½åŠ ï¼‰
    CHANGES:
    - å±¥æ­´ã®ã€Œæ®‹ã‚‹/æ¶ˆãˆã‚‹ã€åŸå› åˆ‡ã‚Šåˆ†ã‘ç”¨ã«ã€localStorageã®smart_price_dbè§£æã¨ã€IndexedDBï¼ˆsmart_img_db_V1 / smart_price_kv_db_V1ï¼‰ã®ä¸­èº«ã‚«ã‚¦ãƒ³ãƒˆã‚’è¿½åŠ 
    - å±¥æ­´ã® userId æ··åœ¨ã‚„ã€è¡¨ç¤ºãƒ•ã‚£ãƒ«ã‚¿ã§è½ã¡ã¦ã„ã‚‹ä»¶ã‚’å¯è¦–åŒ–ï¼ˆåˆè¨ˆ/è¡¨ç¤ºå¯¾è±¡/é™¤å¤–ç†ç”±ï¼‰
    - ã¾ã¨ã‚ï¼ˆã‚³ãƒ”ãƒšç”¨ï¼‰ã‚’1ãƒœã‚¿ãƒ³ã§ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã‚³ãƒ”ãƒ¼
    BUILD_PARAM(b): ?b=2026-01-30_0919_diag-history-r1
    DEBUG_PARAM: &debug=1ï¼ˆã“ã®è¨ºæ–­ãƒšãƒ¼ã‚¸ã§ã‚‚æœ‰åŠ¹ï¼‰
    POLICY: UIã¯æ—¢å­˜è¨ºæ–­ãƒšãƒ¼ã‚¸ã®é›°å›²æ°—ï¼ˆé»’ï¼‹ã‚ªãƒ¬ãƒ³ã‚¸ï¼‹ã‚«ãƒ¼ãƒ‰ï¼‰ã‚’ç¶­æŒã—ã¤ã¤ã€æ©Ÿèƒ½ã ã‘è¿½åŠ 
  -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#b31212" />
  <title>Smart Price åŸå› èª¿æŸ»ã‚¢ãƒ—ãƒª</title>
  <style>
    :root {
      --bg0:#0b0b0c;
      --card:#17181b;
      --line:#2a2c31;
      --text:#e9e9ee;
      --muted:#a7a7b2;
      --accent:#ff9f1a;
      --accent2:#ffbf66;
      --danger:#ff4d4d;
      --ok:#6ef27b;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Noto Sans Mono CJK JP", "Noto Sans Mono", monospace;
      --sans: system-ui, -apple-system, "Segoe UI", "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
    }
    *{box-sizing:border-box}
    body {
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 700px at 20% 0%, #1b1b20 0%, var(--bg0) 55%, #070708 100%);
      color:var(--text);
    }
    .topbar {
      position: sticky;
      top:0;
      z-index:10;
      background: linear-gradient(180deg, #d01818 0%, #b31212 100%);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding: 14px 14px calc(14px + env(safe-area-inset-top));
    }
    .topbar h1 {
      margin:0;
      font-size: 28px;
      letter-spacing: .5px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .topbar .sub {
      margin-top:8px;
      color: rgba(255,255,255,0.85);
      font-size: 13px;
      line-height: 1.35;
    }
    .wrap {
      padding: 18px 14px calc(30px + env(safe-area-inset-bottom));
      max-width: 920px;
      margin: 0 auto;
    }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, rgba(0,0,0,0.08) 100%), var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: 0 12px 28px rgba(0,0,0,0.35);
      padding: 14px;
      margin: 14px 0;
    }
    .card h2 {
      margin: 0 0 10px 0;
      font-size: 18px;
      color: var(--accent);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .kv {
      display:grid;
      grid-template-columns: 220px 1fr;
      gap: 10px;
      margin: 8px 0;
    }
    @media (max-width:640px){
      .kv{grid-template-columns: 1fr;}
    }
    .k {
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12.5px;
    }
    .v {
      background: #0f1012;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      font-family: var(--mono);
      font-size: 12.5px;
      overflow-wrap: anywhere;
      white-space: pre-wrap;
      line-height: 1.45;
    }
    .btnrow {
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      margin-top: 10px;
    }
    button {
      appearance:none;
      border:none;
      border-radius: 12px;
      padding: 12px 14px;
      font-weight: 700;
      font-size: 14px;
      letter-spacing: .2px;
      cursor:pointer;
      color:#101014;
      background: var(--accent);
      box-shadow: 0 10px 22px rgba(255,159,26,0.18);
    }
    button.secondary {
      background: #2b2d33;
      color: var(--text);
      border: 1px solid var(--line);
      box-shadow:none;
    }
    button.danger {
      background: var(--danger);
      color: #1b0505;
      box-shadow: 0 10px 22px rgba(255,77,77,0.12);
    }
    button:active { transform: translateY(1px); }
    .hr { height:1px; background: var(--line); margin: 12px 0; }
    .list {
      background: #0f1012;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      max-height: 260px;
      overflow:auto;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
      overflow-wrap:anywhere;
    }
    .small { color: var(--muted); font-size: 12px; line-height: 1.4; }
    .tag {
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,159,26,0.08);
      color: var(--accent2);
      font-family: var(--mono);
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>ğŸ” Smart Price åŸå› èª¿æŸ»ã‚¢ãƒ—ãƒª</h1>
    <div class="sub">
      VERSION: <b>v1.1.0-diag-history-r1</b> ï¼ BUILD: <b>2026-01-30_0919_diag-history-r1</b><br>
      â€» ã“ã®ãƒšãƒ¼ã‚¸ã¯ã€Œå±¥æ­´ãŒãƒªãƒ­ãƒ¼ãƒ‰ã§æ¶ˆãˆã‚‹ã€åŸå› ã‚’ã€ç«¯æœ«å†…ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆlocalStorage/IndexedDB/ServiceWorkerï¼‰ã‹ã‚‰åˆ‡ã‚Šåˆ†ã‘ã¾ã™ã€‚
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h2>ğŸ“Œ A) ã“ã®ãƒšãƒ¼ã‚¸è‡ªèº«ã®æƒ…å ±</h2>
      <div class="kv"><div class="k">èª­ã¿è¾¼ã‚“ã URL</div><div class="v" id="a_url"></div></div>
      <div class="kv"><div class="k">ORIGIN</div><div class="v" id="a_origin"></div></div>
      <div class="kv"><div class="k">PATH / QUERY</div><div class="v" id="a_pathquery"></div></div>
      <div class="kv"><div class="k">BUILD_PARAM (?b=)</div><div class="v" id="a_b"></div></div>
      <div class="kv"><div class="k">DEBUG_PARAM (&debug=1)</div><div class="v" id="a_debug"></div></div>
      <div class="kv"><div class="k">USER AGENT</div><div class="v" id="a_ua"></div></div>
      <div class="kv"><div class="k">Date.now()</div><div class="v" id="a_now"></div></div>

      <div class="btnrow">
        <button id="btnRefreshA">ğŸ”„ ãƒšãƒ¼ã‚¸æƒ…å ±ã‚’æ›´æ–°</button>
        <button class="secondary" id="btnCopySummary">ğŸ“‹ ã¾ã¨ã‚ã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
      <div class="small" id="a_note"></div>
    </div>

    <div class="card">
      <h2>ğŸ§° B) Service Worker / ã‚­ãƒ£ãƒƒã‚·ãƒ¥</h2>
      <div class="kv"><div class="k">controller</div><div class="v" id="sw_controller"></div></div>
      <div class="kv"><div class="k">registration</div><div class="v" id="sw_reg"></div></div>
      <div class="kv"><div class="k">caches.keys()</div><div class="v" id="sw_caches"></div></div>
      <div class="btnrow">
        <button class="secondary" id="btnUpdateSW">ğŸ”„ çŠ¶æ…‹ã‚’æ›´æ–°</button>
        <button class="danger" id="btnClearCaches">ğŸ—‘ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤</button>
        <button class="danger" id="btnUnregSW">ğŸ—‘ Service Workerã‚’è§£é™¤</button>
      </div>
      <div class="small">â€» ãƒªãƒ­ãƒ¼ãƒ‰ã§å±¥æ­´ãŒæ¶ˆãˆã‚‹æ™‚ã€Service Workerã®å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåŸå› ã®ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</div>
    </div>

    <div class="card">
      <h2>ğŸ’¾ C) ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç³»ã®çŠ¶æ…‹ï¼ˆlocalStorage / IndexedDBï¼‰</h2>

      <div class="kv"><div class="k">localStorageä½¿ç”¨çŠ¶æ³</div><div class="v" id="ls_summary"></div></div>
      <div class="kv"><div class="k">localStorageã‚­ãƒ¼ä¸€è¦§ï¼ˆå…ˆé ­50ï¼‰</div><div class="v" id="ls_keys"></div></div>

      <div class="hr"></div>

      <div class="kv"><div class="k">IDBä¸€è¦§ï¼ˆè¦‹ãˆã‚‹ç¯„å›²ï¼‰</div><div class="v" id="idb_list"></div></div>
      <div class="kv"><div class="k">IDBè©³ç´°ï¼ˆsmart_img_db_V1 / smart_price_kv_db_V1ï¼‰</div><div class="v" id="idb_detail"></div></div>

      <div class="btnrow">
        <button class="secondary" id="btnUpdateStorage">ğŸ”„ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸çŠ¶æ…‹ã‚’æ›´æ–°</button>
        <button class="danger" id="btnClearYahooCache">ğŸ—‘ yahoo_cache_ ã‚’å‰Šé™¤</button>
      </div>
    </div>

    <div class="card">
      <h2>ğŸ§ª D) å±¥æ­´ãŒã€Œæ¶ˆãˆã‚‹ã€åŸå› ãƒã‚§ãƒƒã‚¯ï¼ˆè¶…é‡è¦ï¼‰</h2>

      <div class="kv"><div class="k">æ¨å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ID</div><div class="v" id="d_uid"></div></div>
      <div class="kv"><div class="k">smart_price_db èª­ã¿è¾¼ã¿</div><div class="v" id="d_dbstatus"></div></div>
      <div class="kv"><div class="k">å±¥æ­´ï¼šåˆè¨ˆ / è¡¨ç¤ºå¯¾è±¡ / é™¤å¤–</div><div class="v" id="d_counts"></div></div>
      <div class="kv"><div class="k">userIdåˆ†å¸ƒï¼ˆä¸Šä½10ï¼‰</div><div class="v" id="d_uiddist"></div></div>
      <div class="kv"><div class="k">å±¥æ­´ã‚µãƒ³ãƒ—ãƒ«ï¼ˆæœ€æ–°5ä»¶ï¼‰</div><div class="v" id="d_samples"></div></div>

      <div class="btnrow">
        <button id="btnRunD">âœ… å±¥æ­´ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ</button>
        <button class="secondary" id="btnCopyD">ğŸ“‹ å±¥æ­´ãƒã‚§ãƒƒã‚¯çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>

      <div class="small">
        ã“ã“ã§ <span class="tag">è¡¨ç¤ºå¯¾è±¡=0</span> ã«ãªã£ã¦ã„ã‚‹ãªã‚‰ã€Œä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ã«ãƒ•ã‚£ãƒ«ã‚¿ã§è½ã¡ã¦ã‚‹ã€å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚<br>
        ã“ã“ã§ <span class="tag">smart_price_db ãªã—</span> ãªã‚‰ã€Œãã‚‚ãã‚‚ä¿å­˜ã•ã‚Œã¦ã„ãªã„ã€ã‹ã€ã‚­ãƒ¼ãŒé•ã†å¯èƒ½æ€§ã§ã™ã€‚
      </div>
    </div>

    <div class="card">
      <h2>âŒ E) ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ï¼ˆç›´è¿‘50ä»¶ï¼‰</h2>
      <div class="kv"><div class="k">ã‚¨ãƒ©ãƒ¼ä»¶æ•°</div><div class="v" id="e_count"></div></div>
      <div class="list" id="e_list"></div>
      <div class="btnrow">
        <button class="secondary" id="btnCopyErr">ğŸ“‹ ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼</button>
        <button class="danger" id="btnClearErr">ğŸ—‘ ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>
      </div>
    </div>

    <div class="card">
      <h2>ğŸ§¯ Z) ã“ã®ã‚µã‚¤ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ï¼ˆæœ€çµ‚æ‰‹æ®µï¼‰</h2>
      <div class="small">
        â€» ã“ã‚Œã‚’æŠ¼ã™ã¨ã€localStorage / IndexedDB / caches / ServiceWorker ã‚’ã¾ã¨ã‚ã¦æ¶ˆã—ã¾ã™ã€‚<br>
        ã€Œä½•ã‚’ã‚„ã£ã¦ã‚‚å±¥æ­´ãŒæ¶ˆãˆã‚‹ã€æ™‚ã ã‘ä½¿ã£ã¦ãã ã•ã„ã€‚
      </div>
      <div class="btnrow">
        <button class="danger" id="btnNuke">âš  ã“ã®ã‚µã‚¤ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–</button>
      </div>
      <div class="small" id="z_result"></div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  const VERSION = "v1.1.0-diag-history-r1";
  const BUILD_ID = "2026-01-30_0919_diag-history-r1";
  const LS_ERR_KEY = "smartPrice_errorLogs";
  const LS_DB_KEY = "smart_price_db";

  const $ = (id) => document.getElementById(id);

  function safeJsonParse(s){
    try { return JSON.parse(s); } catch(e){ return null; }
  }
  function fmtBytes(n){
    if (!isFinite(n)) return "0B";
    const units=["B","KB","MB","GB"];
    let i=0, v=n;
    while(v>=1024 && i<units.length-1){ v/=1024; i++; }
    return (Math.round(v*100)/100)+units[i];
  }
  function nowIso(){
    const d=new Date();
    const pad=(x)=>String(x).padStart(2,"0");
    return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate())+" "+pad(d.getHours())+":"+pad(d.getMinutes())+":"+pad(d.getSeconds());
  }

  // --- Error logging
  function loadErrs(){
    const raw = localStorage.getItem(LS_ERR_KEY);
    const arr = safeJsonParse(raw) || [];
    return Array.isArray(arr) ? arr.slice(-50) : [];
  }
  function saveErr(type, message, extra){
    const arr = loadErrs();
    arr.push({
      t: nowIso(),
      type: String(type || "ä¸æ˜"),
      msg: String(message || ""),
      extra: extra ? String(extra).slice(0,1200) : ""
    });
    localStorage.setItem(LS_ERR_KEY, JSON.stringify(arr.slice(-50)));
    renderErrs();
  }
  window.addEventListener("error", (ev)=>{
    saveErr(ev?.error?.name || "error", ev?.message || "unknown", (ev?.filename||"")+" :"+(ev?.lineno||"")+" :"+(ev?.colno||""));
  });
  window.addEventListener("unhandledrejection", (ev)=>{
    const r = ev?.reason;
    saveErr(r?.name || "promise", r?.message || String(r), "");
  });

  function renderErrs(){
    const arr = loadErrs();
    $("e_count").textContent = arr.length + "ä»¶";
    if(!arr.length){
      $("e_list").textContent = "ï¼ˆãªã—ï¼‰";
      return;
    }
    $("e_list").textContent = arr.map((e,idx)=>{
      return `(${idx+1}) ${e.t}\nã‚¿ã‚¤ãƒ—: ${e.type}\n${e.msg}\n${e.extra}\n--------------------`;
    }).join("\n");
  }

  // --- A) page info
  function updateA(){
    const u = new URL(location.href);
    $("a_url").textContent = u.href;
    $("a_origin").textContent = u.origin;
    $("a_pathquery").textContent = u.pathname + u.search;
    $("a_b").textContent = u.searchParams.get("b") || "ãªã—";
    $("a_debug").textContent = (u.searchParams.get("debug")==="1") ? "ON" : "OFF";
    $("a_ua").textContent = navigator.userAgent;
    $("a_now").textContent = String(Date.now());
    $("a_note").textContent = `ã“ã®è¨ºæ–­ãƒšãƒ¼ã‚¸: VERSION=${VERSION} / BUILD=${BUILD_ID}`;
  }

  // --- B) SW
  async function updateSW(){
    try{
      const ctrl = navigator.serviceWorker ? (navigator.serviceWorker.controller ? "ã‚ã‚Š" : "ãªã—") : "éå¯¾å¿œ";
      $("sw_controller").textContent = ctrl;

      let regText = "éå¯¾å¿œ";
      if(navigator.serviceWorker && navigator.serviceWorker.getRegistration){
        const reg = await navigator.serviceWorker.getRegistration();
        if(!reg){
          regText = "ç™»éŒ²ãªã—";
        } else {
          const active = reg.active ? ("active: "+reg.active.state) : "active: ãªã—";
          const waiting = reg.waiting ? ("waiting: "+reg.waiting.state) : "waiting: ãªã—";
          const installing = reg.installing ? ("installing: "+reg.installing.state) : "installing: ãªã—";
          regText = `scope: ${reg.scope}\n${active}\n${waiting}\n${installing}`;
        }
      }
      $("sw_reg").textContent = regText;

      if(window.caches && caches.keys){
        const keys = await caches.keys();
        $("sw_caches").textContent = keys.length ? keys.join("\n") : "0ä»¶";
      } else {
        $("sw_caches").textContent = "éå¯¾å¿œ";
      }
    } catch(e){
      $("sw_reg").textContent = "å–å¾—å¤±æ•—: " + (e?.message || e);
      saveErr("SW", "updateSW failed", e?.message || String(e));
    }
  }

  async function clearCaches(){
    try{
      if(!window.caches || !caches.keys) return;
      const keys = await caches.keys();
      for(const k of keys){ await caches.delete(k); }
      await updateSW();
      toast("ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
    } catch(e){
      saveErr("CACHE", "clearCaches failed", e?.message || String(e));
      toast("ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ã«å¤±æ•—");
    }
  }

  async function unregSW(){
    try{
      if(!navigator.serviceWorker || !navigator.serviceWorker.getRegistration) return;
      const reg = await navigator.serviceWorker.getRegistration();
      if(reg) await reg.unregister();
      await updateSW();
      toast("Service Workerã‚’è§£é™¤ã—ã¾ã—ãŸ");
    } catch(e){
      saveErr("SW", "unreg failed", e?.message || String(e));
      toast("è§£é™¤ã«å¤±æ•—");
    }
  }

  // --- C) storage
  function updateLocalStorageInfo(){
    try{
      const keys = Object.keys(localStorage);
      let total=0;
      for(const k of keys){
        const v = localStorage.getItem(k) || "";
        total += (k.length + v.length) * 2;
      }
      $("ls_summary").textContent = `${keys.length}ã‚­ãƒ¼ / ç´„${fmtBytes(total)}`;
      $("ls_keys").textContent = keys.slice(0,50).join(", ") + (keys.length>50 ? "\n...ï¼ˆçœç•¥ï¼‰" : "");
    } catch(e){
      $("ls_summary").textContent = "å–å¾—å¤±æ•—";
      $("ls_keys").textContent = "";
      saveErr("LS", "updateLocalStorageInfo failed", e?.message || String(e));
    }
  }

  async function listIndexedDBs(){
    try{
      if(indexedDB.databases){
        const list = await indexedDB.databases();
        const names = list.map(x=>x.name).filter(Boolean);
        return names;
      }
    } catch(e){
      // ignore
    }
    return ["smart_img_db_V1","smart_price_kv_db_V1","firebaseLocalStorageDb","firebase-heartbeat-database"];
  }

  function openDb(name){
    return new Promise((resolve,reject)=>{
      try{
        const req = indexedDB.open(name);
        req.onerror = ()=>reject(req.error || new Error("open error"));
        req.onsuccess = ()=>resolve(req.result);
        req.onupgradeneeded = ()=>{ /* no-op */ };
      } catch(e){
        reject(e);
      }
    });
  }

  function countStore(db, storeName){
    return new Promise((resolve)=>{
      try{
        const tx = db.transaction(storeName,"readonly");
        const st = tx.objectStore(storeName);
        const req = st.count();
        req.onsuccess = ()=>resolve(req.result || 0);
        req.onerror = ()=>resolve(null);
      } catch(e){
        resolve(null);
      }
    });
  }

  async function idbDetails(){
    const targets = ["smart_img_db_V1","smart_price_kv_db_V1"];
    const out=[];
    for(const name of targets){
      try{
        const db = await openDb(name);
        const stores = Array.from(db.objectStoreNames || []);
        out.push(`â–  ${name} / stores: ${stores.length ? stores.join(", ") : "ï¼ˆãªã—ï¼‰"}`);
        for(const s of stores){
          const c = await countStore(db, s);
          out.push(`  - ${s}: ${c===null ? "countå¤±æ•—" : (c+"ä»¶")}`);
        }
        db.close();
      } catch(e){
        out.push(`â–  ${name}: openå¤±æ•—ï¼ˆæœªä½œæˆ or æ¨©é™ï¼‰`);
      }
    }
    return out.join("\n");
  }

  async function updateStorage(){
    updateLocalStorageInfo();
    try{
      const names = await listIndexedDBs();
      $("idb_list").textContent = `è¦‹ãˆã‚‹IDB: ${names.length}ä»¶\n` + names.join(", ");
      $("idb_detail").textContent = "å–å¾—ä¸­â€¦";
      $("idb_detail").textContent = await idbDetails();
    } catch(e){
      $("idb_list").textContent = "å–å¾—å¤±æ•—";
      $("idb_detail").textContent = "";
      saveErr("IDB", "updateStorage failed", e?.message || String(e));
    }
  }

  function clearYahooCache(){
    try{
      const keys = Object.keys(localStorage);
      const target = keys.filter(k=>k.startsWith("yahoo_cache_"));
      for(const k of target) localStorage.removeItem(k);
      toast(`yahoo_cache_ ã‚’ ${target.length}ä»¶ å‰Šé™¤`);
      updateLocalStorageInfo();
    } catch(e){
      saveErr("LS", "clearYahooCache failed", e?.message || String(e));
      toast("å‰Šé™¤ã«å¤±æ•—");
    }
  }

  // --- D) history diagnosis
  function guessUserId(){
    const direct = localStorage.getItem("sp_user_id") || localStorage.getItem("sp_user_id_dev");
    if(direct) return String(direct);

    const profRaw = localStorage.getItem("smartPrice_userProfile");
    const prof = safeJsonParse(profRaw);
    if(prof && (prof.uid || prof.userId)) return String(prof.uid || prof.userId);

    return "";
  }

  function findHistoryArray(dbObj){
    if(!dbObj || typeof dbObj !== "object") return null;
    const candidates = ["history","purchaseHistory","purchases","buyHistory","logs"];
    for(const k of candidates){
      if(Array.isArray(dbObj[k])) return dbObj[k];
    }
    for(const k of Object.keys(dbObj)){
      const v = dbObj[k];
      if(v && typeof v === "object"){
        for(const ck of candidates){
          if(Array.isArray(v[ck])) return v[ck];
        }
      }
    }
    return null;
  }

  function summarizeHistory(arr, currentUid){
    const total = arr.length;
    const dist = new Map();
    let show=0, miss=0, mismatch=0;

    const getUid = (item)=> (item && typeof item==="object") ? (item.userId || item.uid || item.user || "") : "";

    const samples = arr.slice().sort((a,b)=>{
      const ta = (a?.ts || a?.time || a?.date || 0);
      const tb = (b?.ts || b?.time || b?.date || 0);
      return (tb||0) - (ta||0);
    }).slice(0,5);

    for(const h of arr){
      const uid = String(getUid(h) || "");
      const key = uid || "(none)";
      dist.set(key, (dist.get(key)||0) + 1);

      const itemUid = uid || (currentUid ? currentUid : "");
      if(!uid) miss++;
      if(currentUid && itemUid === currentUid) show++;
      else if(currentUid && itemUid !== currentUid) mismatch++;
      else if(!currentUid) show++;
    }

    const distTop = Array.from(dist.entries())
      .sort((a,b)=>b[1]-a[1])
      .slice(0,10)
      .map(([k,v])=>`${k}: ${v}`)
      .join("\n");

    const sampleText = samples.map((h,idx)=>{
      const name = h?.name || h?.title || h?.itemName || "(no name)";
      const store = h?.store || h?.storeName || h?.shop || "(no store)";
      const price = (h?.price ?? h?.value ?? h?.amount ?? "");
      const ts = (h?.ts || h?.time || h?.date || "");
      const uid = (h?.userId || h?.uid || "") || "(none)";
      const img = h?.imgKey || h?.imageKey || h?.img || h?.image || "";
      return `(${idx+1}) ${store} / ${name} / price=${price} / ts=${ts} / userId=${uid} / img=${img}`;
    }).join("\n");

    return {
      total,
      show,
      excluded: Math.max(0, total - show),
      miss,
      mismatch,
      distTop,
      sampleText
    };
  }

  function runHistoryDiagnosis(){
    const uid = guessUserId();
    $("d_uid").textContent = uid ? uid : "ï¼ˆä¸æ˜ï¼‰";

    const raw = localStorage.getItem(LS_DB_KEY);
    if(!raw){
      $("d_dbstatus").textContent = `${LS_DB_KEY} ãŒ localStorage ã«ã‚ã‚Šã¾ã›ã‚“`;
      $("d_counts").textContent = "-";
      $("d_uiddist").textContent = "-";
      $("d_samples").textContent = "-";
      return { ok:false, msg:`${LS_DB_KEY} missing` };
    }

    const obj = safeJsonParse(raw);
    if(!obj){
      $("d_dbstatus").textContent = `${LS_DB_KEY} ã¯ JSON ã§èª­ã‚ã¾ã›ã‚“ï¼ˆç ´æã®å¯èƒ½æ€§ï¼‰`;
      return { ok:false, msg:`${LS_DB_KEY} parse failed` };
    }

    const hist = findHistoryArray(obj);
    if(!hist){
      $("d_dbstatus").textContent = `${LS_DB_KEY} ã¯èª­ã‚ã¾ã—ãŸãŒã€å±¥æ­´é…åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`;
      return { ok:false, msg:"history array not found" };
    }

    $("d_dbstatus").textContent = `OKï¼ˆJSONï¼‰ / æ¨å®šå±¥æ­´ä»¶æ•°: ${hist.length}`;
    const s = summarizeHistory(hist, uid);

    $("d_counts").textContent = `åˆè¨ˆ ${s.total} / è¡¨ç¤ºå¯¾è±¡ ${s.show} / é™¤å¤– ${s.excluded}\nï¼ˆuserIdãªã—: ${s.miss} / userIdä¸ä¸€è‡´: ${s.mismatch}ï¼‰`;
    $("d_uiddist").textContent = s.distTop || "ï¼ˆãªã—ï¼‰";
    $("d_samples").textContent = s.sampleText || "ï¼ˆãªã—ï¼‰";

    return { ok:true, uid, ...s };
  }

  // --- toast
  let toastTimer=null;
  function toast(msg){
    let t=document.getElementById("_diag_toast");
    if(!t){
      t=document.createElement("div");
      t.id="_diag_toast";
      t.style.position="fixed";
      t.style.left="12px";
      t.style.right="12px";
      t.style.bottom="12px";
      t.style.zIndex="9999";
      t.style.padding="12px 14px";
      t.style.borderRadius="14px";
      t.style.border="1px solid rgba(255,159,26,0.35)";
      t.style.background="rgba(16,16,20,0.92)";
      t.style.color="var(--text)";
      t.style.fontFamily="var(--mono)";
      t.style.fontSize="13px";
      t.style.boxShadow="0 14px 30px rgba(0,0,0,0.35)";
      document.body.appendChild(t);
    }
    t.textContent=msg;
    t.style.display="block";
    if(toastTimer) clearTimeout(toastTimer);
    toastTimer=setTimeout(()=>{ t.style.display="none"; }, 3200);
  }

  // --- copy helpers
  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      toast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
      return true;
    } catch(e){
      try{
        const ta=document.createElement("textarea");
        ta.value=text;
        ta.style.position="fixed";
        ta.style.left="-9999px";
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        toast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        return true;
      } catch(e2){
        toast("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—");
        return false;
      }
    }
  }

  function buildSummaryText(extra){
    const u=new URL(location.href);
    const lines=[];
    lines.push("=== Smart Price è¨ºæ–­ã¾ã¨ã‚ ===");
    lines.push("URL: "+u.href);
    lines.push("ORIGIN: "+u.origin);
    lines.push("PATH: "+u.pathname);
    lines.push("b: "+(u.searchParams.get("b") || "ãªã—"));
    lines.push("debug: "+(u.searchParams.get("debug")==="1" ? "ON" : "OFF"));
    lines.push("DiagVersion: "+VERSION);
    lines.push("DiagBuild: "+BUILD_ID);
    lines.push("Date: "+nowIso());
    lines.push("");
    if(extra) lines.push(extra);
    return lines.join("\n");
  }

  // --- Z) nuke
  async function deleteIDB(name){
    return new Promise((resolve)=>{
      try{
        const req=indexedDB.deleteDatabase(name);
        req.onsuccess=()=>resolve(true);
        req.onerror=()=>resolve(false);
        req.onblocked=()=>resolve(false);
      } catch(e){
        resolve(false);
      }
    });
  }

  async function nukeAll(){
    const ok = confirm("æœ¬å½“ã«åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿï¼ˆå±¥æ­´ãƒ»ç”»åƒãƒ»è¨­å®šãŒæ¶ˆãˆã¾ã™ï¼‰");
    if(!ok) return;
    $("z_result").textContent = "åˆæœŸåŒ–ä¸­â€¦";
    const steps=[];

    try{ localStorage.clear(); steps.push("localStorage: OK"); } catch(e){ steps.push("localStorage: NG"); }

    try{
      if(window.caches && caches.keys){
        const keys=await caches.keys();
        for(const k of keys) await caches.delete(k);
      }
      steps.push("caches: OK");
    } catch(e){
      steps.push("caches: NG");
    }

    try{
      if(navigator.serviceWorker && navigator.serviceWorker.getRegistration){
        const reg=await navigator.serviceWorker.getRegistration();
        if(reg) await reg.unregister();
      }
      steps.push("serviceWorker: OK");
    } catch(e){
      steps.push("serviceWorker: NG");
    }

    try{
      const names=await listIndexedDBs();
      let okc=0, ngc=0;
      for(const n of names){
        const r=await deleteIDB(n);
        if(r) okc++; else ngc++;
      }
      steps.push(`indexedDB: OK=${okc} / NG=${ngc}`);
    } catch(e){
      steps.push("indexedDB: NG");
    }

    $("z_result").textContent = steps.join(" / ") + "  â†’  ã„ã£ãŸã‚“ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ã€ã‚‚ã†ä¸€åº¦é–‹ã„ã¦ãã ã•ã„";
    toast("åˆæœŸåŒ–ã—ã¾ã—ãŸ");
    setTimeout(()=>{ updateA(); updateSW(); updateStorage(); renderErrs(); }, 300);
  }

  // --- wiring
  $("btnRefreshA").addEventListener("click", updateA);
  $("btnUpdateSW").addEventListener("click", updateSW);
  $("btnClearCaches").addEventListener("click", clearCaches);
  $("btnUnregSW").addEventListener("click", unregSW);
  $("btnUpdateStorage").addEventListener("click", updateStorage);
  $("btnClearYahooCache").addEventListener("click", clearYahooCache);

  $("btnRunD").addEventListener("click", ()=>{
    const res=runHistoryDiagnosis();
    toast(res.ok ? "å±¥æ­´ãƒã‚§ãƒƒã‚¯OK" : "å±¥æ­´ãƒã‚§ãƒƒã‚¯NG");
  });
  $("btnCopyD").addEventListener("click", ()=>{
    const res=runHistoryDiagnosis();
    const extra="=== å±¥æ­´ãƒã‚§ãƒƒã‚¯ ===\n" + JSON.stringify(res, null, 2);
    copyText(buildSummaryText(extra));
  });

  $("btnCopyErr").addEventListener("click", ()=>{
    const txt="=== ã‚¨ãƒ©ãƒ¼ãƒ­ã‚° ===\n" + ($("e_list").textContent || "");
    copyText(buildSummaryText(txt));
  });
  $("btnClearErr").addEventListener("click", ()=>{
    localStorage.setItem(LS_ERR_KEY, JSON.stringify([]));
    renderErrs();
    toast("ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ");
  });

  $("btnCopySummary").addEventListener("click", ()=>{
    const parts=[];
    parts.push("localStorageKeys: "+Object.keys(localStorage).length);
    parts.push("ls_summary: "+($("ls_summary").textContent || ""));
    parts.push("idb_list: "+($("idb_list").textContent || ""));
    parts.push("idb_detail:\n"+($("idb_detail").textContent || ""));
    parts.push("history_check:\n"+($("d_counts").textContent || ""));
    copyText(buildSummaryText(parts.join("\n")));
  });

  $("btnNuke").addEventListener("click", nukeAll);

  // init
  updateA();
  updateSW();
  updateStorage();
  renderErrs();
  runHistoryDiagnosis();
})();
</script>

<!-- === D) REMOTE HTML DIRECT CHECK (added) === -->
<section class="card" id="remoteCheckCard" style="margin-top:16px;">
  <h2>ğŸ›°ï¸ D) ãƒªãƒ¢ãƒ¼ãƒˆHTMLç›´èª­ã¿ãƒã‚§ãƒƒã‚¯ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡è¦–ï¼‰</h2>
  <p class="muted">
    ã“ã®è¨ºæ–­ãƒšãƒ¼ã‚¸ã¯ <b>Service Workerã®ç®¡ç†å¤–</b> ã§å‹•ãã¾ã™ï¼ˆ=ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«é‚ªé­”ã•ã‚Œã«ãã„ï¼‰ã€‚<br>
    ã“ã“ã‹ã‚‰ <code>/dev/index.html</code> ã‚’ <b>cache:no-store</b> ã§ç›´èª­ã¿ã—ã¦ã€å®Ÿéš›ã«ã‚µãƒ¼ãƒãŒè¿”ã—ã¦ã„ã‚‹ <b>VERSION/BUILD</b> ã‚’æŠœãå‡ºã—ã¾ã™ã€‚
  </p>

  <div class="row" style="gap:8px; flex-wrap:wrap;">
    <input id="remoteUrl" type="text" style="flex:1; min-width:240px;"
      value="https://smart-price-official.github.io/Smart-Price-Book/dev/index.html?b=2026-01-30_1818_histpersist-force&debug=1" />
    <button class="btn btn-orange" id="btnRemoteFetch">ç›´èª­ã¿ã—ã¦åˆ¤å®š</button>
  </div>

  <div class="row" style="margin-top:10px;">
    <div class="kv">
      <div class="k">æœ€çµ‚URLï¼ˆresponse.urlï¼‰</div>
      <div class="v" id="remoteFinalUrl">â€”</div>
    </div>
  </div>

  <div class="row" style="margin-top:10px;">
    <div class="kv">
      <div class="k">æŠ½å‡ºVERSIONå€™è£œ</div>
      <div class="v mono" id="remoteVersion">â€”</div>
    </div>
    <div class="kv">
      <div class="k">æŠ½å‡ºBUILDå€™è£œ</div>
      <div class="v mono" id="remoteBuild">â€”</div>
    </div>
  </div>

  <details style="margin-top:10px;">
    <summary class="btn btn-dark" style="display:inline-block;">æœ¬æ–‡ã®å…ˆé ­2000æ–‡å­—ï¼ˆç¢ºèªç”¨ï¼‰</summary>
    <pre class="mono" id="remoteHead" style="white-space:pre-wrap; max-height:260px; overflow:auto; margin-top:8px; padding:10px; border-radius:10px; background:#111; border:1px solid #2b2b2b;">â€”</pre>
  </details>

  <div class="log mono" id="remoteLog" style="margin-top:10px;">[ready] ç›´èª­ã¿ãƒã‚§ãƒƒã‚¯å¾…æ©Ÿ</div>
</section>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  function pickFirst(re, s){
    const m = s.match(re);
    return m ? m[0] : '';
  }

  function extractVersion(text){
    // ä¾‹: v20.4.45CH / 20.4.45CH / VERSION = "20.4.45CH"
    return pickFirst(/v?\d{1,3}\.\d{1,3}\.\d{1,4}[A-Za-z-]*/g, text);
  }
  function extractBuild(text){
    // ä¾‹: 2026-01-30_1818_histpersist-force
    return pickFirst(/\d{4}-\d{2}-\d{2}_\d{4}_[A-Za-z0-9_-]{3,}/g, text);
  }

  async function remoteFetch(){
    const base = $('remoteUrl').value.trim();
    if(!base){
      $('remoteLog').textContent = '[error] URLãŒç©ºã§ã™';
      return;
    }

    // è¿½åŠ ã§å¿…ãšãƒ¦ãƒ‹ãƒ¼ã‚¯ã«ã™ã‚‹
    const u = new URL(base);
    u.searchParams.set('_ts', String(Date.now()));
    // debugã¯ä¿æŒï¼ˆç„¡ã‘ã‚Œã°å…¥ã‚Œã‚‹ï¼‰
    if(!u.searchParams.get('debug')) u.searchParams.set('debug','1');

    $('remoteLog').textContent = '[fetch] ' + u.toString();

    try{
      const res = await fetch(u.toString(), { cache: 'no-store' });
      $('remoteFinalUrl').textContent = res.url || '(no url)';
      const text = await res.text();

      const ver = extractVersion(text) || '(è¦‹ã¤ã‹ã‚‰ãš)';
      const bld = extractBuild(text) || '(è¦‹ã¤ã‹ã‚‰ãš)';

      $('remoteVersion').textContent = ver;
      $('remoteBuild').textContent = bld;
      $('remoteHead').textContent = text.slice(0,2000);

      $('remoteLog').textContent = '[ok] status=' + res.status + ' / version=' + ver + ' / build=' + bld;
    }catch(e){
      $('remoteLog').textContent = '[error] ' + (e && e.message ? e.message : String(e));
    }
  }

  $('btnRemoteFetch').addEventListener('click', remoteFetch);
})();
</script>

</body>
</html>
