<!doctype html>
<html lang="ja">
<head>
  <!--
  APP: Smart Price - SW Doctor (è¨ºæ–­ãƒ„ãƒ¼ãƒ«)
  VERSION: v1.0.0-swdoctor-01
  DATE(JST): 2026-01-30 21:35 JST
  TITLE: Service Worker / ã‚­ãƒ£ãƒƒã‚·ãƒ¥æš´èµ°ã®åˆ‡ã‚Šåˆ†ã‘ï¼†å¾©æ—§
  AUTHOR: Yui
  CHANGES:
    - è‡ªå‹•ãƒ«ãƒ¼ãƒ—ã‚’å»ƒæ­¢ï¼ˆå‹æ‰‹ã«è§£é™¤/ãƒªãƒ­ãƒ¼ãƒ‰ã—ãªã„ï¼‰
    - Service Worker çŠ¶æ…‹/ç™»éŒ²ä¸€è¦§/ã‚­ãƒ£ãƒƒã‚·ãƒ¥/ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸/èª­ã¿è¾¼ã‚“ã HTMLã®ãƒãƒƒã‚·ãƒ¥è¡¨ç¤º
    - æ‰‹å‹•ã§ã€Œè§£é™¤â†’å‰Šé™¤â†’ä¸€åº¦ã ã‘å†èª­ã¿è¾¼ã¿ã€ã‚’å®Ÿè¡Œã§ãã‚‹ãƒ¯ãƒ³ãƒœã‚¿ãƒ³
    - ä½•åº¦ã‚‚ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒå‡ºã‚‹äº‹æ•…ã‚’é˜²ãâ€œé€£æ‰“ã‚¬ãƒ¼ãƒ‰â€ã‚’è¿½åŠ 
  BUILD PARAM (b): ?b=<build>ï¼ˆé…å¸ƒå¿…é ˆï¼‰
  DEBUG PARAM: &debug=1ï¼ˆè¡¨ç¤ºã‚’å¢—ã‚„ã™ã ã‘ã€‚æŒ™å‹•ã¯å¤‰ãˆãªã„ï¼‰
  POLICY: UI(æœ¬ä½“)ã¯å¤‰æ›´ã—ãªã„ã€‚ã“ã‚Œã¯â€œåˆ¥ãƒ„ãƒ¼ãƒ«â€ã¨ã—ã¦åˆ‡ã‚Šåˆ†ã‘ç”¨ã«ä½¿ã†ã€‚
  -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Smart Price | SW Doctor | v1.0.0-swdoctor-01</title>
  <style>
    :root {
      --bg: #0f1115;
      --card: #171a20;
      --muted: #9aa4b2;
      --text: #e7ecf3;
      --accent: #e23b4a;
      --line: rgba(255,255,255,.08);
      --ok: rgba(46, 204, 113, .95);
      --ng: rgba(231, 76, 60, .95);
      --warn: rgba(241, 196, 15, .95);
      --btn: #242a33;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(900px 600px at 20% -10%, rgba(226,59,74,.18), transparent 70%),
                  radial-gradient(900px 600px at 90% 10%, rgba(80,120,255,.14), transparent 70%),
                  var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
    }
    header {
      padding: 14px 16px 10px;
      border-bottom: 1px solid var(--line);
      position: sticky; top: 0;
      backdrop-filter: blur(10px);
      background: rgba(15,17,21,.72);
      z-index: 10;
    }
    .row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .title {
      font-weight: 700;
      letter-spacing: .2px;
      display: flex; align-items: center; gap: 10px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(226,59,74,.15);
      border: 1px solid rgba(226,59,74,.35);
      color: #ffd9dc;
      font-weight: 650;
      font-size: 12px;
      white-space: nowrap;
    }
    main {
      padding: 14px 16px 26px;
      max-width: 980px;
      margin: 0 auto;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 900px) {
      .grid { grid-template-columns: 1.2fr .8fr; }
    }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent 120%), var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .card h2 {
      margin: 0 0 10px;
      font-size: 15px;
      letter-spacing: .2px;
    }
    .card p {
      margin: 6px 0;
      color: var(--muted);
      line-height: 1.5;
      font-size: 13px;
    }
    .btns { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 520px) {
      .btns { grid-template-columns: 1fr 1fr; }
    }
    button {
      width: 100%;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)), var(--btn);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      font-weight: 700;
      letter-spacing: .2px;
      cursor: pointer;
      touch-action: manipulation;
    }
    button.primary {
      border-color: rgba(226,59,74,.42);
      background: linear-gradient(180deg, rgba(226,59,74,.35), rgba(226,59,74,.18));
    }
    button.danger {
      border-color: rgba(231,76,60,.45);
      background: linear-gradient(180deg, rgba(231,76,60,.33), rgba(231,76,60,.14));
    }
    button:disabled {
      opacity: .55;
      cursor: not-allowed;
    }
    .kv {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 6px 10px;
      font-size: 13px;
      border-top: 1px solid var(--line);
      padding-top: 10px;
      margin-top: 10px;
    }
    .k { color: var(--muted); }
    .v {
      color: var(--text);
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-size: 12px;
      color: var(--muted);
    }
    .dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: rgba(255,255,255,.25);
    }
    .dot.ok { background: var(--ok); }
    .dot.ng { background: var(--ng); }
    .dot.warn { background: var(--warn); }
    pre {
      margin: 10px 0 0;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.35);
      color: #cfe2ff;
      overflow: auto;
      font-size: 12px;
      line-height: 1.45;
      max-height: 340px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .small { font-size: 12px; color: var(--muted); }
    .warnbox {
      border: 1px solid rgba(241,196,15,.35);
      background: rgba(241,196,15,.08);
      padding: 10px 12px;
      border-radius: 14px;
      color: #ffe9a3;
      font-size: 13px;
      line-height: 1.5;
    }
    .okbox {
      border: 1px solid rgba(46,204,113,.30);
      background: rgba(46,204,113,.08);
      padding: 10px 12px;
      border-radius: 14px;
      color: #caffdf;
      font-size: 13px;
      line-height: 1.5;
    }
  </style>
</head>
<body>
<header>
  <div class="row" style="justify-content: space-between;">
    <div class="title">
      <span style="font-size:16px;">ğŸ§¯ SW Doctor</span>
      <span class="pill">v1.0.0-swdoctor-01</span>
    </div>
    <div class="row">
      <span class="tag"><span class="dot" id="dotController"></span><span id="swControllerText">SW æœªåˆ¤å®š</span></span>
      <span class="tag"><span class="dot" id="dotOnline"></span><span id="netText">ãƒãƒƒãƒˆæœªåˆ¤å®š</span></span>
    </div>
  </div>
  <div class="small" style="margin-top:8px;">
    é…å¸ƒURLã¯ <b>?b=</b> ã‚’å¿…ãšä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š<span id="exampleUrl"></span>ï¼‰
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <h2>ã¾ãšã¯ã“ã“ï¼ˆ1å›ã ã‘ï¼‰</h2>
      <div class="warnbox">
        ã„ã¾ã€Œãƒœã‚¿ãƒ³å…¨æ»…ã€ã¿ãŸã„ãªç—‡çŠ¶ã¯ã€ã ã„ãŸã„ <b>Service Workerï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ã®ä»•çµ„ã¿ï¼‰</b> ãŒå¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ´ã‚“ã§æš´èµ°ã—ã¦ã‚‹æ™‚ã«èµ·ãã¾ã™ã€‚<br>
        ã“ã®ãƒšãƒ¼ã‚¸ã¯ <b>å‹æ‰‹ã«è§£é™¤/å‰Šé™¤/ãƒªãƒ­ãƒ¼ãƒ‰</b> ã—ã¾ã›ã‚“ã€‚ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã ã‘å‹•ãã¾ã™ã€‚
      </div>

      <div style="height:12px;"></div>

      <div class="btns">
        <button class="primary" id="btnStatus">â‘  çŠ¶æ…‹ã‚’è¦‹ã‚‹ï¼ˆå®‰å…¨ï¼‰</button>
        <button class="danger" id="btnFix">â‘¡ SWè§£é™¤ï¼‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ â†’ 1å›ã ã‘ãƒªãƒ­ãƒ¼ãƒ‰</button>
        <button id="btnOpenTargets">â‘¢ æœ¬ä½“URLã®ãƒ•ãƒ«ãƒ‘ã‚¹ã‚’è¡¨ç¤º</button>
        <button id="btnCopy">â‘£ ã„ã¾ã®è¨ºæ–­çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>

      <div class="kv" id="kvTop">
        <div class="k">DATE/JST</div><div class="v" id="vDate"></div>
        <div class="k">LOCATION</div><div class="v" id="vLoc"></div>
        <div class="k">bï¼ˆbuildï¼‰</div><div class="v" id="vB"></div>
        <div class="k">debug</div><div class="v" id="vDebug"></div>
        <div class="k">TITLE</div><div class="v" id="vTitle"></div>
        <div class="k">UAï¼ˆç«¯æœ«æƒ…å ±ï¼‰</div><div class="v" id="vUA"></div>
      </div>

      <pre id="log" aria-label="ãƒ­ã‚°"></pre>
    </section>

    <aside class="card">
      <h2>ã„ã¾å›°ã£ã¦ã‚‹ç—‡çŠ¶ï¼ˆãƒã‚§ãƒƒã‚¯ï¼‰</h2>
      <p>ãƒ»URLã‚’å¤‰ãˆã¦ã‚‚å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå‡ºã‚‹</p>
      <p>ãƒ»è¨ºæ–­ãƒ„ãƒ¼ãƒ«ã§ã€ŒService Workerï¼šè§£é™¤ã€ãŒä½•å›ã‚‚å‡ºã‚‹</p>
      <p>ãƒ»æœ¬ä½“ã®ãƒœã‚¿ãƒ³ãŒå…¨éƒ¨åå¿œã—ãªã„ï¼ˆå…¨æ»…ï¼‰</p>

      <div style="height:10px;"></div>

      <div class="okbox">
        <b>ã“ã®ãƒ„ãƒ¼ãƒ«ã®ç‹™ã„</b><br>
        â‘ ã€Œèª°ãŒæ”¯é…ã—ã¦ã„ã‚‹ã‹ã€ã‚’è¦‹ãˆã‚‹åŒ–<br>
        â‘¡ è§£é™¤ï¼†å‰Šé™¤ã‚’â€œæ‰‹å‹•ä¸€å›â€ã§å®Œäº†<br>
        â‘¢ æœ¬ä½“ã«æˆ»ã‚‹æ™‚ã®ã€Œãƒ•ãƒ«ãƒ‘ã‚¹ã€ã‚’ç¢ºå®Ÿã«å‡ºã™
      </div>

      <div style="height:10px;"></div>

      <h2>æ³¨æ„ï¼ˆå¤§äº‹ï¼‰</h2>
      <div class="warnbox">
        ã€Œå®¹é‡ã‚’ç©ºã‘ã‚‹ã€ã€Œã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã€ã¯ã€<b>Chromeå…¨ä½“</b>ã«å½±éŸ¿ãŒå‡ºã‚‹ã®ã§ã€åŸºæœ¬ã¯æŠ¼ã•ãªã„ã§OKã€‚<br>
        ã¾ãšã¯ã“ã®ãƒ„ãƒ¼ãƒ«ã® <b>â‘¡</b> ã§ â€œã“ã®ã‚µã‚¤ãƒˆåˆ†ã ã‘â€ æƒé™¤ã—ã¾ã™ã€‚
      </div>
    </aside>
  </div>
</main>

<script>
(() => {
  "use strict";

  const VERSION = "v1.0.0-swdoctor-01";
  const DATE_JST = "2026-01-30 21:35 JST";
  const DEFAULT_BUILD = "2026-01-30_2135_swdoctor-01";
  const IS_DEBUG = new URLSearchParams(location.search).get("debug") === "1";
  const b = new URLSearchParams(location.search).get("b") || DEFAULT_BUILD;

  const $ = (id) => document.getElementById(id);

  const logEl = $("log");
  const btnStatus = $("btnStatus");
  const btnFix = $("btnFix");
  const btnOpenTargets = $("btnOpenTargets");
  const btnCopy = $("btnCopy");

  const dotController = $("dotController");
  const swControllerText = $("swControllerText");
  const dotOnline = $("dotOnline");
  const netText = $("netText");

  const state = {
    lines: [],
    lastSnapshot: null
  };

  function line(s="") {
    state.lines.push(String(s));
    logEl.textContent = state.lines.join("\n");
  }

  function nowISO() {
    const d = new Date();
    return d.toISOString();
  }

  function setBadge(dot, textEl, status, text) {
    dot.classList.remove("ok", "ng", "warn");
    if (status) dot.classList.add(status);
    textEl.textContent = text;
  }

  function sleep(ms) {
    return new Promise(r => setTimeout(r, ms));
  }

  // é€£æ‰“ã‚¬ãƒ¼ãƒ‰ï¼ˆåŒã˜æ“ä½œã‚’çŸ­æ™‚é–“ã«ç¹°ã‚Šè¿”ã—ã¦â€œè§£é™¤ãƒ€ã‚¤ã‚¢ãƒ­ã‚°åœ°ç„â€ã‚’é˜²ãï¼‰
  const GUARD_KEY = "swdoctor_guard_until";
  function guarded(seconds) {
    const until = Number(sessionStorage.getItem(GUARD_KEY) || "0");
    const now = Date.now();
    if (until && now < until) return false;
    sessionStorage.setItem(GUARD_KEY, String(now + seconds*1000));
    return true;
  }

  function baseDir() {
    // /Smart-Price-Book/diagnostics... ãªã‚‰ /Smart-Price-Book/ ã‚’è¿”ã™
    const p = location.pathname;
    const idx = p.indexOf("/Smart-Price-Book/");
    if (idx >= 0) return "/Smart-Price-Book/";
    // ä¿é™º
    return p.replace(/\/[^\/]*$/, "/");
  }

  function buildUrl(path) {
    const u = new URL(location.origin + path);
    u.searchParams.set("b", b);
    if (IS_DEBUG) u.searchParams.set("debug", "1");
    u.searchParams.set("t", String(Date.now())); // è¿½åŠ ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿
    return u.toString();
  }

  function showTopInfo() {
    $("vDate").textContent = DATE_JST;
    $("vLoc").textContent = location.href;
    $("vB").textContent = b;
    $("vDebug").textContent = IS_DEBUG ? "1" : "0";
    $("vTitle").textContent = document.title;
    $("vUA").textContent = navigator.userAgent;
    $("exampleUrl").textContent = buildUrl(location.pathname);
  }

  async function snapshot() {
    const snap = {
      at: nowISO(),
      online: navigator.onLine,
      sw: {
        supported: "serviceWorker" in navigator,
        controller: !!(navigator.serviceWorker && navigator.serviceWorker.controller),
        controllerScriptURL: null,
        registrations: [],
      },
      caches: {
        supported: "caches" in window,
        keys: []
      },
      storage: {
        estimate: null
      },
      doc: {
        title: document.title,
        url: location.href
      },
      fetchTest: null
    };

    // SW
    if (snap.sw.supported) {
      try {
        if (navigator.serviceWorker.controller) {
          // controller.scriptURL ã¯ç›´æ¥ã¯å–ã‚Œãªã„ã“ã¨ãŒå¤šã„ã®ã§ã€messageã§èãæ–¹å¼ã¯ã“ã“ã§ã¯ä½¿ã‚ãªã„ï¼ˆå®‰å…¨å„ªå…ˆï¼‰
          snap.sw.controllerScriptURL = "(controllerã‚ã‚Šï¼šè©³ç´°ã¯å–å¾—ã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™)";
        }
        const regs = await navigator.serviceWorker.getRegistrations();
        for (const r of regs) {
          const obj = {
            scope: r.scope,
            active: r.active ? r.active.scriptURL : null,
            waiting: r.waiting ? r.waiting.scriptURL : null,
            installing: r.installing ? r.installing.scriptURL : null,
            updateViaCache: r.updateViaCache || null
          };
          snap.sw.registrations.push(obj);
        }
      } catch (e) {
        snap.sw.registrations.push({ error: String(e) });
      }
    }

    // caches
    if (snap.caches.supported) {
      try {
        const keys = await caches.keys();
        snap.caches.keys = keys;
      } catch (e) {
        snap.caches.keys = ["(error) " + String(e)];
      }
    }

    // storage estimate
    if (navigator.storage && navigator.storage.estimate) {
      try {
        snap.storage.estimate = await navigator.storage.estimate();
      } catch (e) {
        snap.storage.estimate = { error: String(e) };
      }
    }

    // fetch test: same URL, no-store
    try {
      const r = await fetch(location.href, {
        cache: "no-store",
        headers: {
          "Cache-Control": "no-cache",
          "Pragma": "no-cache"
        }
      });
      const txt = await r.text();
      const hash = await sha256(txt);
      snap.fetchTest = {
        ok: r.ok,
        status: r.status,
        redirected: r.redirected,
        url: r.url,
        len: txt.length,
        sha256: hash.slice(0, 16),
        headers: {
          "content-type": r.headers.get("content-type"),
          "cache-control": r.headers.get("cache-control"),
          "etag": r.headers.get("etag"),
          "last-modified": r.headers.get("last-modified"),
        }
      };
    } catch (e) {
      snap.fetchTest = { error: String(e) };
    }

    return snap;
  }

  async function sha256(str) {
    const buf = new TextEncoder().encode(str);
    const dig = await crypto.subtle.digest("SHA-256", buf);
    const arr = Array.from(new Uint8Array(dig));
    return arr.map(b => b.toString(16).padStart(2, "0")).join("");
  }

  function fmtBytes(n) {
    if (typeof n !== "number") return String(n);
    const units = ["B","KB","MB","GB","TB"];
    let v = n;
    let i = 0;
    while (v >= 1024 && i < units.length-1) {
      v /= 1024;
      i++;
    }
    return (i===0 ? v.toFixed(0) : v.toFixed(2)) + " " + units[i];
  }

  function renderSnap(snap) {
    line("");
    line("=== SNAPSHOT " + snap.at + " ===");
    line("VERSION: " + VERSION);
    line("URL: " + snap.doc.url);
    line("");

    // net
    setBadge(dotOnline, netText, snap.online ? "ok" : "warn", snap.online ? "ONLINE" : "OFFLINE?");
    line("NETWORK: " + (snap.online ? "ONLINE" : "OFFLINE?"));

    // sw
    const swText = snap.sw.supported
      ? (snap.sw.controller ? "SW ãŒã“ã®ãƒšãƒ¼ã‚¸ã‚’æ”¯é…ä¸­" : "SW ã¯æ”¯é…ã—ã¦ã„ãªã„")
      : "SW éå¯¾å¿œ";
    setBadge(dotController, swControllerText, snap.sw.controller ? "warn" : "ok", swText);

    line("");
    line("[Service Worker]");
    line("supported: " + snap.sw.supported);
    line("controller: " + snap.sw.controller);
    if (snap.sw.registrations && snap.sw.registrations.length) {
      line("registrations: " + snap.sw.registrations.length);
      snap.sw.registrations.forEach((r, i) => {
        line("  #" + (i+1));
        Object.keys(r).forEach(k => line("    " + k + ": " + r[k]));
      });
    } else {
      line("registrations: 0");
    }

    line("");
    line("[Cache Storage]");
    if (snap.caches.supported) {
      line("caches.keys: " + snap.caches.keys.length);
      snap.caches.keys.forEach(k => line("  - " + k));
    } else {
      line("caches: unsupported");
    }

    line("");
    line("[Storage Estimate]");
    if (snap.storage.estimate && !snap.storage.estimate.error) {
      line("quota: " + fmtBytes(snap.storage.estimate.quota));
      line("usage: " + fmtBytes(snap.storage.estimate.usage));
      if (snap.storage.estimate.usageDetails) {
        line("usageDetails: " + JSON.stringify(snap.storage.estimate.usageDetails));
      }
    } else {
      line(JSON.stringify(snap.storage.estimate));
    }

    line("");
    line("[Fetch Test (cache: no-store)]");
    line(JSON.stringify(snap.fetchTest, null, 2));
    line("");
  }

  async function doStatus() {
    line("=== Smart Price SW Doctor ===");
    line("DATE(JST): " + DATE_JST);
    line("b: " + b + " / debug: " + (IS_DEBUG ? "1" : "0"));
    line("-----");
    const snap = await snapshot();
    state.lastSnapshot = snap;
    renderSnap(snap);
  }

  async function clearCaches() {
    if (!("caches" in window)) return;
    const keys = await caches.keys();
    for (const k of keys) {
      try {
        await caches.delete(k);
      } catch (e) {
        // ignore
      }
    }
  }

  async function clearIDB() {
    // indexedDB.databases() ã¯ä¸€éƒ¨ç«¯æœ«ã§æœªå¯¾å¿œã€‚å®‰å…¨ã«ã‚„ã‚‹ã€‚
    try {
      if (!("indexedDB" in window)) return;
      if (indexedDB.databases) {
        const dbs = await indexedDB.databases();
        for (const db of dbs) {
          if (db && db.name) {
            await new Promise((res) => {
              const req = indexedDB.deleteDatabase(db.name);
              req.onsuccess = () => res();
              req.onerror = () => res();
              req.onblocked = () => res();
            });
          }
        }
      } else {
        // ä»£æ›¿ï¼šã‚ˆãã‚ã‚‹åå‰ã¯æ¶ˆã›ãªã„ã®ã§ã‚¹ã‚­ãƒƒãƒ—
      }
    } catch (e) {
      // ignore
    }
  }

  async function unregisterAll() {
    if (!("serviceWorker" in navigator)) return 0;
    const regs = await navigator.serviceWorker.getRegistrations();
    let n = 0;
    for (const r of regs) {
      try {
        const ok = await r.unregister();
        if (ok) n++;
      } catch (e) {
        // ignore
      }
    }
    return n;
  }

  async function hardReloadOnce() {
    // location.reload(true) ã¯å»ƒæ­¢ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€URLã‚’ä½œã£ã¦ç½®ãæ›ãˆã‚‹
    const u = new URL(location.href);
    u.searchParams.set("b", b);
    u.searchParams.set("t", String(Date.now()));
    location.replace(u.toString());
  }

  async function doFix() {
    if (!guarded(12)) {
      line("ï¼ˆé€£æ‰“é˜²æ­¢ï¼‰ã„ã¾ã¯å¾…ã£ã¦ã­ã€‚å°‘ã—ã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€å›ã€‚");
      return;
    }

    const ok = confirm("ã“ã®ã‚µã‚¤ãƒˆã® Service Worker ã‚’è§£é™¤ã—ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ã¦ã€1å›ã ã‘ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ï¼Ÿ");
    if (!ok) return;

    btnFix.disabled = true;
    btnStatus.disabled = true;
    btnOpenTargets.disabled = true;

    line("");
    line("=== FIX START " + nowISO() + " ===");

    try {
      line("1) Service Worker è§£é™¤...");
      const n = await unregisterAll();
      line("   unregistered: " + n);

      // controller ãŒå±…ã‚‹ã¨å³åæ˜ ã•ã‚Œãªã„ã“ã¨ãŒã‚ã‚‹ã®ã§ã€å°‘ã—å¾…ã¤
      await sleep(350);

      line("2) Cache Storage å‰Šé™¤...");
      await clearCaches();
      line("   caches deleted.");

      line("3) localStorage/sessionStorage ã‚’æƒé™¤...");
      try {
        localStorage.clear();
        sessionStorage.removeItem(GUARD_KEY); // ã‚¬ãƒ¼ãƒ‰ã¯æ®‹ã•ãªã„
      } catch (e) {}
      try {
        // sessionStorage ã¯ãƒšãƒ¼ã‚¸å†…ã®æƒ…å ±ãŒæ¶ˆãˆã‚‹ã®ã§ã€ã‚¬ãƒ¼ãƒ‰ä»¥å¤–ã¯æ¶ˆã•ãªã„ï¼ˆå®‰å…¨ï¼‰
      } catch (e) {}
      line("   localStorage cleared.");

      line("4) IndexedDBï¼ˆã‚ã‚Œã°ï¼‰å‰Šé™¤...");
      await clearIDB();
      line("   indexedDB cleared (if supported).");

      line("5) çŠ¶æ…‹ã‚’å†ãƒã‚§ãƒƒã‚¯...");
      const snap = await snapshot();
      state.lastSnapshot = snap;
      renderSnap(snap);

      line("6) 1å›ã ã‘ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ï¼ˆå¼·åˆ¶ï¼‰...");
      await sleep(250);
      await hardReloadOnce();

    } catch (e) {
      line("FIX ERROR: " + String(e));
    } finally {
      btnFix.disabled = false;
      btnStatus.disabled = false;
      btnOpenTargets.disabled = false;
    }
  }

  function showTargets() {
    const dir = baseDir(); // /Smart-Price-Book/
    const targets = [
      { name: "æœ¬ä½“ï¼ˆdevï¼‰", url: buildUrl(dir + "dev/index.html") },
      { name: "æœ¬ä½“ï¼ˆrootï¼‰", url: buildUrl(dir + "index.html") },
      { name: "è¨ºæ–­ï¼ˆã“ã®ãƒ„ãƒ¼ãƒ«ï¼‰", url: buildUrl(location.pathname) },
    ];
    line("");
    line("=== FULL PATHS ===");
    targets.forEach(t => {
      line(t.name + ":");
      line("  " + t.url);
    });
    line("");
  }

  async function copyReport() {
    const txt = logEl.textContent || "";
    try {
      await navigator.clipboard.writeText(txt);
      alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚Rex/Gemini ã«ãã®ã¾ã¾è²¼ã‚Œã¾ã™ã€‚");
    } catch (e) {
      // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ãŒä½¿ãˆãªã„ç«¯æœ«å‘ã‘
      prompt("ã‚³ãƒ”ãƒ¼ã§ããªã„ç«¯æœ«ã§ã™ã€‚ã“ã“ã‚’é•·æŠ¼ã—ã—ã¦å…¨é¸æŠâ†’ã‚³ãƒ”ãƒ¼ã—ã¦ã­ã€‚", txt.slice(0, 20000));
    }
  }

  function wire() {
    showTopInfo();

    // åˆæœŸè¡¨ç¤ºï¼ˆå‹æ‰‹ã«è§£é™¤ã¯ã—ãªã„ï¼‰
    line("ã“ã®ãƒšãƒ¼ã‚¸ã¯è‡ªå‹•ã§æƒé™¤ã—ã¾ã›ã‚“ã€‚");
    line("ã¾ãšã¯ â‘ ã€çŠ¶æ…‹ã‚’è¦‹ã‚‹ã€â†’ ãã‚Œã§ã‚‚ãƒ€ãƒ¡ãªã‚‰ â‘¡ ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");

    // badges init
    setBadge(dotOnline, netText, navigator.onLine ? "ok" : "warn", navigator.onLine ? "ONLINE" : "OFFLINE?");
    const hasCtrl = ("serviceWorker" in navigator) && !!navigator.serviceWorker.controller;
    setBadge(dotController, swControllerText, hasCtrl ? "warn" : "ok", hasCtrl ? "SW ãŒæ”¯é…ä¸­" : "SW ãªã—");

    btnStatus.addEventListener("click", async () => {
      btnStatus.disabled = true;
      try {
        await doStatus();
      } finally {
        btnStatus.disabled = false;
      }
    });

    btnFix.addEventListener("click", doFix);
    btnOpenTargets.addEventListener("click", showTargets);
    btnCopy.addEventListener("click", copyReport);

    window.addEventListener("online", () => setBadge(dotOnline, netText, "ok", "ONLINE"));
    window.addEventListener("offline", () => setBadge(dotOnline, netText, "warn", "OFFLINE?"));
  }

  wire();
})();
</script>
</body>
</html>
