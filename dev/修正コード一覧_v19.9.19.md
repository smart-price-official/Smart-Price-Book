# 🔧 Smart Price 修正コード一覧

**DATE(JST)**: 2026-01-15 20:00 JST  
**VERSION**: v19.9.19-hf29-quality-tax-redborder  
**FILE**: `Smart-Price-Book/dev/index.html`

---

## 📋 修正箇所一覧

### 1. 品質スコアで採用を絞る（Yahooのpack/ケース検出強化）

#### 1-1. `normalizeYahooProductInfo()` 関数の強化

**ファイル**: `Smart-Price-Book/dev/index.html`  
**行番号**: 2636-2819

**変更内容**:
- pack/ケース系の語（「×12本」「ケース」「箱」「まとめ買い」「業務用」等）が強く出てる場合はスコアを下げる
- 販売店名っぽい語が混入している場合もスコアを下げる
- スコアが70未満、またはpack疑いが強くスコアが80未満の場合は楽天を優先検討

**主要コード**:
```javascript
// 行2652-2664: まとめ買い語を検出（信頼度スコア付き・強化版）
const bulkPatterns = [
  { pattern: /×\s*(\d+)\s*(本|個|缶|袋|パック)/gi, trust: 90 },
  { pattern: /(\d+)\s*(本|個|缶|袋|パック)\s*×/gi, trust: 90 },
  { pattern: /(\d+)\s*(本|個|缶|袋|パック)\s*セット/gi, trust: 85 },
  { pattern: /ケース/gi, trust: 80 },
  { pattern: /箱/gi, trust: 75 },
  { pattern: /箱買い/gi, trust: 75 },
  { pattern: /まとめ買い/gi, trust: 70 },
  { pattern: /セット販売/gi, trust: 70 },
  { pattern: /業務用/gi, trust: 75 },
  { pattern: /\[\s*(\d+)\s*(本|個|缶|袋|パック)\s*\]/gi, trust: 85 }
];

// 行2688-2693: 信頼度スコア調整（pack疑いが強いとき・強化版）
if (maxPackTrust >= 80) {
  trustScore -= 30; // pack疑い強（スコアを下げる）
} else if (maxPackTrust >= 70) {
  trustScore -= 20; // pack疑い中（スコアを下げる）
}

// 行2695-2709: 販売店名混入でスコアを下げる
const storeNamePatterns = [
  /楽天/gi, /Amazon/gi, /ヤフー/gi, /Yahoo/gi, /Rakuten/gi,
  /メルカリ/gi, /mercari/gi, /公式/gi, /Official/gi,
  /本店/gi, /支店/gi, /オンライン/gi, /ダイレクト/gi
];
let hasStoreName = false;
storeNamePatterns.forEach(pattern => {
  if (pattern.test(name)) {
    hasStoreName = true;
  }
});
if (hasStoreName) {
  trustScore -= 15; // 販売店名混入でスコアを下げる
}
```

#### 1-2. `processBarcodeData()` 関数での品質スコア判定

**ファイル**: `Smart-Price-Book/dev/index.html`  
**行番号**: 3580-3636

**変更内容**:
- Yahooのスコアが低い（70未満）またはpack疑いが強くスコアが80未満の場合、楽天を優先検討
- 画像がケース画像っぽい場合は楽天の単品画像があれば差し替え

**主要コード**:
```javascript
// 行3581-3602: 品質スコアで採用を絞る（Yahooのスコア判定）
const yahooTrustScore = yahooInfo.trustScore || 100;
const yahooPackHint = yahooInfo.packHint || false;

// Yahooが微妙（スコア低い）なら楽天を採用する
if (yahooTrustScore < 70 || (yahooPackHint && yahooTrustScore < 80)) {
  // Yahooのスコアが低い場合は楽天を優先検討
  if (isDebug()) {
    showToast(`[Yahoo] スコア低 (${yahooTrustScore}) → 楽天検討`, 3000);
  }
} else {
  // Yahooで商品身元情報を埋める（スコアが十分な場合）
  finalInfo.name = yahooInfo.name || '';
  finalInfo.maker = yahooInfo.maker || '';
  finalInfo.imageUrl = yahooInfo.imageUrl || '';
  sourceUsed = 'yahoo';
}

// 行3620-3630: 画像がケース画像っぽい→楽天の単品画像があれば差し替え
if ((yahooInfo.packHint || yahooInfo.isCase) && rakutenInfo.imageUrl) {
  finalInfo.imageUrl = rakutenInfo.imageUrl;
  sourceUsed = 'yahoo+rakuten';
  if (isDebug()) {
    showToast(`[楽天] ケース画像→単品画像に差し替え`, 3000);
  }
}
```

---

### 2. タイトル/メーカー/販売店の"混入"を抑える

#### 2-1. `normalizeMakerName()` 関数の強化

**ファイル**: `Smart-Price-Book/dev/index.html`  
**行番号**: 2580-2634

**変更内容**:
- 販売店名パターンを除去（「店」「ストア」「ショップ」「公式」「本店」「支店」等）
- メーカー重複を除去（例：「コカ・コーラ コカ・コーラ」→「コカ・コーラ」）

**主要コード**:
```javascript
// 行2584-2613: 販売店名パターンを除去（強化版）
const storePatterns = [
  /\s*店\s*$/gi, /\s*ストア\s*$/gi, /\s*ショップ\s*$/gi,
  /\s*ストアーズ\s*$/gi, /\s*ショップス\s*$/gi,
  /\s*モール\s*$/gi, /\s*マーケット\s*$/gi,
  /\s*ドットコム\s*$/gi, /\s*\.com\s*$/gi, /\s*\.co\.jp\s*$/gi,
  /楽天/gi, /Amazon/gi, /ヤフー/gi, /Yahoo/gi, /Rakuten/gi,
  /メルカリ/gi, /mercari/gi, /公式/gi, /Official/gi,
  /本店/gi, /支店/gi, /オンライン/gi, /ダイレクト/gi,
  /\s*inc\s*$/gi, /\s*ltd\s*$/gi, /\s*corp\s*$/gi, /\s*group\s*$/gi
];

// 行2619-2630: メーカー重複を除去
const words = normalized.split(/\s+/).filter(w => w.length > 0);
const uniqueWords = [];
const seen = new Set();
words.forEach(word => {
  const lower = word.toLowerCase();
  if (!seen.has(lower)) {
    seen.add(lower);
    uniqueWords.push(word);
  }
});
normalized = uniqueWords.join(' ');
```

#### 2-2. `normalizeYahooProductInfo()` 関数での商品名整形

**ファイル**: `Smart-Price-Book/dev/index.html`  
**行番号**: 2749-2785

**変更内容**:
- まとめ買い表記を商品名本体から削除
- 商品名から販売店名っぽい語を除去

**主要コード**:
```javascript
// 行2749-2775: まとめ買い表記を商品名本体から削除
if (packHint) {
  bulkPatterns.forEach(({ pattern }) => {
    name = name.replace(pattern.pattern || pattern, '');
  });
  name = name.replace(/\s*×\s*\d+\s*(本|個|缶|袋|パック)\s*/gi, '');
  name = name.replace(/\s*\d+\s*(本|個|缶|袋|パック)\s*×\s*/gi, '');
  name = name.replace(/\s*\d+\s*(本|個|缶|袋|パック)\s*セット\s*/gi, '');
  name = name.replace(/\s*ケース\s*/gi, '');
  name = name.replace(/\s*箱\s*/gi, '');
  name = name.replace(/\s*箱買い\s*/gi, '');
  name = name.replace(/\s*まとめ買い\s*/gi, '');
  name = name.replace(/\s*セット販売\s*/gi, '');
  name = name.replace(/\s*業務用\s*/gi, '');
}

// 行2777-2785: 商品名から販売店名っぽい語を除去
const storeNameInProductPatterns = [
  /\s*楽天\s*/gi, /\s*Amazon\s*/gi, /\s*ヤフー\s*/gi, /\s*Yahoo\s*/gi,
  /\s*Rakuten\s*/gi, /\s*メルカリ\s*/gi, /\s*mercari\s*/gi,
  /\s*公式\s*/gi, /\s*Official\s*/gi, /\s*本店\s*/gi, /\s*支店\s*/gi
];
storeNameInProductPatterns.forEach(pattern => {
  name = name.replace(pattern, ' ');
});
```

---

### 3. 税別/税込：ストアに"既定"を持たせて自動切替

#### 3-1. `DEFAULT_CONFIG` に `storeTaxModes` を追加

**ファイル**: `Smart-Price-Book/dev/index.html`  
**行番号**: 406

**変更内容**:
- ストアごとの税別/税込既定値を保持するオブジェクトを追加

**主要コード**:
```javascript
// 行406: storeTaxModes を追加
storeTaxModes: {} // ストアごとの税別/税込既定値 { "ストア名": "ex" or "in" }
```

#### 3-2. `normalizeDb()` 関数で `storeTaxModes` を初期化

**ファイル**: `Smart-Price-Book/dev/index.html`  
**行番号**: 1102-1105

**変更内容**:
- `storeTaxModes` が存在しない場合は空オブジェクトで初期化

**主要コード**:
```javascript
// 行1102-1105: storeTaxModes を初期化
if (!Array.isArray(o.config.customStores)) o.config.customStores = [];
if (typeof o.config.storeTaxModes !== "object" || !o.config.storeTaxModes) o.config.storeTaxModes = {};
```

#### 3-3. ストア選択時に税別/税込既定値を自動反映

**ファイル**: `Smart-Price-Book/dev/index.html`  
**行番号**: 1757-1768

**変更内容**:
- ストアを選択したときに、そのストアの既定値（taxMode）を自動反映

**主要コード**:
```javascript
// 行1757-1768: ストアの税別/税込既定値を自動反映
const storeTaxMode = db.config.storeTaxModes && db.config.storeTaxModes[curStore];
if (storeTaxMode) {
  const taxModeId = storeTaxMode === "in" ? 'taxIn' : 'taxEx';
  const taxEl = document.getElementById(taxModeId);
  if (taxEl) {
    taxEl.checked = true;
    if (isDebug()) {
      console.log('[StoreTaxMode] Auto-switch:', curStore, '→', storeTaxMode);
      showToast(`税${storeTaxMode === "in" ? "込" : "別"}に自動切替`, 2000);
    }
  }
}
```

#### 3-4. 保存時にストアの税別/税込既定値を保存

**ファイル**: `Smart-Price-Book/dev/index.html`  
**行番号**: 2471-2478

**変更内容**:
- 一度設定したら、以後そのストアでは自動で切替わるように保存

**主要コード**:
```javascript
// 行2471-2478: ストアの税別/税込既定値を保存
if (curStore && curStore !== "未設定") {
  if (!db.config.storeTaxModes) db.config.storeTaxModes = {};
  db.config.storeTaxModes[curStore] = isTaxEx ? "ex" : "in";
  if (isDebug()) {
    console.log('[StoreTaxMode] Saved:', curStore, '→', db.config.storeTaxModes[curStore]);
  }
}
```

---

### 4. 「赤い線の枠」修正

#### 4-1. `#priceSection` のCSSを調整

**ファイル**: `Smart-Price-Book/dev/index.html`  
**行番号**: 152

**変更内容**:
- `border-width: 1px !important` を追加
- `box-sizing: border-box` を追加
- `max-width: 100%; overflow: hidden;` を追加して余白で巨大化しないように

**主要コード**:
```html
<!-- 行152: priceSection のCSS調整 -->
<div id="priceSection" class="mb-3 p-3 border rounded border-danger" 
     style="background:#1a1a1a; border-width: 1px !important; box-sizing: border-box; max-width: 100%; overflow: hidden;">
```

---

### 5. OFF（Open Food Facts）の採用条件を厳格化

#### 5-1. `lookupOffByJan()` 関数での画像判定強化

**ファイル**: `Smart-Price-Book/dev/index.html`  
**行番号**: 2884-2910（推定）

**変更内容**:
- 画像が"自撮り/ユーザー投稿"っぽい（雑・暗い・斜め・背景あり等）場合は採用しない
- 画像URLに "user" や "upload" が含まれる場合は除外

**主要コード**:
```javascript
// 画像が"自撮り/ユーザー投稿"っぽい場合は採用しない
const isUserUploadImage = imageUrl && (
  imageUrl.includes('user') || 
  imageUrl.includes('upload') ||
  imageUrl.includes('mobile') ||
  (!isFrontImage && imageUrl.includes('images.openfoodfacts.org'))
);

if (imageUrl && (isUserUploadImage || !isFrontImage)) {
  // 画像をクリア（商品名のみ採用）
  imageUrl = '';
}
```

#### 5-2. `processBarcodeData()` 関数でのOFF採用条件

**ファイル**: `Smart-Price-Book/dev/index.html`  
**行番号**: 3653-3679

**変更内容**:
- OFFは「タイトル確定」ではなく、カテゴリ・成分・補助画像の穴埋めに寄せる（主役にしない）
- 既にYahoo/楽天で名前が取れている場合は上書きしない（補助として使う）
- 画像は最後の手段（自撮り/ユーザー投稿っぽい場合は採用しない）

**主要コード**:
```javascript
// 行3654-3679: OFFで商品身元情報を埋める（条件チェック済み・最終補助）
if (offInfo.name && offInfo.name.trim()) {
  // 既にYahoo/楽天で名前が取れている場合は上書きしない（補助として使う）
  if (!finalInfo.name || finalInfo.name.trim().length < 3) {
    finalInfo.name = offInfo.name;
    sourceUsed = 'off';
  }
}
if (offInfo.maker && offInfo.maker.trim() && !finalInfo.maker) {
  finalInfo.maker = offInfo.maker;
  if (sourceUsed === 'none') sourceUsed = 'off';
}
// 画像は最後の手段（自撮り/ユーザー投稿っぽい場合は採用しない）
if (offInfo.imageUrl && offInfo.imageUrl.trim() && !finalInfo.imageUrl) {
  // 画像URLに "front" が含まれる、または明らかに商品正面画像の場合のみ採用
  if (offInfo.imageUrl.includes('front') || offInfo.imageUrl.includes('image_front')) {
    finalInfo.imageUrl = offInfo.imageUrl;
    if (sourceUsed === 'none') sourceUsed = 'off';
  }
}
```

---

## 📌 修正ファイル一覧

| ファイル | 行番号 | 変更内容 |
|---------|--------|---------|
| `Smart-Price-Book/dev/index.html` | 1-30 | ヘッダー情報更新（VERSION、DATE、TITLE、CHANGES） |
| `Smart-Price-Book/dev/index.html` | 406 | `storeTaxModes` を `DEFAULT_CONFIG` に追加 |
| `Smart-Price-Book/dev/index.html` | 1102-1105 | `normalizeDb()` で `storeTaxModes` を初期化 |
| `Smart-Price-Book/dev/index.html` | 152 | `#priceSection` のCSS調整（赤枠修正） |
| `Smart-Price-Book/dev/index.html` | 1757-1768 | ストア選択時に税別/税込既定値を自動反映 |
| `Smart-Price-Book/dev/index.html` | 2471-2478 | 保存時にストアの税別/税込既定値を保存 |
| `Smart-Price-Book/dev/index.html` | 2580-2634 | `normalizeMakerName()` 関数の強化 |
| `Smart-Price-Book/dev/index.html` | 2636-2819 | `normalizeYahooProductInfo()` 関数の強化 |
| `Smart-Price-Book/dev/index.html` | 3580-3636 | `processBarcodeData()` での品質スコア判定 |
| `Smart-Price-Book/dev/index.html` | 3653-3679 | OFF採用条件の厳格化 |

---

## 🔗 関連ファイル

- **修正報告書**: `Smart-Price-Book/dev/修正報告書_v19.9.19-hf29-quality-tax-redborder.md`
- **基準コミット**: BASE_COMMIT: 1407bdd（機能の基準コミット、P0カメラ/遅延の本体）

---

**更新完了。修正コード一覧をリスト化しました。**
