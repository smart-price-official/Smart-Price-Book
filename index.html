// ========= Debug =========
function isDebug() {
  try { return new URL(location.href).searchParams.get('debug') === '1'; } catch(e){ return false; }
}

// ✅ グローバルスコープに移動
let errorLogs = [];
const MAX_ERROR_LOGS = 50;

function addErrorLog(errorInfo) {
  if (!isDebug()) return; // デバッグモード時のみ実行
  
  errorLogs.push({
    ...errorInfo,
    timestamp: errorInfo.timestamp || new Date().toISOString()
  });
  if (errorLogs.length > MAX_ERROR_LOGS) {
    errorLogs.shift();
  }
  try {
    localStorage.setItem('smartPrice_errorLogs', JSON.stringify(errorLogs));
  } catch(e) {
    console.warn('[ErrorLog] Failed to save to localStorage:', e);
  }
}

function setLastError(msg) {
  if (!isDebug()) return;
  
  const errorDisplay = document.getElementById('debug-error-display');
  if (errorDisplay) {
    errorDisplay.textContent = msg;
    errorDisplay.style.display = 'block';
  }
}

// ✅ デバッグ用のエラーハンドリング
if (isDebug()) {
  const errorDisplay = document.getElementById('debug-error-display');
  if (errorDisplay) errorDisplay.style.display = 'block';

  window.addEventListener('error', (e) => {
    // ... 既存のエラーハンドリングコード
    // ✅ ここで addErrorLog と setLastError を呼び出せる
    addErrorLog({
      type: 'js_error',
      name: errorName,
      message: errorMsg,
      filename: errorFileName,
      lineno: errorLine,
      colno: errorCol,
      stack: errorStack,
      timestamp: new Date().toISOString()
    });
    setLastError(fullMsg);
  });
}
