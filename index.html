<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#D50000">
  <title>Smart Price v19.9.41</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    body { font-family: sans-serif; background-color: #121212; color: #e0e0e0; padding-bottom: 90px; touch-action: manipulation; }
    .header { background: linear-gradient(135deg, #D50000, #9b0000); padding: 12px 15px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
    .v-badge { background: #ff5252; color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; margin-left: 10px; font-weight: bold; }
    .store-area { background: #1e1e1e; padding: 10px; border-bottom: 1px solid #333; min-height: 55px; }
    .store-list { display: flex; overflow-x: auto; gap: 8px; padding: 5px 0; -webkit-overflow-scrolling: touch; }
    .store-tag { padding: 6px 14px; border: 1px solid #444; border-radius: 20px; white-space: nowrap; font-size: 0.85rem; background: #2c2c2c; color: #ccc; }
    .store-tag.active { background: #D50000; color: white; border-color: #D50000; }
    .store-tag.gps-btn { border: 1px solid #ff5252; color: #ff5252; }
    .store-tag.gps-btn.on { background: #ff5252; color: white; }
    .store-tag.add-store { border: 1px dashed #777; color: #ddd; background: #262626; }
    .store-tag.add-store:active { background: #333; }
    .gps-status { font-size: 0.6rem; margin-left: 4px; opacity: 0.9; }

    .card { background-color: #1e1e1e; border: 1px solid #333; margin-bottom: 10px; border-radius: 12px; overflow: hidden; }
    .price-card { padding: 12px; border-left: 4px solid #444; cursor: pointer; }
    .price-card.cheap { border-left-color: #ff5252; background: linear-gradient(90deg, #2a1a1a 0%, #1e1e1e 100%); }
    .prod-thumb { width: 68px; height: 68px; object-fit: contain; background: #fff; border-radius: 8px; margin-right: 12px; }

    .price-main { font-size: 1.25rem; font-weight: bold; color: #fff; line-height: 1; }
    .stats-strip { display: flex; flex-direction: column; background: #262626; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.75rem; border: 1px solid #333; }
    .stats-row { display: flex; justify-content: space-around; width: 100%; }
    .stat-item { text-align: center; flex: 1; color: #aaa; }
    .stat-val { display: block; font-weight: bold; color: #fff; font-size: 0.9rem; }

    .history-row { font-size: 0.8rem; padding: 10px 0; border-top: 1px solid #333; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    
    .selected {
      border: 1px solid #ff5252 !important;
      border-radius: 12px !important;
      background: rgba(213,0,0,0.12);
      box-sizing: border-box !important;
      max-width: 100% !important;
      overflow: hidden !important;
      padding: 12px !important;
      margin: 0 !important;
    }

    #camera-area { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; background: black; z-index: 2000; }
    #interactive { width: 100%; height: 100%; position: relative; }
    #interactive video { width: 100%; height: 100%; object-fit: cover; }
    .scan-frame { 
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      width: 280px; 
      height: 180px; 
      z-index: 2001;
      box-shadow: 0 0 0 4000px rgba(0,0,0,0.65);
      border: 2px solid #ff5252;
      border-radius: 12px;
      display: block;
      pointer-events: none;
    }
    
    .scan-laser { 
      position: absolute; 
      top: 15%;
      left: 5%; 
      width: 90%; 
      height: 3px;
      background: linear-gradient(180deg, rgba(255,0,0,0.3), rgba(255,0,0,1), rgba(255,0,0,0.3));
      box-shadow: 
        0 0 8px 1px rgba(255,0,0,0.8), 
        0 0 15px 3px rgba(255,0,0,0.5);
      animation: scan-move 2s infinite ease-in-out; 
      z-index: 2002;
      border-radius: 2px; 
      will-change: transform;
      pointer-events: none;
      transform: translateZ(0);
      backface-visibility: hidden;
    }
    
    @keyframes scan-move { 
      0% { 
        top: 15%; 
        opacity: 0.6; 
      } 
      50% { 
        top: 82%;
        opacity: 1; 
      } 
      100% { 
        top: 15%; 
        opacity: 0.6; 
      } 
    }

    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; justify-content: center; align-items: center; }
    .modal-content { background: #1e1e1e; padding: 25px; border-radius: 20px; width: 95%; max-width: 450px; border: 1px solid #D50000; }

    .toast-container{
      position: fixed;
      top: auto;
      bottom: 110px;
      left: 50%;
      transform: translateX(-50%);
      width: min(92vw, 420px);
      z-index: 5000;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .toast-item{
      background: rgba(50,50,50,0.95);
      color: #fff;
      padding: 10px 14px;
      border-radius: 14px;
      font-size: 0.88rem;
      line-height: 1.25;
      border: 1px solid #777;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
      opacity: 0;
      transform: translateY(-6px);
      transition: opacity .18s ease, transform .18s ease;
      word-break: break-word;
      white-space: pre-wrap;
    }
    .toast-item.show{
      opacity: 1;
      transform: translateY(0);
    }
    .toast-item.small{
      font-size: 0.82rem;
      padding: 9px 12px;
    }

    /* ‚úÖ „Éá„Éê„ÉÉ„Ç∞„Éë„Éç„É´ - Èñâ„Åò„Çã„Éú„Çø„É≥‰ªò„Åç„ÄÅ„Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩ */
    #debug-panel {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: 92%;
      max-width: 820px;
      background: rgba(0,0,0,0.92);
      color: #9ff;
      font: 11px/1.5 monospace;
      padding: 10px 12px 12px 12px;
      border-radius: 8px;
      z-index: 99999;
      border: 1px solid #ff5252;
      box-shadow: 0 4px 20px rgba(255,0,0,0.3);
      max-height: 60vh;
      overflow-y: auto;
      display: none;
    }
    #debug-panel.show {
      display: block;
    }
    #debug-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid #444;
    }
    #debug-panel-title {
      color: #ff5252;
      font-weight: bold;
      font-size: 12px;
    }
    #debug-panel-close {
      background: #ff5252;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 2px 8px;
      cursor: pointer;
      font-size: 11px;
      font-family: monospace;
    }
    #debug-panel-close:hover {
      background: #ff1744;
    }
    #debug-panel-content {
      font-size: 11px;
    }
    #debug-panel-content div {
      margin-bottom: 2px;
    }
    #debug-panel-content b {
      color: #ffeb3b;
    }

    /* ‚úÖ „Éá„Éê„ÉÉ„Ç∞„Éú„Çø„É≥ - Âè≥‰∏ãÂõ∫ÂÆö */
    #debug-toggle-btn {
      position: fixed;
      bottom: 120px;
      right: 15px;
      width: 50px;
      height: 50px;
      background: rgba(213,0,0,0.9);
      color: white;
      border: 2px solid #ff5252;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 99998;
      font-size: 18px;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      display: none;
    }
    #debug-toggle-btn.show {
      display: flex;
    }
    #debug-toggle-btn:active {
      transform: scale(0.95);
    }

    .city-chips { display: flex; overflow-x: auto; gap: 5px; padding: 5px 0; margin-bottom: 10px; -webkit-overflow-scrolling: touch; }
    .city-chip { font-size: 0.75rem; padding: 4px 12px; border-radius: 15px; background: #333; color: #ccc; border: 1px solid #555; white-space: nowrap; cursor: pointer; }
    .city-chip:active { background: #D50000; color: white; }

    .url-box { font-size: 0.9rem; padding: 12px; border-radius: 12px; }
    .hint { font-size: 0.75rem; color: #aaa; line-height: 1.4; }
  </style>
</head>
<body>
  <div class="toast-container" id="toast-container"></div>

  <!-- ‚úÖ „Éá„Éê„ÉÉ„Ç∞„Éà„Ç∞„É´„Éú„Çø„É≥ -->
  <div id="debug-toggle-btn" title="„Éá„Éê„ÉÉ„Ç∞„Éë„Éç„É´„ÇíÈñã„Åè">
    <i class="bi bi-bug-fill"></i>
  </div>

  <!-- ‚úÖ „Éá„Éê„ÉÉ„Ç∞„Éë„Éç„É´ -->
  <div id="debug-panel">
    <div id="debug-panel-header">
      <div id="debug-panel-title">üêõ DEBUG PANEL</div>
      <button id="debug-panel-close">√ó</button>
    </div>
    <div id="debug-panel-content"></div>
  </div>

  <div class="header">
    <h5 class="m-0 d-inline-block">Smart Price<span class="v-badge">v19.9.41</span></h5>
  </div>

  <div class="container mt-3">
    <p style="color: #aaa; font-size: 0.9rem;">„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ„ÅåÊúâÂäπ„Å´„Å™„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇÂè≥‰∏ã„ÅÆ„Éú„Çø„É≥„Åß„Éá„Éê„ÉÉ„Ç∞„Éë„Éç„É´„ÇíË°®Á§∫„Åß„Åç„Åæ„Åô„ÄÇ</p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ========= „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ =========
    const APP_VERSION = 'v19.9.41';
    const BUILD_ID = '2026-02-05_0925_toastlife-r5';
    
    // ========= „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÊ§úÂá∫ =========
    function isDebug() {
      const params = new URLSearchParams(location.search);
      return params.has('debug');
    }

    // ========= ToastÊ©üËÉΩ =========
    let toastQueue = [];
    let toastTimeout = null;

    function showToast(message, type = 'info', durationSec = 3) {
      const container = document.getElementById('toast-container');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = 'toast-item';
      toast.textContent = String(message);

      container.appendChild(toast);

      requestAnimationFrame(() => {
        toast.classList.add('show');
      });

      const duration = durationSec * 1000;
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 200);
      }, duration);
    }

    function clearToasts() {
      const container = document.getElementById('toast-container');
      if (!container) return;
      container.innerHTML = '';
    }

    // ========= „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞Ê©üËÉΩ =========
    function debugLog(message, type = 'info') {
      if (!isDebug()) return;
      
      // „Ç≥„É≥„ÇΩ„Éº„É´„Å´„É≠„Ç∞Âá∫Âäõ
      console.log('[DEBUG]', message);
      
      // „Éà„Éº„Çπ„Éà„ÅßË°®Á§∫Ôºà10ÁßíÔºâ
      showToast(String(message), type, 10);
    }

    // ========= „Éá„Éê„ÉÉ„Ç∞„Éë„Éç„É´Ê©üËÉΩ =========
    (function initDebugPanel() {
      if (!isDebug()) return;

      const panel = document.getElementById('debug-panel');
      const content = document.getElementById('debug-panel-content');
      const toggleBtn = document.getElementById('debug-toggle-btn');
      const closeBtn = document.getElementById('debug-panel-close');

      if (!panel || !content || !toggleBtn || !closeBtn) return;

      // „Éá„Éê„ÉÉ„Ç∞„Éú„Çø„É≥„ÇíË°®Á§∫
      toggleBtn.classList.add('show');

      // „Éë„Éç„É´ÊÉÖÂ†±„ÇíËøΩÂä†
      const log = (k, v) => {
        const div = document.createElement('div');
        div.innerHTML = `<b>${k}</b>: ${String(v)}`;
        content.appendChild(div);
      };

      const params = new URLSearchParams(location.search);

      log('TIME', new Date().toISOString());
      log('URL', location.href);
      log('PATH', location.pathname);
      log('BUILD', params.get('b') || BUILD_ID);
      log('VERSION', APP_VERSION);
      log('TITLE', document.title || '(empty)');
      log('USER_AGENT', navigator.userAgent.substring(0, 80) + '...');

      // Service WorkerÁä∂ÊÖã
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(rs => {
          log('SW', rs.length ? `${rs.length} REGISTERED` : 'NONE');
          if (rs.length > 0) {
            log('SW_ACTION', '„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ„Åß„ÅØSW„ÅØÁÑ°ÂäπÂåñ„Åï„Çå„Åæ„Åô');
          }
        }).catch(e => log('SW', 'ERROR ' + e.message));
      } else {
        log('SW', 'NOT SUPPORTED');
      }

      // localStorageÊÉÖÂ†±
      try {
        const dbStr = localStorage.getItem('smart_price_db');
        if (dbStr) {
          const db = JSON.parse(dbStr);
          log('DB_PRODUCTS', Object.keys(db.products || {}).length);
          log('DB_STORES', Object.keys(db.stores || {}).length);
        } else {
          log('DB', 'EMPTY');
        }
      } catch (e) {
        log('DB', 'ERROR: ' + e.message);
      }

      // „Éà„Ç∞„É´„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà
      toggleBtn.addEventListener('click', () => {
        if (panel.classList.contains('show')) {
          panel.classList.remove('show');
          debugLog('„Éá„Éê„ÉÉ„Ç∞„Éë„Éç„É´„ÇíÈñâ„Åò„Åæ„Åó„Åü');
        } else {
          panel.classList.add('show');
          debugLog('„Éá„Éê„ÉÉ„Ç∞„Éë„Éç„É´„ÇíÈñã„Åç„Åæ„Åó„Åü');
        }
      });

      // Èñâ„Åò„Çã„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà
      closeBtn.addEventListener('click', () => {
        panel.classList.remove('show');
        debugLog('„Éá„Éê„ÉÉ„Ç∞„Éë„Éç„É´„ÇíÈñâ„Åò„Åæ„Åó„Åü');
      });

      // ÂàùÊúüË°®Á§∫
      debugLog('„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ„ÅåÊúâÂäπ„Åß„Åô„ÄÇÂè≥‰∏ã„ÅÆ„Éú„Çø„É≥„Åß„Éë„Éç„É´„ÇíË°®Á§∫„Åß„Åç„Åæ„Åô„ÄÇ');
    })();

    // ========= ÂàùÊúüÂåñÂá¶ÁêÜ =========
    document.addEventListener('DOMContentLoaded', () => {
      if (isDebug()) {
        debugLog('„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñÂÆå‰∫Ü');
        debugLog(`„Éê„Éº„Ç∏„Éß„É≥: ${APP_VERSION}`);
        debugLog(`„Éì„É´„ÉâID: ${BUILD_ID}`);
      }
    });

    // Service Worker ÁÑ°ÂäπÂåñÔºà„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÊôÇÔºâ
    if (isDebug() && 'serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for (let registration of registrations) {
          registration.unregister();
          debugLog('Service Worker „ÇíÁÑ°ÂäπÂåñ„Åó„Åæ„Åó„Åü');
        }
      });
    }
  </script>
</body>
</html>
