<!--
APP: Yahoo Lab (Smart Price - Yahoo連携 実験ページ)
FILE: index.html
VERSION: v0.1.0-yahoo-lab-A
DATE(JST): 2026-01-11 22:17 JST
TITLE: Yahoo商品検索 実験ページ（GitHub Pages + GASプロキシ）
CHANGES:
- GitHub Pagesで動く単一HTMLの実験UI（JAN/キーワード検索）
- 推奨：Apps Script Webアプリ（プロキシ）経由でYahoo APIを呼ぶ（APP IDを隠す）
- 直接呼び出しモード（APP IDを画面入力）も用意（実験用途のみ）
AUTHOR: Yui
BUILD_PARAM: ?b=2026-01-11_2217_yahoo-lab
DEBUG_PARAM: &debug=1
POLICY: UI最小・実験用。Yahooデータ表示時はクレジット表示を必須。
-->
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Yahoo Lab | v0.1.0-yahoo-lab-A</title>
<style>
  :root { color-scheme: dark; }
  body {
    margin: 0;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
    background: #121212;
    color: #e8e8e8;
  }
  header {
    padding: 14px 16px;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    position: sticky;
    top: 0;
    background: rgba(18,18,18,0.92);
    backdrop-filter: blur(10px);
    z-index: 5;
  }
  .h1 { font-size: 16px; font-weight: 700; letter-spacing: 0.02em; }
  .sub { font-size: 12px; opacity: 0.78; margin-top: 2px; }
  main { padding: 16px; max-width: 980px; margin: 0 auto; }
  .card {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 14px;
    padding: 14px;
    margin-bottom: 12px;
  }
  label { display: block; font-size: 12px; opacity: 0.85; margin-bottom: 6px; }
  input, select {
    width: 100%;
    box-sizing: border-box;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(0,0,0,0.25);
    color: #e8e8e8;
    padding: 12px 12px;
    outline: none;
  }
  input:focus, select:focus { border-color: rgba(255,255,255,0.25); }
  .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
  @media (min-width: 760px) { .row { grid-template-columns: 1fr 1fr; } }
  .btn {
    width: 100%;
    border: 0;
    border-radius: 14px;
    padding: 12px 14px;
    font-weight: 700;
    cursor: pointer;
    background: #2d7ff9;
    color: #07121f;
  }
  .btn:disabled { opacity: 0.6; cursor: default; }
  .tiny { font-size: 12px; opacity: 0.78; line-height: 1.55; }
  .warn { color: #ffd29a; }
  .ok { color: #a8ffcc; }
  .err { color: #ff9aa8; }
  .divider { height: 1px; background: rgba(255,255,255,0.08); margin: 12px 0; }
  .results { display: grid; grid-template-columns: 1fr; gap: 10px; }
  @media (min-width: 760px) { .results { grid-template-columns: 1fr 1fr; } }
  .item { display: grid; grid-template-columns: 92px 1fr; gap: 12px; align-items: start; }
  .thumb {
    width: 92px; height: 92px; border-radius: 14px; object-fit: cover;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.08);
  }
  .name { font-size: 14px; font-weight: 700; line-height: 1.35; margin-bottom: 6px; }
  .meta { font-size: 12px; opacity: 0.82; line-height: 1.55; }
  a { color: #9ec4ff; text-decoration: none; }
  a:hover { text-decoration: underline; }
  .debugBanner {
    display:none;
    margin-top: 8px;
    font-size: 12px;
    padding: 8px 10px;
    border-radius: 12px;
    border: 1px dashed rgba(255,255,255,0.25);
    background: rgba(0,0,0,0.25);
  }
  .pillRow { display:flex; gap: 8px; flex-wrap: wrap; }
  .pill {
    display:inline-flex; align-items:center; gap:6px;
    padding: 8px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(0,0,0,0.22);
    font-size: 12px;
    cursor:pointer;
    user-select:none;
  }
  .pill input { width: auto; padding: 0; margin: 0; }
  footer { padding: 18px 16px 26px; opacity: 0.85; }
</style>
</head>
<body>
<header>
  <div class="h1">Yahoo商品検索（実験）</div>
  <div class="sub">v0.1.0-yahoo-lab-A / build 2026-01-11_2217_yahoo-lab</div>
  <div id="debugBanner" class="debugBanner"></div>
</header>

<main>
  <section class="card">
    <div class="tiny">
      このページは <b>GitHub Pages</b> 上で動かす「実験用」です。<br>
      <span class="warn">おすすめ：</span> Yahoo API は <b>Apps Script（GAS）プロキシ</b>経由で呼び出します（APP IDを公開しないため）。<br>
      まずは「プロキシURL」を入れて検索してみてね。
    </div>
    <div class="divider"></div>

    <div class="row">
      <div>
        <label>プロキシURL（GAS Webアプリ URL）</label>
        <input id="proxyUrl" placeholder="例）https://script.google.com/macros/s/〜/exec" autocomplete="off">
        <div class="tiny warn" style="margin-top:6px;">
          ※ 末尾に /exec が付くURL（Webアプリ）を入れてね
        </div>
      </div>
      <div>
        <label>（実験用）直接呼び出しAPP ID（公開になるので非推奨）</label>
        <input id="appId" placeholder="YahooのアプリケーションID（任意）" autocomplete="off">
        <div class="tiny" style="margin-top:6px;">
          プロキシが未設定のときだけ使用します（実験用途）。
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="pillRow" role="radiogroup" aria-label="検索モード">
      <label class="pill"><input type="radio" name="mode" value="jan" checked> JANコード</label>
      <label class="pill"><input type="radio" name="mode" value="keyword"> キーワード</label>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label id="qLabel">JANコード</label>
        <input id="q" placeholder="例）4901777310159" inputmode="numeric" autocomplete="off">
      </div>
      <div class="row" style="grid-template-columns: 1fr 1fr; gap:10px;">
        <div>
          <label>画像サイズ</label>
          <select id="imageSize">
            <option value="146">146</option>
            <option value="300" selected>300</option>
            <option value="600">600</option>
          </select>
        </div>
        <div>
          <label>件数（results）</label>
          <select id="results">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="20">20</option>
          </select>
        </div>
      </div>
    </div>

    <div style="margin-top:12px;">
      <button id="btn" class="btn">検索する</button>
    </div>

    <div id="status" class="tiny" style="margin-top:10px;"></div>
  </section>

  <section class="card">
    <div class="tiny">
      <b>表示ルール（必須）</b><br>
      Yahooのデータ（商品名・価格・画像など）を表示する場合は、クレジット表記が必要です。<br>
      このページは下のフッターに常に表示する形にしています。
    </div>
  </section>

  <section class="card">
    <div class="h1" style="font-size:14px;">検索結果</div>
    <div class="divider"></div>
    <div id="resultsBox" class="results"></div>
  </section>
</main>

<footer class="tiny">
  <div>
    <b>Web Services by Yahoo! JAPAN</b>
    <span style="opacity:0.85;">（データ提供元表示）</span>
  </div>
</footer>

<script>
(() => {
  "use strict";

  const APP = {
    version: "v0.1.0-yahoo-lab-A",
    build: "2026-01-11_2217_yahoo-lab",
    yahooEndpoint: "https://shopping.yahooapis.jp/ShoppingWebService/V3/itemSearch"
  };

  // &debug=1 でデバッグ表示
  const params = new URLSearchParams(location.search);
  const debug = params.get("debug") === "1";
  const debugBanner = document.getElementById("debugBanner");
  if (debug) {
    debugBanner.style.display = "block";
    debugBanner.textContent = `DEBUG ON | version=${APP.version} | build=${APP.build} | ua=${navigator.userAgent}`;
  }

  const el = {
    proxyUrl: document.getElementById("proxyUrl"),
    appId: document.getElementById("appId"),
    qLabel: document.getElementById("qLabel"),
    q: document.getElementById("q"),
    imageSize: document.getElementById("imageSize"),
    results: document.getElementById("results"),
    btn: document.getElementById("btn"),
    status: document.getElementById("status"),
    resultsBox: document.getElementById("resultsBox")
  };

  // localStorageに保存（実験の手間削減）
  const LS_KEY = "yahoo_lab_settings_v1";
  try {
    const saved = JSON.parse(localStorage.getItem(LS_KEY) || "null");
    if (saved && typeof saved === "object") {
      if (saved.proxyUrl) el.proxyUrl.value = saved.proxyUrl;
      if (saved.appId) el.appId.value = saved.appId;
    }
  } catch (_e) {}

  function setStatus(text, kind) {
    const cls = kind === "ok" ? "ok" : kind === "err" ? "err" : kind === "warn" ? "warn" : "";
    el.status.className = "tiny " + cls;
    el.status.textContent = text;
  }

  function getMode() {
    const checked = document.querySelector('input[name="mode"]:checked');
    return checked ? checked.value : "jan";
  }

  function updateLabel() {
    const mode = getMode();
    el.qLabel.textContent = mode === "keyword" ? "キーワード" : "JANコード";
    el.q.placeholder = mode === "keyword" ? "例）明治 お菓子" : "例）4901777310159";
    el.q.inputMode = mode === "keyword" ? "text" : "numeric";
  }

  document.querySelectorAll('input[name="mode"]').forEach(r => {
    r.addEventListener("change", updateLabel);
  });
  updateLabel();

  function escapeHtml(s) {
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function formatYen(n) {
    const num = Number(n);
    if (!Number.isFinite(num)) return "";
    return num.toLocaleString("ja-JP") + "円";
  }

  function pickImage(item) {
    // V3 itemSearch の画像フィールドは Image.Medium など（ドキュメント準拠）
    // ただしフィールド名の大小などは揺れる可能性があるので複数候補を試す
    const cand = [
      item?.Image?.Medium,
      item?.Image?.medium,
      item?.Image?.Small,
      item?.Image?.small,
      item?.image?.medium,
      item?.image?.small
    ].filter(Boolean);
    return cand[0] || "";
  }

  function render(items) {
    el.resultsBox.innerHTML = "";
    if (!Array.isArray(items) || items.length === 0) {
      el.resultsBox.innerHTML = '<div class="tiny warn">結果が見つからなかったよ。</div>';
      return;
    }

    const frag = document.createDocumentFragment();

    for (const it of items) {
      const div = document.createElement("div");
      div.className = "card";
      const img = pickImage(it);
      const name = it?.Name || it?.name || "";
      const price = it?.Price || it?.price || it?.PriceLabel?.DefaultPrice || "";
      const store = it?.Seller?.Name || it?.seller?.name || it?.Store?.Name || "";
      const url = it?.Url || it?.url || "";
      const code = it?.JanCode || it?.janCode || it?.jan_code || "";

      const nameHtml = url
        ? `<a href="${escapeHtml(url)}" target="_blank" rel="noopener">${escapeHtml(name)}</a>`
        : escapeHtml(name);

      div.innerHTML = `
        <div class="item">
          <img class="thumb" src="${escapeHtml(img)}" alt="">
          <div>
            <div class="name">${nameHtml}</div>
            <div class="meta">
              <div>価格：<b>${escapeHtml(formatYen(price))}</b></div>
              ${store ? `<div>販売：${escapeHtml(store)}</div>` : ""}
              ${code ? `<div>JAN：${escapeHtml(code)}</div>` : ""}
            </div>
          </div>
        </div>
      `;
      frag.appendChild(div);
    }
    el.resultsBox.appendChild(frag);
  }

  async function fetchViaProxy({ proxyUrl, mode, q, imageSize, results }) {
    const url = new URL(proxyUrl);
    url.searchParams.set("mode", mode);
    url.searchParams.set(mode === "keyword" ? "query" : "jan", q);
    url.searchParams.set("image_size", imageSize);
    url.searchParams.set("results", results);

    const res = await fetch(url.toString(), {
      method: "GET"
      // 注意：ヘッダを付けるとCORSの事前確認（プリフライト）が起きやすいので付けない
    });
    if (!res.ok) {
      const t = await res.text().catch(() => "");
      throw new Error(`プロキシ応答エラー：HTTP ${res.status} ${t?.slice(0,180)}`);
    }
    return await res.json();
  }

  async function fetchDirect({ appId, mode, q, imageSize, results }) {
    const url = new URL(APP.yahooEndpoint);
    url.searchParams.set("appid", appId);
    url.searchParams.set("results", results);
    url.searchParams.set("image_size", imageSize);
    if (mode === "keyword") {
      url.searchParams.set("query", q);
    } else {
      // 商品検索(v3)のJANパラメータ
      url.searchParams.set("jan_code", q);
    }

    // 注意：Yahoo側がCORSを許可していない場合、ここはブラウザで失敗します（実験用）
    const res = await fetch(url.toString(), { method: "GET" });
    if (!res.ok) {
      const t = await res.text().catch(() => "");
      throw new Error(`Yahoo直呼び出しエラー：HTTP ${res.status} ${t?.slice(0,180)}`);
    }
    return await res.json();
  }

  function normalizeItems(apiJson) {
    // V3は "items" 配列を返す（ドキュメント準拠）
    const items = apiJson?.items || apiJson?.Items;
    return Array.isArray(items) ? items : [];
  }

  function saveSettings() {
    try {
      localStorage.setItem(LS_KEY, JSON.stringify({
        proxyUrl: el.proxyUrl.value.trim(),
        appId: el.appId.value.trim()
      }));
    } catch (_e) {}
  }

  el.btn.addEventListener("click", async () => {
    const mode = getMode();
    const q = el.q.value.trim();
    const proxyUrl = el.proxyUrl.value.trim();
    const appId = el.appId.value.trim();
    const imageSize = el.imageSize.value;
    const results = el.results.value;

    saveSettings();

    if (!q) {
      setStatus("入力が空だよ。", "warn");
      return;
    }
    if (mode === "jan" && !/^[0-9]{8,14}$/.test(q)) {
      setStatus("JANコードは数字だけで入れてね（8〜14桁の目安）。", "warn");
      // 続行は許可
    }

    el.btn.disabled = true;
    setStatus("検索中…", "");
    el.resultsBox.innerHTML = "";

    try {
      let json;
      if (proxyUrl) {
        json = await fetchViaProxy({ proxyUrl, mode, q, imageSize, results });
      } else if (appId) {
        json = await fetchDirect({ appId, mode, q, imageSize, results });
      } else {
        throw new Error("プロキシURL か APP ID のどちらかが必要です。");
      }

      const items = normalizeItems(json);
      render(items);
      const total = json?.totalResultsAvailable ?? "";
      setStatus(`OK：${items.length}件表示${total ? `（全体: ${total}）` : ""}`, "ok");
      if (debug) console.log("API JSON", json);
    } catch (e) {
      console.error(e);
      setStatus(String(e?.message || e), "err");
      el.resultsBox.innerHTML = '<div class="tiny err">エラー。上のメッセージを見てね。</div>';
    } finally {
      el.btn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
