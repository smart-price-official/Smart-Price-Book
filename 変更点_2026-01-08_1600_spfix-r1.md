# Smart Price 修正レポート

**バージョン**: v19.9c-hf13-spfix-r1  
**BUILD_ID**: 2026-01-08_1600_spfix-r1  
**日時**: 2026-01-08 16:00 JST

## 修正内容

### 1. PC真っ黒画面の解消

#### manifest.json 404対策
- `<link rel="manifest">` を一旦無効化（コメントアウト）
- PWA機能は後で復活予定

#### Service Worker無効化
- 既存のService Workerを解除（`unregister()`）
- 新規登録を無効化（`if (false && ...)`）
- PCだけ真っ黒になる問題を防止

### 2. 画像表示・貼付機能の修正

#### 画像貼付（スマホ対応）
- `<input type="file">` に `capture="environment"` を追加
- スマホでカメラ/アルバムから確実に選択可能に

#### 画像表示の強化
- `renderHistory()`: `div.querySelector('img.prod-thumb')` で確実に取得
- `applyImageKeyToImg()`: エラーハンドリング強化、`referrerPolicy`設定
- フォールバック順序: `last.imageKey` → `it.imageKey` → `last.imageUrl` → `it.imageUrl` → placeholder

#### 画像処理エラー表示
- `handleImage()`: エラー時にトーストで理由を表示
- 失敗時も握り潰さず、ユーザーに通知

### 3. バーコード読取後の商品情報取得

#### Yahoo Shopping API実装
- `lookupYahooByJan()`: JANコード（8〜14桁）から商品情報を自動取得
- 初回のみYahoo App IDをpromptで入力（その後はlocalStorageに保存）
- CORS回避のため `r.jina.ai` 経由で取得
- 取得内容: 商品名、メーカー名、画像URL

#### 自動反映
- `startScanner()`: バーコード読取後に自動でYahoo検索
- `openForm()`: 新規商品の場合もJANコードなら自動検索
- 取得した情報を自動入力（商品名、メーカー、画像）

### 4. エラーハンドリング強化

#### 起動時エラー
- `window.onload`: try-catchでエラーを捕捉
- エラー時はトーストで通知（debug時は詳細表示）

#### 画像処理エラー
- `handleImage()`: 各段階でエラーを捕捉・表示
- `applyImageKeyToImg()`: エラー時にフォールバック

#### Yahoo検索エラー
- `lookupYahooByJan()`: エラー時にトーストで通知（debug時は詳細）

## テスト手順

### A: PC Chrome（シークレット）
1. `?b=2026-01-08_1600_spfix-r1` を付けて起動
2. 黒画面にならないことを確認
3. コンソールエラーがないことを確認

### C: スマホ（通常タブ）
1. 画像貼付ができることを確認
2. 履歴に画像が表示されることを確認
3. バーコード読取後に商品名が反映されることを確認

### B: PC Edge（通常）
1. 同条件で確認

## 注意事項

- **Yahoo App ID**: 初回バーコード読取時に入力が必要（Yahoo Shopping Web ServiceのClient ID）
- **manifest.json**: 一旦無効化しているため、PWA機能は動作しません（後で復活予定）
- **Service Worker**: 無効化しているため、オフライン機能は動作しません

## 配布URL

必ず `?b=2026-01-08_1600_spfix-r1` を付与してください。

例: `https://example.com/index.html?b=2026-01-08_1600_spfix-r1`
